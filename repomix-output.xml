This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.beads/.gitignore
.beads/config.yaml
.beads/interactions.jsonl
.beads/metadata.json
.beads/README.md
.gitattributes
.github/CODEOWNERS
.gitignore
.kiro/settings/mcp.json
.metadata
AGENTS.md
analysis_options.yaml
app.so
assets/fluxorigin logo.png
assets/fluxorigin_logo.png
Book translator portable.json
desktop_drop_plugin.dll
flutter_assets/AssetManifest.bin
flutter_assets/FontManifest.json
flutter_assets/fonts/MaterialIcons-Regular.otf
flutter_assets/NativeAssetsManifest.json
flutter_assets/NOTICES.Z
flutter_assets/packages/font_awesome_flutter/lib/fonts/Font-Awesome-7-Brands-Regular-400.otf
flutter_assets/packages/font_awesome_flutter/lib/fonts/Font-Awesome-7-Free-Regular-400.otf
flutter_assets/packages/font_awesome_flutter/lib/fonts/Font-Awesome-7-Free-Solid-900.otf
flutter_assets/packages/window_manager/images/ic_chrome_close.png
flutter_assets/packages/window_manager/images/ic_chrome_maximize.png
flutter_assets/packages/window_manager/images/ic_chrome_minimize.png
flutter_assets/packages/window_manager/images/ic_chrome_unmaximize.png
flutter_assets/shaders/ink_sparkle.frag
flutter_assets/shaders/stretch_effect.frag
flutter_windows.dll
icudtl.dat
installers/Flux_Origin.iss
lib/controllers/translation_controller.dart
lib/main.dart
lib/models/translation_progress.dart
lib/services/ai_service.dart
lib/services/dev_logger.dart
lib/services/web_search_service.dart
lib/ui/app.dart
lib/ui/screens/dev_logs_screen.dart
lib/ui/screens/dictionary_screen.dart
lib/ui/screens/history_screen.dart
lib/ui/screens/settings_screen.dart
lib/ui/screens/translate_screen.dart
lib/ui/theme/app_theme.dart
lib/ui/theme/config_provider.dart
lib/ui/widgets/file_upload_zone.dart
lib/ui/widgets/language_selector.dart
lib/ui/widgets/ollama_connection_dialog.dart
lib/ui/widgets/ollama_health_check.dart
lib/ui/widgets/path_setup_modal.dart
lib/ui/widgets/sidebar_item.dart
lib/ui/widgets/sidebar.dart
lib/ui/widgets/title_bar.dart
lib/ui/widgets/upload_dictionary_modal.dart
lib/utils/app_strings.dart
lib/utils/file_parser.dart
lib/utils/text_processor.dart
LICENSE
plans/reports/scout-external-260104-2319-documentation-audit.md
plans/reports/scout-external-260104-2319-lib-structure.md
plans/reports/scout-external-260104-2319-project-structure.md
PRIVACY.md
pubspec.lock
pubspec.yaml
README.md
screen_retriever_plugin.dll
temp_snippet.txt
test_output.txt
test/ai_service_refactor_test.dart
test/text_processor_test.dart
test/verify_web_search.dart
test/widget_test.dart
ui_design.html
unins000.dat
url_launcher_windows_plugin.dll
window_manager_plugin.dll
windows/.gitignore
windows/CMakeLists.txt
windows/flutter/CMakeLists.txt
windows/flutter/generated_plugin_registrant.cc
windows/flutter/generated_plugin_registrant.h
windows/flutter/generated_plugins.cmake
windows/runner/CMakeLists.txt
windows/runner/flutter_window.cpp
windows/runner/flutter_window.h
windows/runner/main.cpp
windows/runner/resource.h
windows/runner/resources/app_icon.ico
windows/runner/runner.exe.manifest
windows/runner/Runner.rc
windows/runner/utils.cpp
windows/runner/utils.h
windows/runner/win32_window.cpp
windows/runner/win32_window.h
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".beads/.gitignore">
# SQLite databases
*.db
*.db?*
*.db-journal
*.db-wal
*.db-shm

# Daemon runtime files
daemon.lock
daemon.log
daemon.pid
bd.sock
sync-state.json
last-touched

# Local version tracking (prevents upgrade notification spam after git ops)
.local_version

# Legacy database files
db.sqlite
bd.db

# Worktree redirect file (contains relative path to main repo's .beads/)
# Must not be committed as paths would be wrong in other clones
redirect

# Merge artifacts (temporary files from 3-way merge)
beads.base.jsonl
beads.base.meta.json
beads.left.jsonl
beads.left.meta.json
beads.right.jsonl
beads.right.meta.json

# NOTE: Do NOT add negation patterns (e.g., !issues.jsonl) here.
# They would override fork protection in .git/info/exclude, allowing
# contributors to accidentally commit upstream issue databases.
# The JSONL files (issues.jsonl, interactions.jsonl) and config files
# are tracked by git by default since no pattern above ignores them.
</file>

<file path=".beads/config.yaml">
# Beads Configuration File
# This file configures default behavior for all bd commands in this repository
# All settings can also be set via environment variables (BD_* prefix)
# or overridden with command-line flags

# Issue prefix for this repository (used by bd init)
# If not set, bd init will auto-detect from directory name
# Example: issue-prefix: "myproject" creates issues like "myproject-1", "myproject-2", etc.
# issue-prefix: ""

# Use no-db mode: load from JSONL, no SQLite, write back after each command
# When true, bd will use .beads/issues.jsonl as the source of truth
# instead of SQLite database
# no-db: false

# Disable daemon for RPC communication (forces direct database access)
# no-daemon: false

# Disable auto-flush of database to JSONL after mutations
# no-auto-flush: false

# Disable auto-import from JSONL when it's newer than database
# no-auto-import: false

# Enable JSON output by default
# json: false

# Default actor for audit trails (overridden by BD_ACTOR or --actor)
# actor: ""

# Path to database (overridden by BEADS_DB or --db)
# db: ""

# Auto-start daemon if not running (can also use BEADS_AUTO_START_DAEMON)
# auto-start-daemon: true

# Debounce interval for auto-flush (can also use BEADS_FLUSH_DEBOUNCE)
# flush-debounce: "5s"

# Git branch for beads commits (bd sync will commit to this branch)
# IMPORTANT: Set this for team projects so all clones use the same sync branch.
# This setting persists across clones (unlike database config which is gitignored).
# Can also use BEADS_SYNC_BRANCH env var for local override.
# If not set, bd sync will require you to run 'bd config set sync.branch <branch>'.
# sync-branch: "beads-sync"

# Multi-repo configuration (experimental - bd-307)
# Allows hydrating from multiple repositories and routing writes to the correct JSONL
# repos:
#   primary: "."  # Primary repo (where this database lives)
#   additional:   # Additional repos to hydrate from (read-only)
#     - ~/beads-planning  # Personal planning repo
#     - ~/work-planning   # Work planning repo

# Integration settings (access with 'bd config get/set')
# These are stored in the database, not in this file:
# - jira.url
# - jira.project
# - linear.url
# - linear.api-key
# - github.org
# - github.repo
</file>

<file path=".beads/interactions.jsonl">

</file>

<file path=".beads/metadata.json">
{
  "database": "beads.db",
  "jsonl_export": "issues.jsonl"
}
</file>

<file path=".beads/README.md">
# Beads - AI-Native Issue Tracking

Welcome to Beads! This repository uses **Beads** for issue tracking - a modern, AI-native tool designed to live directly in your codebase alongside your code.

## What is Beads?

Beads is issue tracking that lives in your repo, making it perfect for AI coding agents and developers who want their issues close to their code. No web UI required - everything works through the CLI and integrates seamlessly with git.

**Learn more:** [github.com/steveyegge/beads](https://github.com/steveyegge/beads)

## Quick Start

### Essential Commands

```bash
# Create new issues
bd create "Add user authentication"

# View all issues
bd list

# View issue details
bd show <issue-id>

# Update issue status
bd update <issue-id> --status in_progress
bd update <issue-id> --status done

# Sync with git remote
bd sync
```

### Working with Issues

Issues in Beads are:
- **Git-native**: Stored in `.beads/issues.jsonl` and synced like code
- **AI-friendly**: CLI-first design works perfectly with AI coding agents
- **Branch-aware**: Issues can follow your branch workflow
- **Always in sync**: Auto-syncs with your commits

## Why Beads?

‚ú® **AI-Native Design**
- Built specifically for AI-assisted development workflows
- CLI-first interface works seamlessly with AI coding agents
- No context switching to web UIs

üöÄ **Developer Focused**
- Issues live in your repo, right next to your code
- Works offline, syncs when you push
- Fast, lightweight, and stays out of your way

üîß **Git Integration**
- Automatic sync with git commits
- Branch-aware issue tracking
- Intelligent JSONL merge resolution

## Get Started with Beads

Try Beads in your own projects:

```bash
# Install Beads
curl -sSL https://raw.githubusercontent.com/steveyegge/beads/main/scripts/install.sh | bash

# Initialize in your repo
bd init

# Create your first issue
bd create "Try out Beads"
```

## Learn More

- **Documentation**: [github.com/steveyegge/beads/docs](https://github.com/steveyegge/beads/tree/main/docs)
- **Quick Start Guide**: Run `bd quickstart`
- **Examples**: [github.com/steveyegge/beads/examples](https://github.com/steveyegge/beads/tree/main/examples)

---

*Beads: Issue tracking that moves at the speed of thought* ‚ö°
</file>

<file path=".gitattributes">
# Use bd merge for beads JSONL files
.beads/issues.jsonl merge=beads
</file>

<file path="AGENTS.md">
# Agent Instructions

This project uses **bd** (beads) for issue tracking. Run `bd onboard` to get started.

## Quick Reference

```bash
bd ready              # Find available work
bd show <id>          # View issue details
bd update <id> --status in_progress  # Claim work
bd close <id>         # Complete work
bd sync               # Sync with git
```

## Landing the Plane (Session Completion)

**When ending a work session**, you MUST complete ALL steps below. Work is NOT complete until `git push` succeeds.

**MANDATORY WORKFLOW:**

1. **File issues for remaining work** - Create issues for anything that needs follow-up
2. **Run quality gates** (if code changed) - Tests, linters, builds
3. **Update issue status** - Close finished work, update in-progress items
4. **PUSH TO REMOTE** - This is MANDATORY:
   ```bash
   git pull --rebase
   bd sync
   git push
   git status  # MUST show "up to date with origin"
   ```
5. **Clean up** - Clear stashes, prune remote branches
6. **Verify** - All changes committed AND pushed
7. **Hand off** - Provide context for next session

**CRITICAL RULES:**
- Work is NOT complete until `git push` succeeds
- NEVER stop before pushing - that leaves work stranded locally
- NEVER say "ready to push when you are" - YOU must push
- If push fails, resolve and retry until it succeeds
</file>

<file path="plans/reports/scout-external-260104-2319-documentation-audit.md">
# Documentation Audit Report - FluxOrigin
Generated: 2026-01-04 23:19
Subagent: scout-external (a412c0b)
CWD: F:\CodeBase\FluxOrigin

## Executive Summary
FluxOrigin is a Flutter-based Windows desktop application for AI-powered book/document translation using local LLM providers (Ollama/LM Studio). Current documentation is comprehensive at user level but lacks developer/architecture documentation.

## Project Identity
- Name: FluxOrigin - AI Book Translator
- Version: 2.0.2
- Platform: Windows 10/11 (64-bit)
- Framework: Flutter 3.x
- License: GPLv3 with trademark restrictions
- Developer: d-init-d (MINH DUNG NGUYEN)
- Contact: d.init.d.contact@gmail.com

## Documentation Inventory

### Existing Documentation (Root Level)

1. README.md (170 lines) - Comprehensive user documentation in Vietnamese
   - Features, installation, usage guide, model recommendations, project structure

2. AGENTS.md (41 lines) - Developer workflow instructions
   - bd (beads) issue tracking workflow
   - Mandatory "landing the plane" completion protocol

3. PRIVACY.md (40 lines) - Complete privacy policy
   - Last updated: Dec 04, 2025
   - Emphasizes local-first architecture, no cloud data collection

4. LICENSE (680 lines) - Full GPLv3 license text
   - Custom trademark clause protecting "FluxOrigin" name/logo

5. docs/ directory - Does NOT exist

## Project Overview

### Description
Desktop app for automatic book/document translation using local AI. Successor to "n8n book translator" - eliminates n8n workflow dependency for all-in-one experience.

### Key Features
- Native Flutter App: Single .exe, no Docker/Node.js/n8n setup
- Multi-AI Provider: Supports Ollama + LM Studio
- Dictionary Management: Upload custom terminology/proper nouns
- Smart Text Processing: Auto-chunking to avoid token limits
- Live Translation Preview: Real-time translation display
- Dev Logs: Developer debug view for requests/responses
- Translation History: Auto-saves previous translations
- Web Search (Experimental): Context enhancement via search

### Supported File Formats
- .txt (plain text)
- .md (Markdown)
- .epub (eBook)

## System Requirements
- OS: Windows 10/11 (64-bit)
- AI Backend: Ollama or LM Studio
- RAM: 8GB+ recommended

## Architecture

### Project Structure
lib/
‚îú‚îÄ‚îÄ ui/                    # User interface
‚îÇ   ‚îú‚îÄ‚îÄ screens/           # Main screens
‚îÇ   ‚îú‚îÄ‚îÄ widgets/           # Reusable widgets
‚îÇ   ‚îî‚îÄ‚îÄ theme/             # Theme & Config Provider
‚îú‚îÄ‚îÄ services/              # API logic
‚îÇ   ‚îú‚îÄ‚îÄ ai_service.dart
‚îÇ   ‚îú‚îÄ‚îÄ web_search_service.dart
‚îÇ   ‚îî‚îÄ‚îÄ dev_logger.dart
‚îú‚îÄ‚îÄ controllers/           # State management
‚îú‚îÄ‚îÄ utils/                 # Text/file processing tools
‚îî‚îÄ‚îÄ models/                # Data definitions

### Technology Stack
- Flutter SDK 3.x
- Dart >=3.0.0 <4.0.0
- UI: google_fonts, font_awesome_flutter, flutter_animate
- State: provider
- Files: file_picker, desktop_drop, epubx
- Network: http, url_launcher
- Storage: shared_preferences
- Deploy: msix (Windows Store)

## AI Model Recommendations

### By Hardware Tier
- 4-6GB: Qwen2.5-3B, Gemma3-4B (Balanced)
- 8GB: Qwen2.5-7B, Llama3.1-8B (Good)
- 12GB: Qwen3-8B, Gemma3-12B (Excellent)
- 16GB: Qwen3-14B, Qwen2.5-14B (Excellent)
- 24GB+: Gemma3-27B, Qwen3-30B-A3B (Excellent)
- 42GB+: Llama3.3-70B (Workstation)

### By Use Case
- Chinese to Vietnamese novels: Qwen3-8B, Qwen3-14B
- English to Vietnamese technical: Llama3.1-8B, Gemma3-12B
- Low-end hardware: Qwen2.5-3B, Gemma3-4B
- Highest quality: Qwen3-14B, Gemma3-27B

## Privacy & Data Handling

### Core Privacy Principles
1. Local-First Architecture
   - No personal data collection
   - No cloud uploads of user files/content
   - All processing happens locally

2. AI Processing
   - Connects to LOCAL AI models (Ollama/LM Studio)
   - Translation text stays within local environment
   - No external API calls for generation

3. Internet Usage (Limited)
   - Only for: Microsoft Store license verification, app updates
   - NOT used for content transmission

4. Analytics
   - No third-party analytics SDKs
   - Local dev logs only

## Licensing Details
- License Type: GPLv3
- Trademark Protection: "FluxOrigin" name + logo are proprietary
- Fork/Modification Rules:
  * Can fork and modify code under GPLv3
  * MUST change name and logo for public distribution of modified versions

## Developer Workflow

### Issue Tracking System (bd/beads)
- bd onboard
- bd ready
- bd show <id>
- bd update <id> --status in_progress
- bd close <id>
- bd sync

### Session Completion Protocol
MANDATORY WORKFLOW:
1. File issues for remaining work
2. Run quality gates
3. Update issue status
4. PUSH TO REMOTE (critical)
5. Clean up
6. Verify
7. Hand off

Critical Rules:
- Work NOT complete until git push succeeds
- NEVER stop before pushing
- NEVER delegate push to user

## Documentation Gaps

### Missing Documentation
1. Architecture Documentation
   - No detailed architecture diagrams
   - No data flow documentation
   - No state management patterns explained
   - No API documentation

2. Developer Documentation
   - No contribution guidelines
   - No code style guide
   - No testing documentation
   - No build/deployment documentation

3. API/Service Documentation
   - No ai_service.dart documentation
   - No web_search_service.dart documentation
   - No dev_logger.dart documentation

4. User Documentation Gaps
   - No troubleshooting guide
   - No FAQ
   - No screenshots/visual guide
   - No video tutorials

5. Technical Documentation
   - No chunking algorithm explanation
   - No dictionary format specification
   - No custom model integration guide
   - No performance tuning guide

### Missing Files/Directories
- docs/ directory (absent)
- CONTRIBUTING.md
- CHANGELOG.md
- CODE_OF_CONDUCT.md
- API reference documentation

## Documentation Quality Assessment

### Strengths
- README is comprehensive and well-structured
- Vietnamese localization for target audience
- Clear installation instructions
- Excellent AI model recommendation table
- Privacy policy is clear and specific
- AGENTS.md provides clear developer workflow

### Weaknesses
- No developer/architecture documentation
- No API documentation
- No visual aids (screenshots, diagrams)
- No troubleshooting guide
- No changelog
- Missing contribution guidelines

## Recommendations

### High Priority
1. Create docs/ directory with:
   - architecture.md
   - api-reference.md
   - troubleshooting.md
   - changelog.md
2. Add screenshots to README
3. Create CONTRIBUTING.md

### Medium Priority
4. Document chunking algorithm
5. Create dictionary file format specification
6. Add performance tuning guide
7. Create developer onboarding guide

### Low Priority
8. Create video tutorial
9. Add FAQ section
10. Create code style guide

## Unresolved Questions
1. Where is the actual installer (FluxOrigin_Installer_v1.0.1.exe)?
2. Is there a separate documentation repository?
3. Are there any internal architecture diagrams not committed?
4. What is the target audience distribution (developer vs end-user)?
5. Is Vietnamese the only target language for docs?
</file>

<file path="plans/reports/scout-external-260104-2319-lib-structure.md">
FluxOrigin lib/ Directory - Complete File Structure Report
Project: FluxOrigin (Flutter Translation Application)
Scope: Complete lib/ directory exploration
Date: 2026-01-04
Total Files: 25 Dart files

EXECUTIVE SUMMARY
FluxOrigin: Desktop Flutter app for AI-powered document translation (Chinese wuxia/romance to Vietnamese). Uses Provider for state management, supports Ollama and LM Studio AI backends.

Core Architecture:
- State Management: Provider (ChangeNotifier)
- AI Integration: HTTP-based (Ollama/LM Studio APIs)
- File Support: TXT, EPUB
- Translation: Genre detection, chunked processing, progress persistence, web search enrichment

DIRECTORY STRUCTURE
lib/
- main.dart - Application entry point
- controllers/translation_controller.dart - Translation orchestration (564 lines)
- models/translation_progress.dart - Progress persistence model
- services/ai_service.dart - AI provider abstraction (774 lines)
- services/dev_logger.dart - Development logging
- services/web_search_service.dart - RAG web search
- ui/app.dart - Root MaterialApp widget
- ui/screens/ - 5 screens (Translate, History, Dictionary, Settings, DevLogs)
- ui/theme/ - ThemeNotifier, ConfigProvider
- ui/widgets/ - 9 widgets (Sidebar, TitleBar, FileUpload, Modals, HealthCheck)
- utils/ - app_strings (i18n), file_parser, text_processor

ENTRY POINTS
main.dart: Bootstrap, window config (1000x700), MultiProvider setup
ui/app.dart: MaterialApp with IndexedStack navigation (5 screens), ThemeNotifier, ConfigProvider

STATE MANAGEMENT
ui/theme/config_provider.dart - Global config store (SharedPreferences)
- State: projectPath, selectedModel, ollamaUrl, lmStudioUrl, aiProvider, appLanguage, ollamaConnected
- Methods: loadConfig(), setProjectPath(), checkOllamaHealth()

ui/theme/app_theme.dart - Theme toggle
- Light: #FDFCF8 paper, #043222 primary
- Dark: #111111 paper, #000000 sidebar

TRANSLATION WORKFLOW
controllers/translation_controller.dart (564 lines)
Pipeline: Upload ‚Üí Parse ‚Üí Chunk ‚Üí Detect Genre ‚Üí Generate Glossary ‚Üí Enrich (RAG) ‚Üí Translate ‚Üí Save ‚Üí Merge

Key Methods:
1. processFile() - Main orchestrator with resume logic
2. Initialization - Extract text, split chunks, detect genre, generate glossary, enrich
3. Translation Loop - Context-aware, save after every chunk, pause handling
4. Finalization - Merge chunks, delete progress, add to history

SERVICES
services/ai_service.dart (774 lines)
- Ollama: /api/chat, /api/tags, /api/pull, /api/delete
- LM Studio: /v1/chat/completions, /v1/models
- Key: checkConnection(), detectGenre(), generateGlossary(), translateChunk()
- Anti-Hallucination: 3-layer system (model params, cleanResponse, isGarbageOutput)

services/web_search_service.dart - RAG glossary enrichment
services/dev_logger.dart - Centralized logging (info, debug, warning, error, request, response)

MODELS
models/translation_progress.dart - Resume state persistence
- Fields: sourcePath, glossary, systemPrompt, genre, rawChunks, translatedChunks, currentIndex
- Methods: toJson(), fromJson(), loadFromFile(), saveToFile()
- Location: {dictionaryDir}/{fileName}.flux_progress.json

UTILITIES
utils/app_strings.dart - i18n strings (Vietnamese + English), ~170 strings
utils/file_parser.dart - Extract text from .txt/.epub
utils/text_processor.dart - smartSplit(), createSample(), extractLastSentences()

WIDGETS (9 total)
- file_upload_zone.dart - Drag-drop upload
- ollama_health_check.dart - Non-blocking AI health monitor
- sidebar.dart - 5-item navigation (badge if AI disconnected)
- title_bar.dart - Custom window controls (32px)
- path_setup_modal.dart - First-run project setup
- language_selector.dart, ollama_connection_dialog.dart, sidebar_item.dart, upload_dictionary_modal.dart

API/BACKEND INTEGRATIONS
Ollama (Default): http://localhost:11434
LM Studio (Alternative): http://localhost:1234 (OpenAI-compatible)
Web Search: RAG glossary enrichment (implementation not visible)

CONFIGURATION
SharedPreferences: project_path, selected_model, ollama_url, lm_studio_url, ai_provider, app_language
File-Based: history_log.json, {fileName}.flux_progress.json, {fileName}_glossary.csv

SUMMARY TABLE
Entry Points: 2 (main.dart, app.dart)
Controllers: 1 (translation_controller.dart - 564 lines)
Models: 1 (translation_progress.dart)
Services: 3 (AI abstraction, RAG search, logging)
Screens: 5 (Translate, History, Dictionary, Settings, DevLogs)
Widgets: 9 (Sidebar, TitleBar, FileUpload, Modals, HealthCheck)
Theme: 2 (ThemeNotifier, ConfigProvider)
Utils: 3 (i18n, file parsing, text processing)

Total: 25 Dart files, ~3500+ lines of code

State Management: Provider (ChangeNotifier)
Dependencies: provider, window_manager, google_fonts, shared_preferences, http, csv, path, epub_view

UNRESOLVED QUESTIONS
1. web_search_service.dart implementation - which API?
2. file_parser.dart - exact EPUB parsing library?
3. text_processor.dart - sentence boundary detection logic?
4. Error recovery - network timeout handling UX?
5. Model naming - LM Studio vs Ollama name conversion?
</file>

<file path="plans/reports/scout-external-260104-2319-project-structure.md">
# FluxOrigin Project Structure Report

**Generated**: 2026-01-04 23:19  
**Scope**: assets/, pubspec.yaml, .github/, windows/, .kiro/, test/

---

## 1. Assets Directory (`assets/`)

### Images
- `F:\CodeBase\FluxOrigin\assets\fluxorigin_logo.png` (61KB)
- `F:\CodeBase\FluxOrigin\assets\fluxorigin logo.png` (61KB)

**Note**: Identical files (61,013 bytes each), likely duplicates with different naming conventions.

### Fonts
Kh√¥ng c√≥ font files trong th∆∞ m·ª•c assets/.

### i18n (Internationalization)
Kh√¥ng c√≥ i18n files trong th∆∞ m·ª•c assets/.

---

## 2. Dependencies (`pubspec.yaml`)

### Project Info
- **Name**: flux_origin
- **Version**: 2.0.2+1
- **Description**: Translation desktop application for Windows
- **Dart SDK**: >=3.0.0 <4.0.0

### Production Dependencies

#### Window Management
- `window_manager: ^0.3.0` - Qu·∫£n l√Ω c·ª≠a s·ªï native (resize, minimize, maximize, position)

#### UI & Visual
- `google_fonts: ^6.1.0` - Fonts t·ª´ Google Fonts API
- `font_awesome_flutter: ^10.6.0` - Icon library Font Awesome
- `flutter_animate: ^4.3.0` - Animation effects v√† transitions

#### State Management & Storage
- `provider: ^6.1.0` - State management solution
- `shared_preferences: ^2.5.3` - Key-value persistent storage

#### File Operations
- `file_picker: ^10.3.7` - File/folder selection dialogs
- `desktop_drop: ^0.4.4` - Drag-and-drop file handling
- `path: ^1.9.0` - Cross-platform path manipulation

#### Networking & Web
- `http: ^1.1.0` - HTTP client cho API calls
- `url_launcher: ^6.3.2` - M·ªü URLs trong browser/external apps

#### Data Processing
- `csv: ^6.0.0` - CSV file parsing/generation
- `html: ^0.15.4` - HTML document parsing/manipulation
- `epubx: ^4.0.0` - EPUB file format parser (e-books)

### Dev Dependencies
- `flutter_test` - Testing framework
- `flutter_lints: ^3.0.0` - Linting rules cho code quality
- `msix: ^3.16.0` - MSIX package builder cho Windows Store

### Dependency Overrides
- `image: ^3.3.0` - Overridden ƒë·ªÉ fix compatibility issues

---

## 3. CI/CD Workflows (`.github/`)

**Status**: Kh√¥ng c√≥ CI/CD workflows ƒë∆∞·ª£c c·∫•u h√¨nh.

Directory `.github/workflows/` kh√¥ng t·ªìn t·∫°i trong project.

**Recommendation**: Consider th√™m GitHub Actions cho:
- Automated testing
- Build automation
- Release packaging
- Code quality checks

---

## 4. Windows Configuration (`windows/`)

### Build Configuration
- `CMakeLists.txt` - Main CMake project config
- `flutter/CMakeLists.txt` - Auto-generated Flutter CMake config
- `runner/CMakeLists.txt` - Application runner config

### Application Entry & Core
- `runner/main.cpp` - Windows entry point, COM init, message loop
- `runner/flutter_window.cpp/.h` - Flutter view hosting trong Windows native window
- `runner/win32_window.cpp/.h` - Base Win32 window abstraction (DPI-aware)

### Utilities & Resources
- `runner/utils.cpp/.h` - Console attach, command-line parsing, UTF-8/UTF-16 conversion
- `runner/Runner.rc` - Windows resource script (icons, version info)
- `runner/resource.h` - Resource ID definitions
- `runner/runner.exe.manifest` - App manifest (DPI awareness, Windows 10/11 compatibility)

### Plugin System
- `flutter/generated_plugin_registrant.cc/.h` - Auto-generated plugin registration
- `flutter/generated_plugins.cmake` - Auto-generated CMake plugin config

### Ignore Rules
- `.gitignore` - Build artifacts, VS user files, Flutter temp files

---

## 5. Project Configuration (`.kiro/`)

### MCP Configuration
**File**: `.kiro/settings/mcp.json`

```json
{
  "mcpServers": {
    "fetch": {
      "command": "uvx",
      "args": ["mcp-server-fetch"],
      "env": {},
      "disabled": true,
      "autoApprove": []
    }
  }
}
```

**Purpose**: Multi-Client Protocol server configuration (currently disabled)

---

## 6. Test Structure (`test/`)

### Test Files
1. **`widget_test.dart`** - UI widget test placeholder (minimal coverage)
2. **`verify_web_search.dart`** - `WebSearchService` functional verification script
   - Tests: EN, VI, ZH language lookups
   - Format: Simple Dart script v·ªõi `print` assertions
3. **`text_processor_test.dart`** - `TextProcessor.smartSplit` comprehensive tests
   - Tests: Various text splitting scenarios
   - Format: Dart script v·ªõi `print` verification
4. **`ai_service_refactor_test.dart`** - **Well-structured** `AIService.cleanResponse` unit tests
   - Uses: `flutter_test` framework v·ªõi `group` v√† `test`
   - Coverage: Response cleaning logic

### Test Organization
- **Structured**: Only `ai_service_refactor_test.dart` uses proper `flutter_test` framework
- **Ad-hoc**: `verify_web_search.dart` v√† `text_processor_test.dart` are verification scripts
- **UI Testing**: Minimal (only placeholder exists)

### Coverage Areas
- ‚úÖ AIService response cleaning
- ‚úÖ Text processing/splitting
- ‚úÖ Web search functionality
- ‚ùå UI widgets (placeholder only)
- ‚ùå Integration tests
- ‚ùå E2E tests

**Recommendation**: Expand test coverage v·ªõi:
- Widget tests cho UI components
- Integration tests cho feature flows
- Migrate verification scripts sang `flutter_test` format

---

## 7. MSIX Configuration (`pubspec.yaml`)

### Windows Store Package Settings
```yaml
display_name: FluxOrigin
publisher_display_name: d-init-d
identity_name: d-init-d.FluxOrigin
publisher: CN=94D446F9-8A96-471F-9749-DFF18CBA6CD8
msix_version: 2.0.2.0
logo_path: D:\FluxOrigin\assets\fluxorigin logo.png
store: true
capabilities: "internetClient, internetClientServer"
```

**Note**: Logo path `D:\FluxOrigin\assets\fluxorigin logo.png` l√† absolute path, c√≥ th·ªÉ g√¢y issues tr√™n m√°y kh√°c.

---

## Key File Paths Summary

### Assets
- `F:\CodeBase\FluxOrigin\assets\fluxorigin_logo.png`
- `F:\CodeBase\FluxOrigin\assets\fluxorigin logo.png`

### Configuration
- `F:\CodeBase\FluxOrigin\pubspec.yaml`
- `F:\CodeBase\FluxOrigin\.kiro\settings\mcp.json`

### Windows Native
- `F:\CodeBase\FluxOrigin\windows\CMakeLists.txt`
- `F:\CodeBase\FluxOrigin\windows\runner\main.cpp`
- `F:\CodeBase\FluxOrigin\windows\runner\flutter_window.cpp`
- `F:\CodeBase\FluxOrigin\windows\runner\win32_window.cpp`
- `F:\CodeBase\FluxOrigin\windows\runner\Runner.rc`
- `F:\CodeBase\FluxOrigin\windows\runner\runner.exe.manifest`

### Tests
- `F:\CodeBase\FluxOrigin\test\ai_service_refactor_test.dart`
- `F:\CodeBase\FluxOrigin\test\text_processor_test.dart`
- `F:\CodeBase\FluxOrigin\test\verify_web_search.dart`
- `F:\CodeBase\FluxOrigin\test\widget_test.dart`

---

## Unresolved Questions

1. **Asset duplication**: T·∫°i sao c√≥ 2 logo files gi·ªëng h·ªát nhau v·ªõi t√™n kh√°c nhau?
2. **MSIX logo path**: Hardcoded path `D:\FluxOrigin\` c√≥ th·ªÉ g√¢y build failures tr√™n m√¥i tr∆∞·ªùng kh√°c - c·∫ßn chuy·ªÉn sang relative path?
3. **MCP server**: M·ª•c ƒë√≠ch c·ªßa `mcp-server-fetch` config (hi·ªán ƒëang disabled)?
4. **CI/CD absence**: C√≥ k·∫ø ho·∫°ch th√™m automated workflows kh√¥ng?
5. **Test coverage**: UI tests ch·ªâ c√≥ placeholder - k·∫ø ho·∫°ch m·ªü r·ªông testing?
</file>

<file path=".github/CODEOWNERS">
# --- QU·∫¢N L√ù D·ª∞ √ÅN & PH√ÅP L√ù ---
# Ch·ªâ c√≥ ch·ªß d·ª± √°n m·ªõi ƒë∆∞·ª£c thay ƒë·ªïi gi·∫•y ph√©p v√† th√¥ng tin d·ª± √°n
LICENSE                 @d-init-d
README.md               @d-init-d
.gitignore              @d-init-d

# --- C·∫§U H√åNH FLUTTER (QUAN TR·ªåNG NH·∫§T) ---
# NgƒÉn ch·∫∑n vi·ªác t·ª± √Ω th√™m th∆∞ vi·ªán ho·∫∑c ƒë·ªïi version Dart
pubspec.yaml            @d-init-d
pubspec.lock            @d-init-d
analysis_options.yaml   @d-init-d

# --- C·∫§U H√åNH WINDOWS NATIVE ---
# C√°c file C++ v√† CMake c·∫•u h√¨nh vi·ªác build app tr√™n Windows
windows/CMakeLists.txt          @d-init-d
windows/runner/CMakeLists.txt   @d-init-d
windows/runner/Runner.rc        @d-init-d
windows/runner/main.cpp         @d-init-d

# --- FILE C√ÄI ƒê·∫∂T (INNO SETUP) ---
# B·∫£o v·ªá script t·∫°o b·ªô c√†i .exe
installers/*.iss        @d-init-d

# --- T√ÄI NGUY√äN TH∆Ø∆†NG HI·ªÜU ---
# B·∫£o v·ªá logo v√† icon app
# L∆∞u √Ω: C·∫ßn th√™m d·∫•u \ tr∆∞·ªõc kho·∫£ng tr·∫Øng trong t√™n file
assets/fluxorigin\ logo.png      @d-init-d
windows/runner/resources/app_icon.ico @d-init-d
</file>

<file path=".kiro/settings/mcp.json">
{
  "mcpServers": {
    "fetch": {
      "command": "uvx",
      "args": ["mcp-server-fetch"],
      "env": {},
      "disabled": true,
      "autoApprove": []
    }
  }
}
</file>

<file path=".metadata">
# This file tracks properties of this Flutter project.
# Used by Flutter tool to assess capabilities and perform upgrades etc.
#
# This file should be version controlled and should not be manually edited.

version:
  revision: "19074d12f7eaf6a8180cd4036a430c1d76de904e"
  channel: "stable"

project_type: app

# Tracks metadata for the flutter migrate command
migration:
  platforms:
    - platform: root
      create_revision: 19074d12f7eaf6a8180cd4036a430c1d76de904e
      base_revision: 19074d12f7eaf6a8180cd4036a430c1d76de904e
    - platform: windows
      create_revision: 19074d12f7eaf6a8180cd4036a430c1d76de904e
      base_revision: 19074d12f7eaf6a8180cd4036a430c1d76de904e

  # User provided section

  # List of Local paths (relative to this file) that should be
  # ignored by the migrate tool.
  #
  # Files that are not part of the templates will be ignored by default.
  unmanaged_files:
    - 'lib/main.dart'
    - 'ios/Runner.xcodeproj/project.pbxproj'
</file>

<file path="analysis_options.yaml">
# This file configures the analyzer, which statically analyzes Dart code to
# check for errors, warnings, and lints.
#
# The issues identified by the analyzer are surfaced in the UI of Dart-enabled
# IDEs (https://dart.dev/tools#ides-and-editors). The analyzer can also be
# invoked from the command line by running `flutter analyze`.

# The following line activates a set of recommended lints for Flutter apps,
# packages, and plugins designed to encourage good coding practices.
include: package:flutter_lints/flutter.yaml

linter:
  # The lint rules applied to this project can be customized in the
  # section below to disable rules from the `package:flutter_lints/flutter.yaml`
  # included above or to enable additional rules. A list of all available lints
  # and their documentation is published at https://dart.dev/lints.
  #
  # Instead of disabling a lint rule for the entire project in the
  # section below, it can also be suppressed for a single line of code
  # or a specific dart file by using the `// ignore: name_of_lint` and
  # `// ignore_for_file: name_of_lint` syntax on the line or in the file
  # producing the lint.
  rules:
    # avoid_print: false  # Uncomment to disable the `avoid_print` rule
    # prefer_single_quotes: true  # Uncomment to enable the `prefer_single_quotes` rule

# Additional information about this file can be found at
# https://dart.dev/guides/language/analysis-options
</file>

<file path="Book translator portable.json">
{
  "name": "Book translator portable",
  "nodes": [
    {
      "parameters": {
        "triggerOn": "folder",
        "path": "D:/N8n_book_translator/Input",
        "events": [
          "add"
        ],
        "options": {}
      },
      "type": "n8n-nodes-base.localFileTrigger",
      "typeVersion": 1,
      "position": [
        -1536,
        -32
      ],
      "id": "e577a657-1d91-43b1-8966-8dd503029926",
      "name": "Local File Trigger"
    },
    {
      "parameters": {
        "jsCode": "// 1. L·∫•y d·ªØ li·ªáu file g·ªëc\nconst binaryData = items[0].binary.data;\nconst fullText = Buffer.from(binaryData.data, 'base64').toString('utf-8');\nconst totalLen = fullText.length;\n\n// --- C·∫§U H√åNH ---\nconst HEAD_SIZE = 4000;\nconst MID_SIZE = 3000;\nconst TAIL_SIZE = 3000;\n// Danh s√°ch c√°c k√Ω t·ª± an to√†n ƒë·ªÉ c·∫Øt (∆Øu ti√™n d·∫•u c√¢u)\nconst SAFE_CHARS = ['.', ',', '!', '?', ';', '\\n', '‚Äù', '\"'];\n// ----------------\n\n// H√†m t√¨m ƒëi·ªÉm c·∫Øt an to√†n (L√πi l·∫°i t·ª´ ƒëi·ªÉm d·ª± ki·∫øn)\nfunction findSafeCutBackwards(text, limitIndex) {\n    // L√πi l·∫°i t·ªëi ƒëa 500 k√Ω t·ª± ƒë·ªÉ t√¨m d·∫•u c√¢u\n    for (let i = 0; i < 500; i++) {\n        const idx = limitIndex - i;\n        if (idx < 0) return limitIndex;\n        \n        // N·∫øu g·∫∑p d·∫•u c√¢u -> C·∫Øt ngay sau n√≥\n        if (SAFE_CHARS.includes(text[idx])) {\n            return idx + 1; \n        }\n    }\n    // N·∫øu ƒëen ƒë·ªßi kh√¥ng c√≥ d·∫•u c√¢u n√†o -> ƒê√†nh c·∫Øt ·ªü d·∫•u c√°ch g·∫ßn nh·∫•t\n    return text.lastIndexOf(' ', limitIndex);\n}\n\n// H√†m t√¨m ƒëi·ªÉm b·∫Øt ƒë·∫ßu an to√†n (Ti·∫øn t·ªõi t·ª´ ƒëi·ªÉm d·ª± ki·∫øn)\nfunction findSafeCutForward(text, startIndex) {\n    // Ti·∫øn t·ªõi t·ªëi ƒëa 500 k√Ω t·ª±\n    for (let i = 0; i < 500; i++) {\n        const idx = startIndex + i;\n        if (idx >= text.length) return startIndex;\n        \n        // N·∫øu g·∫∑p d·∫•u c√¢u -> B·∫Øt ƒë·∫ßu ƒëo·∫°n m·ªõi sau d·∫•u c√¢u ƒë√≥\n        if (SAFE_CHARS.includes(text[idx])) {\n            return idx + 1;\n        }\n    }\n    return text.indexOf(' ', startIndex) + 1;\n}\n\nlet combinedSample = \"\";\n\nif (totalLen <= (HEAD_SIZE + MID_SIZE + TAIL_SIZE)) {\n    combinedSample = fullText;\n} else {\n    // 1. KH√öC ƒê·∫¶U\n    // C·∫Øt t·∫°i d·∫•u c√¢u g·∫ßn m·ªëc 4000 nh·∫•t\n    const safeHeadEnd = findSafeCutBackwards(fullText, HEAD_SIZE);\n    combinedSample += \"--- [PH·∫¶N M·ªû ƒê·∫¶U] ---\\n\" + fullText.substring(0, safeHeadEnd) + \"\\n\\n\";\n\n    // 2. KH√öC GI·ªÆA\n    const midPoint = Math.floor(totalLen / 2);\n    // T√¨m ƒëi·ªÉm b·∫Øt ƒë·∫ßu an to√†n (sau d·∫•u ph·∫©y/ch·∫•m)\n    const safeMidStart = findSafeCutForward(fullText, midPoint);\n    // T√¨m ƒëi·ªÉm k·∫øt th√∫c an to√†n\n    const safeMidEnd = findSafeCutBackwards(fullText, safeMidStart + MID_SIZE);\n    \n    combinedSample += \"--- [PH·∫¶N GI·ªÆA TRUY·ªÜN] ---\\n... \" + fullText.substring(safeMidStart, safeMidEnd) + \" ...\\n\\n\";\n\n    // 3. KH√öC CU·ªêI\n    const startTail = totalLen - TAIL_SIZE;\n    // T√¨m ƒëi·ªÉm b·∫Øt ƒë·∫ßu an to√†n\n    const safeTailStart = findSafeCutForward(fullText, startTail);\n    \n    combinedSample += \"--- [PH·∫¶N K·∫æT TH√öC] ---\\n... \" + fullText.substring(safeTailStart, totalLen);\n}\n\nreturn [{\n    json: {\n        sample_text: combinedSample,\n        total_length: totalLen\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -448,
        -48
      ],
      "id": "48d4d52a-7963-4e62-8d8d-49ce8a010410",
      "name": "L·∫•y m·∫´u"
    },
    {
      "parameters": {
        "fileSelector": "={{ $json.path.replace(/\\\\/g, '/') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [
        -768,
        -48
      ],
      "id": "77b763f8-5960-4828-9291-607ad072e502",
      "name": "ƒê·ªçc n·ªôi dung"
    },
    {
      "parameters": {
        "jsCode": "// L·∫•y k·∫øt qu·∫£ t·ª´ AI (S·ª≠a ƒë·ªÉ nh·∫≠n t·ª´ HTTP Request)\nconst response = $input.first().json.message;\nconst aiText = response ? response.content : \"\";\nconst genre = aiText.trim().toUpperCase();\n\n// KHO T√ÄNG KH·∫®U QUY·∫æT\nconst prompts = {\n  \"KIEMHIEP\": \"B·∫°n l√† d·ªãch gi·∫£ ki·∫øm hi·ªáp l√£o luy·ªán. D√πng t·ª´ H√°n Vi·ªát (huynh, ƒë·ªá, t·∫°i h·∫°...), vƒÉn phong h√†o h√πng, c·ªï trang. Chi√™u th·ª©c gi·ªØ nguy√™n √¢m H√°n Vi·ªát.\",\n  \"NGONTINH\": \"B·∫°n l√† d·ªãch gi·∫£ ng√¥n t√¨nh. VƒÉn phong l√£ng m·∫°n, nh·∫π nh√†ng, ∆∞·ªõt √°t. X∆∞ng h√¥ Anh - Em ho·∫∑c Ch√†ng - N√†ng t√πy ng·ªØ c·∫£nh.\",\n  \"KINHDOANH\": \"B·∫°n l√† chuy√™n gia kinh t·∫ø. D·ªãch vƒÉn phong trang tr·ªçng, chuy√™n nghi·ªáp, d√πng thu·∫≠t ng·ªØ ch√≠nh x√°c.\",\n  \"KHAC\": \"B·∫°n l√† m·ªôt d·ªãch gi·∫£ chuy√™n nghi·ªáp. H√£y d·ªãch tr√¥i ch·∫£y, t·ª± nhi√™n, s√°t nghƒ©a g·ªëc.\"\n};\n\n// Ch·ªçn prompt\nconst selectedPrompt = prompts[genre] || prompts[\"KHAC\"];\n\nreturn [{\n  json: {\n    system_prompt: selectedPrompt,\n    detected_genre: genre\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        64,
        -48
      ],
      "id": "a9171907-6dca-4134-9333-5469b06faf1b",
      "name": "Quy·∫øt ƒë·ªãnh th·ªÉ lo·∫°i vƒÉn phong"
    },
    {
      "parameters": {
        "jsCode": "// L·∫•y d·ªØ li·ªáu t·ª´ node ƒê·ªçc n·ªôi dung\nconst binaryData = items[0].binary.data;\nconst fullText = Buffer.from(binaryData.data, 'base64').toString('utf-8');\n\n// --- C·∫§U H√åNH ---\nconst TARGET_CHUNK_SIZE = 1000; // ƒê·ªô d√†i mong mu·ªën\n// ----------------\n\nconst chunks = [];\nlet currentPos = 0;\n\nwhile (currentPos < fullText.length) {\n  let endPos = currentPos + TARGET_CHUNK_SIZE;\n\n  // N·∫øu ƒëo·∫°n c√≤n l·∫°i ng·∫Øn h∆°n target th√¨ l·∫•y n·ªët\n  if (endPos >= fullText.length) {\n    endPos = fullText.length;\n  } else {\n    // --- THU·∫¨T TO√ÅN T√åM ƒêI·ªÇM C·∫ÆT AN TO√ÄN (SMART SPLIT) ---\n    // Thay v√¨ c·∫Øt b·ª´a, ta s·∫Ω l√πi l·∫°i ƒë·ªÉ t√¨m d·∫•u ch·∫•m c√¢u.\n    // M·ª•c ti√™u: Kh√¥ng bao gi·ªù c·∫Øt gi·ªØa ch·ª´ng m·ªôt c√¢u.\n    \n    let safeSpot = -1;\n    // Ch·ªâ l√πi t·ªëi ƒëa 300 k√Ω t·ª± ƒë·ªÉ t√¨m d·∫•u ch·∫•m, n·∫øu c√¢u qu√° d√†i th√¨ ƒë√†nh ch·ªãu\n    const lookBackLimit = 300; \n    \n    // Qu√©t ng∆∞·ª£c t·ª´ ƒëi·ªÉm c·∫Øt d·ª± ki·∫øn v·ªÅ ph√≠a tr∆∞·ªõc\n    for (let i = 0; i < lookBackLimit; i++) {\n      const checkPos = endPos - i;\n      const char = fullText[checkPos];\n      \n      // CH·ªà C·∫ÆT KHI G·∫∂P: D·∫•u ch·∫•m (.), Xu·ªëng d√≤ng (\\n), Ch·∫•m than (!), H·ªèi ch·∫•m (?)\n      // Tuy·ªát ƒë·ªëi KH√îNG c·∫Øt ·ªü d·∫•u c√°ch (' ')\n      if (char === '.' || char === '\\n' || char === '!' || char === '?' || char === '‚Äù' || char === '\"') {\n        safeSpot = checkPos + 1; // +1 ƒë·ªÉ l·∫•y lu√¥n c·∫£ d·∫•u c√¢u ƒë√≥\n        break;\n      }\n    }\n\n    // N·∫øu t√¨m th·∫•y d·∫•u ch·∫•m th√¨ c·∫Øt t·∫°i ƒë√≥\n    if (safeSpot !== -1) {\n      endPos = safeSpot;\n    } \n    // N·∫øu ƒëen ƒë·ªßi c√¢u vƒÉn d√†i qu√° 1300 ch·ªØ kh√¥ng c√≥ d·∫•u ch·∫•m n√†o (hi·∫øm)\n    // Th√¨ bu·ªôc ph·∫£i c·∫Øt t·∫°i d·∫•u c√°ch g·∫ßn nh·∫•t ƒë·ªÉ ƒë·ª° g√£y t·ª´\n    else {\n       for (let i = 0; i < 100; i++) {\n          if (fullText[endPos - i] === ' ') {\n             endPos = endPos - i;\n             break;\n          }\n       }\n    }\n  }\n\n  const chunkText = fullText.substring(currentPos, endPos).trim();\n  \n  if (chunkText.length > 0) {\n    chunks.push({\n      json: { \n          chunk_text: chunkText, \n          index: chunks.length\n      }\n    });\n  }\n  \n  // ƒê·∫∑t con tr·ªè b·∫Øt ƒë·∫ßu cho ƒëo·∫°n ti·∫øp theo\n  currentPos = endPos;\n}\n\nreturn chunks;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        -352
      ],
      "id": "583b50ef-f930-42ca-b032-2b17abd1ff62",
      "name": "Chia nh·ªè"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b0deff51-4a69-4b85-a0c1-777620d596e5",
              "leftValue": "={{ $json.path }}",
              "rightValue": ".txt",
              "operator": {
                "type": "string",
                "operation": "endsWith"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1296,
        -32
      ],
      "id": "eb8306f6-8b73-45ed-9187-21b9e5ce9039",
      "name": "Ki·ªÉm tra ƒëu√¥i"
    },
    {
      "parameters": {
        "jsCode": "// L·∫•y ƒë∆∞·ªùng d·∫´n g·ªëc t·ª´ node Trigger (ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng b·ªã m·∫•t d·ªØ li·ªáu)\n// L∆∞u √Ω: ƒê·∫£m b·∫£o t√™n node trigger c·ªßa b·∫°n ƒë√∫ng l√† 'Local File Trigger'\nconst oldPath = $('Local File Trigger').first().json.path;\n\n// T·∫°o ƒë∆∞·ªùng d·∫´n m·ªõi (Pandoc s·∫Ω th√™m ƒëu√¥i .txt v√†o file g·ªëc)\nconst newPath = oldPath + \".txt\";\n\nreturn [{\n    json: {\n        path: newPath\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -928,
        208
      ],
      "id": "e88191d3-d4c2-4c28-9afa-49d4c30c1df1",
      "name": "ƒê·ªïi ƒë·ªãa ch·ªâ file"
    },
    {
      "parameters": {
        "command": "=pandoc \"{{ $json.path }}\" -t plain -o \"{{ $json.path }}.txt\""
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        -1120,
        208
      ],
      "id": "2ed3532b-f66c-4b5b-9762-d37d35d193d3",
      "name": "ƒê·ªïi ƒëu√¥i file"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        368,
        -64
      ],
      "id": "973820ae-9bc7-4c36-9a5b-8d32e8c10fa3",
      "name": "K·∫øt h·ª£p vƒÉn phong v√† n·ªôi dung"
    },
    {
      "parameters": {
        "jsCode": "// B∆Ø·ªöC 1: L·∫•y d·ªØ li·ªáu t·ª´ node D·ªãch\nconst items = $('D·ªãch').all(); \n\n// B∆Ø·ªöC 2: S·∫Øp x·∫øp\nitems.sort((a, b) => {\n    const indexA = a.json.index || 0;\n    const indexB = b.json.index || 0;\n    return indexA - indexB;\n});\n\nlet fullBook = \"\";\n\n// B∆Ø·ªöC 3: Gh√©p n·ªëi (QUAN TR·ªåNG: S·ª≠a ƒë∆∞·ªùng d·∫´n l·∫•y content)\nfor (const item of items) {\n    // API Ollama tr·∫£ v·ªÅ n·ªôi dung trong json.message.content\n    const content = item.json.message ? item.json.message.content : \"\";\n    \n    if (content) {\n        fullBook += content + \"\\n\\n\"; \n    }\n}\n\nreturn [{\n    json: {\n        translated_content: fullBook\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1264,
        -80
      ],
      "id": "21c9d92e-c31a-4c53-a7c5-c1b9e6d6dc26",
      "name": "Gh√©p l·∫°i"
    },
    {
      "parameters": {
        "operation": "write",
        "fileName": "=D:/N8n_book_translator/Output/{{ $('Local File Trigger').first().json.path.split('\\\\').pop().split('/').pop().replace(/\\.[^/.]+$/, \"\") }}_translated.txt",
        "options": {}
      },
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [
        1664,
        -80
      ],
      "id": "f677d721-a83c-4973-a8c3-0569093f5a5f",
      "name": "L∆∞u file"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        608,
        -64
      ],
      "id": "b37c6961-b3c0-4ae3-ac17-249a60976f52",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        768,
        96
      ],
      "id": "790d9356-b7c4-4625-8f7a-d378fa6d3cc8",
      "name": "Wait",
      "webhookId": "ddbd6049-9ba6-4025-ad29-11e03d1a5905"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://127.0.0.1:11434/api/chat",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\n  {\n    \"model\": \"qwen3:14b\",\n    \"messages\": [\n      {\n        \"role\": \"user\",\n        \"content\": \"B·∫°n l√† m·ªôt tr·ª£ l√Ω ph√¢n lo·∫°i vƒÉn h·ªçc.\\nH√£y ƒë·ªçc ƒëo·∫°n vƒÉn b·∫£n m·∫´u d∆∞·ªõi ƒë√¢y v√† x√°c ƒë·ªãnh th·ªÉ lo·∫°i ch√≠nh c·ªßa n√≥.\\nCh·ªâ tr·∫£ v·ªÅ DUY NH·∫§T m·ªôt t·ª´ kh√≥a trong danh s√°ch sau: [KIEMHIEP, NGONTINH, KINHDOANH, KHOAHOC, KHAC].\\nTuy·ªát ƒë·ªëi kh√¥ng gi·∫£i th√≠ch g√¨ th√™m.\\n\\nVƒÉn b·∫£n m·∫´u:\\n\" + $('L·∫•y m·∫´u').first().json.sample_text\n      }\n    ],\n    \"stream\": false\n  }\n}}",
        "options": {
          "timeout": 28800000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -96,
        -48
      ],
      "id": "43470632-97f2-40d0-8093-2085974f12ff",
      "name": "X√°c ƒë·ªãnh th·ªÉ lo·∫°i"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://127.0.0.1:11434/api/chat",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\n  (\n    {\n      \"model\": \"qwen3:14b\",\n      \"messages\": [\n        {\n          \"role\": \"system\",\n          // PH·∫¶N 1: G·ªåI SYSTEM PROMPT T·ª™ NODE QUY·∫æT ƒê·ªäNH\n          \"content\": $('Quy·∫øt ƒë·ªãnh th·ªÉ lo·∫°i vƒÉn phong').first().json.system_prompt + \n          \n          // PH·∫¶N 2: CH√àN T·ª™ ƒêI·ªÇN T·ª™ NODE T·∫†O T·ª™ ƒêI·ªÇN\n          \"\\n\\n### B·∫ÆT BU·ªòC TU√ÇN TH·ª¶ T·ª™ ƒêI·ªÇN (GLOSSARY):\\n\" + \n          $('T·∫°o t·ª´ ƒëi·ªÉn').first().json.message.content +\n\n          // PH·∫¶N 3: L·ªÜNH TƒÇNG C∆Ø·ªúNG (ƒê·ªÉ d·ªãch k·ªπ nh·∫•t)\n          \"\\n\\n### Y√äU C·∫¶U D·ªäCH THU·∫¨T N√ÇNG CAO:\\n\" +\n          \"1. D·ªãch CHI TI·∫æT t·ª´ng c√¢u, tuy·ªát ƒë·ªëi KH√îNG ƒë∆∞·ª£c t√≥m t·∫Øt hay b·ªè s√≥t √Ω.\\n\" +\n          \"2. Gi·ªØ nguy√™n s·∫Øc th√°i bi·ªÉu c·∫£m, c√°c th√°n t·ª´, m√¥ t·∫£ n·ªôi t√¢m c·ªßa nh√¢n v·∫≠t.\\n\" +\n          \"3. N·∫øu g·∫∑p th∆° ca ho·∫∑c c√¢u ƒë·ªëi, h√£y d·ªãch sao cho v·∫ßn ƒëi·ªáu ho·∫∑c gi·ªØ nguy√™n H√°n Vi·ªát n·∫øu c·∫ßn.\\n\" +\n          \"4. VƒÉn phong ph·∫£i tr√¥i ch·∫£y, t·ª± nhi√™n nh∆∞ ng∆∞·ªùi b·∫£n x·ª© vi·∫øt.\"\n        },\n        {\n          \"role\": \"user\",\n          \"content\": \"D·ªãch ƒëo·∫°n vƒÉn b·∫£n sau sang ti·∫øng Vi·ªát:\\n\\n\" + $json.chunk_text\n        }\n      ],\n      \"stream\": false,\n      \"options\": {\n         \"timeout\": 28800000 // 8 ti·∫øng\n      }\n    }\n  )\n}}",
        "options": {
          "timeout": 28800000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        960,
        96
      ],
      "id": "7191d7da-3142-4885-8451-01ea38c75332",
      "name": "D·ªãch"
    },
    {
      "parameters": {
        "jsCode": "// 1. L·∫•y n·ªôi dung truy·ªán t·ª´ node tr∆∞·ªõc\n// (N·∫øu node tr∆∞·ªõc t√™n kh√°c \"Gh√©p l·∫°i\" th√¨ s·ª≠a trong d·∫•u ngo·∫∑c, nh∆∞ng th∆∞·ªùng l√† t·ª± nh·∫≠n)\nconst textContent = $input.first().json.translated_content;\n\n// 2. M√£ h√≥a n·ªôi dung th√†nh d·∫°ng file (Binary Base64)\nconst binaryData = Buffer.from(textContent, 'utf8').toString('base64');\n\n// 3. Tr·∫£ v·ªÅ ƒë√∫ng ƒë·ªãnh d·∫°ng ƒë·ªÉ node L∆∞u File hi·ªÉu\nreturn [\n  {\n    json: {\n        success: true // B√°o th√†nh c√¥ng\n    },\n    binary: {\n      data: { // T√™n bi·∫øn file l√† \"data\"\n        data: binaryData,\n        mimeType: 'text/plain',\n        fileExtension: 'txt',\n        fileName: 'truyen_dich.txt'\n      }\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1472,
        -80
      ],
      "id": "047f10d8-47eb-418e-9946-3351ef575732",
      "name": "Chuy·ªÉn d·∫°ng file"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://127.0.0.1:11434/api/chat",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\n  {\n    \"model\": \"qwen3:14b\",\n    \"messages\": [\n      {\n        \"role\": \"user\",\n        \"content\": \"H√£y ph√¢n t√≠ch ƒëo·∫°n vƒÉn sau v√† li·ªát k√™ c√°c T√™n Ri√™ng (Nh√¢n v·∫≠t, ƒê·ªãa danh, M√¥n ph√°i, Chi√™u th·ª©c) quan tr·ªçng nh·∫•t ƒë·ªÉ l√†m T·ª´ ƒêi·ªÉn d·ªãch thu·∫≠t.\\n\\nƒê·ªãnh d·∫°ng tr·∫£ v·ªÅ: Ch·ªâ li·ªát k√™ d·∫°ng text, m·ªói t·ª´ m·ªôt d√≤ng: T√™n G·ªëc - T√™n H√°n Vi·ªát.\\nV√≠ d·ª•:\\nLi Feng - L√Ω Phong\\nAzure Dragon - Thanh Long\\n\\nTuy·ªát ƒë·ªëi kh√¥ng gi·∫£i th√≠ch g√¨ th√™m.\\n\\nN·ªôi dung:\\n\" + $('L·∫•y m·∫´u').first().json.sample_text\n      }\n    ],\n    \"stream\": false,\n    \"options\": {\n       \"num_predict\": 3000\n    }\n  }\n}}",
        "options": {
          "timeout": 3600000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -272,
        -48
      ],
      "id": "504ac9c1-df37-4c8d-aa28-4efd1496310e",
      "name": "T·∫°o t·ª´ ƒëi·ªÉn"
    }
  ],
  "pinData": {},
  "connections": {
    "Local File Trigger": {
      "main": [
        [
          {
            "node": "Ki·ªÉm tra ƒëu√¥i",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "L·∫•y m·∫´u": {
      "main": [
        [
          {
            "node": "T·∫°o t·ª´ ƒëi·ªÉn",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ƒê·ªçc n·ªôi dung": {
      "main": [
        [
          {
            "node": "L·∫•y m·∫´u",
            "type": "main",
            "index": 0
          },
          {
            "node": "Chia nh·ªè",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chia nh·ªè": {
      "main": [
        [
          {
            "node": "K·∫øt h·ª£p vƒÉn phong v√† n·ªôi dung",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ki·ªÉm tra ƒëu√¥i": {
      "main": [
        [
          {
            "node": "ƒê·ªçc n·ªôi dung",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ƒê·ªïi ƒëu√¥i file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ƒê·ªïi ƒë·ªãa ch·ªâ file": {
      "main": [
        [
          {
            "node": "ƒê·ªçc n·ªôi dung",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ƒê·ªïi ƒëu√¥i file": {
      "main": [
        [
          {
            "node": "ƒê·ªïi ƒë·ªãa ch·ªâ file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Quy·∫øt ƒë·ªãnh th·ªÉ lo·∫°i vƒÉn phong": {
      "main": [
        [
          {
            "node": "K·∫øt h·ª£p vƒÉn phong v√† n·ªôi dung",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "K·∫øt h·ª£p vƒÉn phong v√† n·ªôi dung": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gh√©p l·∫°i": {
      "main": [
        [
          {
            "node": "Chuy·ªÉn d·∫°ng file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "L∆∞u file": {
      "main": [
        []
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Gh√©p l·∫°i",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "D·ªãch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "X√°c ƒë·ªãnh th·ªÉ lo·∫°i": {
      "main": [
        [
          {
            "node": "Quy·∫øt ƒë·ªãnh th·ªÉ lo·∫°i vƒÉn phong",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "D·ªãch": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chuy·ªÉn d·∫°ng file": {
      "main": [
        [
          {
            "node": "L∆∞u file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "T·∫°o t·ª´ ƒëi·ªÉn": {
      "main": [
        [
          {
            "node": "X√°c ƒë·ªãnh th·ªÉ lo·∫°i",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "versionId": "d5978edf-b616-4289-8936-c1292d3bd3bb",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "50a355daa6e8e5d372113cb0763e3abcc694788f9449017d8c65b1c09f570d45"
  },
  "id": "WNz4Q1pp8QUXh5Sz",
  "tags": []
}
</file>

<file path="flutter_assets/FontManifest.json">
[{"family":"MaterialIcons","fonts":[{"asset":"fonts/MaterialIcons-Regular.otf"}]},{"family":"packages/font_awesome_flutter/FontAwesomeBrands","fonts":[{"weight":400,"asset":"packages/font_awesome_flutter/lib/fonts/Font-Awesome-7-Brands-Regular-400.otf"}]},{"family":"packages/font_awesome_flutter/FontAwesomeRegular","fonts":[{"weight":400,"asset":"packages/font_awesome_flutter/lib/fonts/Font-Awesome-7-Free-Regular-400.otf"}]},{"family":"packages/font_awesome_flutter/FontAwesomeSolid","fonts":[{"weight":900,"asset":"packages/font_awesome_flutter/lib/fonts/Font-Awesome-7-Free-Solid-900.otf"}]}]
</file>

<file path="flutter_assets/NativeAssetsManifest.json">
{"format-version":[1,0,0],"native-assets":{}}
</file>

<file path="lib/ui/screens/dev_logs_screen.dart">
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:font_awesome_flutter/font_awesome_flutter.dart';
import 'package:flutter_animate/flutter_animate.dart';
import '../theme/app_theme.dart';
import '../../services/dev_logger.dart';

class DevLogsScreen extends StatefulWidget {
  final bool isDark;

  const DevLogsScreen({super.key, required this.isDark});

  @override
  State<DevLogsScreen> createState() => _DevLogsScreenState();
}

class _DevLogsScreenState extends State<DevLogsScreen> {
  final DevLogger _logger = DevLogger();
  final TextEditingController _searchController = TextEditingController();
  final ScrollController _scrollController = ScrollController();

  LogLevel? _selectedLevel;
  String _searchQuery = '';
  bool _autoScroll = true;
  String? _expandedLogId;

  @override
  void initState() {
    super.initState();
    _logger.addListener(_onLogsChanged);
  }

  @override
  void dispose() {
    _logger.removeListener(_onLogsChanged);
    _searchController.dispose();
    _scrollController.dispose();
    super.dispose();
  }

  void _onLogsChanged() {
    if (mounted) {
      setState(() {});
      if (_autoScroll && _scrollController.hasClients) {
        _scrollController.animateTo(
          0,
          duration: const Duration(milliseconds: 200),
          curve: Curves.easeOut,
        );
      }
    }
  }

  List<LogEntry> get _filteredLogs {
    List<LogEntry> logs = _logger.logs;

    if (_selectedLevel != null) {
      logs = logs.where((log) => log.level == _selectedLevel).toList();
    }

    if (_searchQuery.isNotEmpty) {
      logs = logs
          .where((log) =>
              log.message.toLowerCase().contains(_searchQuery.toLowerCase()) ||
              log.category.toLowerCase().contains(_searchQuery.toLowerCase()) ||
              (log.details
                      ?.toLowerCase()
                      .contains(_searchQuery.toLowerCase()) ??
                  false))
          .toList();
    }

    return logs;
  }

  Color _getLevelColor(LogLevel level) {
    switch (level) {
      case LogLevel.debug:
        return Colors.grey;
      case LogLevel.info:
        return Colors.blue;
      case LogLevel.warning:
        return Colors.orange;
      case LogLevel.error:
        return Colors.red;
      case LogLevel.request:
        return Colors.purple;
      case LogLevel.response:
        return Colors.teal;
    }
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(32),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Row(
            children: [
              Text(
                'Dev Logs',
                style: GoogleFonts.merriweather(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: widget.isDark ? Colors.white : AppColors.lightPrimary,
                ),
              ),
              const SizedBox(width: 16),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                decoration: BoxDecoration(
                  color: Colors.orange.withOpacity(0.2),
                  borderRadius: BorderRadius.circular(4),
                  border: Border.all(color: Colors.orange.withOpacity(0.5)),
                ),
                child: Text(
                  'DEV ONLY',
                  style: TextStyle(
                    fontSize: 10,
                    fontWeight: FontWeight.bold,
                    color: Colors.orange,
                  ),
                ),
              ),
              const Spacer(),
              // Log count
              Text(
                '${_filteredLogs.length} / ${_logger.logs.length} logs',
                style: TextStyle(
                  fontSize: 12,
                  color: widget.isDark ? Colors.grey[400] : Colors.grey[600],
                ),
              ),
            ],
          ),

          const SizedBox(height: 24),

          // Controls Row
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: widget.isDark ? AppColors.darkSurface : Colors.white,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(
                color: widget.isDark
                    ? AppColors.darkBorder
                    : AppColors.lightBorder,
              ),
            ),
            child: Column(
              children: [
                // Search and Filter Row
                Row(
                  children: [
                    // Search Box
                    Expanded(
                      flex: 2,
                      child: TextField(
                        controller: _searchController,
                        style: TextStyle(
                          fontSize: 14,
                          color: widget.isDark ? Colors.white : Colors.black,
                        ),
                        decoration: InputDecoration(
                          hintText: 'T√¨m ki·∫øm logs...',
                          hintStyle: TextStyle(
                            color: widget.isDark
                                ? Colors.grey[600]
                                : Colors.grey[400],
                          ),
                          prefixIcon: Icon(
                            Icons.search,
                            size: 18,
                            color: widget.isDark
                                ? Colors.grey[400]
                                : Colors.grey[600],
                          ),
                          contentPadding: const EdgeInsets.symmetric(
                              horizontal: 12, vertical: 10),
                          filled: true,
                          fillColor: widget.isDark
                              ? Colors.black.withOpacity(0.2)
                              : AppColors.lightPaper,
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(6),
                            borderSide: BorderSide.none,
                          ),
                        ),
                        onChanged: (value) {
                          setState(() => _searchQuery = value);
                        },
                      ),
                    ),
                    const SizedBox(width: 12),

                    // Level Filter Dropdown
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 12),
                      decoration: BoxDecoration(
                        color: widget.isDark
                            ? Colors.black.withOpacity(0.2)
                            : AppColors.lightPaper,
                        borderRadius: BorderRadius.circular(6),
                      ),
                      child: DropdownButtonHideUnderline(
                        child: DropdownButton<LogLevel?>(
                          value: _selectedLevel,
                          hint: Text(
                            'T·∫•t c·∫£ levels',
                            style: TextStyle(
                              fontSize: 14,
                              color: widget.isDark
                                  ? Colors.grey[400]
                                  : Colors.grey[600],
                            ),
                          ),
                          dropdownColor: widget.isDark
                              ? AppColors.darkSurface
                              : Colors.white,
                          items: [
                            DropdownMenuItem<LogLevel?>(
                              value: null,
                              child: Text(
                                'T·∫•t c·∫£ levels',
                                style: TextStyle(
                                  fontSize: 14,
                                  color: widget.isDark
                                      ? Colors.white
                                      : Colors.black,
                                ),
                              ),
                            ),
                            ...LogLevel.values.map((level) => DropdownMenuItem(
                                  value: level,
                                  child: Row(
                                    children: [
                                      Container(
                                        width: 8,
                                        height: 8,
                                        decoration: BoxDecoration(
                                          color: _getLevelColor(level),
                                          shape: BoxShape.circle,
                                        ),
                                      ),
                                      const SizedBox(width: 8),
                                      Text(
                                        level.name.toUpperCase(),
                                        style: TextStyle(
                                          fontSize: 14,
                                          color: widget.isDark
                                              ? Colors.white
                                              : Colors.black,
                                        ),
                                      ),
                                    ],
                                  ),
                                )),
                          ],
                          onChanged: (value) {
                            setState(() => _selectedLevel = value);
                          },
                        ),
                      ),
                    ),
                  ],
                ),

                const SizedBox(height: 12),

                // Action Buttons Row
                Row(
                  children: [
                    // Auto-scroll toggle
                    _ActionButton(
                      icon: _autoScroll
                          ? FontAwesomeIcons.lock
                          : FontAwesomeIcons.lockOpen,
                      label: _autoScroll ? 'Auto-scroll ON' : 'Auto-scroll OFF',
                      isActive: _autoScroll,
                      isDark: widget.isDark,
                      onTap: () => setState(() => _autoScroll = !_autoScroll),
                    ),
                    const SizedBox(width: 8),

                    // Toggle logging
                    _ActionButton(
                      icon: _logger.isEnabled
                          ? FontAwesomeIcons.play
                          : FontAwesomeIcons.pause,
                      label: _logger.isEnabled ? 'Logging ON' : 'Logging OFF',
                      isActive: _logger.isEnabled,
                      isDark: widget.isDark,
                      onTap: () {
                        _logger.setEnabled(!_logger.isEnabled);
                        setState(() {});
                      },
                    ),

                    const Spacer(),

                    // Copy all logs
                    _ActionButton(
                      icon: FontAwesomeIcons.copy,
                      label: 'Copy All',
                      isDark: widget.isDark,
                      onTap: () => _copyAllLogs(),
                    ),
                    const SizedBox(width: 8),

                    // Clear logs
                    _ActionButton(
                      icon: FontAwesomeIcons.trash,
                      label: 'Clear',
                      isDark: widget.isDark,
                      isDestructive: true,
                      onTap: () {
                        _logger.clear();
                        setState(() {});
                      },
                    ),
                  ],
                ),
              ],
            ),
          ),

          const SizedBox(height: 16),

          // Logs List
          Expanded(
            child: Container(
              decoration: BoxDecoration(
                color: widget.isDark
                    ? const Color(0xFF1E1E1E)
                    : const Color(0xFFF5F5F5),
                borderRadius: BorderRadius.circular(12),
                border: Border.all(
                  color: widget.isDark
                      ? AppColors.darkBorder
                      : AppColors.lightBorder,
                ),
              ),
              child: _filteredLogs.isEmpty
                  ? Center(
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          FaIcon(
                            FontAwesomeIcons.scroll,
                            size: 48,
                            color: widget.isDark
                                ? Colors.grey[700]
                                : Colors.grey[400],
                          ),
                          const SizedBox(height: 16),
                          Text(
                            _logger.logs.isEmpty
                                ? 'Ch∆∞a c√≥ logs n√†o'
                                : 'Kh√¥ng t√¨m th·∫•y logs ph√π h·ª£p',
                            style: TextStyle(
                              fontSize: 16,
                              color: widget.isDark
                                  ? Colors.grey[500]
                                  : Colors.grey[600],
                            ),
                          ),
                        ],
                      ),
                    )
                  : ListView.builder(
                      controller: _scrollController,
                      itemCount: _filteredLogs.length,
                      padding: const EdgeInsets.all(8),
                      itemBuilder: (context, index) {
                        final log = _filteredLogs[index];
                        final logId = '${log.timestamp.microsecondsSinceEpoch}';
                        final isExpanded = _expandedLogId == logId;

                        return _LogEntryCard(
                          log: log,
                          isDark: widget.isDark,
                          isExpanded: isExpanded,
                          levelColor: _getLevelColor(log.level),
                          onTap: () {
                            setState(() {
                              _expandedLogId = isExpanded ? null : logId;
                            });
                          },
                          onCopy: () => _copyLog(log),
                        );
                      },
                    ),
            ),
          ),
        ],
      ),
    ).animate().fadeIn();
  }

  void _copyLog(LogEntry log) {
    final text = '''
[${log.timestamp.toString()}] [${log.levelName}] [${log.category}]
${log.message}
${log.details != null ? '\nDetails:\n${log.details}' : ''}
'''
        .trim();

    Clipboard.setData(ClipboardData(text: text));
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: const Text('ƒê√£ copy log!'),
        behavior: SnackBarBehavior.floating,
        duration: const Duration(seconds: 1),
      ),
    );
  }

  void _copyAllLogs() {
    final buffer = StringBuffer();
    for (final log in _filteredLogs) {
      buffer.writeln(
          '[${log.timestamp.toString()}] [${log.levelName}] [${log.category}] ${log.message}');
      if (log.details != null) {
        buffer.writeln('  Details: ${log.details}');
      }
      buffer.writeln();
    }

    Clipboard.setData(ClipboardData(text: buffer.toString()));
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text('ƒê√£ copy ${_filteredLogs.length} logs!'),
        behavior: SnackBarBehavior.floating,
        duration: const Duration(seconds: 1),
      ),
    );
  }
}

class _ActionButton extends StatelessWidget {
  final IconData icon;
  final String label;
  final bool isDark;
  final bool isActive;
  final bool isDestructive;
  final VoidCallback onTap;

  const _ActionButton({
    required this.icon,
    required this.label,
    required this.isDark,
    this.isActive = false,
    this.isDestructive = false,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    final color = isDestructive
        ? Colors.red
        : isActive
            ? Colors.green
            : (isDark ? Colors.grey[400] : Colors.grey[600]);

    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(6),
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
        decoration: BoxDecoration(
          color: isDark
              ? Colors.black.withOpacity(0.2)
              : Colors.grey.withOpacity(0.1),
          borderRadius: BorderRadius.circular(6),
          border: Border.all(
            color: color!.withOpacity(0.3),
          ),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            FaIcon(icon, size: 12, color: color),
            const SizedBox(width: 6),
            Text(
              label,
              style: TextStyle(fontSize: 12, color: color),
            ),
          ],
        ),
      ),
    );
  }
}

class _LogEntryCard extends StatelessWidget {
  final LogEntry log;
  final bool isDark;
  final bool isExpanded;
  final Color levelColor;
  final VoidCallback onTap;
  final VoidCallback onCopy;

  const _LogEntryCard({
    required this.log,
    required this.isDark,
    required this.isExpanded,
    required this.levelColor,
    required this.onTap,
    required this.onCopy,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: const EdgeInsets.only(bottom: 4),
      decoration: BoxDecoration(
        color: isDark ? const Color(0xFF252526) : Colors.white,
        borderRadius: BorderRadius.circular(6),
        border: Border.all(
          color: isExpanded
              ? levelColor.withOpacity(0.5)
              : (isDark
                  ? const Color(0xFF3C3C3C)
                  : Colors.grey.withOpacity(0.2)),
        ),
      ),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(6),
        child: Padding(
          padding: const EdgeInsets.all(10),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Header Row
              Row(
                children: [
                  // Level Badge
                  Container(
                    padding:
                        const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                    decoration: BoxDecoration(
                      color: levelColor.withOpacity(0.2),
                      borderRadius: BorderRadius.circular(4),
                    ),
                    child: Text(
                      log.levelName,
                      style: TextStyle(
                        fontSize: 10,
                        fontWeight: FontWeight.bold,
                        fontFamily: 'Consolas',
                        color: levelColor,
                      ),
                    ),
                  ),
                  const SizedBox(width: 8),

                  // Category
                  Container(
                    padding:
                        const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                    decoration: BoxDecoration(
                      color: isDark
                          ? Colors.blue.withOpacity(0.1)
                          : Colors.blue.withOpacity(0.1),
                      borderRadius: BorderRadius.circular(4),
                    ),
                    child: Text(
                      log.category,
                      style: TextStyle(
                        fontSize: 10,
                        fontFamily: 'Consolas',
                        color: isDark ? Colors.blue[300] : Colors.blue[700],
                      ),
                    ),
                  ),

                  const Spacer(),

                  // Timestamp
                  Text(
                    _formatTimestamp(log.timestamp),
                    style: TextStyle(
                      fontSize: 10,
                      fontFamily: 'Consolas',
                      color: isDark ? Colors.grey[500] : Colors.grey[600],
                    ),
                  ),

                  if (log.details != null) ...[
                    const SizedBox(width: 8),
                    FaIcon(
                      isExpanded
                          ? FontAwesomeIcons.chevronUp
                          : FontAwesomeIcons.chevronDown,
                      size: 10,
                      color: isDark ? Colors.grey[500] : Colors.grey[600],
                    ),
                  ],
                ],
              ),

              const SizedBox(height: 6),

              // Message
              SelectableText(
                log.message,
                style: TextStyle(
                  fontSize: 12,
                  fontFamily: 'Consolas',
                  color: isDark ? Colors.grey[300] : Colors.grey[800],
                ),
              ),

              // Expanded Details
              if (isExpanded && log.details != null) ...[
                const SizedBox(height: 8),
                Container(
                  width: double.infinity,
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: isDark
                        ? Colors.black.withOpacity(0.3)
                        : Colors.grey.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(4),
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text(
                            'Details',
                            style: TextStyle(
                              fontSize: 10,
                              fontWeight: FontWeight.bold,
                              color:
                                  isDark ? Colors.grey[400] : Colors.grey[600],
                            ),
                          ),
                          InkWell(
                            onTap: onCopy,
                            child: Padding(
                              padding: const EdgeInsets.all(4),
                              child: FaIcon(
                                FontAwesomeIcons.copy,
                                size: 12,
                                color: isDark
                                    ? Colors.grey[400]
                                    : Colors.grey[600],
                              ),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 8),
                      SelectableText(
                        log.details!,
                        style: TextStyle(
                          fontSize: 11,
                          fontFamily: 'Consolas',
                          color: isDark ? Colors.grey[400] : Colors.grey[700],
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ],
          ),
        ),
      ),
    );
  }

  String _formatTimestamp(DateTime timestamp) {
    return '${timestamp.hour.toString().padLeft(2, '0')}:'
        '${timestamp.minute.toString().padLeft(2, '0')}:'
        '${timestamp.second.toString().padLeft(2, '0')}.'
        '${timestamp.millisecond.toString().padLeft(3, '0')}';
  }
}
</file>

<file path="lib/ui/widgets/ollama_connection_dialog.dart">
import 'package:flutter/material.dart';
import 'package:font_awesome_flutter/font_awesome_flutter.dart';
import '../theme/app_theme.dart';
import '../../utils/app_strings.dart';

/// A user-friendly dialog shown when the app cannot connect to Ollama.
/// Matches the app's design language with rounded corners and soft colors.
class OllamaConnectionDialog extends StatelessWidget {
  final bool isDark;
  final String lang;

  const OllamaConnectionDialog({
    super.key,
    required this.isDark,
    required this.lang,
  });

  @override
  Widget build(BuildContext context) {
    return Dialog(
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
      ),
      backgroundColor: isDark ? AppColors.darkSurface : Colors.white,
      child: Container(
        constraints: const BoxConstraints(maxWidth: 400),
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Warning Icon
            Container(
              width: 64,
              height: 64,
              decoration: BoxDecoration(
                color: Colors.orange.withValues(alpha: 0.15),
                shape: BoxShape.circle,
              ),
              child: const Center(
                child: FaIcon(
                  FontAwesomeIcons.triangleExclamation,
                  size: 28,
                  color: Colors.orange,
                ),
              ),
            ),
            const SizedBox(height: 20),

            // Title
            Text(
              AppStrings.get(lang, 'ollama_connection_error_title'),
              style: TextStyle(
                fontFamily: 'Merriweather',
                fontSize: 20,
                fontWeight: FontWeight.bold,
                color: isDark ? Colors.white : AppColors.lightPrimary,
              ),
            ),
            const SizedBox(height: 12),

            // Body
            Text(
              AppStrings.get(lang, 'ollama_connection_error_body'),
              textAlign: TextAlign.center,
              style: TextStyle(
                fontSize: 14,
                height: 1.5,
                color: isDark ? Colors.grey[300] : Colors.grey[700],
              ),
            ),
            const SizedBox(height: 8),

            // Hint
            Text(
              AppStrings.get(lang, 'check_settings_hint'),
              textAlign: TextAlign.center,
              style: TextStyle(
                fontSize: 12,
                fontStyle: FontStyle.italic,
                color: isDark ? Colors.grey[500] : Colors.grey[500],
              ),
            ),
            const SizedBox(height: 24),

            // OK Button
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: () => Navigator.of(context).pop(),
                style: ElevatedButton.styleFrom(
                  backgroundColor:
                      isDark ? Colors.white : AppColors.lightPrimary,
                  foregroundColor: isDark ? Colors.black : Colors.white,
                  elevation: 0,
                  padding: const EdgeInsets.symmetric(vertical: 14),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
                child: Text(
                  AppStrings.get(lang, 'ok_button'),
                  style: const TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
</file>

<file path="lib/utils/file_parser.dart">
import 'dart:io';
import 'package:epubx/epubx.dart';
import 'package:html/parser.dart' as html_parser;

/// Utility class for parsing different file formats
class FileParser {
  /// Extracts plain text content from an EPUB file
  /// Throws Exception if file is corrupted, DRM protected, or unreadable
  static Future<String> extractTextFromEpub(String filePath) async {
    final File file = File(filePath);
    
    if (!await file.exists()) {
      throw Exception('File EPUB kh√¥ng t·ªìn t·∫°i: $filePath');
    }

    try {
      final bytes = await file.readAsBytes();
      final EpubBook epubBook = await EpubReader.readBook(bytes);
      
      final StringBuffer textContent = StringBuffer();
      
      // Get content from chapters
      final chapters = epubBook.Chapters;
      if (chapters != null && chapters.isNotEmpty) {
        for (final chapter in chapters) {
          _extractChapterText(chapter, textContent);
        }
      }
      
      // If no chapters found, try to extract from content files directly
      if (textContent.isEmpty) {
        final content = epubBook.Content;
        if (content?.Html != null) {
          for (final htmlFile in content!.Html!.values) {
            final htmlContent = htmlFile.Content;
            if (htmlContent != null) {
              final plainText = _stripHtmlTags(htmlContent);
              if (plainText.isNotEmpty) {
                textContent.writeln(plainText);
                textContent.writeln();
              }
            }
          }
        }
      }
      
      final result = textContent.toString().trim();
      
      if (result.isEmpty) {
        throw Exception('Kh√¥ng th·ªÉ tr√≠ch xu·∫•t n·ªôi dung t·ª´ file EPUB. File c√≥ th·ªÉ b·ªã DRM ho·∫∑c kh√¥ng c√≥ n·ªôi dung text.');
      }
      
      return result;
    } catch (e) {
      if (e is Exception) rethrow;
      throw Exception('L·ªói ƒë·ªçc file EPUB: $e. File c√≥ th·ªÉ b·ªã h·ªèng ho·∫∑c ƒë∆∞·ª£c b·∫£o v·ªá DRM.');
    }
  }
  
  /// Recursively extracts text from a chapter and its sub-chapters
  static void _extractChapterText(EpubChapter chapter, StringBuffer buffer) {
    // Add chapter title if available
    final title = chapter.Title;
    if (title != null && title.isNotEmpty) {
      buffer.writeln('\n--- $title ---\n');
    }
    
    // Extract text from chapter content
    final htmlContent = chapter.HtmlContent;
    if (htmlContent != null && htmlContent.isNotEmpty) {
      final plainText = _stripHtmlTags(htmlContent);
      if (plainText.isNotEmpty) {
        buffer.writeln(plainText);
        buffer.writeln();
      }
    }
    
    // Process sub-chapters recursively
    final subChapters = chapter.SubChapters;
    if (subChapters != null) {
      for (final subChapter in subChapters) {
        _extractChapterText(subChapter, buffer);
      }
    }
  }
  
  /// Strips HTML tags and returns plain text
  static String _stripHtmlTags(String htmlString) {
    if (htmlString.isEmpty) return '';
    try {
      var document = html_parser.parse(htmlString);
      return document.body?.text.trim() ?? '';
    } catch (e) {
      // Fallback: simple regex-based tag removal
      return htmlString.replaceAll(RegExp(r'<[^>]*>'), '');
    }
  }
  
  /// Determines file type and extracts text content accordingly
  /// Returns plain text content from either TXT or EPUB files
  static Future<String> extractText(String filePath) async {
    final extension = filePath.toLowerCase();
    
    if (extension.endsWith('.epub')) {
      return extractTextFromEpub(filePath);
    } else if (extension.endsWith('.txt')) {
      final file = File(filePath);
      if (!await file.exists()) {
        throw Exception('File kh√¥ng t·ªìn t·∫°i: $filePath');
      }
      return file.readAsString();
    } else {
      throw Exception('ƒê·ªãnh d·∫°ng file kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£. Ch·ªâ ch·∫•p nh·∫≠n .TXT v√† .EPUB');
    }
  }
}
</file>

<file path="PRIVACY.md">
# Privacy Policy for FluxOrigin

**Last updated:** December 04, 2025

## 1. Introduction
FluxOrigin ("we", "our", or "us") is committed to protecting your privacy. This Privacy Policy explains how our application handles your data.

**The most important point:** FluxOrigin is designed as a local-first application. We do not collect, store, or transmit your personal data, files, or translation content to any cloud servers controlled by us.

## 2. Data Collection and Usage

### 2.1. Personal Information
We do not collect any personal information (such as name, email address, phone number, or location data) when you use FluxOrigin.

### 2.2. User Content (Files and Text)
FluxOrigin allows you to open and translate document files (such as .TXT and .EPUB).
* **Local Processing:** All file parsing and reading happen locally on your device.
* **No Uploads:** Your files are **never** uploaded to our servers.

## 3. Generative AI and Translation

FluxOrigin utilizes Artificial Intelligence (AI) features to provide translation services.

* **Local AI Models:** The application connects to local AI models running on your device (e.g., via Ollama).
* **Data Privacy:** Since the AI models run locally on your machine or local network, the text you translate is processed within your own environment. No text data is sent to external third-party API providers or our servers for generation.

## 4. Analytics
The application does not integrate third-party analytics SDKs that track user behavior or crash reports. Any logs generated by the application are stored locally on your device for debugging purposes (`Dev Logs`) and are not transmitted to us unless you manually choose to share them via email for support.

## 5. Internet Access
FluxOrigin may require internet access solely for the purpose of:
* Verifying license/purchase status from the Microsoft Store.
* Downloading updates if applicable.
It does not use the internet to transmit your content.

## 6. Contact Us
If you have any questions about this Privacy Policy, please contact us at:

* **Email:** d.init.d.contact@gmail.com
</file>

<file path="temp_snippet.txt">
e == 'Ti√°¬∫¬øng Vi√°¬ª‚Ä°t') {
        finalSystemPrompt =
            "$strictSystemPrompt\n\n$constraints\n\n$contextInstruction### Y√É≈†U C√°¬∫¬¶U D√°¬ª≈†CH THU√°¬∫¬¨T N√É‚ÄöNG CAO:\n1. D√°¬ª‚Äπch CHI TI√°¬∫¬æT t√°¬ª¬´ng c√É¬¢u, tuy√°¬ª‚Ä°t √Ñ‚Äò√°¬ª‚Äòi KH√É‚ÄùNG √Ñ‚Äò√Ü¬∞√°¬ª¬£c t√É¬≥m t√°¬∫¬Øt hay b√°¬ª¬è s√É¬≥t √É¬Ω.\n2. Gi√°¬ª¬Ø nguy√É¬™n s√°¬∫¬Øc th√É¬°i bi√°¬ª∆íu c√°¬∫¬£m, c√É¬°c th√É¬°n t√°¬ª¬´, m√É¬¥ t√°¬∫¬£ n√°¬ª‚Ñ¢i t√É¬¢m c√°¬ª¬ßa nh√É¬¢n v√°¬∫¬≠t.\n3. N√°¬∫¬øu g√°¬∫¬∑p th√Ü¬° ca ho√°¬∫¬∑c c√É¬¢u √Ñ‚Äò√°¬ª‚Äòi, h√É¬£y d√°¬ª‚Äπch sao cho v√°¬∫¬ßn √Ñ‚Äòi√°¬ª‚Ä°u ho√°¬∫¬∑c gi√°¬ª¬Ø nguy√É¬™n H√É¬°n Vi√°¬ª‚Ä°t n√°¬∫¬øu c√°¬∫¬ßn.\n4. V√Ñ∆ín phong
</file>

<file path="test_output.txt">
00:00 +0: loading D:/FluxOrigin/test/ai_service_refactor_test.dart
flutter : Error: 
Couldn't resolve the 
package 'test' in 
'package:test/test.dart'.
At line:1 char:1
+ flutter test test/ai_se
rvice_refactor_test.dart 
> test_output.txt 2>& ...
+ ~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo       
       : NotSpecified:   
  (Error: Couldn't...e   
 st/test.dart'.:Strin    
g) [], RemoteExcepti    
on
    + FullyQualifiedErro 
   rId : NativeCommandE  
  rror
 
test/ai_service_refactor_
test.dart:1:8: Error: 
Not found: 
'package:test/test.dart'
import 
'package:test/test.dart';
       ^
test/ai_service_refactor_
test.dart:13:7: Error: 
Method not found: 
'expect'.
      expect(result, 
expected);
      ^^^^^^
test/ai_service_refactor_
test.dart:8:5: Error: 
Method not found: 'test'.
    test('Removes 
English suffixes 
(Fallback)', () {
    ^^^^
test/ai_service_refactor_
test.dart:20:7: Error: 
Method not found: 
'expect'.
      expect(result, 
expected);
      ^^^^^^
test/ai_service_refactor_
test.dart:16:5: Error: 
Method not found: 'test'.
    test('Removes 
English suffixes with 
space', () {
    ^^^^
test/ai_service_refactor_
test.dart:27:7: Error: 
Method not found: 
'expect'.
      expect(result, 
expected);
      ^^^^^^
test/ai_service_refactor_
test.dart:23:5: Error: 
Method not found: 'test'.
    test('Removes 
trailing punctuation 
loops', () {
    ^^^^
test/ai_service_refactor_
test.dart:34:7: Error: 
Method not found: 
'expect'.
      expect(result, 
expected);
      ^^^^^^
test/ai_service_refactor_
test.dart:30:5: Error: 
Method not found: 'test'.
    test('Removes 
trailing dots loop', () {
    ^^^^
test/ai_service_refactor_
test.dart:41:7: Error: 
Method not found: 
'expect'.
      expect(result, 
expected);
      ^^^^^^
test/ai_service_refactor_
test.dart:37:5: Error: 
Method not found: 'test'.
    test('Removes 
parenthesized Chinese', 
() {
    ^^^^
test/ai_service_refactor_
test.dart:48:7: Error: 
Method not found: 
'expect'.
      expect(result, 
expected);
      ^^^^^^
test/ai_service_refactor_
test.dart:44:5: Error: 
Method not found: 'test'.
    test('Removes square 
bracket Chinese', () {
    ^^^^
test/ai_service_refactor_
test.dart:5:3: Error: 
Method not found: 
'group'.
  group('AIService 
Cleanup Logic', () {
  ^^^^^
00:00 +0 -1: loading D:/FluxOrigin/test/ai_service_refactor_test.dart [E]
  Failed to load "D:/FluxOrigin/test/ai_service_refactor_test.dart":
  Compilation failed for testPath=D:/FluxOrigin/test/ai_service_refactor_test.dart: Error: Couldn't resolve the package 'test' in 'package:test/test.dart'.
  test/ai_service_refactor_test.dart:1:8: Error: Not found: 'package:test/test.dart'
  import 'package:test/test.dart';
         ^
  test/ai_service_refactor_test.dart:13:7: Error: Method not found: 'expect'.
        expect(result, expected);
        ^^^^^^
  test/ai_service_refactor_test.dart:8:5: Error: Method not found: 'test'.
      test('Removes English suffixes (Fallback)', () {
      ^^^^
  test/ai_service_refactor_test.dart:20:7: Error: Method not found: 'expect'.
        expect(result, expected);
        ^^^^^^
  test/ai_service_refactor_test.dart:16:5: Error: Method not found: 'test'.
      test('Removes English suffixes with space', () {
      ^^^^
  test/ai_service_refactor_test.dart:27:7: Error: Method not found: 'expect'.
        expect(result, expected);
        ^^^^^^
  test/ai_service_refactor_test.dart:23:5: Error: Method not found: 'test'.
      test('Removes trailing punctuation loops', () {
      ^^^^
  test/ai_service_refactor_test.dart:34:7: Error: Method not found: 'expect'.
        expect(result, expected);
        ^^^^^^
  test/ai_service_refactor_test.dart:30:5: Error: Method not found: 'test'.
      test('Removes trailing dots loop', () {
      ^^^^
  test/ai_service_refactor_test.dart:41:7: Error: Method not found: 'expect'.
        expect(result, expected);
        ^^^^^^
  test/ai_service_refactor_test.dart:37:5: Error: Method not found: 'test'.
      test('Removes parenthesized Chinese', () {
      ^^^^
  test/ai_service_refactor_test.dart:48:7: Error: Method not found: 'expect'.
        expect(result, expected);
        ^^^^^^
  test/ai_service_refactor_test.dart:44:5: Error: Method not found: 'test'.
      test('Removes square bracket Chinese', () {
      ^^^^
  test/ai_service_refactor_test.dart:5:3: Error: Method not found: 'group'.
    group('AIService Cleanup Logic', () {
    ^^^^^
  .
00:00 +0 -1: Some tests failed.
</file>

<file path="test/ai_service_refactor_test.dart">
import 'package:flutter_test/flutter_test.dart';
import 'package:flux_origin/services/ai_service.dart';

void main() {
  group('AIService Cleanup Logic', () {
    final aiService = AIService();

    test('Removes English suffixes (Fallback)', () {
      // Scenario: AI translates "Mystic Cloud" but leaves "Hall"
      const input = "Huy·ªÅn V√¢n Hall";
      const expected = "Huy·ªÅn V√¢n";
      final result = aiService.cleanResponse(input, 'Ti·∫øng Vi·ªát');
      expect(result, expected);
    });

    test('Removes English suffixes with space', () {
      const input = "Thi√™n Ki·∫øm Sect";
      const expected = "Thi√™n Ki·∫øm";
      final result = aiService.cleanResponse(input, 'Ti·∫øng Vi·ªát');
      expect(result, expected);
    });

    test('Removes trailing punctuation loops', () {
      const input = "C·ª≠u D∆∞∆°ngÔºå„ÄÇÔºå„ÄÇÔºå„ÄÇ";
      const expected = "C·ª≠u D∆∞∆°ng.";
      final result = aiService.cleanResponse(input, 'Ti·∫øng Vi·ªát');
      expect(result, expected);
    });

    test('Removes trailing dots loop', () {
      const input = "N·ªôi dung......";
      const expected = "N·ªôi dung.";
      final result = aiService.cleanResponse(input, 'Ti·∫øng Vi·ªát');
      expect(result, expected);
    });

    test('Removes parenthesized Chinese', () {
      const input = "Huy·ªÅn V√¢n ƒêi·ªán (ÁéÑ‰∫ëÊÆø)";
      const expected = "Huy·ªÅn V√¢n ƒêi·ªán";
      final result = aiService.cleanResponse(input, 'Ti·∫øng Vi·ªát');
      expect(result, expected);
    });

    test('Removes square bracket Chinese', () {
      const input = "Huy·ªÅn V√¢n ƒêi·ªán [ÁéÑ‰∫ëÊÆø]";
      const expected = "Huy·ªÅn V√¢n ƒêi·ªán";
      final result = aiService.cleanResponse(input, 'Ti·∫øng Vi·ªát');
      expect(result, expected);
    });

    test('Replaces Chinese punctuation', () {
      const input = "Xin ch√†oÔºåth·∫ø gi·ªõi„ÄÇƒê√¢y l√† th·ª≠ nghi·ªámÔºöth√†nh c√¥ngÔºüTuy·ªát v·ªùiÔºÅ";
      const expected =
          "Xin ch√†o, th·∫ø gi·ªõi. ƒê√¢y l√† th·ª≠ nghi·ªám: th√†nh c√¥ng? Tuy·ªát v·ªùi!";
      final result = aiService.cleanResponse(input, 'Ti·∫øng Vi·ªát');
      expect(result, expected);
    });

    test('Replaces Chinese quotes', () {
      const input = "Anh ·∫•y n√≥i: ‚ÄúXin ch√†o‚Äù";
      const expected = 'Anh ·∫•y n√≥i: "Xin ch√†o"';
      final result = aiService.cleanResponse(input, 'Ti·∫øng Vi·ªát');
      expect(result, expected);
    });

    test('Removes rare Chinese symbols', () {
      const input = "Ti√™u ƒë·ªÅ\u3000M·ªõi"; // Ideographic space
      const expected = "Ti√™u ƒë·ªÅM·ªõi";
      final result = aiService.cleanResponse(input, 'Ti·∫øng Vi·ªát');
      expect(result, expected);
    });
  });
}
</file>

<file path="test/text_processor_test.dart">
import 'package:flux_origin/utils/text_processor.dart';

void main() {
  print("Testing TextProcessor.smartSplit...");

  // Test 1: Normal sentence splitting
  String text1 = "Hello world. This is a test. Another sentence.";
  List<String> chunks1 = TextProcessor.smartSplit(text1, targetSize: 20);
  print("\nTest 1 (Normal):");
  for (var chunk in chunks1) {
    print("[$chunk]");
  }
  // Expected: [Hello world.], [This is a test.], [Another sentence.]

  // Test 2: Long sentence that exceeds targetSize but has a terminator nearby
  String text2 =
      "This is a very long sentence that should ideally not be broken in the middle of a word or phrase.";
  // targetSize 30. "This is a very long sentence" is 28 chars.
  // "that should ideally not be broken" is 33 chars.
  // It should try to find a break.
  List<String> chunks2 = TextProcessor.smartSplit(text2, targetSize: 30);
  print("\nTest 2 (Long Sentence):");
  for (var chunk in chunks2) {
    print("[$chunk]");
  }

  // Test 3: Extremely long sentence with no terminators (Fallback)
  String text3 =
      "ThisIsAnExtremelyLongSentenceWithNoSpacesOrPunctuationThatWillForceAFallbackSplitAtSomePointHopefully";
  List<String> chunks3 = TextProcessor.smartSplit(text3, targetSize: 20);
  print("\nTest 3 (Fallback):");
  for (var chunk in chunks3) {
    print("[$chunk]");
  }

  // Test 4: Look forward logic
  // "A" * 90 + ". " + "B" * 10. Target 80.
  // It should NOT cut at 80. It should look forward to 92 (the dot).
  String text4 = "${"A" * 90}. ${"B" * 10}";
  List<String> chunks4 = TextProcessor.smartSplit(text4, targetSize: 80);
  print("\nTest 4 (Look Forward):");
  print("Length: ${text4.length}");
  for (var chunk in chunks4) {
    print(
        "Chunk len: ${chunk.length} -> [${chunk.substring(0, min(10, chunk.length))}...]");
  }

  if (chunks4[0].length > 80) {
    print(
        "SUCCESS: Chunk 0 extended beyond target size to include sentence terminator.");
  } else {
    print("FAIL: Chunk 0 was cut strictly at target size.");
  }
}

int min(int a, int b) => a < b ? a : b;
</file>

<file path="test/verify_web_search.dart">
import 'package:flux_origin/services/web_search_service.dart';

void main() async {
  final service = WebSearchService();

  print('--- Testing WebSearchService ---');

  // Test 1: English Lookup
  print('\nTest 1: Lookup "Apple" in English (en)');
  final resultEn = await service.lookupTerm('Apple', 'en');
  print(
      'Result (EN): ${resultEn != null ? resultEn.substring(0, 100) + "..." : "null"}');

  // Test 2: Vietnamese Lookup
  print('\nTest 2: Lookup "T√°o" in Vietnamese (vi)');
  final resultVi = await service.lookupTerm('T√°o', 'vi');
  print(
      'Result (VI): ${resultVi != null ? resultVi.substring(0, 100) + "..." : "null"}');

  // Test 3: Chinese Lookup (if possible)
  print('\nTest 3: Lookup "ËãπÊûú" in Chinese (zh)');
  final resultZh = await service.lookupTerm('ËãπÊûú', 'zh');
  print(
      'Result (ZH): ${resultZh != null ? resultZh.substring(0, 100) + "..." : "null"}');

  print('\n--- Verification Complete ---');
}
</file>

<file path="test/widget_test.dart">
// Basic widget test placeholder
import 'package:flutter_test/flutter_test.dart';

void main() {
  testWidgets('App starts without crashing', (WidgetTester tester) async {
    // TODO: Add proper widget tests for FluxOrigin UI
    expect(true, true);
  });
}
</file>

<file path="ui_design.html">
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FluxOrigin Windows Preview V2</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e5e5e5; /* Desktop wallpaper bg mock */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .font-serif-custom {
            font-family: 'Merriweather', serif;
        }
        
        /* --- CUSTOM COLORS (UPDATED: Monochrome Dark Mode) --- */
        
        /* Primary Color: Dark Green #043222 (STILL USED FOR LIGHT MODE) */
        .bg-primary { background-color: #043222; }
        .text-primary { color: #043222; }
        
        /* Accent Color: Lighter Green (STILL USED FOR LIGHT MODE) */
        .bg-accent { background-color: #13503D; } 
        .text-accent { color: #13503D; }
        .border-accent { border-color: #13503D; }
        
        /* Light Mode Theme */
        .bg-paper-light { background-color: #fdfcf8; } 
        .bg-sidebar-light { background-color: #f4f2ed; } 
        .bg-surface-light { background-color: #ffffff; } 
        .border-light { border-color: #e6e4dc; }
        
        /* Dark Mode Theme - PURE BLACK/WHITE/GRAYSCALE */
        .bg-paper-dark { background-color: #111111; } /* Main Canvas Background */
        .bg-sidebar-dark { background-color: #000000; } /* Sidebar Background */
        .bg-surface-dark { background-color: #1a1a1a; } /* Card/Input Surfaces */
        
        /* Custom Scrollbar for Desktop feel */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #333;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-animate-in {
            animation: modalFadeIn 0.2s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const DOMAINS = [
            { id: 'it', name: 'C√¥ng ngh·ªá th√¥ng tin', icon: 'fa-microchip' },
            { id: 'med', name: 'Y t·∫ø & D∆∞·ª£c ph·∫©m', icon: 'fa-staff-snake' },
            { id: 'law', name: 'Ph√°p l√Ω & Lu·∫≠t', icon: 'fa-scale-balanced' },
            { id: 'fin', name: 'T√†i ch√≠nh & Ng√¢n h√†ng', icon: 'fa-coins' },
            { id: 'edu', name: 'Gi√°o d·ª•c & Khoa h·ªçc', icon: 'fa-graduation-cap' },
            { id: 'mkt', name: 'Marketing & Media', icon: 'fa-bullhorn' },
        ];
        
        // C·∫≠p nh·∫≠t: Danh s√°ch t·∫•t c·∫£ c√°c ng√¥n ng·ªØ c√≥ th·ªÉ ch·ªçn cho c·∫£ ngu·ªìn v√† ƒë√≠ch
        const ALL_LANGUAGES = ["Ti·∫øng Anh", "Ti·∫øng Trung", "Ti·∫øng Vi·ªát"];
        // H·∫±ng s·ªë SOURCE_LANGUAGES v√† TARGET_LANGUAGE kh√¥ng c√≤n ƒë∆∞·ª£c s·ª≠ d·ª•ng n·ªØa.

        // --- Mock Data for Dictionary ---
        const MOCK_DICTS = [
            { id: 1, name: "IT Terminology Base", entries: 1240, lastUpdated: "2 gi·ªù tr∆∞·ªõc", type: "cloud", status: "ƒê√£ ƒë·ªìng b·ªô" },
            { id: 2, name: "H·ª£p ƒë·ªìng kinh t·∫ø", entries: 850, lastUpdated: "1 ng√†y tr∆∞·ªõc", type: "local", status: "C·ª•c b·ªô" },
            { id: 3, name: "Marketing Glosary 2024", entries: 320, lastUpdated: "3 ng√†y tr∆∞·ªõc", type: "cloud", status: "ƒêang t·∫£i..." },
        ];

        // --- Components ---

        const TitleBar = ({ isDark }) => (
            <div className={`h-8 flex justify-between items-center select-none draggable border-b ${isDark ? 'bg-sidebar-dark text-gray-400 border-gray-800' : 'bg-[#f4f2ed] text-[#043222] border-[#e6e4dc]'}`} style={{WebkitAppRegion: 'drag'}}>
                <div className="flex items-center px-4 space-x-2">
                     <i className={`fa-solid fa-layer-group text-xs ${isDark ? 'text-white/80' : 'text-primary'}`}></i> 
                    <span className="text-xs font-medium opacity-80">FluxOrigin</span>
                </div>
                <div className="flex h-full">
                    <button className="w-12 h-full flex items-center justify-center hover:bg-white/10 transition-colors"><i className="fa-regular fa-window-minimize text-[10px] -translate-y-1"></i></button>
                    <button className="w-12 h-full flex items-center justify-center hover:bg-white/10 transition-colors"><i className="fa-regular fa-window-maximize text-[10px]"></i></button>
                    <button className="w-12 h-full flex items-center justify-center hover:bg-red-500 hover:text-white transition-colors"><i className="fa-solid fa-xmark text-sm"></i></button>
                </div>
            </div>
        );

        const SidebarItem = ({ icon, label, isActive, onClick, isDark }) => (
            <button 
                onClick={onClick}
                className={`w-full flex items-center px-4 py-3 mb-1 rounded-lg transition-all duration-200 group ${
                    isActive 
                        ? (isDark ? 'bg-white/10 text-white font-bold' : 'bg-[#043222]/10 text-primary font-bold') 
                        : (isDark ? 'text-gray-400 hover:bg-white/5 hover:text-gray-200' : 'text-[#043222]/70 hover:bg-[#043222]/5 hover:text-primary')
                }`}
            >
                <i className={`fa-solid ${icon} w-6 text-center text-lg mr-3 transition-colors ${isActive ? (isDark ? 'text-white' : 'text-primary') : ''}`}></i>
                <span className="text-sm">{label}</span>
                {isActive && <div className={`ml-auto w-1 h-4 rounded-full ${isDark ? 'bg-white' : 'bg-primary'}`}></div>}
            </button>
        );

        const LanguageSelector = ({ value, isDark, onChange, isLocked = false, availableLanguages = [] }) => {
            const [isOpen, setIsOpen] = useState(false);
            const dropdownRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);
            
            const baseClasses = `w-full flex items-center px-4 py-2 rounded-lg border shadow-sm transition-colors `;
            const activeClasses = isDark ? 'bg-surface-dark border-gray-700 text-gray-200' : 'bg-white border-[#e6e4dc] text-primary';
            const hoverClasses = isLocked ? 'cursor-default opacity-80' : (isDark ? 'cursor-pointer hover:border-white/50' : 'cursor-pointer hover:border-primary/50');

            return (
                <div className="relative" ref={dropdownRef}>
                    <button 
                        onClick={() => !isLocked && setIsOpen(!isOpen)}
                        className={`${baseClasses} ${activeClasses} ${hoverClasses}`}
                    >
                        <div className="flex items-center space-x-3">
                             <div className={`w-6 h-6 rounded overflow-hidden flex items-center justify-center text-[10px] font-bold ${isDark ? 'bg-white/10 text-white/80' : 'bg-[#043222]/5 text-primary'}`}>
                                {value.substring(0, 2).toUpperCase()}
                             </div>
                            <span className="font-medium text-sm truncate">{value}</span>
                        </div>
                        {!isLocked && (
                            <i className={`fa-solid fa-chevron-down text-xs opacity-50 transition-transform duration-200 ml-auto ${isOpen ? 'rotate-180' : ''}`}></i>
                        )}
                    </button>

                    {isOpen && !isLocked && (
                        <div className={`absolute top-full left-0 w-full mt-2 py-1 rounded-xl shadow-xl z-50 overflow-hidden border ${isDark ? 'bg-surface-dark border-gray-700' : 'bg-white border-gray-100'}`}>
                            {/* Cho ph√©p hi·ªÉn th·ªã t·∫•t c·∫£ c√°c ng√¥n ng·ªØ ƒë∆∞·ª£c truy·ªÅn v√†o, bao g·ªìm c·∫£ ng√¥n ng·ªØ hi·ªán t·∫°i */}
                            {availableLanguages.map((lang) => (
                                <button
                                    key={lang}
                                    onClick={() => { onChange(lang); setIsOpen(false); }}
                                    className={`w-full text-left px-4 py-2 text-sm flex items-center space-x-3 transition-colors ${
                                        value === lang 
                                            ? (isDark ? 'bg-white/10 text-white font-bold' : 'bg-[#043222]/10 text-primary font-bold') 
                                            : (isDark ? 'text-gray-300 hover:bg-white/5' : 'text-gray-600 hover:bg-gray-50')
                                    }`}
                                >
                                    <div className={`w-6 h-6 rounded overflow-hidden flex items-center justify-center text-[10px] font-bold ${isDark ? 'bg-white/20 text-white' : 'bg-gray-100 text-gray-500'}`}>
                                        {lang.substring(0, 2).toUpperCase()}
                                    </div>
                                    <span>{lang}</span>
                                    {/* S·ª≠ d·ª•ng d·∫•u check ƒë·ªÉ ƒë√°nh d·∫•u ng√¥n ng·ªØ hi·ªán t·∫°i */}
                                    <i className={`fa-solid fa-check text-xs ml-auto opacity-70 ${value === lang ? (isDark ? 'text-white' : 'text-primary') : 'text-transparent'}`}></i>
                                </button>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const FileUploadZone = ({ isDark, heightClass = "flex-1", title = "K√©o th·∫£ t√†i li·ªáu v√†o ƒë√¢y", sub = "H·ªó tr·ª£ .PDF, .DOCX, .EPUB, .TXT", icon = "fa-cloud-arrow-up" }) => (
            <div className={`${heightClass} w-full border-2 border-dashed rounded-2xl flex flex-col items-center justify-center transition-all cursor-pointer group hover:border-accent relative overflow-hidden ${isDark ? 'border-gray-700 bg-surface-dark/50 hover:bg-surface-dark hover:border-gray-500' : 'border-gray-300 bg-white hover:bg-white hover:border-primary/50'}`}>
                <div className="text-center p-8 z-10">
                    <div className={`w-16 h-16 mx-auto rounded-full flex items-center justify-center mb-4 transition-transform group-hover:scale-110 duration-300 ${isDark ? 'bg-white/10 text-white/90' : 'bg-[#043222]/5 text-primary'}`}>
                        <i className={`fa-solid ${icon} text-2xl`}></i>
                    </div>
                    <p className={`text-base font-medium mb-1 ${isDark ? 'text-gray-200' : 'text-primary'}`}>
                        {title}
                    </p>
                    <p className={`text-xs mb-4 ${isDark ? 'text-gray-500' : 'text-[#043222]/60'}`}>
                        {sub}
                    </p>
                    <button className={`px-5 py-1.5 rounded-full text-xs font-semibold transition-colors ${isDark ? 'bg-white/10 hover:bg-white/20 text-white' : 'bg-primary/10 hover:bg-primary/20 text-primary'}`}>
                        Ch·ªçn file
                    </button>
                </div>
            </div>
        );

        const TranslateScreen = ({ isDark }) => {
            const [mode, setMode] = useState('document'); 
            const [selectedDomain, setSelectedDomain] = useState('it');
            const [useCustomDict, setUseCustomDict] = useState(true); // Default ON
            
            // C·∫≠p nh·∫≠t: S·ª≠ d·ª•ng state cho c·∫£ ng√¥n ng·ªØ ngu·ªìn v√† ng√¥n ng·ªØ ƒë√≠ch
            const [sourceLang, setSourceLang] = useState("Ti·∫øng Anh");
            const [targetLang, setTargetLang] = useState("Ti·∫øng Vi·ªát"); 

            // Logic swap ng√¥n ng·ªØ
            const handleSwap = () => {
                setSourceLang(targetLang);
                setTargetLang(sourceLang);
            };

            // C·∫≠p nh·∫≠t: H√†m tr·∫£ v·ªÅ t·∫•t c·∫£ c√°c ng√¥n ng·ªØ (3 options) cho c·∫£ hai b·ªô ch·ªçn
            const getAllOptions = () => ALL_LANGUAGES;

            // ƒêI·ªÄU CH·ªàNH: Gi·∫£m chi·ªÅu cao c·ªßa kh·ªëi t·ª´ ƒëi·ªÉn/upload t·ª´ h-32 (128px) xu·ªëng h-20 (80px)
            const DICT_BLOCK_HEIGHT = 'h-20'; 

            return (
                <div className="flex flex-col h-full p-6 animate-fade-in">
                    {/* Mode Toggle Tabs */}
                    <div className="flex justify-center mb-6">
                        <div className={`p-1 rounded-lg flex shadow-inner transition-colors ${isDark ? 'bg-white/10' : 'bg-[#E8E4D9]'}`}>
                            <button
                                onClick={() => setMode('document')}
                                className={`px-6 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center ${mode === 'document' ? (isDark ? 'bg-white text-black shadow' : 'bg-white text-primary shadow') : (isDark ? 'text-gray-400 hover:text-white' : 'text-[#043222]/60 hover:text-primary')}`}
                            >
                                <i className="fa-solid fa-file mr-2 text-xs"></i>
                                T√†i li·ªáu
                            </button>
                             <button
                                onClick={() => setMode('specialized')}
                                className={`px-6 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center ${mode === 'specialized' ? (isDark ? 'bg-white text-black shadow' : 'bg-white text-primary shadow') : (isDark ? 'text-gray-400 hover:text-white' : 'text-[#043222]/60 hover:text-primary')}`}
                            >
                                <i className="fa-solid fa-briefcase mr-2 text-xs"></i>
                                Chuy√™n ng√†nh
                            </button>
                        </div>
                    </div>

                    {/* Language Control - C·∫≠p nh·∫≠t ƒë·ªÉ h·ªó tr·ª£ swap */}
                    <div className="flex items-center justify-center space-x-4 mb-6 z-20 relative">
                        <div className="w-48">
                            <LanguageSelector 
                                value={sourceLang} 
                                isDark={isDark} 
                                onChange={setSourceLang} 
                                availableLanguages={getAllOptions()} // TRUY·ªÄN V√ÄO T·∫§T C·∫¢ 3 NG√îN NG·ªÆ
                            />
                        </div>
                        {/* N√∫t swap ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t */}
                        <button 
                            onClick={handleSwap}
                            className={`w-10 h-10 rounded-full flex items-center justify-center transition-colors ${isDark ? 'text-white hover:bg-white/10' : 'text-primary hover:bg-primary/10'}`}
                        >
                            <i className="fa-solid fa-arrow-right-arrow-left"></i>
                        </button>
                        <div className="w-48">
                            <LanguageSelector 
                                value={targetLang} 
                                isDark={isDark} 
                                onChange={setTargetLang} 
                                availableLanguages={getAllOptions()} // TRUY·ªÄN V√ÄO T·∫§T C·∫¢ 3 NG√îN NG·ªÆ
                                isLocked={false} 
                            />
                        </div>
                    </div>

                    {/* Content Switcher */}
                    {mode === 'document' && (
                        <div className="flex-1 flex flex-col z-0 overflow-y-auto pr-2">
                            <div className="flex-1 flex flex-col mb-0">
                                <FileUploadZone isDark={isDark} heightClass="h-full" />
                            </div>
                        </div>
                    )}

                    {mode === 'specialized' && (
                        <div className="flex-1 flex flex-col h-full z-0 animate-fade-in">
                            {/* COMPACT UI: Header Row */}
                            <div className="flex items-center justify-between mb-4 px-1">
                                <div className="flex items-center space-x-2">
                                    {/* ICON theo m√†u ch·ªß ƒë·∫°o */}
                                    <i className={`fa-solid fa-book-bookmark ${isDark ? 'text-white' : 'text-primary'}`}></i>
                                    <span className={`text-base font-bold ${isDark ? 'text-white' : 'text-primary'}`}>T·ª´ ƒëi·ªÉn chuy√™n ng√†nh</span>
                                </div>
                                <label className="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" checked={useCustomDict} onChange={() => setUseCustomDict(!useCustomDict)} className="sr-only peer" />
                                    {/* ƒê·ªìng b·ªô k√≠ch th∆∞·ªõc Toggle - ƒê√£ s·ª≠a w-12 h-7 */}
                                    <div className={`relative w-12 h-7 bg-gray-300 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all ${isDark ? 'peer-checked:bg-white/90' : 'peer-checked:bg-[#3E4C59]'}`}></div>
                                </label>
                            </div>

                            {/* LOGIC: Show Upload Box OR AI Auto-gen Box */}
                            <div className={`mb-4 animate-fade-in ${DICT_BLOCK_HEIGHT}`}>
                                {useCustomDict ? (
                                    // SHOW: Upload Box 
                                    <div className={`p-4 h-full rounded-xl border border-dashed flex items-center justify-between ${isDark ? 'bg-white/5 border-gray-600' : 'bg-gray-50 border-gray-300'}`}>
                                        <div className="flex items-center space-x-4">
                                            {/* ICON theo m√†u ch·ªß ƒë·∫°o */}
                                            <div className={`w-8 h-8 flex items-center justify-center ${isDark ? 'text-white' : 'text-primary'}`}>
                                                <i className="fa-solid fa-upload text-lg"></i>
                                            </div>
                                            <div>
                                                {/* Gi·∫£m k√≠ch th∆∞·ªõc text ƒë·ªÉ ph√π h·ª£p v·ªõi chi·ªÅu cao m·ªõi */}
                                                <p className={`text-sm font-medium ${isDark ? 'text-gray-200' : 'text-gray-800'}`}>T·∫£i l√™n t·ª´ ƒëi·ªÉn c·ªßa b·∫°n</p>
                                                <p className={`text-xs ${isDark ? 'text-gray-400' : 'text-gray-500'}`}>.CSV, .TBX, .XLSX</p>
                                            </div>
                                        </div>
                                        <button className={`text-xs px-4 py-2 rounded border transition-colors ${isDark ? 'border-gray-500 text-gray-300 hover:bg-white/10' : 'border-gray-300 text-gray-600 hover:bg-white bg-white shadow-sm'}`}>
                                            Ch·ªçn file
                                        </button>
                                    </div>
                                ) : (
                                    // SHOW: AI Auto-generation Box 
                                    <div className={`p-4 h-full rounded-xl border flex items-center space-x-4 ${isDark ? 'bg-white/5 border-gray-700' : 'bg-[#e8e6df] border-[#e6e4dc]'}`}>
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${isDark ? 'bg-white/10 text-white' : 'bg-[#d1fae5] text-accent'}`}>
                                            <i className="fa-solid fa-wand-magic-sparkles text-lg"></i>
                                        </div>
                                        <div>
                                            <p className={`text-sm font-bold ${isDark ? 'text-white' : 'text-[#043222]'}`}>AI T·ª± ƒë·ªông t·∫°o t·ª´ ƒëi·ªÉn</p>
                                            <p className={`text-xs ${isDark ? 'text-gray-400' : 'text-[#043222]/60'}`}>H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ph√¢n t√≠ch t√†i li·ªáu v√† tr√≠ch xu·∫•t thu·∫≠t ng·ªØ chuy√™n ng√†nh.</p>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Main Upload Zone */}
                            <div className="flex-1 flex flex-col bg-opacity-50 mt-2">
                                <FileUploadZone isDark={isDark} heightClass="h-full" />
                            </div>
                            
                        </div>
                    )}
                </div>
            );
        };

        const DictionaryScreen = ({ isDark, openModal }) => (
            <div className="p-8 h-full flex flex-col animate-fade-in">
                <div className="flex justify-between items-end mb-8">
                    <div>
                        <h2 className={`text-2xl font-bold mb-2 font-serif-custom ${isDark ? 'text-white' : 'text-primary'}`}>
                            T·ª´ ƒëi·ªÉn & Thu·∫≠t ng·ªØ
                        </h2>
                        <p className={`text-sm ${isDark ? 'text-gray-400' : 'text-[#043222]/70'}`}>
                            Qu·∫£n l√Ω c√°c t·ªáp t·ª´ ƒëi·ªÉn c√° nh√¢n v√† chuy√™n ng√†nh.
                        </p>
                    </div>
                    {/* N√∫t Th√™m m·ªõi (khi click s·∫Ω m·ªü Modal) */}
                    <button 
                        onClick={openModal}
                        className={`px-4 py-2 rounded-lg font-medium text-sm transition-colors border flex items-center ${isDark ? 'bg-white text-black border-white hover:bg-gray-200' : 'bg-primary text-white border-primary hover:bg-primary/80'}`}
                    >
                        <i className="fa-solid fa-plus mr-2"></i> Th√™m m·ªõi
                    </button>
                </div>

                <div className={`flex-1 overflow-hidden rounded-xl border ${isDark ? 'bg-surface-dark border-gray-700' : 'bg-white border-[#e6e4dc]'}`}>
                    <table className="w-full text-left border-collapse">
                        <thead>
                            <tr className={`text-xs font-bold uppercase tracking-wider border-b ${isDark ? 'text-gray-400 border-gray-700 bg-black/20' : 'text-gray-500 border-gray-100 bg-gray-50/50'}`}>
                                <th className="p-4 font-medium">T√™n t·ª´ ƒëi·ªÉn</th>
                                <th className="p-4 font-medium text-center">S·ªë m·ª•c</th>
                                <th className="p-4 font-medium">Lo·∫°i</th>
                                <th className="p-4 font-medium">C·∫≠p nh·∫≠t</th>
                                <th className="p-4 font-medium text-right">Tr·∫°ng th√°i</th>
                                <th className="p-4 font-medium text-right"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {MOCK_DICTS.map((dict, index) => (
                                <tr key={dict.id} className={`group text-sm transition-colors border-b last:border-0 ${isDark ? 'border-gray-800 hover:bg-white/5 text-gray-300' : 'border-gray-50 hover:bg-gray-50 text-gray-700'}`}>
                                    <td className="p-4">
                                        <div className="flex items-center space-x-3">
                                            <div className={`w-8 h-8 rounded flex items-center justify-center ${isDark ? 'bg-white/10 text-white' : 'bg-primary/10 text-primary'}`}>
                                                <i className="fa-solid fa-book text-xs"></i>
                                            </div>
                                            <span className={`font-medium ${isDark ? 'text-white' : 'text-primary'}`}>{dict.name}</span>
                                        </div>
                                    </td>
                                    <td className="p-4 text-center font-mono text-xs opacity-70">{dict.entries.toLocaleString()}</td>
                                    <td className="p-4">
                                        <span className={`text-xs px-2 py-1 rounded border ${
                                            dict.type === 'cloud' 
                                                ? (isDark ? 'border-blue-500/30 text-blue-400 bg-blue-500/10' : 'border-blue-200 text-blue-700 bg-blue-50')
                                                : (isDark ? 'border-gray-600 text-gray-400 bg-gray-800' : 'border-gray-200 text-gray-600 bg-gray-100')
                                            }`}>
                                            {dict.type === 'cloud' ? <><i className="fa-solid fa-cloud text-[10px] mr-1"></i> Cloud</> : <><i className="fa-solid fa-hard-drive text-[10px] mr-1"></i> Local</>}
                                        </span>
                                    </td>
                                    <td className="p-4 text-xs opacity-60">{dict.lastUpdated}</td>
                                    <td className="p-4 text-right">
                                        <div className="flex items-center justify-end space-x-2">
                                            <div className={`w-2 h-2 rounded-full ${dict.status === 'ƒê√£ ƒë·ªìng b·ªô' ? 'bg-green-500' : (dict.status === 'C·ª•c b·ªô' ? 'bg-gray-400' : 'bg-yellow-500 animate-pulse')}`}></div>
                                            <span className="text-xs">{dict.status}</span>
                                        </div>
                                    </td>
                                    <td className="p-4 text-right">
                                        <button className={`w-8 h-8 rounded-full flex items-center justify-center transition-colors ${isDark ? 'hover:bg-white/20 text-gray-400 hover:text-white' : 'hover:bg-gray-200 text-gray-400 hover:text-primary'}`}>
                                            <i className="fa-solid fa-ellipsis-vertical"></i>
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                     {/* Empty State Mock (Visual filler for list end) */}
                     <div className={`p-8 text-center border-t border-dashed ${isDark ? 'border-gray-800 text-gray-600' : 'border-gray-100 text-gray-400'}`}>
                        <p className="text-xs italic">Hi·ªÉn th·ªã 3 / 3 t·ª´ ƒëi·ªÉn</p>
                    </div>
                </div>
            </div>
        );

        const HistoryScreen = ({ isDark }) => (
            <div className="p-8 h-full flex flex-col animate-fade-in">
                <div className="flex justify-between items-center mb-6">
                    <h2 className={`text-2xl font-bold font-serif-custom ${isDark ? 'text-white' : 'text-primary'}`}>L·ªãch s·ª≠ d·ªãch thu·∫≠t</h2>
                    <div className={`flex rounded-lg overflow-hidden border ${isDark ? 'border-gray-700' : 'border-gray-200'}`}>
                         <button className={`px-3 py-1.5 text-xs font-medium ${isDark ? 'bg-white text-black' : 'bg-primary text-white'}`}>T·∫•t c·∫£</button>
                         <button className={`px-3 py-1.5 text-xs font-medium ${isDark ? 'bg-transparent text-gray-400 hover:text-white' : 'bg-white text-gray-500 hover:bg-gray-50'}`}>ƒê√£ l∆∞u</button>
                    </div>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto pr-2 pb-4">
                    {[1,2,3,4,5,6].map((i) => (
                        <div key={i} className={`p-5 rounded-xl border group hover:-translate-y-1 transition-all duration-300 cursor-pointer relative overflow-hidden ${isDark ? 'bg-surface-dark border-gray-700 hover:border-white/50' : 'bg-white border-[#e6e4dc] hover:border-primary/50 hover:shadow-lg'}`}>
                            <div className="flex justify-between items-center mb-3">
                                <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${isDark ? 'text-white border border-white/30' : 'text-primary border border-primary/30'}`}>EN ‚Üí VI</span> 
                                <span className={`text-xs ${isDark ? 'text-gray-500' : 'text-[#043222]/50'}`}>2 ph√∫t tr∆∞·ªõc</span>
                            </div>
                            <div className="space-y-2">
                                <p className={`text-sm font-medium truncate ${isDark ? 'text-gray-300' : 'text-primary'}`}>FluxOrigin is the sibling app...</p>
                                <div className={`h-px w-full opacity-10 ${isDark ? 'bg-white' : 'bg-black'}`}></div>
                                <p className={`font-serif-custom text-base truncate ${isDark ? 'text-gray-100' : 'text-primary'}`}>FluxOrigin l√† ·ª©ng d·ª•ng anh em...</p>
                            </div>
                             {/* Hover Action */}
                             <div className={`absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity`}>
                                <button className={`w-6 h-6 rounded-full flex items-center justify-center ${isDark ? 'bg-white text-black' : 'bg-primary text-white'}`}>
                                    <i className="fa-solid fa-arrow-right text-[10px]"></i>
                                </button>
                             </div>
                        </div>
                    ))}
                </div>
            </div>
        );

        const SettingsScreen = ({ isDark, toggleTheme }) => {
             const [selectedModel, setSelectedModel] = useState("Qwen 3 14B");
             const [isModelDropdownOpen, setIsModelDropdownOpen] = useState(false);
             const models = ["Qwen 3 14B", "GPT-4o", "Claude 3.5 Sonnet", "Gemini 1.5 Pro"];
             const [settingsSelectedDomain, setSettingsSelectedDomain] = useState(null); 

             return (
                 <div className="p-8 h-full max-w-3xl mx-auto overflow-y-auto animate-fade-in">
                    <h2 className={`text-2xl font-bold mb-8 font-serif-custom ${isDark ? 'text-white' : 'text-primary'}`}>C√†i ƒë·∫∑t</h2>
                    
                    <div className="space-y-8">
                        {/* Appearance Section */}
                        <section>
                             <h3 className={`text-xs font-bold tracking-widest mb-4 uppercase flex items-center ${isDark ? 'text-white/70' : 'text-primary'}`}>
                                 <i className="fa-solid fa-palette mr-2"></i> Giao di·ªán
                            </h3>
                            <div className={`rounded-xl border overflow-hidden ${isDark ? 'bg-surface-dark border-gray-700' : 'bg-white border-[#e6e4dc]'}`}>
                                <div className={`flex items-center justify-between p-5 border-b ${isDark ? 'border-gray-700' : 'border-[#e6e4dc]'}`}>
                                    <div>
                                        <div className={`font-medium ${isDark ? 'text-gray-200' : 'text-primary'}`}>Ch·∫ø ƒë·ªô t·ªëi (Dark Mode)</div>
                                        <div className={`text-sm mt-1 ${isDark ? 'text-gray-500' : 'text-[#043222]/60'}`}>S·ª≠ d·ª•ng giao di·ªán t·ªëi ƒë·ªÉ b·∫£o v·ªá m·∫Øt</div>
                                    </div>
                                    <button onClick={toggleTheme} className={`w-14 h-8 rounded-full p-1 transition-colors duration-300 ${isDark ? 'bg-white/20' : 'bg-[#e0ded6]'}`}>
                                        <div className={`w-6 h-6 rounded-full bg-white shadow-md transform transition-transform duration-300 ${isDark ? 'translate-x-6' : ''}`}></div>
                                    </button>
                                </div>
                                 <div className="flex items-center justify-between p-5">
                                    <div>
                                        <div className={`font-medium ${isDark ? 'text-gray-200' : 'text-primary'}`}>Font ch·ªØ hi·ªÉn th·ªã</div>
                                        <div className={`text-sm mt-1 ${isDark ? 'text-gray-500' : 'text-[#043222]/60'}`}>T√πy ch·ªânh font ch·ªØ cho ph·∫ßn ƒë·ªçc</div>
                                    </div>
                                    <div className={`px-4 py-2 rounded border cursor-pointer ${isDark ? 'bg-black/20 border-gray-600 text-gray-300' : 'bg-[#fdfcf8] border-[#e6e4dc] text-primary'}`}>
                                        Merriweather (M·∫∑c ƒë·ªãnh)
                                    </div>
                                </div>
                            </div>
                        </section>

                        {/* AI Section */}
                        <section>
                             <h3 className={`text-xs font-bold tracking-widest mb-4 uppercase flex items-center ${isDark ? 'text-white/70' : 'text-primary'}`}>
                                 <i className="fa-solid fa-brain mr-2"></i> C·∫•u h√¨nh AI
                            </h3>
                            <div className={`rounded-xl border overflow-hidden ${isDark ? 'bg-surface-dark border-gray-700' : 'bg-white border-[#e6e4dc]'}`}>
                                
                                {/* Model Selection */}
                                <div className={`flex items-center justify-between p-5 border-b ${isDark ? 'border-gray-700' : 'border-[#e6e4dc]'}`}>
                                    <div>
                                        <div className={`font-medium ${isDark ? 'text-gray-200' : 'text-primary'}`}>M√¥ h√¨nh d·ªãch thu·∫≠t</div>
                                        <div className={`text-sm mt-1 ${isDark ? 'text-gray-500' : 'text-[#043222]/60'}`}>Ch·ªçn m√¥ h√¨nh ng√¥n ng·ªØ ch√≠nh</div>
                                    </div>
                                    
                                    <div className="relative">
                                        <button 
                                            onClick={() => setIsModelDropdownOpen(!isModelDropdownOpen)}
                                            className={`px-4 py-2 rounded border cursor-pointer flex items-center min-w-[140px] justify-between transition-colors ${isDark ? 'bg-black/20 border-gray-600 text-gray-300 hover:border-white/50' : 'bg-[#fdfcf8] border-[#e6e4dc] text-primary hover:border-primary/50'}`}
                                        >
                                            <span>{selectedModel}</span>
                                            <i className={`fa-solid fa-chevron-down text-xs opacity-50 transition-transform ${isModelDropdownOpen ? 'rotate-180' : ''}`}></i>
                                        </button>
                                        
                                        {isModelDropdownOpen && (
                                            <div className={`absolute top-full right-0 mt-2 w-48 rounded-lg shadow-xl z-50 border overflow-hidden ${isDark ? 'bg-surface-dark border-gray-700' : 'bg-white border-[#e6e4dc]'}`}>
                                                {models.map(m => (
                                                    <button
                                                        key={m}
                                                        onClick={() => { setSelectedModel(m); setIsModelDropdownOpen(false); }}
                                                        className={`w-full text-left px-4 py-2 text-sm hover:bg-black/5 flex items-center justify-between ${selectedModel === m ? (isDark ? 'text-white font-bold bg-white/10' : 'text-primary font-bold bg-[#043222]/5') : (isDark ? 'text-gray-300' : 'text-gray-600')}`}
                                                    >
                                                        {m}
                                                        {selectedModel === m && <i className="fa-solid fa-check text-xs"></i>}
                                                    </button>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* ƒê√£ lo·∫°i b·ªè ph·∫ßn CH·ªåN Lƒ®NH V·ª∞C M·∫∂C ƒê·ªäNH theo y√™u c·∫ßu */}
                                
                            </div>
                        </section>

                        {/* Data Section */}
                        <section>
                             <h3 className={`text-xs font-bold tracking-widest mb-4 uppercase flex items-center ${isDark ? 'text-white/70' : 'text-primary'}`}>
                                 <i className="fa-solid fa-database mr-2"></i> D·ªØ li·ªáu
                            </h3>
                             <div className={`rounded-xl border overflow-hidden ${isDark ? 'bg-surface-dark border-gray-700' : 'bg-white border-[#e6e4dc]'}`}>
                                <div className="p-5 flex items-center hover:bg-black/5 cursor-pointer transition-colors">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center mr-4 ${isDark ? 'bg-white/10 text-white' : 'bg-[#043222]/5 text-primary'}`}>
                                        <i className="fa-solid fa-cloud-arrow-down"></i>
                                    </div>
                                    <div className="flex-1">
                                        <div className={`font-medium ${isDark ? 'text-gray-200' : 'text-primary'}`}>Qu·∫£n l√Ω g√≥i ng√¥n ng·ªØ Offline</div>
                                        <div className={`text-sm mt-1 ${isDark ? 'text-gray-500' : 'text-[#043222]/60'}`}>ƒê√£ t·∫£i: Ti·∫øng Anh, Ti·∫øng Vi·ªát (120MB)</div>
                                    </div>
                                    <i className="fa-solid fa-chevron-right text-gray-400 text-sm"></i>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            );
        }

        // --- NEW COMPONENT: Upload Dictionary Modal ---
        const UploadDictionaryModal = ({ isOpen, onClose, isDark }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm transition-opacity">
                    <div className={`w-full max-w-lg rounded-2xl shadow-2xl modal-animate-in overflow-hidden ${isDark ? 'bg-surface-dark border border-gray-700' : 'bg-white border border-gray-100'}`}>
                        {/* Header */}
                        <div className={`p-6 border-b flex justify-between items-center ${isDark ? 'border-gray-700' : 'border-gray-100'}`}>
                            <h3 className={`text-xl font-bold font-serif-custom ${isDark ? 'text-white' : 'text-primary'}`}>T·∫£i l√™n T·ª´ ƒëi·ªÉn M·ªõi</h3>
                            <button onClick={onClose} className={`w-8 h-8 rounded-full flex items-center justify-center transition-colors ${isDark ? 'text-gray-400 hover:bg-white/10' : 'text-gray-500 hover:bg-gray-100'}`}>
                                <i className="fa-solid fa-xmark"></i>
                            </button>
                        </div>

                        {/* Body */}
                        <div className="p-6 space-y-6">
                            {/* Input: T√™n t·ª´ ƒëi·ªÉn */}
                            <div>
                                <label className={`block text-sm font-medium mb-2 ${isDark ? 'text-gray-300' : 'text-gray-700'}`}>T√™n t·ª´ ƒëi·ªÉn</label>
                                <input 
                                    type="text" 
                                    placeholder="V√≠ d·ª•: Thu·∫≠t ng·ªØ C√¥ng ngh·ªá th√¥ng tin 2025" 
                                    className={`w-full p-3 rounded-lg border text-sm transition-colors ${isDark ? 'bg-black/20 border-gray-600 text-white placeholder-gray-500 focus:border-white/50' : 'bg-gray-50 border-gray-300 text-primary placeholder-gray-400 focus:border-primary/50'}`}
                                />
                            </div>
                            
                            {/* File Upload Zone */}
                            <div className="pt-2">
                                <label className={`block text-sm font-medium mb-2 ${isDark ? 'text-gray-300' : 'text-gray-700'}`}>Ch·ªçn t·ªáp t·ª´ m√°y t√≠nh</label>
                                <div className={`w-full h-32 border-2 border-dashed rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all hover:border-accent ${isDark ? 'border-gray-600 bg-white/5 hover:bg-white/10' : 'border-gray-300 bg-gray-50 hover:bg-gray-100'}`}>
                                    <div className="text-center p-4">
                                        <i className={`fa-solid fa-arrow-up-from-bracket text-2xl mb-2 ${isDark ? 'text-white/70' : 'text-primary/70'}`}></i>
                                        <p className={`text-sm font-medium ${isDark ? 'text-gray-200' : 'text-gray-700'}`}>K√©o v√† th·∫£ file ho·∫∑c <span className={`underline ${isDark ? 'text-white' : 'text-primary'}`}>Ch·ªçn t·ª´ m√°y</span></p>
                                        <p className={`text-xs ${isDark ? 'text-gray-500' : 'text-gray-400'}`}>H·ªó tr·ª£: .CSV, .TBX, .XLSX</p>
                                    </div>
                                    <input type="file" className="absolute w-full h-full opacity-0 cursor-pointer" accept=".csv,.tbx,.xlsx" />
                                </div>
                            </div>
                        </div>

                        {/* Footer */}
                        <div className={`p-6 border-t flex justify-end space-x-3 ${isDark ? 'border-gray-700' : 'border-gray-100'}`}>
                            <button 
                                onClick={onClose} 
                                className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors border ${isDark ? 'border-gray-600 text-gray-300 hover:bg-white/10' : 'border-gray-300 text-gray-600 hover:bg-gray-100'}`}
                            >
                                H·ªßy
                            </button>
                            <button className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${isDark ? 'bg-white text-black hover:bg-gray-200' : 'bg-primary text-white hover:bg-primary/80'}`}>
                                T·∫£i l√™n
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Kh·∫Øc ph·ª•c l·ªói: Thay th·∫ø khai b√°o arrow function b·∫±ng khai b√°o function truy·ªÅn th·ªëng
        // ƒë·ªÉ ƒë·∫£m b·∫£o hoisting v√† truy c·∫≠p ƒë∆∞·ª£c ·ªü cu·ªëi script.
        function App() {
            const [isDark, setIsDark] = useState(false);
            const [tab, setTab] = useState(0);
            const [isUploadModalOpen, setIsUploadModalOpen] = useState(false); // NEW STATE for Modal

            const toggleTheme = () => setIsDark(!isDark);

            return (
                <div className={`shadow-2xl rounded-lg overflow-hidden flex flex-col transition-all duration-300 border ${isDark ? 'dark bg-paper-dark border-gray-700' : 'bg-[#fdfcf8] border-[#e6e4dc]'}`} style={{ width: '1000px', height: '700px' }}>
                    
                    {/* Window Title Bar */}
                    <TitleBar isDark={isDark} />

                    {/* Main Content Area */}
                    <div className="flex flex-1 overflow-hidden">
                        
                        {/* Sidebar */}
                        <div className={`w-64 flex flex-col p-4 border-r transition-colors duration-300 overflow-y-auto ${isDark ? 'bg-sidebar-dark border-gray-800' : 'bg-[#f4f2ed] border-[#e6e4dc]'}`}>
                            
                            {/* User Profile Snippet */}
                            <div className="mb-8 px-2 flex items-center space-x-3">
                                {/* Used bg-white/10 in dark mode for monochrome look */}
                                <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-md ${isDark ? 'bg-white/10' : 'bg-gradient-to-tr from-primary/70 to-primary'}`}>
                                    FL
                                </div>
                                <div>
                                    <div className={`text-sm font-bold ${isDark ? 'text-gray-200' : 'text-primary'}`}>Flux User</div>
                                    {/* Used text-white/70 in dark mode */}
                                    <div className={`text-[10px] ${isDark ? 'text-white/70' : 'text-primary'}`}>Premium Account</div>
                                </div>
                            </div>

                            <div className="space-y-1 flex-1">
                                <SidebarItem icon="fa-language" label="D·ªãch thu·∫≠t" isActive={tab === 0} onClick={() => setTab(0)} isDark={isDark} />
                                <SidebarItem icon="fa-clock-rotate-left" label="L·ªãch s·ª≠" isActive={tab === 1} onClick={() => setTab(1)} isDark={isDark} />
                                <SidebarItem icon="fa-book-open-reader" label="T·ª´ ƒëi·ªÉn" isActive={tab === 3} onClick={() => setTab(3)} isDark={isDark} />
                            </div>

                            <div className="pt-4 border-t border-gray-500/10">
                                <SidebarItem icon="fa-gear" label="C√†i ƒë·∫∑t" isActive={tab === 2} onClick={() => setTab(2)} isDark={isDark} />
                            </div>
                        </div>

                        {/* Content View */}
                        <div className={`flex-1 overflow-hidden relative transition-colors duration-300 ${isDark ? 'bg-paper-dark' : 'bg-paper-light'}`}>
                             {tab === 0 && <TranslateScreen isDark={isDark} />}
                             {tab === 1 && <HistoryScreen isDark={isDark} />}
                             {tab === 2 && <SettingsScreen isDark={isDark} toggleTheme={toggleTheme} />}
                             {tab === 3 && <DictionaryScreen 
                                                isDark={isDark} 
                                                openModal={() => setIsUploadModalOpen(true)} // Truy·ªÅn h√†m m·ªü modal
                                            />}
                        </div>

                    </div>
                    
                    {/* NEW: Upload Modal Component */}
                    <UploadDictionaryModal 
                        isOpen={isUploadModalOpen} 
                        onClose={() => setIsUploadModalOpen(false)} 
                        isDark={isDark} 
                    />

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
</file>

<file path="windows/.gitignore">
flutter/ephemeral/

# Visual Studio user-specific files.
*.suo
*.user
*.userosscache
*.sln.docstates

# Visual Studio build-related files.
x64/
x86/

# Visual Studio cache files
# files ending in .cache can be ignored
*.[Cc]ache
# but keep track of directories ending in .cache
!*.[Cc]ache/
</file>

<file path="windows/CMakeLists.txt">
# Project-level configuration.
cmake_minimum_required(VERSION 3.14)
project(flux_origin LANGUAGES CXX)

# The name of the executable created for the application. Change this to change
# the on-disk name of your application.
set(BINARY_NAME "flux_origin")

# Explicitly opt in to modern CMake behaviors to avoid warnings with recent
# versions of CMake.
cmake_policy(VERSION 3.14...3.25)

# Define build configuration option.
get_property(IS_MULTICONFIG GLOBAL PROPERTY GENERATOR_IS_MULTI_CONFIG)
if(IS_MULTICONFIG)
  set(CMAKE_CONFIGURATION_TYPES "Debug;Profile;Release"
    CACHE STRING "" FORCE)
else()
  if(NOT CMAKE_BUILD_TYPE AND NOT CMAKE_CONFIGURATION_TYPES)
    set(CMAKE_BUILD_TYPE "Debug" CACHE
      STRING "Flutter build mode" FORCE)
    set_property(CACHE CMAKE_BUILD_TYPE PROPERTY STRINGS
      "Debug" "Profile" "Release")
  endif()
endif()
# Define settings for the Profile build mode.
set(CMAKE_EXE_LINKER_FLAGS_PROFILE "${CMAKE_EXE_LINKER_FLAGS_RELEASE}")
set(CMAKE_SHARED_LINKER_FLAGS_PROFILE "${CMAKE_SHARED_LINKER_FLAGS_RELEASE}")
set(CMAKE_C_FLAGS_PROFILE "${CMAKE_C_FLAGS_RELEASE}")
set(CMAKE_CXX_FLAGS_PROFILE "${CMAKE_CXX_FLAGS_RELEASE}")

# Use Unicode for all projects.
add_definitions(-DUNICODE -D_UNICODE)

# Compilation settings that should be applied to most targets.
#
# Be cautious about adding new options here, as plugins use this function by
# default. In most cases, you should add new options to specific targets instead
# of modifying this function.
function(APPLY_STANDARD_SETTINGS TARGET)
  target_compile_features(${TARGET} PUBLIC cxx_std_17)
  target_compile_options(${TARGET} PRIVATE /W4 /WX /wd"4100")
  target_compile_options(${TARGET} PRIVATE /EHsc)
  target_compile_definitions(${TARGET} PRIVATE "_HAS_EXCEPTIONS=0")
  target_compile_definitions(${TARGET} PRIVATE "$<$<CONFIG:Debug>:_DEBUG>")
endfunction()

# Flutter library and tool build rules.
set(FLUTTER_MANAGED_DIR "${CMAKE_CURRENT_SOURCE_DIR}/flutter")
add_subdirectory(${FLUTTER_MANAGED_DIR})

# Application build; see runner/CMakeLists.txt.
add_subdirectory("runner")


# Generated plugin build rules, which manage building the plugins and adding
# them to the application.
include(flutter/generated_plugins.cmake)


# === Installation ===
# Support files are copied into place next to the executable, so that it can
# run in place. This is done instead of making a separate bundle (as on Linux)
# so that building and running from within Visual Studio will work.
set(BUILD_BUNDLE_DIR "$<TARGET_FILE_DIR:${BINARY_NAME}>")
# Make the "install" step default, as it's required to run.
set(CMAKE_VS_INCLUDE_INSTALL_TO_DEFAULT_BUILD 1)
if(CMAKE_INSTALL_PREFIX_INITIALIZED_TO_DEFAULT)
  set(CMAKE_INSTALL_PREFIX "${BUILD_BUNDLE_DIR}" CACHE PATH "..." FORCE)
endif()

set(INSTALL_BUNDLE_DATA_DIR "${CMAKE_INSTALL_PREFIX}/data")
set(INSTALL_BUNDLE_LIB_DIR "${CMAKE_INSTALL_PREFIX}")

install(TARGETS ${BINARY_NAME} RUNTIME DESTINATION "${CMAKE_INSTALL_PREFIX}"
  COMPONENT Runtime)

install(FILES "${FLUTTER_ICU_DATA_FILE}" DESTINATION "${INSTALL_BUNDLE_DATA_DIR}"
  COMPONENT Runtime)

install(FILES "${FLUTTER_LIBRARY}" DESTINATION "${INSTALL_BUNDLE_LIB_DIR}"
  COMPONENT Runtime)

if(PLUGIN_BUNDLED_LIBRARIES)
  install(FILES "${PLUGIN_BUNDLED_LIBRARIES}"
    DESTINATION "${INSTALL_BUNDLE_LIB_DIR}"
    COMPONENT Runtime)
endif()

# Copy the native assets provided by the build.dart from all packages.
set(NATIVE_ASSETS_DIR "${PROJECT_BUILD_DIR}native_assets/windows/")
install(DIRECTORY "${NATIVE_ASSETS_DIR}"
   DESTINATION "${INSTALL_BUNDLE_LIB_DIR}"
   COMPONENT Runtime)

# Fully re-copy the assets directory on each build to avoid having stale files
# from a previous install.
set(FLUTTER_ASSET_DIR_NAME "flutter_assets")
install(CODE "
  file(REMOVE_RECURSE \"${INSTALL_BUNDLE_DATA_DIR}/${FLUTTER_ASSET_DIR_NAME}\")
  " COMPONENT Runtime)
install(DIRECTORY "${PROJECT_BUILD_DIR}/${FLUTTER_ASSET_DIR_NAME}"
  DESTINATION "${INSTALL_BUNDLE_DATA_DIR}" COMPONENT Runtime)

# Install the AOT library on non-Debug builds only.
install(FILES "${AOT_LIBRARY}" DESTINATION "${INSTALL_BUNDLE_DATA_DIR}"
  CONFIGURATIONS Profile;Release
  COMPONENT Runtime)
</file>

<file path="windows/flutter/CMakeLists.txt">
# This file controls Flutter-level build steps. It should not be edited.
cmake_minimum_required(VERSION 3.14)

set(EPHEMERAL_DIR "${CMAKE_CURRENT_SOURCE_DIR}/ephemeral")

# Configuration provided via flutter tool.
include(${EPHEMERAL_DIR}/generated_config.cmake)

# TODO: Move the rest of this into files in ephemeral. See
# https://github.com/flutter/flutter/issues/57146.
set(WRAPPER_ROOT "${EPHEMERAL_DIR}/cpp_client_wrapper")

# Set fallback configurations for older versions of the flutter tool.
if (NOT DEFINED FLUTTER_TARGET_PLATFORM)
  set(FLUTTER_TARGET_PLATFORM "windows-x64")
endif()

# === Flutter Library ===
set(FLUTTER_LIBRARY "${EPHEMERAL_DIR}/flutter_windows.dll")

# Published to parent scope for install step.
set(FLUTTER_LIBRARY ${FLUTTER_LIBRARY} PARENT_SCOPE)
set(FLUTTER_ICU_DATA_FILE "${EPHEMERAL_DIR}/icudtl.dat" PARENT_SCOPE)
set(PROJECT_BUILD_DIR "${PROJECT_DIR}/build/" PARENT_SCOPE)
set(AOT_LIBRARY "${PROJECT_DIR}/build/windows/app.so" PARENT_SCOPE)

list(APPEND FLUTTER_LIBRARY_HEADERS
  "flutter_export.h"
  "flutter_windows.h"
  "flutter_messenger.h"
  "flutter_plugin_registrar.h"
  "flutter_texture_registrar.h"
)
list(TRANSFORM FLUTTER_LIBRARY_HEADERS PREPEND "${EPHEMERAL_DIR}/")
add_library(flutter INTERFACE)
target_include_directories(flutter INTERFACE
  "${EPHEMERAL_DIR}"
)
target_link_libraries(flutter INTERFACE "${FLUTTER_LIBRARY}.lib")
add_dependencies(flutter flutter_assemble)

# === Wrapper ===
list(APPEND CPP_WRAPPER_SOURCES_CORE
  "core_implementations.cc"
  "standard_codec.cc"
)
list(TRANSFORM CPP_WRAPPER_SOURCES_CORE PREPEND "${WRAPPER_ROOT}/")
list(APPEND CPP_WRAPPER_SOURCES_PLUGIN
  "plugin_registrar.cc"
)
list(TRANSFORM CPP_WRAPPER_SOURCES_PLUGIN PREPEND "${WRAPPER_ROOT}/")
list(APPEND CPP_WRAPPER_SOURCES_APP
  "flutter_engine.cc"
  "flutter_view_controller.cc"
)
list(TRANSFORM CPP_WRAPPER_SOURCES_APP PREPEND "${WRAPPER_ROOT}/")

# Wrapper sources needed for a plugin.
add_library(flutter_wrapper_plugin STATIC
  ${CPP_WRAPPER_SOURCES_CORE}
  ${CPP_WRAPPER_SOURCES_PLUGIN}
)
apply_standard_settings(flutter_wrapper_plugin)
set_target_properties(flutter_wrapper_plugin PROPERTIES
  POSITION_INDEPENDENT_CODE ON)
set_target_properties(flutter_wrapper_plugin PROPERTIES
  CXX_VISIBILITY_PRESET hidden)
target_link_libraries(flutter_wrapper_plugin PUBLIC flutter)
target_include_directories(flutter_wrapper_plugin PUBLIC
  "${WRAPPER_ROOT}/include"
)
add_dependencies(flutter_wrapper_plugin flutter_assemble)

# Wrapper sources needed for the runner.
add_library(flutter_wrapper_app STATIC
  ${CPP_WRAPPER_SOURCES_CORE}
  ${CPP_WRAPPER_SOURCES_APP}
)
apply_standard_settings(flutter_wrapper_app)
target_link_libraries(flutter_wrapper_app PUBLIC flutter)
target_include_directories(flutter_wrapper_app PUBLIC
  "${WRAPPER_ROOT}/include"
)
add_dependencies(flutter_wrapper_app flutter_assemble)

# === Flutter tool backend ===
# _phony_ is a non-existent file to force this command to run every time,
# since currently there's no way to get a full input/output list from the
# flutter tool.
set(PHONY_OUTPUT "${CMAKE_CURRENT_BINARY_DIR}/_phony_")
set_source_files_properties("${PHONY_OUTPUT}" PROPERTIES SYMBOLIC TRUE)
add_custom_command(
  OUTPUT ${FLUTTER_LIBRARY} ${FLUTTER_LIBRARY_HEADERS}
    ${CPP_WRAPPER_SOURCES_CORE} ${CPP_WRAPPER_SOURCES_PLUGIN}
    ${CPP_WRAPPER_SOURCES_APP}
    ${PHONY_OUTPUT}
  COMMAND ${CMAKE_COMMAND} -E env
    ${FLUTTER_TOOL_ENVIRONMENT}
    "${FLUTTER_ROOT}/packages/flutter_tools/bin/tool_backend.bat"
      ${FLUTTER_TARGET_PLATFORM} $<CONFIG>
  VERBATIM
)
add_custom_target(flutter_assemble DEPENDS
  "${FLUTTER_LIBRARY}"
  ${FLUTTER_LIBRARY_HEADERS}
  ${CPP_WRAPPER_SOURCES_CORE}
  ${CPP_WRAPPER_SOURCES_PLUGIN}
  ${CPP_WRAPPER_SOURCES_APP}
)
</file>

<file path="windows/flutter/generated_plugin_registrant.h">
//
//  Generated file. Do not edit.
//

// clang-format off

#ifndef GENERATED_PLUGIN_REGISTRANT_
#define GENERATED_PLUGIN_REGISTRANT_

#include <flutter/plugin_registry.h>

// Registers Flutter plugins.
void RegisterPlugins(flutter::PluginRegistry* registry);

#endif  // GENERATED_PLUGIN_REGISTRANT_
</file>

<file path="windows/runner/CMakeLists.txt">
cmake_minimum_required(VERSION 3.14)
project(runner LANGUAGES CXX)

# Define the application target. To change its name, change BINARY_NAME in the
# top-level CMakeLists.txt, not the value here, or `flutter run` will no longer
# work.
#
# Any new source files that you add to the application should be added here.
add_executable(${BINARY_NAME} WIN32
  "flutter_window.cpp"
  "main.cpp"
  "utils.cpp"
  "win32_window.cpp"
  "${FLUTTER_MANAGED_DIR}/generated_plugin_registrant.cc"
  "Runner.rc"
  "runner.exe.manifest"
)

# Apply the standard set of build settings. This can be removed for applications
# that need different build settings.
apply_standard_settings(${BINARY_NAME})

# Add preprocessor definitions for the build version.
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION=\"${FLUTTER_VERSION}\"")
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION_MAJOR=${FLUTTER_VERSION_MAJOR}")
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION_MINOR=${FLUTTER_VERSION_MINOR}")
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION_PATCH=${FLUTTER_VERSION_PATCH}")
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION_BUILD=${FLUTTER_VERSION_BUILD}")

# Disable Windows macros that collide with C++ standard library functions.
target_compile_definitions(${BINARY_NAME} PRIVATE "NOMINMAX")

# Add dependency libraries and include directories. Add any application-specific
# dependencies here.
target_link_libraries(${BINARY_NAME} PRIVATE flutter flutter_wrapper_app)
target_link_libraries(${BINARY_NAME} PRIVATE "dwmapi.lib")
target_include_directories(${BINARY_NAME} PRIVATE "${CMAKE_SOURCE_DIR}")

# Run the Flutter tool portions of the build. This must not be removed.
add_dependencies(${BINARY_NAME} flutter_assemble)
</file>

<file path="windows/runner/flutter_window.cpp">
#include "flutter_window.h"

#include <optional>

#include "flutter/generated_plugin_registrant.h"

FlutterWindow::FlutterWindow(const flutter::DartProject& project)
    : project_(project) {}

FlutterWindow::~FlutterWindow() {}

bool FlutterWindow::OnCreate() {
  if (!Win32Window::OnCreate()) {
    return false;
  }

  RECT frame = GetClientArea();

  // The size here must match the window dimensions to avoid unnecessary surface
  // creation / destruction in the startup path.
  flutter_controller_ = std::make_unique<flutter::FlutterViewController>(
      frame.right - frame.left, frame.bottom - frame.top, project_);
  // Ensure that basic setup of the controller was successful.
  if (!flutter_controller_->engine() || !flutter_controller_->view()) {
    return false;
  }
  RegisterPlugins(flutter_controller_->engine());
  SetChildContent(flutter_controller_->view()->GetNativeWindow());

  flutter_controller_->engine()->SetNextFrameCallback([&]() {
    this->Show();
  });

  // Flutter can complete the first frame before the "show window" callback is
  // registered. The following call ensures a frame is pending to ensure the
  // window is shown. It is a no-op if the first frame hasn't completed yet.
  flutter_controller_->ForceRedraw();

  return true;
}

void FlutterWindow::OnDestroy() {
  if (flutter_controller_) {
    flutter_controller_ = nullptr;
  }

  Win32Window::OnDestroy();
}

LRESULT
FlutterWindow::MessageHandler(HWND hwnd, UINT const message,
                              WPARAM const wparam,
                              LPARAM const lparam) noexcept {
  // Give Flutter, including plugins, an opportunity to handle window messages.
  if (flutter_controller_) {
    std::optional<LRESULT> result =
        flutter_controller_->HandleTopLevelWindowProc(hwnd, message, wparam,
                                                      lparam);
    if (result) {
      return *result;
    }
  }

  switch (message) {
    case WM_FONTCHANGE:
      flutter_controller_->engine()->ReloadSystemFonts();
      break;
  }

  return Win32Window::MessageHandler(hwnd, message, wparam, lparam);
}
</file>

<file path="windows/runner/flutter_window.h">
#ifndef RUNNER_FLUTTER_WINDOW_H_
#define RUNNER_FLUTTER_WINDOW_H_

#include <flutter/dart_project.h>
#include <flutter/flutter_view_controller.h>

#include <memory>

#include "win32_window.h"

// A window that does nothing but host a Flutter view.
class FlutterWindow : public Win32Window {
 public:
  // Creates a new FlutterWindow hosting a Flutter view running |project|.
  explicit FlutterWindow(const flutter::DartProject& project);
  virtual ~FlutterWindow();

 protected:
  // Win32Window:
  bool OnCreate() override;
  void OnDestroy() override;
  LRESULT MessageHandler(HWND window, UINT const message, WPARAM const wparam,
                         LPARAM const lparam) noexcept override;

 private:
  // The project to run.
  flutter::DartProject project_;

  // The Flutter instance hosted by this window.
  std::unique_ptr<flutter::FlutterViewController> flutter_controller_;
};

#endif  // RUNNER_FLUTTER_WINDOW_H_
</file>

<file path="windows/runner/main.cpp">
#include <flutter/dart_project.h>
#include <flutter/flutter_view_controller.h>
#include <windows.h>

#include "flutter_window.h"
#include "utils.h"

int APIENTRY wWinMain(_In_ HINSTANCE instance, _In_opt_ HINSTANCE prev,
                      _In_ wchar_t *command_line, _In_ int show_command) {
  // Attach to console when present (e.g., 'flutter run') or create a
  // new console when running with a debugger.
  if (!::AttachConsole(ATTACH_PARENT_PROCESS) && ::IsDebuggerPresent()) {
    CreateAndAttachConsole();
  }

  // Initialize COM, so that it is available for use in the library and/or
  // plugins.
  ::CoInitializeEx(nullptr, COINIT_APARTMENTTHREADED);

  flutter::DartProject project(L"data");

  std::vector<std::string> command_line_arguments =
      GetCommandLineArguments();

  project.set_dart_entrypoint_arguments(std::move(command_line_arguments));

  FlutterWindow window(project);
  Win32Window::Point origin(10, 10);
  Win32Window::Size size(1280, 720);
  if (!window.Create(L"flux_origin", origin, size)) {
    return EXIT_FAILURE;
  }
  window.SetQuitOnClose(true);

  ::MSG msg;
  while (::GetMessage(&msg, nullptr, 0, 0)) {
    ::TranslateMessage(&msg);
    ::DispatchMessage(&msg);
  }

  ::CoUninitialize();
  return EXIT_SUCCESS;
}
</file>

<file path="windows/runner/resource.h">
//{{NO_DEPENDENCIES}}
// Microsoft Visual C++ generated include file.
// Used by Runner.rc
//
#define IDI_APP_ICON                    101

// Next default values for new objects
//
#ifdef APSTUDIO_INVOKED
#ifndef APSTUDIO_READONLY_SYMBOLS
#define _APS_NEXT_RESOURCE_VALUE        102
#define _APS_NEXT_COMMAND_VALUE         40001
#define _APS_NEXT_CONTROL_VALUE         1001
#define _APS_NEXT_SYMED_VALUE           101
#endif
#endif
</file>

<file path="windows/runner/runner.exe.manifest">
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<assembly xmlns="urn:schemas-microsoft-com:asm.v1" manifestVersion="1.0">
  <application xmlns="urn:schemas-microsoft-com:asm.v3">
    <windowsSettings>
      <dpiAwareness xmlns="http://schemas.microsoft.com/SMI/2016/WindowsSettings">PerMonitorV2</dpiAwareness>
    </windowsSettings>
  </application>
  <compatibility xmlns="urn:schemas-microsoft-com:compatibility.v1">
    <application>
      <!-- Windows 10 and Windows 11 -->
      <supportedOS Id="{8e0f7a12-bfb3-4fe8-b9a5-48fd50a15a9a}"/>
    </application>
  </compatibility>
</assembly>
</file>

<file path="windows/runner/utils.cpp">
#include "utils.h"

#include <flutter_windows.h>
#include <io.h>
#include <stdio.h>
#include <windows.h>

#include <iostream>

void CreateAndAttachConsole() {
  if (::AllocConsole()) {
    FILE *unused;
    if (freopen_s(&unused, "CONOUT$", "w", stdout)) {
      _dup2(_fileno(stdout), 1);
    }
    if (freopen_s(&unused, "CONOUT$", "w", stderr)) {
      _dup2(_fileno(stdout), 2);
    }
    std::ios::sync_with_stdio();
    FlutterDesktopResyncOutputStreams();
  }
}

std::vector<std::string> GetCommandLineArguments() {
  // Convert the UTF-16 command line arguments to UTF-8 for the Engine to use.
  int argc;
  wchar_t** argv = ::CommandLineToArgvW(::GetCommandLineW(), &argc);
  if (argv == nullptr) {
    return std::vector<std::string>();
  }

  std::vector<std::string> command_line_arguments;

  // Skip the first argument as it's the binary name.
  for (int i = 1; i < argc; i++) {
    command_line_arguments.push_back(Utf8FromUtf16(argv[i]));
  }

  ::LocalFree(argv);

  return command_line_arguments;
}

std::string Utf8FromUtf16(const wchar_t* utf16_string) {
  if (utf16_string == nullptr) {
    return std::string();
  }
  unsigned int target_length = ::WideCharToMultiByte(
      CP_UTF8, WC_ERR_INVALID_CHARS, utf16_string,
      -1, nullptr, 0, nullptr, nullptr)
    -1; // remove the trailing null character
  int input_length = (int)wcslen(utf16_string);
  std::string utf8_string;
  if (target_length == 0 || target_length > utf8_string.max_size()) {
    return utf8_string;
  }
  utf8_string.resize(target_length);
  int converted_length = ::WideCharToMultiByte(
      CP_UTF8, WC_ERR_INVALID_CHARS, utf16_string,
      input_length, utf8_string.data(), target_length, nullptr, nullptr);
  if (converted_length == 0) {
    return std::string();
  }
  return utf8_string;
}
</file>

<file path="windows/runner/utils.h">
#ifndef RUNNER_UTILS_H_
#define RUNNER_UTILS_H_

#include <string>
#include <vector>

// Creates a console for the process, and redirects stdout and stderr to
// it for both the runner and the Flutter library.
void CreateAndAttachConsole();

// Takes a null-terminated wchar_t* encoded in UTF-16 and returns a std::string
// encoded in UTF-8. Returns an empty std::string on failure.
std::string Utf8FromUtf16(const wchar_t* utf16_string);

// Gets the command line arguments passed in as a std::vector<std::string>,
// encoded in UTF-8. Returns an empty std::vector<std::string> on failure.
std::vector<std::string> GetCommandLineArguments();

#endif  // RUNNER_UTILS_H_
</file>

<file path="windows/runner/win32_window.cpp">
#include "win32_window.h"

#include <dwmapi.h>
#include <flutter_windows.h>

#include "resource.h"

namespace {

/// Window attribute that enables dark mode window decorations.
///
/// Redefined in case the developer's machine has a Windows SDK older than
/// version 10.0.22000.0.
/// See: https://docs.microsoft.com/windows/win32/api/dwmapi/ne-dwmapi-dwmwindowattribute
#ifndef DWMWA_USE_IMMERSIVE_DARK_MODE
#define DWMWA_USE_IMMERSIVE_DARK_MODE 20
#endif

constexpr const wchar_t kWindowClassName[] = L"FLUTTER_RUNNER_WIN32_WINDOW";

/// Registry key for app theme preference.
///
/// A value of 0 indicates apps should use dark mode. A non-zero or missing
/// value indicates apps should use light mode.
constexpr const wchar_t kGetPreferredBrightnessRegKey[] =
  L"Software\\Microsoft\\Windows\\CurrentVersion\\Themes\\Personalize";
constexpr const wchar_t kGetPreferredBrightnessRegValue[] = L"AppsUseLightTheme";

// The number of Win32Window objects that currently exist.
static int g_active_window_count = 0;

using EnableNonClientDpiScaling = BOOL __stdcall(HWND hwnd);

// Scale helper to convert logical scaler values to physical using passed in
// scale factor
int Scale(int source, double scale_factor) {
  return static_cast<int>(source * scale_factor);
}

// Dynamically loads the |EnableNonClientDpiScaling| from the User32 module.
// This API is only needed for PerMonitor V1 awareness mode.
void EnableFullDpiSupportIfAvailable(HWND hwnd) {
  HMODULE user32_module = LoadLibraryA("User32.dll");
  if (!user32_module) {
    return;
  }
  auto enable_non_client_dpi_scaling =
      reinterpret_cast<EnableNonClientDpiScaling*>(
          GetProcAddress(user32_module, "EnableNonClientDpiScaling"));
  if (enable_non_client_dpi_scaling != nullptr) {
    enable_non_client_dpi_scaling(hwnd);
  }
  FreeLibrary(user32_module);
}

}  // namespace

// Manages the Win32Window's window class registration.
class WindowClassRegistrar {
 public:
  ~WindowClassRegistrar() = default;

  // Returns the singleton registrar instance.
  static WindowClassRegistrar* GetInstance() {
    if (!instance_) {
      instance_ = new WindowClassRegistrar();
    }
    return instance_;
  }

  // Returns the name of the window class, registering the class if it hasn't
  // previously been registered.
  const wchar_t* GetWindowClass();

  // Unregisters the window class. Should only be called if there are no
  // instances of the window.
  void UnregisterWindowClass();

 private:
  WindowClassRegistrar() = default;

  static WindowClassRegistrar* instance_;

  bool class_registered_ = false;
};

WindowClassRegistrar* WindowClassRegistrar::instance_ = nullptr;

const wchar_t* WindowClassRegistrar::GetWindowClass() {
  if (!class_registered_) {
    WNDCLASS window_class{};
    window_class.hCursor = LoadCursor(nullptr, IDC_ARROW);
    window_class.lpszClassName = kWindowClassName;
    window_class.style = CS_HREDRAW | CS_VREDRAW;
    window_class.cbClsExtra = 0;
    window_class.cbWndExtra = 0;
    window_class.hInstance = GetModuleHandle(nullptr);
    window_class.hIcon =
        LoadIcon(window_class.hInstance, MAKEINTRESOURCE(IDI_APP_ICON));
    window_class.hbrBackground = 0;
    window_class.lpszMenuName = nullptr;
    window_class.lpfnWndProc = Win32Window::WndProc;
    RegisterClass(&window_class);
    class_registered_ = true;
  }
  return kWindowClassName;
}

void WindowClassRegistrar::UnregisterWindowClass() {
  UnregisterClass(kWindowClassName, nullptr);
  class_registered_ = false;
}

Win32Window::Win32Window() {
  ++g_active_window_count;
}

Win32Window::~Win32Window() {
  --g_active_window_count;
  Destroy();
}

bool Win32Window::Create(const std::wstring& title,
                         const Point& origin,
                         const Size& size) {
  Destroy();

  const wchar_t* window_class =
      WindowClassRegistrar::GetInstance()->GetWindowClass();

  const POINT target_point = {static_cast<LONG>(origin.x),
                              static_cast<LONG>(origin.y)};
  HMONITOR monitor = MonitorFromPoint(target_point, MONITOR_DEFAULTTONEAREST);
  UINT dpi = FlutterDesktopGetDpiForMonitor(monitor);
  double scale_factor = dpi / 96.0;

  HWND window = CreateWindow(
      window_class, title.c_str(), WS_OVERLAPPEDWINDOW,
      Scale(origin.x, scale_factor), Scale(origin.y, scale_factor),
      Scale(size.width, scale_factor), Scale(size.height, scale_factor),
      nullptr, nullptr, GetModuleHandle(nullptr), this);

  if (!window) {
    return false;
  }

  UpdateTheme(window);

  return OnCreate();
}

bool Win32Window::Show() {
  return ShowWindow(window_handle_, SW_SHOWNORMAL);
}

// static
LRESULT CALLBACK Win32Window::WndProc(HWND const window,
                                      UINT const message,
                                      WPARAM const wparam,
                                      LPARAM const lparam) noexcept {
  if (message == WM_NCCREATE) {
    auto window_struct = reinterpret_cast<CREATESTRUCT*>(lparam);
    SetWindowLongPtr(window, GWLP_USERDATA,
                     reinterpret_cast<LONG_PTR>(window_struct->lpCreateParams));

    auto that = static_cast<Win32Window*>(window_struct->lpCreateParams);
    EnableFullDpiSupportIfAvailable(window);
    that->window_handle_ = window;
  } else if (Win32Window* that = GetThisFromHandle(window)) {
    return that->MessageHandler(window, message, wparam, lparam);
  }

  return DefWindowProc(window, message, wparam, lparam);
}

LRESULT
Win32Window::MessageHandler(HWND hwnd,
                            UINT const message,
                            WPARAM const wparam,
                            LPARAM const lparam) noexcept {
  switch (message) {
    case WM_DESTROY:
      window_handle_ = nullptr;
      Destroy();
      if (quit_on_close_) {
        PostQuitMessage(0);
      }
      return 0;

    case WM_DPICHANGED: {
      auto newRectSize = reinterpret_cast<RECT*>(lparam);
      LONG newWidth = newRectSize->right - newRectSize->left;
      LONG newHeight = newRectSize->bottom - newRectSize->top;

      SetWindowPos(hwnd, nullptr, newRectSize->left, newRectSize->top, newWidth,
                   newHeight, SWP_NOZORDER | SWP_NOACTIVATE);

      return 0;
    }
    case WM_SIZE: {
      RECT rect = GetClientArea();
      if (child_content_ != nullptr) {
        // Size and position the child window.
        MoveWindow(child_content_, rect.left, rect.top, rect.right - rect.left,
                   rect.bottom - rect.top, TRUE);
      }
      return 0;
    }

    case WM_ACTIVATE:
      if (child_content_ != nullptr) {
        SetFocus(child_content_);
      }
      return 0;

    case WM_DWMCOLORIZATIONCOLORCHANGED:
      UpdateTheme(hwnd);
      return 0;
  }

  return DefWindowProc(window_handle_, message, wparam, lparam);
}

void Win32Window::Destroy() {
  OnDestroy();

  if (window_handle_) {
    DestroyWindow(window_handle_);
    window_handle_ = nullptr;
  }
  if (g_active_window_count == 0) {
    WindowClassRegistrar::GetInstance()->UnregisterWindowClass();
  }
}

Win32Window* Win32Window::GetThisFromHandle(HWND const window) noexcept {
  return reinterpret_cast<Win32Window*>(
      GetWindowLongPtr(window, GWLP_USERDATA));
}

void Win32Window::SetChildContent(HWND content) {
  child_content_ = content;
  SetParent(content, window_handle_);
  RECT frame = GetClientArea();

  MoveWindow(content, frame.left, frame.top, frame.right - frame.left,
             frame.bottom - frame.top, true);

  SetFocus(child_content_);
}

RECT Win32Window::GetClientArea() {
  RECT frame;
  GetClientRect(window_handle_, &frame);
  return frame;
}

HWND Win32Window::GetHandle() {
  return window_handle_;
}

void Win32Window::SetQuitOnClose(bool quit_on_close) {
  quit_on_close_ = quit_on_close;
}

bool Win32Window::OnCreate() {
  // No-op; provided for subclasses.
  return true;
}

void Win32Window::OnDestroy() {
  // No-op; provided for subclasses.
}

void Win32Window::UpdateTheme(HWND const window) {
  DWORD light_mode;
  DWORD light_mode_size = sizeof(light_mode);
  LSTATUS result = RegGetValue(HKEY_CURRENT_USER, kGetPreferredBrightnessRegKey,
                               kGetPreferredBrightnessRegValue,
                               RRF_RT_REG_DWORD, nullptr, &light_mode,
                               &light_mode_size);

  if (result == ERROR_SUCCESS) {
    BOOL enable_dark_mode = light_mode == 0;
    DwmSetWindowAttribute(window, DWMWA_USE_IMMERSIVE_DARK_MODE,
                          &enable_dark_mode, sizeof(enable_dark_mode));
  }
}
</file>

<file path="windows/runner/win32_window.h">
#ifndef RUNNER_WIN32_WINDOW_H_
#define RUNNER_WIN32_WINDOW_H_

#include <windows.h>

#include <functional>
#include <memory>
#include <string>

// A class abstraction for a high DPI-aware Win32 Window. Intended to be
// inherited from by classes that wish to specialize with custom
// rendering and input handling
class Win32Window {
 public:
  struct Point {
    unsigned int x;
    unsigned int y;
    Point(unsigned int x, unsigned int y) : x(x), y(y) {}
  };

  struct Size {
    unsigned int width;
    unsigned int height;
    Size(unsigned int width, unsigned int height)
        : width(width), height(height) {}
  };

  Win32Window();
  virtual ~Win32Window();

  // Creates a win32 window with |title| that is positioned and sized using
  // |origin| and |size|. New windows are created on the default monitor. Window
  // sizes are specified to the OS in physical pixels, hence to ensure a
  // consistent size this function will scale the inputted width and height as
  // as appropriate for the default monitor. The window is invisible until
  // |Show| is called. Returns true if the window was created successfully.
  bool Create(const std::wstring& title, const Point& origin, const Size& size);

  // Show the current window. Returns true if the window was successfully shown.
  bool Show();

  // Release OS resources associated with window.
  void Destroy();

  // Inserts |content| into the window tree.
  void SetChildContent(HWND content);

  // Returns the backing Window handle to enable clients to set icon and other
  // window properties. Returns nullptr if the window has been destroyed.
  HWND GetHandle();

  // If true, closing this window will quit the application.
  void SetQuitOnClose(bool quit_on_close);

  // Return a RECT representing the bounds of the current client area.
  RECT GetClientArea();

 protected:
  // Processes and route salient window messages for mouse handling,
  // size change and DPI. Delegates handling of these to member overloads that
  // inheriting classes can handle.
  virtual LRESULT MessageHandler(HWND window,
                                 UINT const message,
                                 WPARAM const wparam,
                                 LPARAM const lparam) noexcept;

  // Called when CreateAndShow is called, allowing subclass window-related
  // setup. Subclasses should return false if setup fails.
  virtual bool OnCreate();

  // Called when Destroy is called.
  virtual void OnDestroy();

 private:
  friend class WindowClassRegistrar;

  // OS callback called by message pump. Handles the WM_NCCREATE message which
  // is passed when the non-client area is being created and enables automatic
  // non-client DPI scaling so that the non-client area automatically
  // responds to changes in DPI. All other messages are handled by
  // MessageHandler.
  static LRESULT CALLBACK WndProc(HWND const window,
                                  UINT const message,
                                  WPARAM const wparam,
                                  LPARAM const lparam) noexcept;

  // Retrieves a class instance pointer for |window|
  static Win32Window* GetThisFromHandle(HWND const window) noexcept;

  // Update the window frame's theme to match the system theme.
  static void UpdateTheme(HWND const window);

  bool quit_on_close_ = false;

  // window handle for top level window.
  HWND window_handle_ = nullptr;

  // window handle for hosted content.
  HWND child_content_ = nullptr;
};

#endif  // RUNNER_WIN32_WINDOW_H_
</file>

<file path=".gitignore">
# Miscellaneous
*.class
*.log
*.pyc
*.swp
.DS_Store
.atom/
.build/
.buildlog/
.history
.svn/
.swiftpm/
migrate_working_dir/

# IntelliJ related
*.iml
*.ipr
*.iws
.idea/

# The .vscode folder contains launch configuration and tasks you configure in
# VS Code which you may wish to be included in version control, so this line
# is commented out by default.
#.vscode/

# Flutter/Dart/Pub related
**/doc/api/
**/ios/Flutter/.last_build_id
.dart_tool/
.flutter-plugins-dependencies
.pub-cache/
.pub/
/build/
/coverage/

# Symbolication related
app.*.symbols

# Obfuscation related
app.*.map.json

# Android Studio will place build artifacts here
/android/app/debug
/android/app/profile
/android/app/release
# B·ªè qua folder ch·ª©a b·ªô c√†i
releases/
*.exe
</file>

<file path="lib/main.dart">
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:window_manager/window_manager.dart';
import 'ui/app.dart';
import 'ui/theme/app_theme.dart';
import 'ui/theme/config_provider.dart';

Future<void> main() async {
  // Ensure Flutter bindings are initialized
  WidgetsFlutterBinding.ensureInitialized();

  // Initialize window manager
  await windowManager.ensureInitialized();

  // Configure window options
  const windowOptions = WindowOptions(
    size: Size(1000, 700),
    minimumSize: Size(800, 600),
    center: true,
    backgroundColor: Colors.transparent,
    skipTaskbar: false,
    titleBarStyle: TitleBarStyle.hidden,
    title: 'FluxOrigin',
  );

  await windowManager.waitUntilReadyToShow(windowOptions, () async {
    await windowManager.show();
    await windowManager.focus();
  });

  // Run app with theme provider
  runApp(
    MultiProvider(
      providers: [
        ChangeNotifierProvider(create: (_) => ThemeNotifier()),
        ChangeNotifierProvider(create: (_) => ConfigProvider()),
      ],
      child: const MyApp(),
    ),
  );
}
</file>

<file path="lib/services/dev_logger.dart">
import 'dart:developer' as developer;
import 'package:flutter/foundation.dart';

enum LogLevel { debug, info, warning, error, request, response }

class LogEntry {
  final DateTime timestamp;
  final LogLevel level;
  final String category;
  final String message;
  final String? details;

  LogEntry({
    required this.timestamp,
    required this.level,
    required this.category,
    required this.message,
    this.details,
  });

  String get levelIcon {
    switch (level) {
      case LogLevel.debug:
        return 'üîß';
      case LogLevel.info:
        return '‚ÑπÔ∏è';
      case LogLevel.warning:
        return '‚ö†Ô∏è';
      case LogLevel.error:
        return '‚ùå';
      case LogLevel.request:
        return 'üì§';
      case LogLevel.response:
        return 'üì•';
    }
  }

  String get levelName {
    switch (level) {
      case LogLevel.debug:
        return 'DEBUG';
      case LogLevel.info:
        return 'INFO';
      case LogLevel.warning:
        return 'WARN';
      case LogLevel.error:
        return 'ERROR';
      case LogLevel.request:
        return 'REQ';
      case LogLevel.response:
        return 'RES';
    }
  }
}

/// Singleton logger for development debugging
class DevLogger extends ChangeNotifier {
  static final DevLogger _instance = DevLogger._internal();
  factory DevLogger() => _instance;
  DevLogger._internal();

  final List<LogEntry> _logs = [];
  static const int _maxLogs = 1000;
  bool _isEnabled = true;

  List<LogEntry> get logs => List.unmodifiable(_logs);
  bool get isEnabled => _isEnabled;

  void setEnabled(bool enabled) {
    _isEnabled = enabled;
    notifyListeners();
  }

  void _addLog(LogLevel level, String category, String message,
      {String? details}) {
    if (!_isEnabled) return;

    final entry = LogEntry(
      timestamp: DateTime.now(),
      level: level,
      category: category,
      message: message,
      details: details,
    );

    _logs.insert(0, entry); // Add to beginning for newest first

    // Trim old logs
    if (_logs.length > _maxLogs) {
      _logs.removeRange(_maxLogs, _logs.length);
    }

    notifyListeners();

    // Also print to console in debug mode using dart:developer.log
    if (kDebugMode) {
      final logMessage = details != null ? '$message\nDetails: $details' : message;
      developer.log(
        logMessage,
        name: 'FluxOrigin.$category',
        level: _getLogLevel(level),
      );
    }
  }

  /// Map LogLevel to dart:developer log levels
  int _getLogLevel(LogLevel level) {
    switch (level) {
      case LogLevel.debug:
        return 500; // FINE
      case LogLevel.info:
        return 800; // INFO
      case LogLevel.warning:
        return 900; // WARNING
      case LogLevel.error:
        return 1000; // SEVERE
      case LogLevel.request:
        return 700; // CONFIG
      case LogLevel.response:
        return 700; // CONFIG
    }
  }

  void debug(String category, String message, {String? details}) {
    _addLog(LogLevel.debug, category, message, details: details);
  }

  void info(String category, String message, {String? details}) {
    _addLog(LogLevel.info, category, message, details: details);
  }

  void warning(String category, String message, {String? details}) {
    _addLog(LogLevel.warning, category, message, details: details);
  }

  void error(String category, String message, {String? details}) {
    _addLog(LogLevel.error, category, message, details: details);
  }

  void request(String category, String message, {String? details}) {
    _addLog(LogLevel.request, category, message, details: details);
  }

  void response(String category, String message, {String? details}) {
    _addLog(LogLevel.response, category, message, details: details);
  }

  void clear() {
    _logs.clear();
    notifyListeners();
  }

  /// Filter logs by level
  List<LogEntry> filterByLevel(LogLevel level) {
    return _logs.where((log) => log.level == level).toList();
  }

  /// Filter logs by category
  List<LogEntry> filterByCategory(String category) {
    return _logs
        .where((log) =>
            log.category.toLowerCase().contains(category.toLowerCase()))
        .toList();
  }

  /// Search logs
  List<LogEntry> search(String query) {
    final lowerQuery = query.toLowerCase();
    return _logs
        .where((log) =>
            log.message.toLowerCase().contains(lowerQuery) ||
            log.category.toLowerCase().contains(lowerQuery) ||
            (log.details?.toLowerCase().contains(lowerQuery) ?? false))
        .toList();
  }
}
</file>

<file path="lib/services/web_search_service.dart">
import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:html/parser.dart' as html_parser;

class WebSearchService {
  /// Tra c·ª©u ƒë·ªãnh nghƒ©a thu·∫≠t ng·ªØ.
  /// ∆Øu ti√™n 1: Wikipedia API
  /// ∆Øu ti√™n 2: DuckDuckGo (Scraping)
  Future<String?> lookupTerm(String term, String langCode) async {
    if (term.trim().isEmpty) return null;

    // 1. Wikipedia Lookup
    try {
      final wikiDefinition = await _lookupWikipedia(term, langCode);
      if (wikiDefinition != null && wikiDefinition.isNotEmpty) {
        return wikiDefinition;
      }
    } catch (e) {
      print("Wikipedia lookup failed for '$term' ($langCode): $e");
    }

    // 2. DuckDuckGo Lookup (Fallback)
    try {
      final ddgDefinition = await _lookupDuckDuckGo(term);
      if (ddgDefinition != null && ddgDefinition.isNotEmpty) {
        return ddgDefinition;
      }
    } catch (e) {
      print("DuckDuckGo lookup failed for '$term': $e");
    }

    return null;
  }

  Future<String?> _lookupWikipedia(String term, String langCode) async {
    // Encode term for URL (e.g., spaces to %20)
    final encodedTerm = Uri.encodeComponent(term);
    final url = Uri.parse(
        'https://$langCode.wikipedia.org/api/rest_v1/page/summary/$encodedTerm');

    final response = await http.get(url);

    if (response.statusCode == 200) {
      final data = jsonDecode(utf8.decode(response.bodyBytes));
      if (data != null && data['extract'] != null) {
        return data['extract'].toString();
      }
    }
    return null;
  }

  Future<String?> _lookupDuckDuckGo(String term) async {
    final url = Uri.parse('https://html.duckduckgo.com/html/');

    final response = await http.post(
      url,
      body: {'q': '$term definition'},
      headers: {
        'User-Agent':
            'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
    );

    if (response.statusCode == 200) {
      final document = html_parser.parse(response.body);
      // DuckDuckGo HTML version usually has results in .result__snippet
      // We take the first result's snippet
      final element = document.querySelector('.result__snippet');
      if (element != null) {
        return element.text.trim();
      }
    }
    return null;
  }
}
</file>

<file path="lib/ui/widgets/ollama_health_check.dart">
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../theme/config_provider.dart';

/// Stealth Mode: Silently checks AI provider health on startup
/// Updates ConfigProvider state instead of showing intrusive dialogs
class OllamaHealthCheck extends StatefulWidget {
  final Widget child;

  const OllamaHealthCheck({super.key, required this.child});

  @override
  State<OllamaHealthCheck> createState() => _OllamaHealthCheckState();
}

class _OllamaHealthCheckState extends State<OllamaHealthCheck> {
  @override
  void initState() {
    super.initState();
    // Check after first frame to ensure context is available
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _checkOllama();
    });
  }

  Future<void> _checkOllama() async {
    if (!mounted) return;
    // Stealth Mode: Update ConfigProvider state silently (no dialogs)
    await context.read<ConfigProvider>().checkOllamaHealth();
  }

  @override
  Widget build(BuildContext context) {
    return widget.child;
  }
}
</file>

<file path="lib/utils/text_processor.dart">
import 'dart:math';

class TextProcessor {
  static const int _targetChunkSize = 1000;
  static const int _maxChunkSize = 1500; // Allow exceeding target to preserve sentences
  static const List<String> _sentenceTerminators = ['.', '!', '?', '\n'];
  static const List<String> _safeChars = ['.', '\n', '!', '?', '"', '"'];

  /// Splits text into chunks, strictly respecting sentence boundaries.
  /// Will exceed [targetSize] up to [_maxChunkSize] to avoid cutting sentences.
  static List<String> smartSplit(String text,
      {int targetSize = _targetChunkSize}) {
    final List<String> chunks = [];
    int currentPos = 0;
    final int length = text.length;

    while (currentPos < length) {
      int endPos = currentPos + targetSize;

      if (endPos >= length) {
        endPos = length;
      } else {
        // First, try to find a sentence terminator by looking BACK from target
        int safeSpot = _findSentenceTerminatorBackward(
            text, endPos, currentPos, targetSize ~/ 2);

        if (safeSpot != -1) {
          endPos = safeSpot;
        } else {
          // No terminator found looking back - look FORWARD to complete the sentence
          // This allows chunks to exceed targetSize but stay under maxChunkSize
          safeSpot = _findSentenceTerminatorForward(
              text, endPos, min(currentPos + _maxChunkSize, length));

          if (safeSpot != -1) {
            endPos = safeSpot;
          } else {
            // Still no terminator - we're in a very long sentence
            // As last resort, find the end of current sentence even if it exceeds max
            safeSpot = _findSentenceTerminatorForward(text, endPos, length);
            if (safeSpot != -1 && safeSpot - currentPos <= _maxChunkSize * 2) {
              endPos = safeSpot;
            }
            // If sentence is extremely long, we have no choice but to cut at max
            // This should be rare in normal text
          }
        }
      }

      final String chunk = text.substring(currentPos, endPos).trim();
      if (chunk.isNotEmpty) {
        chunks.add(chunk);
      }

      currentPos = endPos;
      // Skip any leading whitespace for next chunk
      while (currentPos < length && text[currentPos] == ' ') {
        currentPos++;
      }
    }

    return chunks;
  }

  /// Find sentence terminator looking backward from position
  static int _findSentenceTerminatorBackward(
      String text, int fromPos, int minPos, int maxLookBack) {
    for (int i = 0; i < maxLookBack; i++) {
      final int checkPos = fromPos - i;
      if (checkPos <= minPos) break;

      final String char = text[checkPos];
      if (_sentenceTerminators.contains(char)) {
        // Include closing quotes after terminator
        int endPos = checkPos + 1;
        while (endPos < text.length &&
            (text[endPos] == '"' || text[endPos] == '"' || text[endPos] == "'")) {
          endPos++;
        }
        return endPos;
      }
    }
    return -1;
  }

  /// Find sentence terminator looking forward from position
  static int _findSentenceTerminatorForward(
      String text, int fromPos, int maxPos) {
    for (int i = fromPos; i < maxPos; i++) {
      final String char = text[i];
      if (_sentenceTerminators.contains(char)) {
        // Include closing quotes after terminator
        int endPos = i + 1;
        while (endPos < text.length &&
            (text[endPos] == '"' || text[endPos] == '"' || text[endPos] == "'")) {
          endPos++;
        }
        return endPos;
      }
    }
    return -1;
  }

  /// Extracts the last 1-2 sentences from a chunk for context passing
  static String extractLastSentences(String text, {int maxLength = 200}) {
    if (text.isEmpty) return "";

    final trimmed = text.trim();
    if (trimmed.length <= maxLength) return trimmed;

    // Find sentence boundaries from the end
    int sentenceCount = 0;
    int cutPos = trimmed.length;

    for (int i = trimmed.length - 2; i >= 0; i--) {
      final char = trimmed[i];
      if (_sentenceTerminators.contains(char)) {
        sentenceCount++;
        if (sentenceCount >= 2 || trimmed.length - i >= maxLength) {
          cutPos = i + 1;
          break;
        }
      }
    }

    // If we couldn't find sentence boundaries, just take the last maxLength chars
    if (cutPos == trimmed.length) {
      cutPos = max(0, trimmed.length - maxLength);
    }

    return trimmed.substring(cutPos).trim();
  }

  /// Creates a sample text for analysis by taking head, mid, and tail sections.
  static String createSample(String text) {
    const int headSize = 4000;
    const int midSize = 3000;
    const int tailSize = 3000;
    final int totalLen = text.length;

    if (totalLen <= (headSize + midSize + tailSize)) {
      return text;
    }

    String combinedSample = "";

    // 1. Head
    int safeHeadEnd = _findSafeCutBackwards(text, headSize);
    combinedSample +=
        "--- [PH·∫¶N M·ªû ƒê·∫¶U] ---\n${text.substring(0, safeHeadEnd)}\n\n";

    // 2. Mid
    final int midPoint = (totalLen / 2).floor();
    int safeMidStart = _findSafeCutForwardLegacy(text, midPoint);
    int safeMidEnd = _findSafeCutBackwards(text, safeMidStart + midSize);

    // Ensure we don't go out of bounds or overlap weirdly
    if (safeMidStart < safeHeadEnd) safeMidStart = safeHeadEnd;
    if (safeMidEnd > totalLen) safeMidEnd = totalLen;

    if (safeMidEnd > safeMidStart) {
      combinedSample +=
          "--- [PH·∫¶N GI·ªÆA TRUY·ªÜN] ---\n... ${text.substring(safeMidStart, safeMidEnd)} ...\n\n";
    }

    // 3. Tail
    int startTail = totalLen - tailSize;
    if (startTail < safeMidEnd) startTail = safeMidEnd;

    int safeTailStart = _findSafeCutForwardLegacy(text, startTail);
    combinedSample +=
        "--- [PH·∫¶N K·∫æT TH√öC] ---\n... ${text.substring(safeTailStart, totalLen)}";

    return combinedSample;
  }

  static int _findSafeCutBackwards(String text, int limitIndex) {
    for (int i = 0; i < 500; i++) {
      final int idx = limitIndex - i;
      if (idx < 0) return 0;

      if (_safeChars.contains(text[idx])) {
        return idx + 1;
      }
    }
    // Fallback to space
    final int lastSpace = text.lastIndexOf(' ', limitIndex);
    return lastSpace != -1 ? lastSpace : limitIndex;
  }

  static int _findSafeCutForwardLegacy(String text, int startIndex) {
    for (int i = 0; i < 500; i++) {
      final int idx = startIndex + i;
      if (idx >= text.length) return text.length;

      if (_safeChars.contains(text[idx])) {
        return idx + 1;
      }
    }
    // Fallback to space
    final int firstSpace = text.indexOf(' ', startIndex);
    return firstSpace != -1 ? firstSpace + 1 : startIndex;
  }
}
</file>

<file path="LICENSE">
GNU GENERAL PUBLIC LICENSE
                       Version 3, 29 June 2007

 Copyright (C) 2007 Free Software Foundation, Inc. <https://fsf.org/>
 Everyone is permitted to copy and distribute verbatim copies
 of this license document, but changing it is not allowed.

                            Preamble

  The GNU General Public License is a free, copyleft license for
software and other kinds of works.

  The licenses for most software and other practical works are designed
to take away your freedom to share and change the works.  By contrast,
the GNU General Public License is intended to guarantee your freedom to
share and change all versions of a program--to make sure it remains free
software for all its users.  We, the Free Software Foundation, use the
GNU General Public License for most of our software; it applies also to
any other work released this way by its authors.  You can apply it to
your programs, too.

  When we speak of free software, we are referring to freedom, not
price.  Our General Public Licenses are designed to make sure that you
have the freedom to distribute copies of free software (and charge for
them if you wish), that you receive source code or can get it if you
want it, that you can change the software or use pieces of it in new
free programs, and that you know you can do these things.

  To protect your rights, we need to prevent others from denying you
these rights or asking you to surrender the rights.  Therefore, you have
certain responsibilities if you distribute copies of the software, or if
you modify it: responsibilities to respect the freedom of others.

  For example, if you distribute copies of such a program, whether
gratis or for a fee, you must pass on to the recipients the same
freedoms that you received.  You must make sure that they, too, receive
or can get the source code.  And you must show them these terms so they
know their rights.

  Developers that use the GNU GPL protect your rights with two steps:
(1) assert copyright on the software, and (2) offer you this License
giving you legal permission to copy, distribute and/or modify it.

  For the developers' and authors' protection, the GPL clearly explains
that there is no warranty for this free software.  For both users' and
authors' sake, the GPL requires that modified versions be marked as
changed, so that their problems will not be attributed erroneously to
authors of previous versions.

  Some devices are designed to deny users access to install or run
modified versions of the software inside them, although the manufacturer
can do so.  This is fundamentally incompatible with the aim of
protecting users' freedom to change the software.  The systematic
pattern of such abuse occurs in the area of products for individuals to
use, which is precisely where it is most unacceptable.  Therefore, we
have designed this version of the GPL to prohibit the practice for those
products.  If such problems arise substantially in other domains, we
stand ready to extend this provision to those domains in future versions
of the GPL, as needed to protect the freedom of users.

  Finally, every program is threatened constantly by software patents.
States should not allow patents to restrict development and use of
software on general-purpose computers, but in those that do, we wish to
avoid the special danger that patents applied to a free program could
make it effectively proprietary.  To prevent this, the GPL assures that
patents cannot be used to render the program non-free.

  The precise terms and conditions for copying, distribution and
modification follow.

                       TERMS AND CONDITIONS

  0. Definitions.

  "This License" refers to version 3 of the GNU General Public License.

  "Copyright" also means copyright-like laws that apply to other kinds of
works, such as semiconductor masks.

  "The Program" refers to any copyrightable work licensed under this
License.  Each licensee is addressed as "you".  "Licensees" and
"recipients" may be individuals or organizations.

  To "modify" a work means to copy from or adapt all or part of the work
in a fashion requiring copyright permission, other than the making of an
exact copy.  The resulting work is called a "modified version" of the
earlier work or a work "based on" the earlier work.

  A "covered work" means either the unmodified Program or a work based
on the Program.

  To "propagate" a work means to do anything with it that, without
permission, would make you directly or secondarily liable for
infringement under applicable copyright law, except executing it on a
computer or modifying a private copy.  Propagation includes copying,
distribution (with or without modification), making available to the
public, and in some countries other activities as well.

  To "convey" a work means any kind of propagation that enables other
parties to make or receive copies.  Mere interaction with a user through
a computer network, with no transfer of a copy, is not conveying.

  An interactive user interface displays "Appropriate Legal Notices"
to the extent that it includes a convenient and prominently visible
feature that (1) displays an appropriate copyright notice, and (2)
tells the user that there is no warranty for the work (except to the
extent that warranties are provided), that licensees may convey the
work under this License, and how to view a copy of this License.  If
the interface presents a list of user commands or options, such as a
menu, a prominent item in the list meets this criterion.

  1. Source Code.

  The "source code" for a work means the preferred form of the work
for making modifications to it.  "Object code" means any non-source
form of a work.

  A "Standard Interface" means an interface that either is an official
standard defined by a recognized standards body, or, in the case of
interfaces specified for a particular programming language, one that
is widely used among developers working in that language.

  The "System Libraries" of an executable work include anything, other
than the work as a whole, that (a) is included in the normal form of
packaging a Major Component, but which is not part of that Major
Component, and (b) serves only to enable use of the work with that
Major Component, or to implement a Standard Interface for which an
implementation is available to the public in source code form.  A
"Major Component", in this context, means a major essential component
(kernel, window system, and so on) of the specific operating system
(if any) on which the executable work runs, or a compiler used to
produce the work, or an object code interpreter used to run it.

  The "Corresponding Source" for a work in object code form means all
the source code needed to generate, install, and (for an executable
work) run the object code and to modify the work, including scripts to
control those activities.  However, it does not include the work's
System Libraries, or general-purpose tools or generally available free
programs which are used unmodified in performing those activities but
which are not part of the work.  For example, Corresponding Source
includes interface definition files associated with source files for
the work, and the source code for shared libraries and dynamically
linked subprograms that the work is specifically designed to require,
such as by intimate data communication or control flow between those
subprograms and other parts of the work.

  The Corresponding Source need not include anything that users
can regenerate automatically from other parts of the Corresponding
Source.

  The Corresponding Source for a work in source code form is that
same work.

  2. Basic Permissions.

  All rights granted under this License are granted for the term of
copyright on the Program, and are irrevocable provided the stated
conditions are met.  This License explicitly affirms your unlimited
permission to run the unmodified Program.  The output from running a
covered work is covered by this License only if the output, given its
content, constitutes a covered work.  This License acknowledges your
rights of fair use or other equivalent, as provided by copyright law.

  You may make, run and propagate covered works that you do not
convey, without conditions so long as your license otherwise remains
in force.  You may convey covered works to others for the sole purpose
of having them make modifications exclusively for you, or provide you
with facilities for running those works, provided that you comply with
the terms of this License in conveying all material for which you do
not control copyright.  Those thus making or running the covered works
for you must do so exclusively on your behalf, under your direction
and control, on terms that prohibit them from making any copies of
your copyrighted material outside their relationship with you.

  Conveying under any other circumstances is permitted solely under
the conditions stated below.  Sublicensing is not allowed; section 10
makes it unnecessary.

  3. Protecting Users' Legal Rights From Anti-Circumvention Law.

  No covered work shall be deemed part of an effective technological
measure under any applicable law fulfilling obligations under article
11 of the WIPO copyright treaty adopted on 20 December 1996, or
similar laws prohibiting or restricting circumvention of such
measures.

  When you convey a covered work, you waive any legal power to forbid
circumvention of technological measures to the extent such circumvention
is effected by exercising rights under this License with respect to
the covered work, and you disclaim any intention to limit operation or
modification of the work as a means of enforcing, against the work's
users, your or third parties' legal rights to forbid circumvention of
technological measures.

  4. Conveying Verbatim Copies.

  You may convey verbatim copies of the Program's source code as you
receive it, in any medium, provided that you conspicuously and
appropriately publish on each copy an appropriate copyright notice;
keep intact all notices stating that this License and any
non-permissive terms added in accord with section 7 apply to the code;
keep intact all notices of the absence of any warranty; and give all
recipients a copy of this License along with the Program.

  You may charge any price or no price for each copy that you convey,
and you may offer support or warranty protection for a fee.

  5. Conveying Modified Source Versions.

  You may convey a work based on the Program, or the modifications to
produce it from the Program, in the form of source code under the
terms of section 4, provided that you also meet all of these conditions:

    a) The work must carry prominent notices stating that you modified
    it, and giving a relevant date.

    b) The work must carry prominent notices stating that it is
    released under this License and any conditions added under section
    7.  This requirement modifies the requirement in section 4 to
    "keep intact all notices".

    c) You must license the entire work, as a whole, under this
    License to anyone who comes into possession of a copy.  This
    License will therefore apply, along with any applicable section 7
    additional terms, to the whole of the work, and all its parts,
    regardless of how they are packaged.  This License gives no
    permission to license the work in any other way, but it does not
    invalidate such permission if you have separately received it.

    d) If the work has interactive user interfaces, each must display
    Appropriate Legal Notices; however, if the Program has interactive
    interfaces that do not display Appropriate Legal Notices, your
    work need not make them do so.

  A compilation of a covered work with other separate and independent
works, which are not by their nature extensions of the covered work,
and which are not combined with it such as to form a larger program,
in or on a volume of a storage or distribution medium, is called an
"aggregate" if the compilation and its resulting copyright are not
used to limit the access or legal rights of the compilation's users
beyond what the individual works permit.  Inclusion of a covered work
in an aggregate does not cause this License to apply to the other
parts of the aggregate.

  6. Conveying Non-Source Forms.

  You may convey a covered work in object code form under the terms
of sections 4 and 5, provided that you also convey the
machine-readable Corresponding Source under the terms of this License,
in one of these ways:

    a) Convey the object code in, or embodied in, a physical product
    (including a physical distribution medium), accompanied by the
    Corresponding Source fixed on a durable physical medium
    customarily used for software interchange.

    b) Convey the object code in, or embodied in, a physical product
    (including a physical distribution medium), accompanied by a
    written offer, valid for at least three years and valid for as
    long as you offer spare parts or customer support for that product
    model, to give anyone who possesses the object code either (1) a
    copy of the Corresponding Source for all the software in the
    product that is covered by this License, on a durable physical
    medium customarily used for software interchange, for a price no
    more than your reasonable cost of physically performing this
    conveying of source, or (2) access to copy the
    Corresponding Source from a network server at no charge.

    c) Convey individual copies of the object code with a copy of the
    written offer to provide the Corresponding Source.  This
    alternative is allowed only occasionally and noncommercially, and
    only if you received the object code with such an offer, in accord
    with subsection 6b.

    d) Convey the object code by offering access from a designated
    place (gratis or for a charge), and offer equivalent access to the
    Corresponding Source in the same way through the same place at no
    further charge.  You need not require recipients to copy the
    Corresponding Source along with the object code.  If the place to
    copy the object code is a network server, the Corresponding Source
    may be on a different server (operated by you or a third party)
    that supports equivalent copying facilities, provided you maintain
    clear directions next to the object code saying where to find the
    Corresponding Source.  Regardless of what server hosts the
    Corresponding Source, you remain obligated to ensure that it is
    available for as long as needed to satisfy these requirements.

    e) Convey the object code using peer-to-peer transmission, provided
    you inform other peers where the object code and Corresponding
    Source of the work are being offered to the general public at no
    charge under subsection 6d.

  A separable portion of the object code, whose source code is excluded
from the Corresponding Source as a System Library, need not be
included in conveying the object code work.

  A "User Product" is either (1) a "consumer product", which means any
tangible personal property which is normally used for personal, family,
or household purposes, or (2) anything designed or sold for incorporation
into a dwelling.  In determining whether a product is a consumer product,
doubtful cases shall be resolved in favor of coverage.  For a particular
product received by a particular user, "normally used" refers to a
typical or common use of that class of product, regardless of the status
of the particular user or of the way in which the particular user
actually uses, or expects or is expected to use, the product.  A product
is a consumer product regardless of whether the product has substantial
commercial, industrial or non-consumer uses, unless such uses represent
the only significant mode of use of the product.

  "Installation Information" for a User Product means any methods,
procedures, authorization keys, or other information required to install
and execute modified versions of a covered work in that User Product from
a modified version of its Corresponding Source.  The information must
suffice to ensure that the continued functioning of the modified object
code is in no case prevented or interfered with solely because
modification has been made.

  If you convey an object code work under this section in, or with, or
specifically for use in, a User Product, and the conveying occurs as
part of a transaction in which the right of possession and use of the
User Product is transferred to the recipient in perpetuity or for a
fixed term (regardless of how the transaction is characterized), the
Corresponding Source conveyed under this section must be accompanied
by the Installation Information.  But this requirement does not apply
if neither you nor any third party retains the ability to install
modified object code on the User Product (for example, the work has
been installed in ROM).

  The requirement to provide Installation Information does not include a
requirement to continue to provide support service, warranty, or updates
for a work that has been modified or installed by the recipient, or for
the User Product in which it has been modified or installed.  Access to a
network may be denied when the modification itself materially and
adversely affects the operation of the network or violates the rules and
protocols for communication across the network.

  Corresponding Source conveyed, and Installation Information provided,
in accord with this section must be in a format that is publicly
documented (and with an implementation available to the public in
source code form), and must require no special password or key for
unpacking, reading or copying.

  7. Additional Terms.

  "Additional permissions" are terms that supplement the terms of this
License by making exceptions from one or more of its conditions.
Additional permissions that are applicable to the entire Program shall
be treated as though they were included in this License, to the extent
that they are valid under applicable law.  If additional permissions
apply only to part of the Program, that part may be used separately
under those permissions, but the entire Program remains governed by
this License without regard to the additional permissions.

  When you convey a copy of a covered work, you may at your option
remove any additional permissions from that copy, or from any part of
it.  (Additional permissions may be written to require their own
removal in certain cases when you modify the work.)  You may place
additional permissions on material, added by you to a covered work,
for which you have or can give appropriate copyright permission.

  Notwithstanding any other provision of this License, for material you
add to a covered work, you may (if authorized by the copyright holders of
that material) supplement the terms of this License with terms:

    a) Disclaiming warranty or limiting liability differently from the
    terms of sections 15 and 16 of this License; or

    b) Requiring preservation of specified reasonable legal notices or
    author attributions in that material or in the Appropriate Legal
    Notices displayed by works containing it; or

    c) Prohibiting misrepresentation of the origin of that material, or
    requiring that modified versions of such material be marked in
    reasonable ways as different from the original version; or

    d) Limiting the use for publicity purposes of names of licensors or
    authors of the material; or

    e) Declining to grant rights under trademark law for use of some
    trade names, trademarks, or service marks; or

    f) Requiring indemnification of licensors and authors of that
    material by anyone who conveys the material (or modified versions of
    it) with contractual assumptions of liability to the recipient, for
    any liability that these contractual assumptions directly impose on
    those licensors and authors.

  All other non-permissive additional terms are considered "further
restrictions" within the meaning of section 10.  If the Program as you
received it, or any part of it, contains a notice stating that it is
governed by this License along with a term that is a further
restriction, you may remove that term.  If a license document contains
a further restriction but permits relicensing or conveying under this
License, you may add to a covered work material governed by the terms
of that license document, provided that the further restriction does
not survive such relicensing or conveying.

  If you add terms to a covered work in accord with this section, you
must place, in the relevant source files, a statement of the
additional terms that apply to those files, or a notice indicating
where to find the applicable terms.

  Additional terms, permissive or non-permissive, may be stated in the
form of a separately written license, or stated as exceptions;
the above requirements apply either way.

  8. Termination.

  You may not propagate or modify a covered work except as expressly
provided under this License.  Any attempt otherwise to propagate or
modify it is void, and will automatically terminate your rights under
this License (including any patent licenses granted under the third
paragraph of section 11).

  However, if you cease all violation of this License, then your
license from a particular copyright holder is reinstated (a)
provisionally, unless and until the copyright holder explicitly and
finally terminates your license, and (b) permanently, if the copyright
holder fails to notify you of the violation by some reasonable means
prior to 60 days after the cessation.

  Moreover, your license from a particular copyright holder is
reinstated permanently if the copyright holder notifies you of the
violation by some reasonable means, this is the first time you have
received notice of violation of this License (for any work) from that
copyright holder, and you cure the violation prior to 30 days after
your receipt of the notice.

  Termination of your rights under this section does not terminate the
licenses of parties who have received copies or rights from you under
this License.  If your rights have been terminated and not permanently
reinstated, you do not qualify to receive new licenses for the same
material under section 10.

  9. Acceptance Not Required for Having Copies.

  You are not required to accept this License in order to receive or
run a copy of the Program.  Ancillary propagation of a covered work
occurring solely as a consequence of using peer-to-peer transmission
to receive a copy likewise does not require acceptance.  However,
nothing other than this License grants you permission to propagate or
modify any covered work.  These actions infringe copyright if you do
not accept this License.  Therefore, by modifying or propagating a
covered work, you indicate your acceptance of this License to do so.

  10. Automatic Licensing of Downstream Recipients.

  Each time you convey a covered work, the recipient automatically
receives a license from the original licensors, to run, modify and
propagate that work, subject to this License.  You are not responsible
for enforcing compliance by third parties with this License.

  An "entity transaction" is a transaction transferring control of an
organization, or substantially all assets of one, or subdividing an
organization, or merging organizations.  If propagation of a covered
work results from an entity transaction, each party to that
transaction who receives a copy of the work also receives whatever
licenses to the work the party's predecessor in interest had or could
give under the previous paragraph, plus a right to possession of the
Corresponding Source of the work from the predecessor in interest, if
the predecessor has it or can get it with reasonable efforts.

  You may not impose any further restrictions on the exercise of the
rights granted or affirmed under this License.  For example, you may
not impose a license fee, royalty, or other charge for exercise of
rights granted under this License, and you may not initiate litigation
(including a cross-claim or counterclaim in a lawsuit) alleging that
any patent claim is infringed by making, using, selling, offering for
sale, or importing the Program or any portion of it.

  11. Patents.

  A "contributor" is a copyright holder who authorizes use under this
License of the Program or a work on which the Program is based.  The
work thus licensed is called the contributor's "contributor version".

  A contributor's "essential patent claims" are all patent claims
owned or controlled by the contributor, whether already acquired or
hereafter acquired, that would be infringed by some manner, permitted
by this License, of making, using, or selling its contributor version,
but do not include claims that would be infringed only as a
consequence of further modification of the contributor version.  For
purposes of this definition, "control" includes the right to grant
patent sublicenses in a manner consistent with the requirements of
this License.

  Each contributor grants you a non-exclusive, worldwide, royalty-free
patent license under the contributor's essential patent claims, to
make, use, sell, offer for sale, import and otherwise run, modify and
propagate the contents of its contributor version.

  In the following three paragraphs, a "patent license" is any express
agreement or commitment, however denominated, not to enforce a patent
(such as an express permission to practice a patent or covenant not to
sue for patent infringement).  To "grant" such a patent license to a
party means to make such an agreement or commitment not to enforce a
patent against the party.

  If you convey a covered work, knowingly relying on a patent license,
and the Corresponding Source of the work is not available for anyone
to copy, free of charge and under the terms of this License, through a
publicly available network server or other readily accessible means,
then you must either (1) cause the Corresponding Source to be so
available, or (2) arrange to deprive yourself of the benefit of the
patent license for this particular work, or (3) arrange, in a manner
consistent with the requirements of this License, to extend the patent
license to downstream recipients.  "Knowingly relying" means you have
actual knowledge that, but for the patent license, your conveying the
covered work in a country, or your recipient's use of the covered work
in a country, would infringe one or more identifiable patents in that
country that you have reason to believe are valid.

  If, pursuant to or in connection with a single transaction or
arrangement, you convey, or propagate by procuring conveyance of, a
covered work, and grant a patent license to some of the parties
receiving the covered work authorizing them to use, propagate, modify
or convey a specific copy of the covered work, then the patent license
you grant is automatically extended to all recipients of the covered
work and works based on it.

  A patent license is "discriminatory" if it does not include within
the scope of its coverage, prohibits the exercise of, or is
conditioned on the non-exercise of one or more of the rights that are
specifically granted under this License.  You may not convey a covered
work if you are a party to an arrangement with a third party that is
in the business of distributing software, under which you make payment
to the third party based on the extent of your activity of conveying
the work, and under which the third party grants, to any of the
parties who would receive the covered work from you, a discriminatory
patent license (a) in connection with copies of the covered work
conveyed by you (or copies made from those copies), or (b) primarily
for and in connection with specific products or compilations that
contain the covered work, unless you entered into that arrangement,
or that patent license was granted, prior to 28 March 2007.

  Nothing in this License shall be construed as excluding or limiting
any implied license or other defenses to infringement that may
otherwise be available to you under applicable patent law.

  12. No Surrender of Others' Freedom.

  If conditions are imposed on you (whether by court order, agreement or
otherwise) that contradict the conditions of this License, they do not
excuse you from the conditions of this License.  If you cannot convey a
covered work so as to satisfy simultaneously your obligations under this
License and any other pertinent obligations, then as a consequence you may
not convey it at all.  For example, if you agree to terms that obligate you
to collect a royalty for further conveying from those to whom you convey
the Program, the only way you could satisfy both those terms and this
License would be to refrain entirely from conveying the Program.

  13. Use with the GNU Affero General Public License.

  Notwithstanding any other provision of this License, you have
permission to link or combine any covered work with a work licensed
under version 3 of the GNU Affero General Public License into a single
combined work, and to convey the resulting work.  The terms of this
License will continue to apply to the part which is the covered work,
but the special requirements of the GNU Affero General Public License,
section 13, concerning interaction through a network will apply to the
combination as such.

  14. Revised Versions of this License.

  The Free Software Foundation may publish revised and/or new versions of
the GNU General Public License from time to time.  Such new versions will
be similar in spirit to the present version, but may differ in detail to
address new problems or concerns.

  Each version is given a distinguishing version number.  If the
Program specifies that a certain numbered version of the GNU General
Public License "or any later version" applies to it, you have the
option of following the terms and conditions either of that numbered
version or of any later version published by the Free Software
Foundation.  If the Program does not specify a version number of the
GNU General Public License, you may choose any version ever published
by the Free Software Foundation.

  If the Program specifies that a proxy can decide which future
versions of the GNU General Public License can be used, that proxy's
public statement of acceptance of a version permanently authorizes you
to choose that version for the Program.

  Later license versions may give you additional or different
permissions.  However, no additional obligations are imposed on any
author or copyright holder as a result of your choosing to follow a
later version.

  15. Disclaimer of Warranty.

  THERE IS NO WARRANTY FOR THE PROGRAM, TO THE EXTENT PERMITTED BY
APPLICABLE LAW.  EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT
HOLDERS AND/OR OTHER PARTIES PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY
OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO,
THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
PURPOSE.  THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE PROGRAM
IS WITH YOU.  SHOULD THE PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF
ALL NECESSARY SERVICING, REPAIR OR CORRECTION.

  16. Limitation of Liability.

  IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MODIFIES AND/OR CONVEYS
THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES, INCLUDING ANY
GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE
USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED TO LOSS OF
DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD
PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER PROGRAMS),
EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF
SUCH DAMAGES.

  17. Interpretation of Sections 15 and 16.

  If the disclaimer of warranty and limitation of liability provided
above cannot be given local legal effect according to their terms,
reviewing courts shall apply local law that most closely approximates
an absolute waiver of all civil liability in connection with the
Program, unless a warranty or assumption of liability accompanies a
copy of the Program in return for a fee.

                     END OF TERMS AND CONDITIONS

            How to Apply These Terms to Your New Programs

  If you develop a new program, and you want it to be of the greatest
possible use to the public, the best way to achieve this is to make it
free software which everyone can redistribute and change under these terms.

  To do so, attach the following notices to the program.  It is safest
to attach them to the start of each source file to most effectively
state the exclusion of warranty; and each file should have at least
the "copyright" line and a pointer to where the full notice is found.

    <one line to give the program's name and a brief idea of what it does.>
    Copyright (C) <year>  <name of author>

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.

Also add information on how to contact you by electronic and paper mail.

  If the program does terminal interaction, make it output a short
notice like this when it starts in an interactive mode:

    <program>  Copyright (C) <year>  <name of author>
    This program comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
    This is free software, and you are welcome to redistribute it
    under certain conditions; type `show c' for details.

The hypothetical commands `show w' and `show c' should show the appropriate
parts of the General Public License.  Of course, your program's commands
might be different; for a GUI interface, you would use an "about box".

  You should also get your employer (if you work as a programmer) or school,
if any, to sign a "copyright disclaimer" for the program, if necessary.
For more information on this, and how to apply and follow the GNU GPL, see
<https://www.gnu.org/licenses/>.

  The GNU General Public License does not permit incorporating your program
into proprietary programs.  If your program is a subroutine library, you
may consider it more useful to permit linking proprietary applications with
the library.  If this is what you want to do, use the GNU Lesser General
Public License instead of this License.  But first, please read
<https://www.gnu.org/licenses/why-not-lgpl.html>.

7. Additional Terms
TRADEMARK NOTICE:
The name "FluxOrigin" and its associated logos are trademarks of MINH DUNG NGUYEN (d-init-d).
You may distribute modified versions of this software under the GNU General Public License v3.0, however, you must remove all references to our trademarks and use your own name and logo.
</file>

<file path="windows/runner/Runner.rc">
// Microsoft Visual C++ generated resource script.
//
#pragma code_page(65001)
#include "resource.h"

#define APSTUDIO_READONLY_SYMBOLS
/////////////////////////////////////////////////////////////////////////////
//
// Generated from the TEXTINCLUDE 2 resource.
//
#include "winres.h"

/////////////////////////////////////////////////////////////////////////////
#undef APSTUDIO_READONLY_SYMBOLS

/////////////////////////////////////////////////////////////////////////////
// English (United States) resources

#if !defined(AFX_RESOURCE_DLL) || defined(AFX_TARG_ENU)
LANGUAGE LANG_ENGLISH, SUBLANG_ENGLISH_US

#ifdef APSTUDIO_INVOKED
/////////////////////////////////////////////////////////////////////////////
//
// TEXTINCLUDE
//

1 TEXTINCLUDE
BEGIN
    "resource.h\0"
END

2 TEXTINCLUDE
BEGIN
    "#include ""winres.h""\r\n"
    "\0"
END

3 TEXTINCLUDE
BEGIN
    "\r\n"
    "\0"
END

#endif    // APSTUDIO_INVOKED


/////////////////////////////////////////////////////////////////////////////
//
// Icon
//

// Icon with lowest ID value placed first to ensure application icon
// remains consistent on all systems.
IDI_APP_ICON            ICON                    "resources\\app_icon.ico"


/////////////////////////////////////////////////////////////////////////////
//
// Version
//

#if defined(FLUTTER_VERSION_MAJOR) && defined(FLUTTER_VERSION_MINOR) && defined(FLUTTER_VERSION_PATCH) && defined(FLUTTER_VERSION_BUILD)
#define VERSION_AS_NUMBER FLUTTER_VERSION_MAJOR,FLUTTER_VERSION_MINOR,FLUTTER_VERSION_PATCH,FLUTTER_VERSION_BUILD
#else
#define VERSION_AS_NUMBER 1,0,0,0
#endif

#if defined(FLUTTER_VERSION)
#define VERSION_AS_STRING FLUTTER_VERSION
#else
#define VERSION_AS_STRING "1.0.0"
#endif

VS_VERSION_INFO VERSIONINFO
 FILEVERSION VERSION_AS_NUMBER
 PRODUCTVERSION VERSION_AS_NUMBER
 FILEFLAGSMASK VS_FFI_FILEFLAGSMASK
#ifdef _DEBUG
 FILEFLAGS VS_FF_DEBUG
#else
 FILEFLAGS 0x0L
#endif
 FILEOS VOS__WINDOWS32
 FILETYPE VFT_APP
 FILESUBTYPE 0x0L
BEGIN
    BLOCK "StringFileInfo"
    BEGIN
        BLOCK "040904e4"
        BEGIN
            VALUE "d-init-d", "com.example" "\0"
            VALUE "FluxOrigin - Book Translator", "flux_origin" "\0"
            VALUE "FileVersion", VERSION_AS_STRING "\0"
            VALUE "InternalName", "flux_origin" "\0"
            VALUE "MinhDungNguyen", "Copyright (C) 2025 com.example. All rights reserved." "\0"
            VALUE "OriginalFilename", "flux_origin.exe" "\0"
            VALUE "ProductName", "flux_origin" "\0"
            VALUE "ProductVersion", VERSION_AS_STRING "\0"
        END
    END
    BLOCK "VarFileInfo"
    BEGIN
        VALUE "Translation", 0x409, 1252
    END
END

#endif    // English (United States) resources
/////////////////////////////////////////////////////////////////////////////



#ifndef APSTUDIO_INVOKED
/////////////////////////////////////////////////////////////////////////////
//
// Generated from the TEXTINCLUDE 3 resource.
//


/////////////////////////////////////////////////////////////////////////////
#endif    // not APSTUDIO_INVOKED
</file>

<file path="lib/models/translation_progress.dart">
import 'dart:convert';
import 'dart:io';

class TranslationProgress {
  final String sourcePath;
  final String outputPath;
  final String glossary;
  final String systemPrompt;
  final String genre;
  final List<String> rawChunks;
  final List<String?> translatedChunks;
  int currentIndex;
  DateTime lastUpdated;

  TranslationProgress({
    required this.sourcePath,
    required this.outputPath,
    required this.glossary,
    required this.systemPrompt,
    required this.genre,
    required this.rawChunks,
    required this.translatedChunks,
    required this.currentIndex,
    required this.lastUpdated,
  });

  Map<String, dynamic> toJson() {
    return {
      'sourcePath': sourcePath,
      'outputPath': outputPath,
      'glossary': glossary,
      'systemPrompt': systemPrompt,
      'genre': genre,
      'rawChunks': rawChunks,
      'translatedChunks': translatedChunks,
      'currentIndex': currentIndex,
      'lastUpdated': lastUpdated.toIso8601String(),
    };
  }

  factory TranslationProgress.fromJson(Map<String, dynamic> json) {
    return TranslationProgress(
      sourcePath: json['sourcePath'],
      outputPath: json['outputPath'],
      glossary: json['glossary'],
      systemPrompt: json['systemPrompt'],
      genre: json['genre'] ?? 'KHAC',
      rawChunks: List<String>.from(json['rawChunks']),
      translatedChunks: List<String?>.from(json['translatedChunks']),
      currentIndex: json['currentIndex'],
      lastUpdated: DateTime.parse(json['lastUpdated']),
    );
  }

  static Future<TranslationProgress?> loadFromFile(String filePath) async {
    final file = File(filePath);
    if (!await file.exists()) return null;
    try {
      final content = await file.readAsString();
      final json = jsonDecode(content);
      return TranslationProgress.fromJson(json);
    } catch (e) {
      print('Error loading progress: $e');
      return null;
    }
  }

  Future<void> saveToFile(String filePath) async {
    final file = File(filePath);
    lastUpdated = DateTime.now();
    await file.writeAsString(jsonEncode(toJson()), flush: true);
  }
}
</file>

<file path="lib/ui/theme/app_theme.dart">
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';

/// Light theme colors extracted from HTML prototype
class AppColors {
  // Light Mode
  static const Color lightPrimary = Color(0xFF043222);
  static const Color lightAccent = Color(0xFF13503D);
  static const Color lightPaper = Color(0xFFFDFCF8);
  static const Color lightSidebar = Color(0xFFF4F2ED);
  static const Color lightSurface = Color(0xFFFFFFFF);
  static const Color lightBorder = Color(0xFFE6E4DC);

  // Dark Mode
  static const Color darkPaper = Color(0xFF111111);
  static const Color darkSidebar = Color(0xFF000000);
  static const Color darkSurface = Color(0xFF1A1A1A);
  static const Color darkBorder = Color(0xFF2A2A2A);
}

/// Theme notifier to manage dark/light mode toggle
class ThemeNotifier extends ChangeNotifier {
  bool _isDark = false;

  bool get isDark => _isDark;

  void toggleTheme() {
    _isDark = !_isDark;
    notifyListeners();
  }

  ThemeData get currentTheme => _isDark ? darkTheme : lightTheme;

  static ThemeData get lightTheme {
    return ThemeData(
      useMaterial3: true,
      brightness: Brightness.light,
      scaffoldBackgroundColor: AppColors.lightPaper,
      primaryColor: AppColors.lightPrimary,
      colorScheme: const ColorScheme.light(
        primary: AppColors.lightPrimary,
        secondary: AppColors.lightAccent,
        surface: AppColors.lightSurface,
      ),
      textTheme: GoogleFonts.interTextTheme().copyWith(
        bodyLarge: GoogleFonts.inter(color: AppColors.lightPrimary),
        bodyMedium: GoogleFonts.inter(color: AppColors.lightPrimary),
      ),
    );
  }

  static ThemeData get darkTheme {
    return ThemeData(
      useMaterial3: true,
      brightness: Brightness.dark,
      scaffoldBackgroundColor: AppColors.darkPaper,
      primaryColor: Colors.white,
      colorScheme: const ColorScheme.dark(
        primary: Colors.white,
        secondary: Colors.white70,
        surface: AppColors.darkSurface,
      ),
      textTheme:
          GoogleFonts.interTextTheme(ThemeData.dark().textTheme).copyWith(
        bodyLarge: GoogleFonts.inter(color: Colors.white),
        bodyMedium: GoogleFonts.inter(color: Colors.grey[300]),
      ),
    );
  }
}
</file>

<file path="lib/ui/widgets/sidebar_item.dart">
import 'package:flutter/material.dart';
import 'package:font_awesome_flutter/font_awesome_flutter.dart';
import '../theme/app_theme.dart';

class SidebarItem extends StatefulWidget {
  final IconData icon;
  final String label;
  final bool isActive;
  final VoidCallback onTap;
  final bool isDark;
  final bool showBadge; // Stealth Mode: Show red dot for connection issues

  const SidebarItem({
    super.key,
    required this.icon,
    required this.label,
    required this.isActive,
    required this.onTap,
    required this.isDark,
    this.showBadge = false,
  });

  @override
  State<SidebarItem> createState() => _SidebarItemState();
}

class _SidebarItemState extends State<SidebarItem> {
  bool _isHovered = false;

  @override
  Widget build(BuildContext context) {
    final backgroundColor = widget.isActive
        ? (widget.isDark
            ? Colors.white.withOpacity(0.1)
            : AppColors.lightPrimary.withOpacity(0.1))
        : (_isHovered
            ? (widget.isDark
                ? Colors.white.withOpacity(0.05)
                : AppColors.lightPrimary.withOpacity(0.05))
            : Colors.transparent);

    final textColor = widget.isActive
        ? (widget.isDark ? Colors.white : AppColors.lightPrimary)
        : (widget.isDark
            ? (_isHovered ? Colors.grey[200] : Colors.grey[400])
            : (_isHovered
                ? AppColors.lightPrimary
                : AppColors.lightPrimary.withOpacity(0.7)));

    return MouseRegion(
      cursor: SystemMouseCursors.click,
      onEnter: (_) => setState(() => _isHovered = true),
      onExit: (_) => setState(() => _isHovered = false),
      child: GestureDetector(
        onTap: widget.onTap,
        child: Container(
          margin: const EdgeInsets.only(bottom: 4),
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
          decoration: BoxDecoration(
            color: backgroundColor,
            borderRadius: BorderRadius.circular(8),
          ),
          child: Row(
            children: [
              // Stealth Mode: Wrap icon in Stack for badge overlay
              Stack(
                clipBehavior: Clip.none,
                children: [
                  FaIcon(
                    widget.icon,
                    size: 18,
                    color: textColor,
                  ),
                  if (widget.showBadge)
                    Positioned(
                      right: -4,
                      top: -4,
                      child: Container(
                        width: 8,
                        height: 8,
                        decoration: const BoxDecoration(
                          color: Colors.redAccent,
                          shape: BoxShape.circle,
                        ),
                      ),
                    ),
                ],
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Text(
                  widget.label,
                  style: TextStyle(
                    fontSize: 14,
                    fontWeight:
                        widget.isActive ? FontWeight.bold : FontWeight.normal,
                    color: textColor,
                  ),
                ),
              ),
              if (widget.isActive)
                Container(
                  width: 4,
                  height: 16,
                  decoration: BoxDecoration(
                    color:
                        widget.isDark ? Colors.white : AppColors.lightPrimary,
                    borderRadius: BorderRadius.circular(2),
                  ),
                ),
            ],
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/ui/widgets/upload_dictionary_modal.dart">
import 'dart:ui' as ui;
import 'package:flutter/material.dart';
import 'package:font_awesome_flutter/font_awesome_flutter.dart';
import 'package:flutter_animate/flutter_animate.dart';
import 'package:provider/provider.dart';
import 'package:file_picker/file_picker.dart';
import 'package:desktop_drop/desktop_drop.dart';
import 'package:path/path.dart' as p;
import '../theme/app_theme.dart';
import '../theme/config_provider.dart';
import '../../utils/app_strings.dart';

class UploadDictionaryModal extends StatefulWidget {
  final bool isDark;
  final VoidCallback onClose;

  const UploadDictionaryModal({
    super.key,
    required this.isDark,
    required this.onClose,
  });

  @override
  State<UploadDictionaryModal> createState() => _UploadDictionaryModalState();
}

class _UploadDictionaryModalState extends State<UploadDictionaryModal> {
  String? _selectedFile;
  String? _dictionaryName;
  bool _isDragging = false;

  void _setSelectedFile(String filePath) {
    final fileName = p.basenameWithoutExtension(filePath);
    setState(() {
      _selectedFile = filePath;
      _dictionaryName = fileName;
    });
  }

  Future<void> _pickFile(String lang) async {
    final result = await FilePicker.platform.pickFiles(
      type: FileType.custom,
      allowedExtensions: ['csv'],
    );
    if (result != null && result.files.single.path != null) {
      _setSelectedFile(result.files.single.path!);
    }
  }

  void _handleDroppedFile(String filePath, String lang) {
    final ext = p.extension(filePath).toLowerCase();
    if (ext == '.csv') {
      _setSelectedFile(filePath);
    } else {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(AppStrings.get(lang, 'unsupported_dict_format_error')),
          behavior: SnackBarBehavior.floating,
          backgroundColor: Colors.red,
          shape:
              RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
        ),
      );
    }
  }


  void _handleUpload(String lang) {
    if (_selectedFile == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(AppStrings.get(lang, 'error_missing_info')),
          behavior: SnackBarBehavior.floating,
          backgroundColor: Colors.orange,
          shape:
              RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
        ),
      );
      return;
    }
    // Upload logic would go here using _selectedFile and _dictionaryName
    widget.onClose();
  }

  @override
  Widget build(BuildContext context) {
    final lang = context.watch<ConfigProvider>().appLanguage;
    // Wrap with DropTarget to intercept drop events and prevent them from
    // propagating to FileUploadZone in TranslateScreen (IndexedStack keeps all screens alive)
    return DropTarget(
      onDragDone: (details) {
        // Handle drop at modal level - delegate to inner handler
        if (details.files.isNotEmpty) {
          _handleDroppedFile(details.files.first.path, lang);
        }
      },
      child: BackdropFilter(
        filter: ui.ImageFilter.blur(sigmaX: 5, sigmaY: 5),
        child: Container(
          color: Colors.black.withValues(alpha: 0.5),
          child: Center(
            child: Container(
              width: 500,
              margin: const EdgeInsets.all(32),
              decoration: BoxDecoration(
                color: widget.isDark ? AppColors.darkSurface : Colors.white,
                borderRadius: BorderRadius.circular(16),
                border: Border.all(
                  color: widget.isDark
                      ? const Color(0xFF444444)
                      : Colors.grey[200]!,
                ),
              ),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  // Header
                  Container(
                    padding: const EdgeInsets.all(24),
                    decoration: BoxDecoration(
                      border: Border(
                        bottom: BorderSide(
                          color: widget.isDark
                              ? const Color(0xFF444444)
                              : Colors.grey[200]!,
                        ),
                      ),
                    ),
                    child: Row(
                      children: [
                        Expanded(
                          child: Text(
                            AppStrings.get(lang, 'add_dict_title'),
                            style: TextStyle(
                              fontSize: 20,
                              fontWeight: FontWeight.bold,
                              fontFamily: 'Merriweather',
                              color: widget.isDark
                                  ? Colors.white
                                  : AppColors.lightPrimary,
                            ),
                          ),
                        ),
                        MouseRegion(
                          cursor: SystemMouseCursors.click,
                          child: IconButton(
                            onPressed: widget.onClose,
                            icon: FaIcon(
                              FontAwesomeIcons.xmark,
                              size: 20,
                              color: widget.isDark
                                  ? Colors.grey[400]
                                  : Colors.grey[500],
                            ),
                            style: IconButton.styleFrom(
                              backgroundColor: widget.isDark
                                  ? Colors.white.withValues(alpha: 0.1)
                                  : Colors.grey[100],
                              shape: const CircleBorder(),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),

                  // Body
                  Padding(
                    padding: const EdgeInsets.all(24),
                    child: DropTarget(
                      onDragEntered: (details) =>
                          setState(() => _isDragging = true),
                      onDragExited: (details) =>
                          setState(() => _isDragging = false),
                      onDragDone: (details) {
                        setState(() => _isDragging = false);
                        if (details.files.isNotEmpty) {
                          _handleDroppedFile(details.files.first.path, lang);
                        }
                      },
                      child: MouseRegion(
                        cursor: SystemMouseCursors.click,
                        child: GestureDetector(
                          behavior: HitTestBehavior.opaque,
                          onTap: () => _pickFile(lang),
                          child: Container(
                            height: 140,
                            decoration: BoxDecoration(
                              color: _isDragging
                                  ? (widget.isDark
                                      ? Colors.blue.withValues(alpha: 0.2)
                                      : Colors.blue.withValues(alpha: 0.1))
                                  : (widget.isDark
                                      ? Colors.white.withValues(alpha: 0.05)
                                      : Colors.grey[50]),
                              borderRadius: BorderRadius.circular(12),
                              border: Border.all(
                                color: _isDragging
                                    ? AppColors.lightPrimary
                                    : (widget.isDark
                                        ? const Color(0xFF444444)
                                        : Colors.grey[300]!),
                                width: 2,
                                strokeAlign: BorderSide.strokeAlignInside,
                              ),
                            ),
                            child: Center(
                              child: _selectedFile != null
                                  ? _buildSelectedFileUI(lang)
                                  : _buildUploadPromptUI(lang),
                            ),
                          ),
                        ),
                      ),
                    ),
                  ),

                  // Footer
                  Container(
                    padding: const EdgeInsets.all(24),
                    decoration: BoxDecoration(
                      border: Border(
                        top: BorderSide(
                          color: widget.isDark
                              ? const Color(0xFF444444)
                              : Colors.grey[200]!,
                        ),
                      ),
                    ),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.end,
                      children: [
                        MouseRegion(
                          cursor: SystemMouseCursors.click,
                          child: TextButton(
                            onPressed: widget.onClose,
                            style: TextButton.styleFrom(
                              padding: const EdgeInsets.symmetric(
                                  horizontal: 16, vertical: 12),
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(8),
                                side: BorderSide(
                                  color: widget.isDark
                                      ? const Color(0xFF444444)
                                      : Colors.grey[300]!,
                                ),
                              ),
                            ),
                            child: Text(
                              AppStrings.get(lang, 'cancel'),
                              style: TextStyle(
                                fontSize: 14,
                                fontWeight: FontWeight.w500,
                                color: widget.isDark
                                    ? Colors.grey[300]
                                    : Colors.grey[600],
                              ),
                            ),
                          ),
                        ),
                        const SizedBox(width: 12),
                        MouseRegion(
                          cursor: SystemMouseCursors.click,
                          child: ElevatedButton(
                            onPressed: () => _handleUpload(lang),
                            style: ElevatedButton.styleFrom(
                              backgroundColor: widget.isDark
                                  ? Colors.white
                                  : AppColors.lightPrimary,
                              foregroundColor:
                                  widget.isDark ? Colors.black : Colors.white,
                              padding: const EdgeInsets.symmetric(
                                  horizontal: 16, vertical: 12),
                              elevation: 0,
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(8),
                              ),
                            ),
                            child: Text(
                              AppStrings.get(lang, 'upload_btn'),
                              style: const TextStyle(
                                fontSize: 14,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ).animate().scale(
                  begin: const Offset(0.95, 0.95),
                  end: const Offset(1, 1),
                  duration: const Duration(milliseconds: 200),
                ),
          ),
        ),
      ),
    );
  }


  Widget _buildUploadPromptUI(String lang) {
    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        FaIcon(
          FontAwesomeIcons.arrowUpFromBracket,
          size: 24,
          color: widget.isDark
              ? Colors.white.withValues(alpha: 0.7)
              : AppColors.lightPrimary.withValues(alpha: 0.7),
        ),
        const SizedBox(height: 12),
        Text.rich(
          TextSpan(
            text: '${AppStrings.get(lang, 'drag_drop_or')} ',
            style: TextStyle(
              fontSize: 14,
              color: widget.isDark ? Colors.grey[200] : Colors.grey[700],
            ),
            children: [
              TextSpan(
                text: AppStrings.get(lang, 'browse_files'),
                style: TextStyle(
                  decoration: TextDecoration.underline,
                  color: widget.isDark ? Colors.white : AppColors.lightPrimary,
                ),
              ),
            ],
          ),
        ),
        const SizedBox(height: 4),
        Text(
          AppStrings.get(lang, 'supported_dict_formats'),
          style: TextStyle(
            fontSize: 12,
            color: widget.isDark ? Colors.grey[500] : Colors.grey[400],
          ),
        ),
      ],
    );
  }

  Widget _buildSelectedFileUI(String lang) {
    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        FaIcon(
          FontAwesomeIcons.fileLines,
          size: 24,
          color: widget.isDark ? Colors.green[400] : Colors.green[600],
        ),
        const SizedBox(height: 12),
        Text(
          AppStrings.get(lang, 'file_selected'),
          style: TextStyle(
            fontSize: 12,
            color: widget.isDark ? Colors.grey[400] : Colors.grey[500],
          ),
        ),
        const SizedBox(height: 4),
        Text(
          _dictionaryName ?? '',
          style: TextStyle(
            fontSize: 14,
            fontWeight: FontWeight.w500,
            color: widget.isDark ? Colors.white : AppColors.lightPrimary,
          ),
          overflow: TextOverflow.ellipsis,
        ),
      ],
    );
  }
}
</file>

<file path="windows/flutter/generated_plugin_registrant.cc">
//
//  Generated file. Do not edit.
//

// clang-format off

#include "generated_plugin_registrant.h"

#include <desktop_drop/desktop_drop_plugin.h>
#include <screen_retriever/screen_retriever_plugin.h>
#include <url_launcher_windows/url_launcher_windows.h>
#include <window_manager/window_manager_plugin.h>

void RegisterPlugins(flutter::PluginRegistry* registry) {
  DesktopDropPluginRegisterWithRegistrar(
      registry->GetRegistrarForPlugin("DesktopDropPlugin"));
  ScreenRetrieverPluginRegisterWithRegistrar(
      registry->GetRegistrarForPlugin("ScreenRetrieverPlugin"));
  UrlLauncherWindowsRegisterWithRegistrar(
      registry->GetRegistrarForPlugin("UrlLauncherWindows"));
  WindowManagerPluginRegisterWithRegistrar(
      registry->GetRegistrarForPlugin("WindowManagerPlugin"));
}
</file>

<file path="windows/flutter/generated_plugins.cmake">
#
# Generated file, do not edit.
#

list(APPEND FLUTTER_PLUGIN_LIST
  desktop_drop
  screen_retriever
  url_launcher_windows
  window_manager
)

list(APPEND FLUTTER_FFI_PLUGIN_LIST
)

set(PLUGIN_BUNDLED_LIBRARIES)

foreach(plugin ${FLUTTER_PLUGIN_LIST})
  add_subdirectory(flutter/ephemeral/.plugin_symlinks/${plugin}/windows plugins/${plugin})
  target_link_libraries(${BINARY_NAME} PRIVATE ${plugin}_plugin)
  list(APPEND PLUGIN_BUNDLED_LIBRARIES $<TARGET_FILE:${plugin}_plugin>)
  list(APPEND PLUGIN_BUNDLED_LIBRARIES ${${plugin}_bundled_libraries})
endforeach(plugin)

foreach(ffi_plugin ${FLUTTER_FFI_PLUGIN_LIST})
  add_subdirectory(flutter/ephemeral/.plugin_symlinks/${ffi_plugin}/windows plugins/${ffi_plugin})
  list(APPEND PLUGIN_BUNDLED_LIBRARIES ${${ffi_plugin}_bundled_libraries})
endforeach(ffi_plugin)
</file>

<file path="installers/Flux_Origin.iss">
; Script generated by the Inno Setup Script Wizard.
; SEE THE DOCUMENTATION FOR DETAILS ON CREATING INNO SETUP SCRIPT FILES!
; Non-commercial use only

#define MyAppName "FluxOrigin"
#define MyAppVersion "2.0.1"
#define MyAppPublisher "d-init-d"
#define MyAppURL "https://github.com/d-init-d/FluxOrigin.git"
#define MyAppExeName "flux_origin.exe"

[Setup]
; NOTE: The value of AppId uniquely identifies this application. Do not use the same AppId value in installers for other applications.
; (To generate a new GUID, click Tools | Generate GUID inside the IDE.)
AppId={{A2C274CA-C6F3-4278-82FD-E19DB7F033F0}
AppName={#MyAppName}
AppVersion={#MyAppVersion}
;AppVerName={#MyAppName} {#MyAppVersion}
AppPublisher={#MyAppPublisher}
AppPublisherURL={#MyAppURL}
AppSupportURL={#MyAppURL}
AppUpdatesURL={#MyAppURL}
DefaultDirName={autopf}\{#MyAppName}
UninstallDisplayIcon={app}\{#MyAppExeName}
; "ArchitecturesAllowed=x64compatible" specifies that Setup cannot run
; on anything but x64 and Windows 11 on Arm.
ArchitecturesAllowed=x64compatible
; "ArchitecturesInstallIn64BitMode=x64compatible" requests that the
; install be done in "64-bit mode" on x64 or Windows 11 on Arm,
; meaning it should use the native 64-bit Program Files directory and
; the 64-bit view of the registry.
ArchitecturesInstallIn64BitMode=x64compatible
DisableProgramGroupPage=yes
DisableDirPage=no
LicenseFile=D:\Downloads\license.txt
InfoBeforeFile=D:\Downloads\info.txt
; Uncomment the following line to run in non administrative install mode (install for current user only).
;PrivilegesRequired=lowest
OutputDir=D:\Downloads
OutputBaseFilename=FluxOrigin_Installer_v2.0.1
SetupIconFile=D:\FluxOrigin\windows\runner\resources\app_icon.ico
SolidCompression=yes
WizardStyle=modern dynamic

[Languages]
Name: "english"; MessagesFile: "compiler:Default.isl"

[Tasks]
Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked

[Files]
Source: "D:\FluxOrigin\build\windows\x64\runner\Release\{#MyAppExeName}"; DestDir: "{app}"; Flags: ignoreversion
Source: "D:\FluxOrigin\build\windows\x64\runner\Release\desktop_drop_plugin.dll"; DestDir: "{app}"; Flags: ignoreversion
Source: "D:\FluxOrigin\build\windows\x64\runner\Release\flutter_windows.dll"; DestDir: "{app}"; Flags: ignoreversion
Source: "D:\FluxOrigin\build\windows\x64\runner\Release\screen_retriever_plugin.dll"; DestDir: "{app}"; Flags: ignoreversion
Source: "D:\FluxOrigin\build\windows\x64\runner\Release\url_launcher_windows_plugin.dll"; DestDir: "{app}"; Flags: ignoreversion
Source: "D:\FluxOrigin\build\windows\x64\runner\Release\window_manager_plugin.dll"; DestDir: "{app}"; Flags: ignoreversion
Source: "D:\FluxOrigin\build\windows\x64\runner\Release\data\*"; DestDir: "{app}\data"; Flags: ignoreversion recursesubdirs createallsubdirs
; NOTE: Don't use "Flags: ignoreversion" on any shared system files

[Icons]
Name: "{autoprograms}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon

[Run]
Filename: "{app}\{#MyAppExeName}"; Description: "{cm:LaunchProgram,{#StringChange(MyAppName, '&', '&&')}}"; Flags: nowait postinstall skipifsilent
</file>

<file path="lib/ui/app.dart">
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'theme/app_theme.dart';
import 'theme/config_provider.dart';
import 'widgets/path_setup_modal.dart';
import 'widgets/title_bar.dart';
import 'widgets/sidebar.dart';
import 'widgets/ollama_health_check.dart';
import 'screens/translate_screen.dart';
import 'screens/history_screen.dart';
import 'screens/dictionary_screen.dart';
import 'screens/settings_screen.dart';
import 'screens/dev_logs_screen.dart';

class MyApp extends StatefulWidget {
  const MyApp({super.key});

  @override
  State<MyApp> createState() => _MyAppState();
}

class _MyAppState extends State<MyApp> {
  int _selectedIndex = 0;

  @override
  Widget build(BuildContext context) {
    return Consumer<ThemeNotifier>(
      builder: (context, themeNotifier, child) {
        return MaterialApp(
          title: 'FluxOrigin',
          theme: themeNotifier.currentTheme,
          debugShowCheckedModeBanner: false,
          home: OllamaHealthCheck(
            child: Consumer<ConfigProvider>(
              builder: (context, configProvider, _) {
                if (configProvider.isLoading) {
                  return Scaffold(
                    backgroundColor: themeNotifier.isDark
                        ? AppColors.darkPaper
                        : AppColors.lightPaper,
                    body: const Center(child: CircularProgressIndicator()),
                  );
                }

                return Stack(
                  children: [
                    Scaffold(
                      backgroundColor: themeNotifier.isDark
                          ? AppColors.darkPaper
                          : AppColors.lightPaper,
                      body: Column(
                        children: [
                          // CRITICAL: Fixed height TitleBar - NO Expanded
                          SizedBox(
                            height: 32,
                            child: TitleBar(isDark: themeNotifier.isDark),
                          ),

                          // CRITICAL: Expanded Row for remaining vertical space
                          Expanded(
                            child: Row(
                              children: [
                                // CRITICAL: Fixed width Sidebar - NO Expanded
                                SizedBox(
                                  width: 250,
                                  child: Sidebar(
                                    isDark: themeNotifier.isDark,
                                    selectedIndex: _selectedIndex,
                                    onItemTap: (index) {
                                      setState(() => _selectedIndex = index);
                                    },
                                  ),
                                ),

                                // CRITICAL: Expanded content area - fills remaining horizontal space
                                Expanded(
                                  child: Container(
                                    color: themeNotifier.isDark
                                        ? AppColors.darkPaper
                                        : AppColors.lightPaper,
                                    child: IndexedStack(
                                      index: _selectedIndex,
                                      children: [
                                        TranslateScreen(
                                            isDark: themeNotifier.isDark),
                                        HistoryScreen(
                                            isDark: themeNotifier.isDark),
                                        DictionaryScreen(
                                            isDark: themeNotifier.isDark),
                                        SettingsScreen(
                                            isDark: themeNotifier.isDark),
                                        DevLogsScreen(
                                            isDark: themeNotifier.isDark),
                                      ],
                                    ),
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                    if (!configProvider.isConfigured)
                      PathSetupModal(
                        isDark: themeNotifier.isDark,
                        isDismissible: false,
                      ),
                  ],
                );
              },
            ),
          ),
        );
      },
    );
  }
}
</file>

<file path="lib/ui/screens/dictionary_screen.dart">
import 'dart:io';
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:font_awesome_flutter/font_awesome_flutter.dart';
import 'package:flutter_animate/flutter_animate.dart';
import 'package:provider/provider.dart';
import '../theme/app_theme.dart';
import '../theme/config_provider.dart';
import '../widgets/upload_dictionary_modal.dart';
import '../../utils/app_strings.dart';

class DictionaryScreen extends StatefulWidget {
  final bool isDark;

  const DictionaryScreen({super.key, required this.isDark});

  @override
  State<DictionaryScreen> createState() => _DictionaryScreenState();
}

class _DictionaryScreenState extends State<DictionaryScreen> {
  bool _showModal = false;
  bool _isLoading = true;
  List<Map<String, dynamic>> _dictionaries = [];

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addPostFrameCallback((_) => _loadDictionaries());
  }

  Future<void> _loadDictionaries() async {
    setState(() => _isLoading = true);

    final configProvider = Provider.of<ConfigProvider>(context, listen: false);
    final dictionaryDir = configProvider.dictionaryDir;

    if (dictionaryDir.isEmpty) {
      setState(() {
        _dictionaries = [];
        _isLoading = false;
      });
      return;
    }

    final dir = Directory(dictionaryDir);
    if (!await dir.exists()) {
      setState(() {
        _dictionaries = [];
        _isLoading = false;
      });
      return;
    }

    final List<Map<String, dynamic>> dicts = [];

    try {
      await for (final entity in dir.list()) {
        if (entity is File && entity.path.toLowerCase().endsWith('.csv')) {
          final file = entity;
          final stat = await file.stat();
          final fileName = file.path.split(Platform.pathSeparator).last;
          
          // Count lines (approximate entry count)
          int lineCount = 0;
          try {
            final content = await file.readAsString();
            lineCount = content.split('\n').where((l) => l.trim().isNotEmpty).length;
          } catch (_) {}

          // Format file size
          final sizeBytes = stat.size;
          String fileSize;
          if (sizeBytes >= 1024 * 1024) {
            fileSize = '${(sizeBytes / (1024 * 1024)).toStringAsFixed(1)} MB';
          } else {
            fileSize = '${(sizeBytes / 1024).toStringAsFixed(0)} KB';
          }

          dicts.add({
            'name': fileName,
            'entries': lineCount,
            'fileSize': fileSize,
            'path': file.path,
          });
        }
      }
    } catch (e) {
      debugPrint('Error loading dictionaries: $e');
    }

    setState(() {
      _dictionaries = dicts;
      _isLoading = false;
    });
  }

  @override
  Widget build(BuildContext context) {
    final lang = context.watch<ConfigProvider>().appLanguage;
    return Stack(
      children: [
        RefreshIndicator(
          onRefresh: _loadDictionaries,
          child: Container(
            padding: const EdgeInsets.all(32),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Header
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          AppStrings.get(lang, 'dictionary_title'),
                          style: GoogleFonts.merriweather(
                            fontSize: 24,
                            fontWeight: FontWeight.bold,
                            color: widget.isDark
                                ? Colors.white
                                : AppColors.lightPrimary,
                          ),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          AppStrings.get(lang, 'dictionary_subtitle'),
                          style: TextStyle(
                            fontSize: 14,
                            color: widget.isDark
                                ? Colors.grey[400]
                                : AppColors.lightPrimary.withValues(alpha: 0.7),
                          ),
                        ),
                      ],
                    ),
                    Row(
                      children: [
                        IconButton(
                          onPressed: _loadDictionaries,
                          icon: const FaIcon(FontAwesomeIcons.arrowsRotate, size: 14),
                          tooltip: AppStrings.get(lang, 'refresh_tooltip'),
                          style: IconButton.styleFrom(
                            backgroundColor: widget.isDark
                                ? Colors.white.withValues(alpha: 0.1)
                                : AppColors.lightPrimary.withValues(alpha: 0.1),
                          ),
                        ),
                        const SizedBox(width: 8),
                        ElevatedButton.icon(
                          onPressed: () => setState(() => _showModal = true),
                          icon: const FaIcon(FontAwesomeIcons.plus, size: 14),
                          label: Text(AppStrings.get(lang, 'add_new')),
                          style: ElevatedButton.styleFrom(
                            backgroundColor:
                                widget.isDark ? Colors.white : AppColors.lightPrimary,
                            foregroundColor:
                                widget.isDark ? Colors.black : Colors.white,
                            elevation: 0,
                            padding: const EdgeInsets.symmetric(
                                horizontal: 16, vertical: 12),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ],
                ),

                const SizedBox(height: 32),

                // Table
                Expanded(
                  child: Container(
                    decoration: BoxDecoration(
                      color: widget.isDark ? AppColors.darkSurface : Colors.white,
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(
                        color: widget.isDark
                            ? AppColors.darkBorder
                            : AppColors.lightBorder,
                      ),
                    ),
                    child: Column(
                      children: [
                        // Table header
                        Container(
                          padding: const EdgeInsets.all(16),
                          decoration: BoxDecoration(
                            color: widget.isDark
                                ? Colors.black.withValues(alpha: 0.2)
                                : Colors.grey[50]?.withValues(alpha: 0.5),
                            borderRadius: const BorderRadius.only(
                              topLeft: Radius.circular(12),
                              topRight: Radius.circular(12),
                            ),
                            border: Border(
                              bottom: BorderSide(
                                color: widget.isDark
                                    ? AppColors.darkBorder
                                    : Colors.grey[100]!,
                              ),
                            ),
                          ),
                          child: Row(
                            children: [
                              Expanded(
                                flex: 3,
                                child: Text(
                                  AppStrings.get(lang, 'dictionary_name'),
                                  style: TextStyle(
                                    fontSize: 12,
                                    fontWeight: FontWeight.bold,
                                    color: widget.isDark
                                        ? Colors.grey[400]
                                        : Colors.grey[500],
                                    letterSpacing: 1,
                                  ),
                                ),
                              ),
                              Expanded(
                                flex: 1,
                                child: Text(
                                  AppStrings.get(lang, 'dictionary_size'),
                                  textAlign: TextAlign.right,
                                  style: TextStyle(
                                    fontSize: 12,
                                    fontWeight: FontWeight.w500,
                                    color: widget.isDark
                                        ? Colors.grey[400]
                                        : Colors.grey[500],
                                    letterSpacing: 1,
                                  ),
                                ),
                              ),
                              Expanded(
                                flex: 1,
                                child: Text(
                                  AppStrings.get(lang, 'dictionary_entries'),
                                  textAlign: TextAlign.center,
                                  style: TextStyle(
                                    fontSize: 12,
                                    fontWeight: FontWeight.w500,
                                    color: widget.isDark
                                        ? Colors.grey[400]
                                        : Colors.grey[500],
                                    letterSpacing: 1,
                                  ),
                                ),
                              ),
                              const SizedBox(width: 48),
                            ],
                          ),
                        ),

                        // Table content
                        Expanded(
                          child: _buildContent(),
                        ),

                        // Footer
                        Container(
                          padding: const EdgeInsets.all(32),
                          decoration: BoxDecoration(
                            border: Border(
                              top: BorderSide(
                                color: widget.isDark
                                    ? AppColors.darkBorder
                                    : Colors.grey[100]!,
                                style: BorderStyle.solid,
                              ),
                            ),
                          ),
                          child: Center(
                            child: Text(
                              'Hi·ªÉn th·ªã ${_dictionaries.length} t·ª´ ƒëi·ªÉn',
                              style: TextStyle(
                                fontSize: 12,
                                fontStyle: FontStyle.italic,
                                color: widget.isDark
                                    ? Colors.grey[600]
                                    : Colors.grey[400],
                              ),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ],
            ),
          ).animate().fadeIn(),
        ),

        // Modal
        if (_showModal)
          UploadDictionaryModal(
            isDark: widget.isDark,
            onClose: () {
              setState(() => _showModal = false);
              _loadDictionaries(); // Refresh after adding
            },
          ),
      ],
    );
  }

  Widget _buildContent() {
    final lang = context.watch<ConfigProvider>().appLanguage;
    if (_isLoading) {
      return const Center(child: CircularProgressIndicator());
    }

    if (_dictionaries.isEmpty) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            FaIcon(
              FontAwesomeIcons.folderOpen,
              size: 48,
              color: widget.isDark ? Colors.grey[600] : Colors.grey[400],
            ),
            const SizedBox(height: 16),
            Text(
              AppStrings.get(lang, 'no_dictionaries'),
              style: TextStyle(
                fontSize: 16,
                color: widget.isDark ? Colors.grey[400] : Colors.grey[600],
              ),
            ),
            const SizedBox(height: 8),
            Text(
              AppStrings.get(lang, 'no_dictionaries_subtitle'),
              style: TextStyle(
                fontSize: 14,
                color: widget.isDark ? Colors.grey[600] : Colors.grey[400],
              ),
            ),
          ],
        ),
      );
    }

    return ListView.builder(
      itemCount: _dictionaries.length,
      itemBuilder: (context, index) => _DictRow(
        dict: _dictionaries[index],
        isDark: widget.isDark,
        isLast: index == _dictionaries.length - 1,
      ),
    );
  }
}


class _DictRow extends StatefulWidget {
  final Map<String, dynamic> dict;
  final bool isDark;
  final bool isLast;

  const _DictRow({
    required this.dict,
    required this.isDark,
    required this.isLast,
  });

  @override
  State<_DictRow> createState() => _DictRowState();
}

class _DictRowState extends State<_DictRow> {
  bool _isHovered = false;

  @override
  Widget build(BuildContext context) {
    return MouseRegion(
      onEnter: (_) => setState(() => _isHovered = true),
      onExit: (_) => setState(() => _isHovered = false),
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: _isHovered
              ? (widget.isDark
                  ? Colors.white.withValues(alpha: 0.05)
                  : Colors.grey[50])
              : Colors.transparent,
          border: widget.isLast
              ? null
              : Border(
                  bottom: BorderSide(
                    color: widget.isDark
                        ? const Color(0xFF2A2A2A)
                        : Colors.grey[50]!,
                  ),
                ),
        ),
        child: Row(
          children: [
            Expanded(
              flex: 3,
              child: Row(
                children: [
                  Container(
                    width: 32,
                    height: 32,
                    decoration: BoxDecoration(
                      color: widget.isDark
                          ? Colors.white.withValues(alpha: 0.1)
                          : AppColors.lightPrimary.withValues(alpha: 0.1),
                      borderRadius: BorderRadius.circular(6),
                    ),
                    child: Center(
                      child: FaIcon(
                        FontAwesomeIcons.book,
                        size: 12,
                        color: widget.isDark
                            ? Colors.white
                            : AppColors.lightPrimary,
                      ),
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Text(
                      widget.dict['name'],
                      style: TextStyle(
                        fontSize: 14,
                        fontWeight: FontWeight.w500,
                        color:
                            widget.isDark ? Colors.white : AppColors.lightPrimary,
                      ),
                      overflow: TextOverflow.ellipsis,
                    ),
                  ),
                ],
              ),
            ),
            Expanded(
              flex: 1,
              child: Text(
                widget.dict['fileSize'],
                textAlign: TextAlign.right,
                style: TextStyle(
                  fontSize: 12,
                  color: widget.isDark ? Colors.grey[400] : Colors.grey[600],
                ),
              ),
            ),
            Expanded(
              flex: 1,
              child: Text(
                widget.dict['entries'].toString(),
                textAlign: TextAlign.center,
                style: TextStyle(
                  fontSize: 12,
                  fontFamily: 'monospace',
                  color: widget.isDark ? Colors.grey[400] : Colors.grey[600],
                ),
              ),
            ),
            SizedBox(
              width: 48,
              child: IconButton(
                onPressed: () {},
                icon: FaIcon(
                  FontAwesomeIcons.ellipsisVertical,
                  size: 16,
                  color: widget.isDark ? Colors.grey[400] : Colors.grey[400],
                ),
                style: IconButton.styleFrom(
                  backgroundColor: _isHovered
                      ? (widget.isDark
                          ? Colors.white.withValues(alpha: 0.2)
                          : Colors.grey[200])
                      : Colors.transparent,
                  shape: const CircleBorder(),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
</file>

<file path="lib/ui/screens/history_screen.dart">
import 'dart:convert';
import 'dart:io';
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:flutter_animate/flutter_animate.dart';
import 'package:font_awesome_flutter/font_awesome_flutter.dart';
import 'package:provider/provider.dart';
import 'package:path/path.dart' as path;
import '../theme/app_theme.dart';
import '../theme/config_provider.dart';
import '../../utils/app_strings.dart';

class HistoryItem {
  final String fileName;
  final DateTime date;
  final String status;

  const HistoryItem({
    required this.fileName,
    required this.date,
    required this.status,
  });

  factory HistoryItem.fromJson(Map<String, dynamic> json) {
    return HistoryItem(
      fileName: json['fileName'] ?? '',
      date: DateTime.tryParse(json['date'] ?? '') ?? DateTime.now(),
      status: json['status'] ?? 'unknown',
    );
  }

  String formattedDate(String lang) {
    final now = DateTime.now();
    final diff = now.difference(date);
    
    if (diff.inDays == 0) {
      return '${date.hour.toString().padLeft(2, '0')}:${date.minute.toString().padLeft(2, '0')}';
    } else if (diff.inDays == 1) {
      return AppStrings.get(lang, 'yesterday');
    } else if (diff.inDays < 7) {
      return '${diff.inDays} ${AppStrings.get(lang, 'days_ago')}';
    } else {
      return '${date.day}/${date.month}/${date.year}';
    }
  }
}

class HistoryScreen extends StatefulWidget {
  final bool isDark;

  const HistoryScreen({super.key, required this.isDark});

  @override
  State<HistoryScreen> createState() => _HistoryScreenState();
}


class _HistoryScreenState extends State<HistoryScreen> {
  bool _isLoading = true;
  List<HistoryItem> _history = [];

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addPostFrameCallback((_) => _loadHistory());
  }

  Future<void> _loadHistory() async {
    setState(() => _isLoading = true);

    final configProvider = Provider.of<ConfigProvider>(context, listen: false);
    final dictionaryDir = configProvider.dictionaryDir;

    if (dictionaryDir.isEmpty) {
      setState(() {
        _history = [];
        _isLoading = false;
      });
      return;
    }

    final historyPath = path.join(dictionaryDir, 'history_log.json');
    final historyFile = File(historyPath);

    if (!await historyFile.exists()) {
      setState(() {
        _history = [];
        _isLoading = false;
      });
      return;
    }

    try {
      final content = await historyFile.readAsString();
      final decoded = jsonDecode(content);
      
      if (decoded is List) {
        final items = decoded
            .map((e) => HistoryItem.fromJson(e as Map<String, dynamic>))
            .toList();
        
        // Sort by newest first
        items.sort((a, b) => b.date.compareTo(a.date));
        
        setState(() {
          _history = items;
          _isLoading = false;
        });
      } else {
        setState(() {
          _history = [];
          _isLoading = false;
        });
      }
    } catch (e) {
      debugPrint('Error loading history: $e');
      setState(() {
        _history = [];
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    final lang = context.watch<ConfigProvider>().appLanguage;
    return RefreshIndicator(
      onRefresh: _loadHistory,
      child: Container(
        padding: const EdgeInsets.all(32),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Header
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(
                  AppStrings.get(lang, 'history_title'),
                  style: GoogleFonts.merriweather(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                    color: widget.isDark ? Colors.white : AppColors.lightPrimary,
                  ),
                ),
                IconButton(
                  onPressed: _loadHistory,
                  icon: const FaIcon(FontAwesomeIcons.arrowsRotate, size: 14),
                  tooltip: AppStrings.get(lang, 'refresh_tooltip'),
                  style: IconButton.styleFrom(
                    backgroundColor: widget.isDark
                        ? Colors.white.withValues(alpha: 0.1)
                        : AppColors.lightPrimary.withValues(alpha: 0.1),
                  ),
                ),
              ],
            ),

            const SizedBox(height: 24),

            // Content
            Expanded(child: _buildContent()),
          ],
        ),
      ).animate().fadeIn(),
    );
  }

  Widget _buildContent() {
    final lang = context.watch<ConfigProvider>().appLanguage;
    if (_isLoading) {
      return const Center(child: CircularProgressIndicator());
    }

    if (_history.isEmpty) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            FaIcon(
              FontAwesomeIcons.clockRotateLeft,
              size: 48,
              color: widget.isDark ? Colors.grey[600] : Colors.grey[400],
            ),
            const SizedBox(height: 16),
            Text(
              AppStrings.get(lang, 'no_history'),
              style: TextStyle(
                fontSize: 16,
                color: widget.isDark ? Colors.grey[400] : Colors.grey[600],
              ),
            ),
            const SizedBox(height: 8),
            Text(
              AppStrings.get(lang, 'no_history_subtitle'),
              style: TextStyle(
                fontSize: 14,
                color: widget.isDark ? Colors.grey[600] : Colors.grey[400],
              ),
            ),
          ],
        ),
      );
    }

    return ListView.separated(
      itemCount: _history.length,
      separatorBuilder: (context, index) => const SizedBox(height: 12),
      itemBuilder: (context, index) => _HistoryCard(
        isDark: widget.isDark,
        item: _history[index],
        lang: lang,
      ),
    );
  }
}


class _HistoryCard extends StatefulWidget {
  final bool isDark;
  final HistoryItem item;
  final String lang;

  const _HistoryCard({
    required this.isDark,
    required this.item,
    required this.lang,
  });

  @override
  State<_HistoryCard> createState() => _HistoryCardState();
}

class _HistoryCardState extends State<_HistoryCard> {
  bool _isHovered = false;

  @override
  Widget build(BuildContext context) {
    return MouseRegion(
      onEnter: (_) => setState(() => _isHovered = true),
      onExit: (_) => setState(() => _isHovered = false),
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        decoration: BoxDecoration(
          color: widget.isDark ? AppColors.darkSurface : Colors.white,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(
            color: _isHovered
                ? (widget.isDark
                    ? Colors.white.withValues(alpha: 0.5)
                    : AppColors.lightPrimary.withValues(alpha: 0.5))
                : (widget.isDark
                    ? AppColors.darkBorder
                    : AppColors.lightBorder),
          ),
          boxShadow: _isHovered
              ? [
                  BoxShadow(
                    color: Colors.black.withValues(alpha: widget.isDark ? 0.3 : 0.05),
                    blurRadius: 8,
                    offset: const Offset(0, 2),
                  ),
                ]
              : null,
        ),
        child: Row(
          children: [
            // Icon (Left)
            Container(
              width: 40,
              height: 40,
              decoration: BoxDecoration(
                color: widget.isDark
                    ? Colors.white.withValues(alpha: 0.1)
                    : AppColors.lightPrimary.withValues(alpha: 0.05),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Center(
                child: FaIcon(
                  widget.item.status == 'completed'
                      ? FontAwesomeIcons.circleCheck
                      : FontAwesomeIcons.fileLines,
                  size: 18,
                  color: widget.item.status == 'completed'
                      ? Colors.green
                      : (widget.isDark ? Colors.white : AppColors.lightPrimary),
                ),
              ),
            ),
            const SizedBox(width: 16),

            // Filename (Middle - Expanded)
            Expanded(
              child: Text(
                widget.item.fileName,
                style: GoogleFonts.merriweather(
                  fontSize: 14,
                  fontWeight: FontWeight.bold,
                  color: widget.isDark ? Colors.white : AppColors.lightPrimary,
                ),
                overflow: TextOverflow.ellipsis,
              ),
            ),

            const SizedBox(width: 16),

            // Date (Right)
            Text(
              widget.item.formattedDate(widget.lang),
              style: GoogleFonts.inter(
                fontSize: 13,
                color: widget.isDark ? Colors.grey[400] : Colors.grey[600],
              ),
            ),
          ],
        ),
      ),
    );
  }
}
</file>

<file path="lib/ui/widgets/language_selector.dart">
import 'package:flutter/material.dart';
import 'package:font_awesome_flutter/font_awesome_flutter.dart';
import 'package:provider/provider.dart';
import '../theme/app_theme.dart';
import '../theme/config_provider.dart';
import '../../utils/app_strings.dart';

class LanguageSelector extends StatefulWidget {
  final String value;
  final bool isDark;
  final Function(String) onChange;
  final List<String> availableLanguages;
  final String? disabledLanguage;

  const LanguageSelector({
    super.key,
    required this.value,
    required this.isDark,
    required this.onChange,
    required this.availableLanguages,
    this.disabledLanguage,
  });

  @override
  State<LanguageSelector> createState() => _LanguageSelectorState();
}

class _LanguageSelectorState extends State<LanguageSelector> {
  bool _isOpen = false;
  final LayerLink _layerLink = LayerLink();
  OverlayEntry? _overlayEntry;

  @override
  void dispose() {
    _removeOverlay();
    super.dispose();
  }

  void _toggleDropdown() {
    if (_isOpen) {
      _removeOverlay();
    } else {
      _showOverlay();
    }
  }

  void _showOverlay() {
    _overlayEntry = _createOverlayEntry();
    Overlay.of(context).insert(_overlayEntry!);
    setState(() => _isOpen = true);
  }

  void _removeOverlay() {
    _overlayEntry?.remove();
    _overlayEntry = null;
    setState(() => _isOpen = false);
  }

  OverlayEntry _createOverlayEntry() {
    RenderBox renderBox = context.findRenderObject() as RenderBox;
    var size = renderBox.size;

    return OverlayEntry(
      builder: (context) => GestureDetector(
        behavior: HitTestBehavior.translucent,
        onTap: _removeOverlay,
        child: Stack(
          children: [
            Positioned(
              width: size.width,
              child: CompositedTransformFollower(
                link: _layerLink,
                showWhenUnlinked: false,
                offset: Offset(0, size.height + 8),
                child: Material(
                  elevation: 8,
                  borderRadius: BorderRadius.circular(12),
                  child: Container(
                    decoration: BoxDecoration(
                      color:
                          widget.isDark ? AppColors.darkSurface : Colors.white,
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(
                        color: widget.isDark
                            ? const Color(0xFF444444)
                            : Colors.grey[200]!,
                      ),
                    ),
                    child: Column(
                      mainAxisSize: MainAxisSize.min,
                      children: widget.availableLanguages.map((lang) {
                        final isSelected = lang == widget.value;
                        final isDisabled = lang == widget.disabledLanguage;
                        return InkWell(
                          onTap: isDisabled
                              ? null
                              : () {
                                  widget.onChange(lang);
                                  _removeOverlay();
                                },
                          child: Container(
                            padding: const EdgeInsets.symmetric(
                                horizontal: 16, vertical: 12),
                            decoration: BoxDecoration(
                              color: isSelected
                                  ? (widget.isDark
                                      ? Colors.white.withValues(alpha: 0.1)
                                      : AppColors.lightPrimary.withValues(alpha: 0.1))
                                  : Colors.transparent,
                            ),
                            child: _buildLanguageItem(lang, isSelected),
                          ),
                        );
                      }).toList(),
                    ),
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildLanguageItem(String lang, bool isSelected) {
    final appLang = context.read<ConfigProvider>().appLanguage;
    final isDisabled = lang == widget.disabledLanguage;

    return Opacity(
      opacity: isDisabled ? 0.5 : 1.0,
      child: Row(
        children: [
          Container(
            width: 24,
            height: 24,
            decoration: BoxDecoration(
              color: widget.isDark
                  ? Colors.white.withValues(alpha: 0.2)
                  : Colors.grey[100],
              borderRadius: BorderRadius.circular(4),
            ),
            child: Center(
              child: Text(
                _getLanguageCode(lang),
                style: TextStyle(
                  fontSize: 10,
                  fontWeight: FontWeight.bold,
                  color: widget.isDark ? Colors.white : Colors.grey[500],
                ),
              ),
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              _getLocalizedLanguageName(lang, appLang),
              style: TextStyle(
                fontSize: 14,
                color: isDisabled
                    ? Colors.grey
                    : (isSelected
                        ? (widget.isDark
                            ? Colors.white
                            : AppColors.lightPrimary)
                        : (widget.isDark ? Colors.white : Colors.grey[800])),
                fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
                decoration: null,
              ),
            ),
          ),
          if (isSelected)
            FaIcon(
              FontAwesomeIcons.check,
              size: 12,
              color: widget.isDark ? Colors.white : AppColors.lightPrimary,
            ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final appLang = context.watch<ConfigProvider>().appLanguage;
    return CompositedTransformTarget(
      link: _layerLink,
      child: MouseRegion(
        cursor: SystemMouseCursors.click,
        child: GestureDetector(
          onTap: _toggleDropdown,
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
            decoration: BoxDecoration(
              color: widget.isDark ? AppColors.darkSurface : Colors.white,
              borderRadius: BorderRadius.circular(8),
              border: Border.all(
                color: widget.isDark
                    ? const Color(0xFF444444)
                    : AppColors.lightBorder,
              ),
            ),
            child: Row(
              children: [
                Container(
                  width: 24,
                  height: 24,
                  decoration: BoxDecoration(
                    color: widget.isDark
                        ? Colors.white.withValues(alpha: 0.1)
                        : AppColors.lightPrimary.withValues(alpha: 0.05),
                    borderRadius: BorderRadius.circular(4),
                  ),
                  child: Center(
                    child: Text(
                      _getLanguageCode(widget.value),
                      style: TextStyle(
                        fontSize: 10,
                        fontWeight: FontWeight.bold,
                        color: widget.isDark
                            ? Colors.white.withValues(alpha: 0.8)
                            : AppColors.lightPrimary,
                      ),
                    ),
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: Text(
                    _getLocalizedLanguageName(widget.value, appLang),
                    style: TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w500,
                      color: widget.isDark
                          ? Colors.grey[200]
                          : AppColors.lightPrimary,
                    ),
                  ),
                ),
                FaIcon(
                  _isOpen
                      ? FontAwesomeIcons.chevronUp
                      : FontAwesomeIcons.chevronDown,
                  size: 12,
                  color: widget.isDark ? Colors.grey : Colors.grey[600],
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  String _getLanguageCode(String lang) {
    switch (lang) {
      case 'Ti·∫øng Anh':
        return 'EN';
      case 'Ti·∫øng Trung':
        return 'CN';
      case 'Ti·∫øng Vi·ªát':
        return 'VI';
      default:
        return lang.length >= 2 ? lang.substring(0, 2).toUpperCase() : lang;
    }
  }

  String _getLocalizedLanguageName(String langCode, String currentAppLang) {
    switch (langCode) {
      case 'Ti·∫øng Anh':
        return AppStrings.get(currentAppLang, 'lang_en');
      case 'Ti·∫øng Vi·ªát':
        return AppStrings.get(currentAppLang, 'lang_vi');
      case 'Ti·∫øng Trung':
        return AppStrings.get(currentAppLang, 'lang_cn');
      default:
        return langCode;
    }
  }
}
</file>

<file path="lib/ui/widgets/path_setup_modal.dart">
import 'dart:io';
import 'dart:ui' as ui;
import 'package:flutter/material.dart';
import 'package:font_awesome_flutter/font_awesome_flutter.dart';
import 'package:flutter_animate/flutter_animate.dart';
import 'package:file_picker/file_picker.dart';
import 'package:provider/provider.dart';
import 'package:path/path.dart' as path;
import '../theme/app_theme.dart';
import '../theme/config_provider.dart';

class PathSetupModal extends StatefulWidget {
  final bool isDark;
  final VoidCallback? onClose;
  final bool isDismissible;

  const PathSetupModal({
    super.key,
    required this.isDark,
    this.onClose,
    this.isDismissible = true,
  });

  @override
  State<PathSetupModal> createState() => _PathSetupModalState();
}

class _PathSetupModalState extends State<PathSetupModal> {
  final TextEditingController _projectController = TextEditingController();
  bool _isLoading = false;

  @override
  void initState() {
    super.initState();
    final config = context.read<ConfigProvider>();
    _projectController.text = config.projectPath;
  }

  @override
  void dispose() {
    _projectController.dispose();
    super.dispose();
  }

  Future<void> _pickDirectory() async {
    String? selectedDirectory = await FilePicker.platform.getDirectoryPath();
    if (selectedDirectory != null) {
      setState(() {
        _projectController.text = selectedDirectory;
      });
    }
  }

  Future<void> _saveConfig() async {
    final projectPath = _projectController.text;
    if (projectPath.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Vui l√≤ng ch·ªçn th∆∞ m·ª•c d·ª± √°n')),
      );
      return;
    }

    setState(() => _isLoading = true);

    try {
      // Create subdirectories
      final dictionaryDir = Directory(path.join(projectPath, 'dictionary'));

      if (!await dictionaryDir.exists()) {
        await dictionaryDir.create(recursive: true);
      }

      await context.read<ConfigProvider>().setProjectPath(projectPath);

      if (mounted) {
        setState(() => _isLoading = false);
        if (widget.onClose != null) {
          widget.onClose!();
        }
      }
    } catch (e) {
      if (mounted) {
        setState(() => _isLoading = false);
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('L·ªói khi t·∫°o th∆∞ m·ª•c: $e')),
        );
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return BackdropFilter(
      filter: ui.ImageFilter.blur(sigmaX: 5, sigmaY: 5),
      child: Container(
        color: Colors.black.withValues(alpha: 0.5),
        child: Center(
          child: Material(
            type: MaterialType.transparency,
            child: Container(
              width: 500,
              margin: const EdgeInsets.all(32),
              decoration: BoxDecoration(
                color: widget.isDark ? AppColors.darkSurface : Colors.white,
                borderRadius: BorderRadius.circular(16),
                border: Border.all(
                  color: widget.isDark
                      ? const Color(0xFF444444)
                      : Colors.grey[200]!,
                ),
              ),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  // Header
                  Container(
                    padding: const EdgeInsets.all(24),
                    decoration: BoxDecoration(
                      border: Border(
                        bottom: BorderSide(
                          color: widget.isDark
                              ? const Color(0xFF444444)
                              : Colors.grey[200]!,
                        ),
                      ),
                    ),
                    child: Row(
                      children: [
                        Expanded(
                          child: Text(
                            'C·∫•u h√¨nh D·ª± √°n',
                            style: TextStyle(
                              fontSize: 20,
                              fontWeight: FontWeight.bold,
                              fontFamily: 'Merriweather',
                              color: widget.isDark
                                  ? Colors.white
                                  : AppColors.lightPrimary,
                            ),
                          ),
                        ),
                        if (widget.isDismissible && widget.onClose != null)
                          IconButton(
                            onPressed: widget.onClose,
                            icon: FaIcon(
                              FontAwesomeIcons.xmark,
                              size: 20,
                              color: widget.isDark
                                  ? Colors.grey[400]
                                  : Colors.grey[500],
                            ),
                            style: IconButton.styleFrom(
                              backgroundColor: widget.isDark
                                  ? Colors.white.withValues(alpha: 0.1)
                                  : Colors.grey[100],
                              shape: const CircleBorder(),
                            ),
                          ),
                      ],
                    ),
                  ),

                  // Body
                  Padding(
                    padding: const EdgeInsets.all(24),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          'H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o th∆∞ m·ª•c "dictionary" ƒë·ªÉ ch·ª©a d·ªØ li·ªáu t·ª´ ƒëi·ªÉn.',
                          style: TextStyle(
                            fontSize: 13,
                            color: widget.isDark
                                ? Colors.grey[400]
                                : Colors.grey[600],
                            fontStyle: FontStyle.italic,
                          ),
                        ),
                        const SizedBox(height: 16),
                        _buildPathInput(
                          'Th∆∞ m·ª•c D·ª± √°n (Project Folder)',
                          'Ch·ªçn th∆∞ m·ª•c g·ªëc cho d·ª± √°n',
                          _projectController,
                        ),
                      ],
                    ),
                  ),

                  // Footer
                  Container(
                    padding: const EdgeInsets.all(24),
                    decoration: BoxDecoration(
                      border: Border(
                        top: BorderSide(
                          color: widget.isDark
                              ? const Color(0xFF444444)
                              : Colors.grey[200]!,
                        ),
                      ),
                    ),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.end,
                      children: [
                        if (widget.isDismissible && widget.onClose != null) ...[
                          TextButton(
                            onPressed: widget.onClose,
                            style: TextButton.styleFrom(
                              padding: const EdgeInsets.symmetric(
                                  horizontal: 16, vertical: 12),
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(8),
                                side: BorderSide(
                                  color: widget.isDark
                                      ? const Color(0xFF444444)
                                      : Colors.grey[300]!,
                                ),
                              ),
                            ),
                            child: Text(
                              'H·ªßy',
                              style: TextStyle(
                                fontSize: 14,
                                fontWeight: FontWeight.w500,
                                color: widget.isDark
                                    ? Colors.grey[300]
                                    : Colors.grey[600],
                              ),
                            ),
                          ),
                          const SizedBox(width: 12),
                        ],
                        ElevatedButton(
                          onPressed: _isLoading ? null : _saveConfig,
                          style: ElevatedButton.styleFrom(
                            backgroundColor: widget.isDark
                                ? Colors.white
                                : AppColors.lightPrimary,
                            foregroundColor:
                                widget.isDark ? Colors.black : Colors.white,
                            padding: const EdgeInsets.symmetric(
                                horizontal: 16, vertical: 12),
                            elevation: 0,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                          ),
                          child: _isLoading
                              ? const SizedBox(
                                  width: 20,
                                  height: 20,
                                  child:
                                      CircularProgressIndicator(strokeWidth: 2),
                                )
                              : const Text(
                                  'L∆∞u & T·∫°o th∆∞ m·ª•c',
                                  style: TextStyle(
                                    fontSize: 14,
                                    fontWeight: FontWeight.w500,
                                  ),
                                ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ).animate().scale(
                begin: const Offset(0.95, 0.95),
                end: const Offset(1, 1),
                duration: const Duration(milliseconds: 200),
              ),
        ),
      ),
    );
  }

  Widget _buildPathInput(
      String label, String hint, TextEditingController controller) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: TextStyle(
            fontSize: 14,
            fontWeight: FontWeight.w500,
            color: widget.isDark ? Colors.grey[300] : Colors.grey[700],
          ),
        ),
        const SizedBox(height: 8),
        Row(
          children: [
            Expanded(
              child: TextField(
                controller: controller,
                readOnly: true,
                decoration: InputDecoration(
                  hintText: hint,
                  hintStyle: TextStyle(
                    color: widget.isDark ? Colors.grey[500] : Colors.grey[400],
                  ),
                  filled: true,
                  fillColor: widget.isDark
                      ? Colors.black.withValues(alpha: 0.2)
                      : Colors.grey[50],
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(8),
                    borderSide: BorderSide(
                      color: widget.isDark
                          ? const Color(0xFF444444)
                          : Colors.grey[300]!,
                    ),
                  ),
                  enabledBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(8),
                    borderSide: BorderSide(
                      color: widget.isDark
                          ? const Color(0xFF444444)
                          : Colors.grey[300]!,
                    ),
                  ),
                  focusedBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(8),
                    borderSide: BorderSide(
                      color: widget.isDark
                          ? Colors.white.withValues(alpha: 0.5)
                          : AppColors.lightPrimary.withValues(alpha: 0.5),
                    ),
                  ),
                  contentPadding:
                      const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
                ),
                style: TextStyle(
                  fontSize: 14,
                  color: widget.isDark ? Colors.white : AppColors.lightPrimary,
                ),
              ),
            ),
            const SizedBox(width: 8),
            IconButton(
              onPressed: _pickDirectory,
              icon: FaIcon(
                FontAwesomeIcons.folderOpen,
                size: 18,
                color: widget.isDark ? Colors.white : AppColors.lightPrimary,
              ),
              style: IconButton.styleFrom(
                backgroundColor: widget.isDark
                    ? Colors.white.withValues(alpha: 0.1)
                    : AppColors.lightPrimary.withValues(alpha: 0.1),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
                padding: const EdgeInsets.all(12),
              ),
            ),
          ],
        ),
      ],
    );
  }
}
</file>

<file path="lib/utils/app_strings.dart">
class AppStrings {
  static const Map<String, Map<String, String>> _localizedValues = {
    'vi': {
      'settings_title': 'C√†i ƒë·∫∑t',
      'appearance_section': 'GIAO DI·ªÜN',
      'dark_mode': 'Ch·∫ø ƒë·ªô t·ªëi (Dark Mode)',
      'dark_mode_subtitle': 'S·ª≠ d·ª•ng giao di·ªán t·ªëi ƒë·ªÉ b·∫£o v·ªá m·∫Øt',
      'display_font': 'Font ch·ªØ hi·ªÉn th·ªã',
      'display_font_subtitle': 'T√πy ch·ªânh font ch·ªØ cho ph·∫ßn ƒë·ªçc',
      'language': 'Ng√¥n ng·ªØ / Language',
      'language_subtitle': 'Ch·ªçn ng√¥n ng·ªØ hi·ªÉn th·ªã',
      'ai_config_section': 'C·∫§U H√åNH AI',
      'translation_model': 'M√¥ h√¨nh d·ªãch thu·∫≠t',
      'translation_model_subtitle': 'Ch·ªçn m√¥ h√¨nh ng√¥n ng·ªØ ch√≠nh',
      'manage_models': 'Qu·∫£n l√Ω Model ƒë√£ t·∫£i',
      'manage_models_subtitle': 'model ƒë√£ c√†i ƒë·∫∑t',
      'translation_config_section': 'C·∫§U H√åNH D·ªäCH THU·∫¨T',
      'project_folder': 'Th∆∞ m·ª•c d·ª± √°n',
      'not_configured': 'Ch∆∞a c·∫•u h√¨nh',
      'footer_credit': 'FluxOrigin v1.0.0 - Made with ‚òï by d-init-d',
      'download_success': 'T·∫£i model th√†nh c√¥ng!',
      'download_fail': 'T·∫£i model th·∫•t b·∫°i.',
      'delete_model_confirm': 'X√°c nh·∫≠n x√≥a',
      'delete_model_question': 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a model',
      'cancel': 'H·ªßy',
      'delete': 'X√≥a',
      'deleted_model': 'ƒê√£ x√≥a model',
      'delete_fail': 'X√≥a model th·∫•t b·∫°i',
      'manage_models_title': 'Qu·∫£n l√Ω Model ƒë√£ t·∫£i',
      'no_models_installed': 'Ch∆∞a c√≥ model n√†o ƒë∆∞·ª£c t·∫£i',
      'delete_model_tooltip': 'X√≥a model',
      'close': 'ƒê√≥ng',
      // AI Provider Settings
      'ai_provider_subtitle': 'Ch·ªçn ngu·ªìn AI ƒë·ªÉ s·ª≠ d·ª•ng cho d·ªãch thu·∫≠t',
      'ollama_url_subtitle':
          'ƒê·ªãa ch·ªâ k·∫øt n·ªëi t·ªõi Ollama (m·∫∑c ƒë·ªãnh: http://localhost:11434)',
      'lmstudio_url_subtitle':
          'ƒê·ªãa ch·ªâ k·∫øt n·ªëi t·ªõi LM Studio (m·∫∑c ƒë·ªãnh: http://localhost:1234)',
      'checking_connection': 'ƒêang ki·ªÉm tra...',
      'check_connection': 'Ki·ªÉm tra k·∫øt n·ªëi',
      'lmstudio_note':
          'LM Studio: H√£y ƒë·∫£m b·∫£o ƒë√£ b·∫≠t Local Server trong LM Studio v√† ƒë√£ load model tr∆∞·ªõc khi s·ª≠ d·ª•ng.',
      'no_models_check_connection':
          'Ch∆∞a c√≥ model n√†o. H√£y ki·ªÉm tra k·∫øt n·ªëi Ollama.',
      'select_from_models': 'Ch·ªçn t·ª´ {count} model ƒë√£ c√†i ƒë·∫∑t',
      'no_model_available': 'Kh√¥ng c√≥ model',
      'models_installed_count': '{count} model ƒë√£ c√†i ƒë·∫∑t',
      // Connection messages
      'ollama_connection_success':
          'K·∫øt n·ªëi Ollama th√†nh c√¥ng! ƒê√£ t√¨m th·∫•y @count model.',
      'lmstudio_connection_success':
          'K·∫øt n·ªëi LM Studio th√†nh c√¥ng! ƒê√£ t√¨m th·∫•y @count model.',
      'connection_error_timeout':
          'H·∫øt th·ªùi gian ch·ªù. Ki·ªÉm tra l·∫°i URL ho·∫∑c server c√≥ ƒëang ch·∫°y kh√¥ng.',
      'connection_error_connect':
          'Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server. H√£y ƒë·∫£m b·∫£o server ƒëang ch·∫°y.',
      'connection_error_status': 'L·ªói: Server tr·∫£ v·ªÅ m√£ @code',
      'connection_error_generic': 'L·ªói k·∫øt n·ªëi: Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server.',
      // Sidebar
      'sidebar_translate': 'D·ªãch thu·∫≠t',
      'sidebar_history': 'L·ªãch s·ª≠',
      'sidebar_dictionary': 'T·ª´ ƒëi·ªÉn',
      'sidebar_settings': 'C√†i ƒë·∫∑t',
      // Translate Screen
      'enter_text_placeholder': 'Nh·∫≠p vƒÉn b·∫£n c·∫ßn d·ªãch...',
      'translate_now': 'D·ªãch ngay',
      'translating': 'ƒêang d·ªãch...',
      'start_translation': 'B·∫ÆT ƒê·∫¶U D·ªäCH',
      'continue_translation': 'TI·∫æP T·ª§C D·ªäCH',
      'pause': 'T·∫°m d·ª´ng',
      'cancel_action': 'H·ªßy b·ªè',
      'save_result': 'L∆ØU K·∫æT QU·∫¢',
      'translate_another': 'D·ªãch file kh√°c',
      'local_dictionary': 'T·ª´ ƒëi·ªÉn c·ª•c b·ªô',
      'processing': 'ƒêang x·ª≠ l√Ω...',
      'translation_success': 'D·ªãch th√†nh c√¥ng!',
      'error_prefix': 'L·ªói: ',
      'please_configure_project': 'Vui l√≤ng c·∫•u h√¨nh th∆∞ m·ª•c d·ª± √°n tr∆∞·ªõc!',
      'file_saved_at': 'ƒê√£ l∆∞u file t·∫°i: ',
      'error_saving_file': 'L·ªói khi l∆∞u file: ',
      'save_result_dialog_title': 'L∆∞u k·∫øt qu·∫£ d·ªãch',
      'progress': 'Ti·∫øn ƒë·ªô: ',
      'delete_progress_tooltip': 'X√≥a ti·∫øn ƒë·ªô v√† b·∫Øt ƒë·∫ßu l·∫°i',
      'restart_from_beginning': 'B·∫Øt ƒë·∫ßu l·∫°i t·ª´ ƒë·∫ßu',
      'pausing': 'ƒêang t·∫°m d·ª´ng sau ƒëo·∫°n hi·ªán t·∫°i...',
      'resuming': 'ƒêang ti·∫øp t·ª•c d·ªãch...',
      'initializing': 'ƒêang kh·ªüi t·∫°o...',
      // Live Preview
      'source_text_panel': 'VƒÉn b·∫£n g·ªëc',
      'translated_text_panel': 'B·∫£n d·ªãch',
      'chunk_progress': 'ƒêo·∫°n',
      'waiting_data': 'Ch·ªù d·ªØ li·ªáu...',
      // History Screen
      'history_title': 'L·ªãch s·ª≠ d·ªãch thu·∫≠t',
      'refresh_tooltip': 'L√†m m·ªõi',
      'no_history': 'Ch∆∞a c√≥ l·ªãch s·ª≠ d·ªãch',
      'no_history_subtitle': 'C√°c file ƒë√£ d·ªãch th√†nh c√¥ng s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y',
      'yesterday': 'H√¥m qua',
      'days_ago': 'ng√†y tr∆∞·ªõc',
      // Dictionary Screen
      'dictionary_title': 'T·ª´ ƒëi·ªÉn & Thu·∫≠t ng·ªØ',
      'dictionary_subtitle': 'Qu·∫£n l√Ω c√°c t·ªáp t·ª´ ƒëi·ªÉn c√° nh√¢n v√† chuy√™n ng√†nh.',
      'add_new': 'Th√™m m·ªõi',
      'dictionary_name': 'T√äN T·ª™ ƒêI·ªÇN',
      'dictionary_size': 'K√çCH TH∆Ø·ªöC',
      'dictionary_entries': 'S·ªê T·ª™',
      'showing_dictionaries': 'Hi·ªÉn th·ªã dictionaries t·ª´ ƒëi·ªÉn',
      'no_dictionaries': 'Ch∆∞a c√≥ t·ª´ ƒëi·ªÉn n√†o',
      'no_dictionaries_subtitle': 'Th√™m file .csv v√†o th∆∞ m·ª•c dictionary',
      // Upload Dictionary Modal
      'add_dict_title': 'Th√™m t·ª´ ƒëi·ªÉn m·ªõi',
      'dict_name_label': 'T√™n hi·ªÉn th·ªã',
      'dict_name_hint': 'Nh·∫≠p t√™n t·ª´ ƒëi·ªÉn...',
      'dict_file_label': 'File d·ªØ li·ªáu (.json, .csv)',
      'select_file_btn': 'Ch·ªçn file',
      'file_selected': 'ƒê√£ ch·ªçn file:',
      'upload_btn': 'Th√™m t·ª´ ƒëi·ªÉn',
      'error_missing_info': 'Vui l√≤ng nh·∫≠p t√™n v√† ch·ªçn file',
      'drag_drop_or': 'K√©o v√† th·∫£ file ho·∫∑c',
      'browse_files': 'Ch·ªçn t·ª´ m√°y',
      'supported_dict_formats': 'H·ªó tr·ª£ .csv',
      'unsupported_dict_format_error': 'Ch·ªâ h·ªó tr·ª£ file .CSV',
      // Common
      'confirm': 'X√°c nh·∫≠n',
      'success': 'Th√†nh c√¥ng',
      'failed': 'Th·∫•t b·∫°i',
      'save': 'L∆∞u',
      'source_text_hint': 'Nh·∫≠p vƒÉn b·∫£n c·∫ßn d·ªãch...',
      'translate_button': 'D·ªãch',
      'auto_detect': 'Ph√°t hi·ªán ng√¥n ng·ªØ',
      'copy': 'Sao ch√©p',
      'clear': 'X√≥a',
      'source_language': 'Ng√¥n ng·ªØ ngu·ªìn',
      'target_language': 'Ng√¥n ng·ªØ ƒë√≠ch',
      'drag_drop_file': 'K√©o th·∫£ t√†i li·ªáu v√†o ƒë√¢y',
      'supported_formats': 'H·ªó tr·ª£ .TXT, .EPUB',
      'unsupported_format_error': 'Ch·ªâ h·ªó tr·ª£ file .TXT v√† .EPUB',
      'drop_file_here': 'Th·∫£ file v√†o ƒë√¢y',
      'choose_file': 'Ch·ªçn file',
      'upload_dictionary_placeholder': 'T·∫£i l√™n t·ª´ ƒëi·ªÉn c·ªßa b·∫°n',
      'selected': 'ƒê√£ ch·ªçn',
      'change_file': 'Thay ƒë·ªïi',
      'local_mode_hint':
          'N·∫øu kh√¥ng t·∫£i l√™n t·ª´ ƒëi·ªÉn, m·∫∑c ƒë·ªãnh AI s·∫Ω t·ª± t·∫°o m·ªõi t·ª´ ƒëi·ªÉn c·ª•c b·ªô (kh√¥ng d√πng Internet).',
      'ai_auto_mode': 'AI T·ª± ƒë·ªông (Online)',
      'ai_auto_hint':
          'H·ªá th·ªëng c√≥ quy·ªÅn truy c·∫≠p internet ƒë·ªÉ ho√†n th√†nh t·ª´ ƒëi·ªÉn.',
      'error_picking_file': 'L·ªói ch·ªçn file: ',
      'lang_en': 'Ti·∫øng Anh',
      'lang_vi': 'Ti·∫øng Vi·ªát',
      'lang_cn': 'Ti·∫øng Trung',
      'default_label': 'M·∫∑c ƒë·ªãnh',
      // Translation Status Messages
      'status_restoring_progress':
          'ƒê√£ t√¨m th·∫•y b·∫£n l∆∞u c≈©. ƒêang kh√¥i ph·ª•c ti·∫øn ƒë·ªô...',
      'status_reading_file': 'ƒêang ƒë·ªçc file g·ªëc...',
      'status_analyzing': 'ƒêang ph√¢n t√≠ch v√† chia nh·ªè vƒÉn b·∫£n...',
      'status_detecting_genre': 'AI ƒëang ƒë·ªçc th·ª≠ ƒë·ªÉ x√°c ƒë·ªãnh th·ªÉ lo·∫°i...',
      'status_creating_glossary': 'AI ƒëang t·∫°o t·ª´ ƒëi·ªÉn t√™n ri√™ng...',
      'status_translating': 'ƒêang d·ªãch ƒëo·∫°n',
      'status_paused': 'ƒê√£ t·∫°m d·ª´ng. Ti·∫øn ƒë·ªô ƒë√£ ƒë∆∞·ª£c l∆∞u.',
      'status_merging': 'ƒêang gh√©p file k·∫øt qu·∫£...',
      'status_completed': 'D·ªãch ho√†n t·∫•t!',
      'status_error': 'L·ªói khi d·ªãch ƒëo·∫°n',
      'report_inappropriate_content': 'B√°o c√°o n·ªôi dung kh√¥ng ph√π h·ª£p',
      // Ollama Connection Error Dialog
      'ollama_connection_error_title': 'L·ªói k·∫øt n·ªëi',
      'ollama_connection_error_body':
          'Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi Ollama. Vui l√≤ng ki·ªÉm tra:\n‚Ä¢ Ollama ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t ch∆∞a?\n‚Ä¢ Ollama ƒëang ch·∫°y ch∆∞a?',
      'check_settings_hint': 'M·ªü C√†i ƒë·∫∑t ƒë·ªÉ ki·ªÉm tra c·∫•u h√¨nh',
      'ok_button': 'OK',
    },
    'en': {
      'settings_title': 'Settings',
      'appearance_section': 'APPEARANCE',
      'dark_mode': 'Dark Mode',
      'dark_mode_subtitle': 'Use dark theme to reduce eye strain',
      'display_font': 'Display Font',
      'display_font_subtitle': 'Customize font for reading',
      'language': 'Language / Ng√¥n ng·ªØ',
      'language_subtitle': 'Choose display language',
      'ai_config_section': 'AI CONFIGURATION',
      'translation_model': 'Translation Model',
      'translation_model_subtitle': 'Select primary language model',
      'manage_models': 'Manage Downloaded Models',
      'manage_models_subtitle': 'models installed',
      'translation_config_section': 'TRANSLATION CONFIG',
      'project_folder': 'Project Folder',
      'not_configured': 'Not configured',
      'footer_credit': 'FluxOrigin v1.0.0 - Made with ‚òï by d-init-d',
      'download_success': 'Model downloaded successfully!',
      'download_fail': 'Model download failed.',
      'delete_model_confirm': 'Confirm Delete',
      'delete_model_question': 'Are you sure you want to delete model',
      'cancel': 'Cancel',
      'delete': 'Delete',
      'deleted_model': 'Model deleted',
      'delete_fail': 'Failed to delete model',
      'manage_models_title': 'Manage Downloaded Models',
      'no_models_installed': 'No models installed',
      'delete_model_tooltip': 'Delete model',
      'close': 'Close',
      // AI Provider Settings
      'ai_provider_subtitle': 'Select AI source for translation',
      'ollama_url_subtitle':
          'Ollama connection address (default: http://localhost:11434)',
      'lmstudio_url_subtitle':
          'LM Studio connection address (default: http://localhost:1234)',
      'checking_connection': 'Checking...',
      'check_connection': 'Test Connection',
      'lmstudio_note':
          'LM Studio: Make sure to enable Local Server in LM Studio and load a model before using.',
      'no_models_check_connection':
          'No models found. Please check Ollama connection.',
      'select_from_models': 'Select from {count} installed models',
      'no_model_available': 'No models',
      'models_installed_count': '{count} models installed',
      // Connection messages
      'ollama_connection_success':
          'Ollama connected successfully! Found @count models.',
      'lmstudio_connection_success':
          'LM Studio connected successfully! Found @count models.',
      'connection_error_timeout':
          'Connection timed out. Please check the URL or if the server is running.',
      'connection_error_connect':
          'Cannot connect to server. Please make sure the server is running.',
      'connection_error_status': 'Error: Server returned status @code',
      'connection_error_generic':
          'Connection error: Unable to connect to server.',
      // Sidebar
      'sidebar_translate': 'Translate',
      'sidebar_history': 'History',
      'sidebar_dictionary': 'Dictionary',
      'sidebar_settings': 'Settings',
      // Translate Screen
      'enter_text_placeholder': 'Enter text to translate...',
      'translate_now': 'Translate Now',
      'translating': 'Translating...',
      'start_translation': 'START TRANSLATION',
      'continue_translation': 'CONTINUE TRANSLATION',
      'pause': 'Pause',
      'cancel_action': 'Cancel',
      'save_result': 'SAVE RESULT',
      'translate_another': 'Translate another file',
      'local_dictionary': 'Local Dictionary',
      'processing': 'Processing...',
      'translation_success': 'Translation Successful!',
      'error_prefix': 'Error: ',
      'please_configure_project': 'Please configure project folder first!',
      'file_saved_at': 'File saved at: ',
      'error_saving_file': 'Error saving file: ',
      'save_result_dialog_title': 'Save Translation Result',
      'progress': 'Progress: ',
      'delete_progress_tooltip': 'Delete progress and restart',
      'restart_from_beginning': 'Restart from beginning',
      'pausing': 'Pausing after current segment...',
      'resuming': 'Resuming translation...',
      'initializing': 'Initializing...',
      // Live Preview
      'source_text_panel': 'Source Text',
      'translated_text_panel': 'Translation',
      'chunk_progress': 'Chunk',
      'waiting_data': 'Waiting for data...',
      // History Screen
      'history_title': 'Translation History',
      'refresh_tooltip': 'Refresh',
      'no_history': 'No translation history',
      'no_history_subtitle': 'Successfully translated files will appear here',
      'yesterday': 'Yesterday',
      'days_ago': 'days ago',
      // Dictionary Screen
      'dictionary_title': 'Dictionaries & Terms',
      'dictionary_subtitle':
          'Manage personal and specialized dictionary files.',
      'add_new': 'Add New',
      'dictionary_name': 'DICTIONARY NAME',
      'dictionary_size': 'SIZE',
      'dictionary_entries': 'ENTRIES',
      'showing_dictionaries': 'Showing dictionaries',
      'no_dictionaries': 'No dictionaries found',
      'no_dictionaries_subtitle': 'Add .csv files to the dictionary folder',
      // Upload Dictionary Modal
      'add_dict_title': 'Add New Dictionary',
      'dict_name_label': 'Display Name',
      'dict_name_hint': 'Enter dictionary name...',
      'dict_file_label': 'Data File (.json, .csv)',
      'select_file_btn': 'Select File',
      'file_selected': 'File selected:',
      'upload_btn': 'Add Dictionary',
      'error_missing_info': 'Please enter name and select file',
      'drag_drop_or': 'Drag and drop file or',
      'browse_files': 'Browse',
      'supported_dict_formats': 'Supports .csv',
      'unsupported_dict_format_error': 'Only .CSV files are supported',
      // Common
      'confirm': 'Confirm',
      'success': 'Success',
      'failed': 'Failed',
      'save': 'Save',
      'source_text_hint': 'Enter text to translate...',
      'translate_button': 'Translate',
      'auto_detect': 'Auto Detect',
      'copy': 'Copy',
      'clear': 'Clear',
      'source_language': 'Source Language',
      'target_language': 'Target Language',
      'drag_drop_file': 'Drag and drop file here',
      'supported_formats': 'Supports .TXT, .EPUB',
      'unsupported_format_error': 'Only .TXT and .EPUB files are supported',
      'drop_file_here': 'Drop file here',
      'choose_file': 'Choose File',
      'upload_dictionary_placeholder': 'Upload your dictionary',
      'selected': 'Selected',
      'change_file': 'Change',
      'local_mode_hint':
          'If no dictionary is uploaded, AI will create a local one by default (offline).',
      'ai_auto_mode': 'AI Auto (Online)',
      'ai_auto_hint': 'System has internet access to complete the dictionary.',
      'error_picking_file': 'Error picking file: ',
      'lang_en': 'English',
      'lang_vi': 'Vietnamese',
      'lang_cn': 'Chinese',
      'default_label': 'Default',
      // Translation Status Messages
      'status_restoring_progress': 'Found saved progress. Resuming...',
      'status_reading_file': 'Reading source file...',
      'status_analyzing': 'Analyzing and chunking text...',
      'status_detecting_genre': 'AI is detecting genre...',
      'status_creating_glossary': 'AI is generating glossary...',
      'status_translating': 'Translating chunk',
      'status_paused': 'Paused. Progress saved.',
      'status_merging': 'Merging output files...',
      'status_completed': 'Translation completed!',
      'status_error': 'Error translating chunk',
      'report_inappropriate_content': 'Report inappropriate content',
      // Ollama Connection Error Dialog
      'ollama_connection_error_title': 'Connection Error',
      'ollama_connection_error_body':
          'Cannot connect to Ollama. Please check:\n‚Ä¢ Is Ollama installed?\n‚Ä¢ Is Ollama running?',
      'check_settings_hint': 'Open Settings to check configuration',
      'ok_button': 'OK',
    },
  };

  static String get(String lang, String key) {
    return _localizedValues[lang]?[key] ?? _localizedValues['vi']![key]!;
  }
}
</file>

<file path="README.md">
# FluxOrigin - AI Book Translator

<p align="center">
  <img src="https://img.shields.io/badge/Platform-Windows-blue?style=flat-square" alt="Platform">
  <img src="https://img.shields.io/badge/Flutter-3.x-02569B?style=flat-square&logo=flutter" alt="Flutter">
  <img src="https://img.shields.io/badge/License-GPLv3-blue?style=flat-square" alt="License">
</p>

**FluxOrigin** l√† m·ªôt ·ª©ng d·ª•ng Desktop (Windows) m·∫°nh m·∫Ω h·ªó tr·ª£ d·ªãch s√°ch, t√†i li·ªáu t·ª± ƒë·ªông s·ª≠ d·ª•ng s·ª©c m·∫°nh c·ªßa AI c·ª•c b·ªô (Local LLM).

ƒê√¢y l√† phi√™n b·∫£n k·∫ø th·ª´a v√† n√¢ng c·∫•p to√†n di·ªán t·ª´ d·ª± √°n **n8n book translator**. FluxOrigin lo·∫°i b·ªè s·ª± ph·ª• thu·ªôc v√†o c√°c workflow ph·ª©c t·∫°p c·ªßa n8n ƒë·ªÉ mang l·∫°i m·ªôt tr·∫£i nghi·ªám "C√†i ƒë·∫∑t l√† ch·∫°y" (All-in-one) v·ªõi giao di·ªán ng∆∞·ªùi d√πng tr·ª±c quan, t·ªëc ƒë·ªô x·ª≠ l√Ω nhanh h∆°n v√† kh·∫£ nƒÉng t√πy bi·∫øn cao h∆°n.

---

## üåü T√≠nh NƒÉng N·ªïi B·∫≠t

So v·ªõi phi√™n b·∫£n n8n c≈©, FluxOrigin mang l·∫°i nh·ªØng c·∫£i ti·∫øn v∆∞·ª£t b·∫≠c:

| T√≠nh nƒÉng                     | M√¥ t·∫£                                                                                  |
| ----------------------------- | -------------------------------------------------------------------------------------- |
| **·ª®ng d·ª•ng Native (Flutter)** | Kh√¥ng c√≤n c·∫ßn c√†i ƒë·∫∑t Docker, Node.js hay n8n server. Ch·ªâ c·∫ßn m·ªôt file `.exe` duy nh·∫•t |
| **H·ªó tr·ª£ ƒëa AI Provider**     | T√≠ch h·ª£p **Ollama** v√† **LM Studio** - linh ho·∫°t ch·ªçn ngu·ªìn AI ph√π h·ª£p                 |
| **Qu·∫£n l√Ω T·ª´ ƒëi·ªÉn**           | T·∫£i l√™n v√† qu·∫£n l√Ω thu·∫≠t ng·ªØ chuy√™n ng√†nh, t√™n ri√™ng ƒë·ªÉ ƒë·∫£m b·∫£o s·ª± nh·∫•t qu√°n           |
| **X·ª≠ l√Ω vƒÉn b·∫£n th√¥ng minh**  | T·ª± ƒë·ªông chia nh·ªè (chunking) vƒÉn b·∫£n ƒë·ªÉ tr√°nh gi·ªõi h·∫°n token m√† v·∫´n gi·ªØ ng·ªØ c·∫£nh        |
| **Live Translation Preview**  | Xem tr·ª±c ti·∫øp AI ƒëang d·ªãch ƒëo·∫°n n√†o v√† k·∫øt qu·∫£ d·ªãch real-time                          |
| **Dev Logs**                  | Tab d√†nh cho developer xem chi ti·∫øt requests, responses v√† debug logs                  |
| **L·ªãch s·ª≠ d·ªãch thu·∫≠t**        | T·ª± ƒë·ªông l∆∞u l·∫°i c√°c b·∫£n d·ªãch tr∆∞·ªõc ƒë√≥ ƒë·ªÉ xem l·∫°i b·∫•t c·ª© l√∫c n√†o                        |
| **Web Search (Experimental)** | T√≠ch h·ª£p t√¨m ki·∫øm th√¥ng tin b·ªï sung ƒë·ªÉ AI hi·ªÉu r√µ ng·ªØ c·∫£nh h∆°n                         |

---

## üöÄ Y√™u C·∫ßu H·ªá Th·ªëng

-   **H·ªá ƒëi·ªÅu h√†nh:** Windows 10/11 (64-bit)
-   **AI Backend:** [Ollama](https://ollama.com/) ho·∫∑c [LM Studio](https://lmstudio.ai/)
-   **RAM:** Khuy·∫øn ngh·ªã 8GB tr·ªü l√™n (ƒë·ªÉ ch·∫°y m∆∞·ª£t c√°c model AI)

---

## üì¶ C√†i ƒê·∫∑t

### C√°ch 1: S·ª≠ d·ª•ng b·ªô c√†i ƒë·∫∑t (Khuy√™n d√πng)

Truy c·∫≠p th∆∞ m·ª•c `releases` trong m√£ ngu·ªìn v√† ch·∫°y file c√†i ƒë·∫∑t:

```
FluxOrigin_Installer_v1.0.1.exe
```

### C√°ch 2: Ch·∫°y t·ª´ m√£ ngu·ªìn (D√†nh cho Developer)

```bash
# 1. Clone repository
git clone https://github.com/tmih06/FluxOrigin.git
cd FluxOrigin

# 2. C√†i ƒë·∫∑t dependencies
flutter pub get

# 3. Ch·∫°y ·ª©ng d·ª•ng
flutter run -d windows
```

---

## üìñ H∆∞·ªõng D·∫´n S·ª≠ D·ª•ng

### B∆∞·ªõc 1: C·∫•u h√¨nh AI

1. M·ªü ·ª©ng d·ª•ng FluxOrigin
2. V√†o m·ª•c **C√†i ƒë·∫∑t (Settings)** ·ªü thanh b√™n tr√°i
3. Ch·ªçn **AI Provider**: Ollama ho·∫∑c LM Studio
4. Nh·∫≠p URL c·ªßa server:
    - Ollama: `http://localhost:11434` (m·∫∑c ƒë·ªãnh)
    - LM Studio: `http://localhost:1234` (m·∫∑c ƒë·ªãnh)
5. Nh·∫•n **"Ki·ªÉm tra k·∫øt n·ªëi"** ƒë·ªÉ ƒë·∫£m b·∫£o server ƒëang ch·∫°y
6. Ch·ªçn Model b·∫°n mu·ªën d√πng t·ª´ danh s√°ch

### üß© G·ª£i √ù Ch·ªçn Model AI

> **L∆∞u √Ω:** C√°c model d∆∞·ªõi ƒë√¢y ho·∫°t ƒë·ªông t·ªët tr√™n c·∫£ **Ollama** v√† **LM Studio**. T·∫£i model t·ª´ Ollama b·∫±ng l·ªánh `ollama pull <t√™n>`, ho·∫∑c t·∫£i file GGUF t·ª´ HuggingFace cho LM Studio.

#### üìä B·∫£ng So S√°nh Model Theo C·∫•u H√¨nh

| Model | Ollama | VRAM | Ch·∫•t l∆∞·ª£ng d·ªãch | Ti·∫øng Vi·ªát | Ph√π h·ª£p |
|-------|--------|------|-----------------|------------|---------|
| **Qwen2.5-0.5B** | `qwen2.5:0.5b` | ~1GB | ‚≠ê | K√©m | M√°y y·∫øu, test nhanh |
| **Qwen2.5-1.5B** | `qwen2.5:1.5b` | ~2GB | ‚≠ê‚≠ê | Trung b√¨nh | M√°y y·∫øu |
| **Qwen2.5-3B** | `qwen2.5:3b` | ~3GB | ‚≠ê‚≠ê‚≠ê | Kh√° | M√°y ph·ªï th√¥ng |
| **Gemma3-4B** | `gemma3:4b` | ~4GB | ‚≠ê‚≠ê‚≠ê | Kh√° | M√°y ph·ªï th√¥ng |
| **Qwen2.5-7B** | `qwen2.5:7b` | ~5GB | ‚≠ê‚≠ê‚≠ê‚≠ê | T·ªët | M√°y v·ª´a (8GB VRAM) |
| **Qwen3-8B** | `qwen3:8b` | ~6GB | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | R·∫•t t·ªët | M√°y kh√° (8-12GB VRAM) |
| **Llama3.1-8B** | `llama3.1:8b` | ~6GB | ‚≠ê‚≠ê‚≠ê‚≠ê | T·ªët | M√°y kh√° |
| **Gemma3-12B** | `gemma3:12b` | ~9GB | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | R·∫•t t·ªët | M√°y kh√° (12GB VRAM) |
| **Qwen3-14B** | `qwen3:14b` | ~10GB | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | Xu·∫•t s·∫Øc | M√°y m·∫°nh (16GB VRAM) |
| **Qwen2.5-14B** | `qwen2.5:14b` | ~10GB | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | Xu·∫•t s·∫Øc | M√°y m·∫°nh |
| **Gemma3-27B** | `gemma3:27b` | ~18GB | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | Xu·∫•t s·∫Øc | M√°y cao c·∫•p (24GB VRAM) |
| **Qwen3-30B-A3B** | `qwen3:30b-a3b` | ~20GB | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | Xu·∫•t s·∫Øc | M√°y cao c·∫•p (MoE) |
| **Llama3.3-70B** | `llama3.3:70b` | ~42GB | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | Xu·∫•t s·∫Øc | M√°y workstation |

#### üéØ Khuy·∫øn Ngh·ªã Theo M·ª•c ƒê√≠ch

| M·ª•c ƒë√≠ch | Model ƒë·ªÅ xu·∫•t | L√Ω do |
|----------|---------------|-------|
| **D·ªãch ti·ªÉu thuy·∫øt Trung ‚Üí Vi·ªát** | Qwen3-8B, Qwen3-14B | Qwen ƒë∆∞·ª£c train nhi·ªÅu ti·∫øng Trung, H√°n Vi·ªát chu·∫©n |
| **D·ªãch s√°ch k·ªπ thu·∫≠t Anh ‚Üí Vi·ªát** | Llama3.1-8B, Gemma3-12B | Hi·ªÉu thu·∫≠t ng·ªØ k·ªπ thu·∫≠t t·ªët |
| **M√°y y·∫øu (4-6GB VRAM)** | Qwen2.5-3B, Gemma3-4B | C√¢n b·∫±ng ch·∫•t l∆∞·ª£ng v√† t·ªëc ƒë·ªô |
| **Ch·∫•t l∆∞·ª£ng cao nh·∫•t** | Qwen3-14B, Gemma3-27B | D·ªãch m∆∞·ª£t, √≠t l·ªói ng·ªØ ph√°p |

> üí° **M·∫πo:** V·ªõi LM Studio, h√£y t·∫£i c√°c phi√™n b·∫£n **Q4_K_M** ho·∫∑c **Q5_K_M** ƒë·ªÉ c√¢n b·∫±ng gi·ªØa ch·∫•t l∆∞·ª£ng v√† VRAM.

### B∆∞·ªõc 2: Chu·∫©n b·ªã T·ª´ ƒëi·ªÉn (T√πy ch·ªçn)

1. V√†o m·ª•c **T·ª´ ƒëi·ªÉn (Dictionary)**
2. Th√™m c√°c t·ª´ kh√≥a ho·∫∑c upload file t·ª´ ƒëi·ªÉn ƒë·ªÉ AI tu√¢n th·ªß theo c√°ch d·ªãch c·ªßa b·∫°n

> **V√≠ d·ª•:** `"FluxOrigin"` ‚Üí `"FluxOrigin"` (gi·ªØ nguy√™n thay v√¨ d·ªãch nghƒ©a ƒëen)

### B∆∞·ªõc 3: D·ªãch thu·∫≠t

1. V√†o m√†n h√¨nh ch√≠nh **D·ªãch thu·∫≠t**
2. T·∫£i l√™n file c·∫ßn d·ªãch (H·ªó tr·ª£ `.txt`, `.md`, `.epub`)
3. Ch·ªçn ng√¥n ng·ªØ ngu·ªìn v√† ng√¥n ng·ªØ ƒë√≠ch
4. Nh·∫•n **B·∫Øt ƒë·∫ßu d·ªãch**
5. Theo d√µi ti·∫øn tr√¨nh tr·ª±c ti·∫øp:
    - Xem vƒÉn b·∫£n g·ªëc ƒëang ƒë∆∞·ª£c d·ªãch
    - Xem k·∫øt qu·∫£ d·ªãch real-time
    - Theo d√µi ti·∫øn ƒë·ªô (ƒëo·∫°n X/Y)

---

## üèóÔ∏è C·∫•u Tr√∫c D·ª± √Ån

```
lib/
‚îú‚îÄ‚îÄ ui/                    # Giao di·ªán ng∆∞·ªùi d√πng
‚îÇ   ‚îú‚îÄ‚îÄ screens/           # C√°c m√†n h√¨nh ch√≠nh
‚îÇ   ‚îú‚îÄ‚îÄ widgets/           # Widget t√°i s·ª≠ d·ª•ng
‚îÇ   ‚îî‚îÄ‚îÄ theme/             # Theme v√† Config Provider
‚îú‚îÄ‚îÄ services/              # Logic g·ªçi API
‚îÇ   ‚îú‚îÄ‚îÄ ai_service.dart    # K·∫øt n·ªëi Ollama/LM Studio
‚îÇ   ‚îú‚îÄ‚îÄ web_search_service.dart
‚îÇ   ‚îî‚îÄ‚îÄ dev_logger.dart    # Logging service
‚îú‚îÄ‚îÄ controllers/           # Qu·∫£n l√Ω tr·∫°ng th√°i
‚îú‚îÄ‚îÄ utils/                 # C√¥ng c·ª• x·ª≠ l√Ω text/file
‚îî‚îÄ‚îÄ models/                # ƒê·ªãnh nghƒ©a d·ªØ li·ªáu
```

---

## ü§ù ƒê√≥ng G√≥p

D·ª± √°n n√†y ƒë∆∞·ª£c ph√°t tri·ªÉn ti·∫øp t·ª´ √Ω t∆∞·ªüng c·ªßa **n8n book translator**.

M·ªçi ƒë√≥ng g√≥p, b√°o l·ªói (Issue) ho·∫∑c y√™u c·∫ßu t√≠nh nƒÉng (Pull Request) ƒë·ªÅu ƒë∆∞·ª£c hoan ngh√™nh!

Developed with ‚ù§Ô∏è by d-init-d
---
## ‚öñÔ∏è Gi·∫•y ph√©p & B·∫£n quy·ªÅn (License & Branding)

D·ª± √°n n√†y ƒë∆∞·ª£c ph√¢n ph·ªëi d∆∞·ªõi gi·∫•y ph√©p **GPLv3**.

> **L∆∞u √Ω v·ªÅ Th∆∞∆°ng hi·ªáu:**
> T√™n ·ª©ng d·ª•ng **"FluxOrigin"** v√† Logo l√† t√†i s·∫£n ri√™ng. B·∫°n c√≥ th·ªÉ fork v√† s·ª≠a code theo GPLv3, nh∆∞ng vui l√≤ng **ƒë·ªïi t√™n v√† logo kh√°c** n·∫øu b·∫°n ph√°t h√†nh b·∫£n s·ª≠a ƒë·ªïi ƒë√≥ ra c√¥ng ch√∫ng.
---
## Contributors

[![Contributors](https://contrib.rocks/image?repo=d-init-d/FluxOrigin)](https://github.com/d-init-d/FluxOrigin/graphs/contributors)
</file>

<file path="lib/ui/widgets/title_bar.dart">
import 'package:flutter/material.dart';
import 'package:font_awesome_flutter/font_awesome_flutter.dart';
import 'package:window_manager/window_manager.dart';
import '../theme/app_theme.dart';

class TitleBar extends StatelessWidget {
  final bool isDark;

  const TitleBar({super.key, required this.isDark});

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      behavior: HitTestBehavior.translucent,
      onPanStart: (details) {
        windowManager.startDragging();
      },
      child: Container(
        height: 32,
        decoration: BoxDecoration(
          color: isDark ? AppColors.darkSidebar : AppColors.lightSidebar,
          border: Border(
            bottom: BorderSide(
              color: isDark ? const Color(0xFF2A2A2A) : AppColors.lightBorder,
              width: 1,
            ),
          ),
        ),
        child: Row(
          children: [
            // Left: App icon and title
            Expanded(
              child: Padding(
                padding: const EdgeInsets.symmetric(horizontal: 16),
                child: Row(
                  children: [
                    FaIcon(
                      FontAwesomeIcons.layerGroup,
                      size: 12,
                      color: isDark
                          ? Colors.white.withValues(alpha: 0.8)
                          : AppColors.lightPrimary,
                    ),
                    const SizedBox(width: 8),
                    Text(
                      'FluxOrigin',
                      style: TextStyle(
                        fontSize: 12,
                        fontWeight: FontWeight.w500,
                        color:
                            isDark ? Colors.grey[400] : AppColors.lightPrimary,
                      ),
                    ),
                  ],
                ),
              ),
            ),
            // Right: Window controls
            _WindowButton(
              isDark: isDark,
              icon: Icons.remove,
              onPressed: () => windowManager.minimize(),
            ),
            _WindowButton(
              isDark: isDark,
              icon: Icons.crop_square,
              onPressed: () async {
                if (await windowManager.isMaximized()) {
                  windowManager.unmaximize();
                } else {
                  windowManager.maximize();
                }
              },
            ),
            _WindowButton(
              isDark: isDark,
              icon: Icons.close,
              isClose: true,
              onPressed: () => windowManager.close(),
            ),
          ],
        ),
      ),
    );
  }
}

class _WindowButton extends StatefulWidget {
  final bool isDark;
  final IconData icon;
  final VoidCallback onPressed;
  final bool isClose;

  const _WindowButton({
    required this.isDark,
    required this.icon,
    required this.onPressed,
    this.isClose = false,
  });

  @override
  State<_WindowButton> createState() => _WindowButtonState();
}

class _WindowButtonState extends State<_WindowButton> {
  bool _isHovered = false;

  @override
  Widget build(BuildContext context) {
    return MouseRegion(
      cursor: SystemMouseCursors.click,
      onEnter: (_) => setState(() => _isHovered = true),
      onExit: (_) => setState(() => _isHovered = false),
      child: GestureDetector(
        onTap: widget.onPressed,
        child: Container(
          width: 46,
          height: double.infinity,
          alignment: Alignment.center,
          color: _isHovered
              ? (widget.isClose
                  ? const Color(0xFFC42B1C)
                  : (widget.isDark
                      ? Colors.white.withValues(alpha: 0.1)
                      : Colors.black.withValues(alpha: 0.1)))
              : Colors.transparent,
          child: Icon(
            widget.icon,
            size: 18,
            color: _isHovered && widget.isClose
                ? Colors.white
                : (widget.isDark ? Colors.grey[400] : AppColors.lightPrimary),
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/ui/widgets/file_upload_zone.dart">
import 'package:flutter/material.dart';
import 'package:font_awesome_flutter/font_awesome_flutter.dart';
import 'package:file_picker/file_picker.dart';
import 'package:desktop_drop/desktop_drop.dart';
import 'package:path/path.dart' as path;
import 'package:provider/provider.dart';
import '../theme/app_theme.dart';
import '../theme/config_provider.dart';
import '../../utils/app_strings.dart';

class FileUploadZone extends StatefulWidget {
  final bool isDark;
  final String? title;
  final String? subtitle;
  final IconData icon;
  final bool enabled;

  final Function(String)? onFileSelected;

  const FileUploadZone({
    super.key,
    required this.isDark,
    this.title,
    this.subtitle,
    this.icon = FontAwesomeIcons.cloudArrowUp,
    this.onFileSelected,
    this.enabled = true,
  });

  @override
  State<FileUploadZone> createState() => _FileUploadZoneState();
}

class _FileUploadZoneState extends State<FileUploadZone> {
  bool _isHovered = false;
  bool _isDragging = false;

  @override
  Widget build(BuildContext context) {
    final lang = context.watch<ConfigProvider>().appLanguage;
    final displayTitle = widget.title ?? AppStrings.get(lang, 'drag_drop_file');
    final displaySubtitle = widget.subtitle ?? AppStrings.get(lang, 'supported_formats');
    
    return DropTarget(
      onDragEntered: (details) {
        if (widget.enabled) setState(() => _isDragging = true);
      },
      onDragExited: (details) {
        setState(() => _isDragging = false);
      },
      onDragDone: (details) {
        setState(() => _isDragging = false);
        if (!widget.enabled) return;
        if (details.files.isNotEmpty) {
          final file = details.files.first;
          final ext = path.extension(file.path).toLowerCase();
          if (ext == '.txt' || ext == '.epub') {
            widget.onFileSelected?.call(file.path);
          } else {
            // Optional: Show error for unsupported file type
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text(AppStrings.get(lang, 'unsupported_format_error')),
                behavior: SnackBarBehavior.floating,
                backgroundColor: Colors.red,
                shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(10)),
              ),
            );
          }
        }
      },
      child: MouseRegion(
        onEnter: (_) {
          if (widget.enabled) setState(() => _isHovered = true);
        },
        onExit: (_) => setState(() => _isHovered = false),
        child: Opacity(
          opacity: widget.enabled ? 1.0 : 0.5,
          child: Container(
          decoration: BoxDecoration(
            color: _isDragging
                ? (widget.isDark
                    ? AppColors.darkSurface.withValues(alpha: 0.8)
                    : Colors.blue.withValues(alpha: 0.1))
                : (widget.isDark
                    ? AppColors.darkSurface.withValues(alpha: 0.5)
                    : Colors.white),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: _isDragging
                  ? AppColors.lightPrimary
                  : (_isHovered
                      ? (widget.isDark
                          ? Colors.grey[500]!
                          : AppColors.lightPrimary.withValues(alpha: 0.5))
                      : (widget.isDark
                          ? const Color(0xFF444444)
                          : Colors.grey[300]!)),
              width: 2,
              strokeAlign: BorderSide.strokeAlignInside,
              style: _isDragging ? BorderStyle.solid : BorderStyle.solid,
            ),
          ),
          child: Center(
            child: Padding(
              padding: const EdgeInsets.all(32),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  AnimatedScale(
                    scale: _isHovered || _isDragging ? 1.1 : 1.0,
                    duration: const Duration(milliseconds: 200),
                    child: Container(
                      width: 64,
                      height: 64,
                      decoration: BoxDecoration(
                        color: widget.isDark
                            ? Colors.white.withValues(alpha: 0.1)
                            : AppColors.lightPrimary.withValues(alpha: 0.05),
                        borderRadius: BorderRadius.circular(32),
                      ),
                      child: Center(
                        child: FaIcon(
                          widget.icon,
                          size: 28,
                          color: widget.isDark
                              ? Colors.white.withValues(alpha: 0.9)
                              : AppColors.lightPrimary,
                        ),
                      ),
                    ),
                  ),
                  const SizedBox(height: 16),
                  Text(
                    _isDragging ? AppStrings.get(lang, 'drop_file_here') : displayTitle,
                    style: TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.w500,
                      color: widget.isDark
                          ? Colors.grey[200]
                          : AppColors.lightPrimary,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    displaySubtitle,
                    style: TextStyle(
                      fontSize: 12,
                      color: widget.isDark
                          ? Colors.grey[500]
                          : AppColors.lightPrimary.withValues(alpha: 0.6),
                    ),
                  ),
                  const SizedBox(height: 16),
                  ElevatedButton(
                    onPressed: widget.enabled
                        ? () async {
                            final result = await FilePicker.platform.pickFiles(
                              type: FileType.custom,
                              allowedExtensions: ['txt', 'epub'],
                            );
                            if (result != null && result.files.single.path != null) {
                              widget.onFileSelected?.call(result.files.single.path!);
                            }
                          }
                        : null,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: widget.isDark
                          ? Colors.white.withValues(alpha: 0.1)
                          : AppColors.lightPrimary.withValues(alpha: 0.1),
                      foregroundColor:
                          widget.isDark ? Colors.white : AppColors.lightPrimary,
                      elevation: 0,
                      padding: const EdgeInsets.symmetric(
                          horizontal: 20, vertical: 8),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(20),
                      ),
                    ),
                    child: Text(
                      AppStrings.get(lang, 'choose_file'),
                      style: const TextStyle(
                        fontSize: 12,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/ui/widgets/sidebar.dart">
import 'package:flutter/material.dart';
import 'package:font_awesome_flutter/font_awesome_flutter.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:provider/provider.dart';
import '../theme/app_theme.dart';
import '../theme/config_provider.dart';
import '../../utils/app_strings.dart';
import 'sidebar_item.dart';

class Sidebar extends StatelessWidget {
  final bool isDark;
  final int selectedIndex;
  final Function(int) onItemTap;

  const Sidebar({
    super.key,
    required this.isDark,
    required this.selectedIndex,
    required this.onItemTap,
  });

  @override
  Widget build(BuildContext context) {
    final lang = context.watch<ConfigProvider>().appLanguage;
    final ollamaConnected = context.watch<ConfigProvider>().ollamaConnected;
    return Container(
      width: 250,
      decoration: BoxDecoration(
        color: isDark ? AppColors.darkSidebar : AppColors.lightSidebar,
        border: Border(
          right: BorderSide(
            color: isDark ? const Color(0xFF2A2A2A) : AppColors.lightBorder,
            width: 1,
          ),
        ),
      ),
      child: Column(
        children: [
          // App Branding Header
          Padding(
            // S·ª≠a th√†nh: ch·ªâ padding Tr√™n, D∆∞·ªõi v√† Tr√°i (16px b·∫±ng v·ªõi menu)
            padding: const EdgeInsets.only(top: 24.0, bottom: 24.0, left: 16.0),
            child: Align(
              alignment: Alignment.centerLeft, // B·∫Øt bu·ªôc cƒÉn tr√°i
              child: RichText(
                text: TextSpan(
                  style: GoogleFonts.merriweather(
                    fontSize: 34,
                    fontWeight: FontWeight.bold,
                    color: isDark ? Colors.white : const Color(0xFF000000),
                  ),
                  children: [
                    const TextSpan(text: 'Flux'),
                    TextSpan(
                      text: 'Origin',
                      style: TextStyle(
                        color: isDark ? Colors.white : const Color(0xFF182b14),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),

          // Navigation Items
          Expanded(
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: 16),
              child: Column(
                children: [
                  SidebarItem(
                    icon: FontAwesomeIcons.language,
                    label: AppStrings.get(lang, 'sidebar_translate'),
                    isActive: selectedIndex == 0,
                    onTap: () => onItemTap(0),
                    isDark: isDark,
                  ),
                  SidebarItem(
                    icon: FontAwesomeIcons.clockRotateLeft,
                    label: AppStrings.get(lang, 'sidebar_history'),
                    isActive: selectedIndex == 1,
                    onTap: () => onItemTap(1),
                    isDark: isDark,
                  ),
                  SidebarItem(
                    icon: FontAwesomeIcons.bookOpenReader,
                    label: AppStrings.get(lang, 'sidebar_dictionary'),
                    isActive: selectedIndex == 2,
                    onTap: () => onItemTap(2),
                    isDark: isDark,
                  ),
                ],
              ),
            ),
          ),

          // Settings and Dev Logs at bottom
          Container(
            padding: const EdgeInsets.only(top: 16),
            decoration: BoxDecoration(
              border: Border(
                top: BorderSide(
                  color: isDark
                      ? Colors.grey.withValues(alpha: 0.1)
                      : Colors.grey.withValues(alpha: 0.1),
                  width: 1,
                ),
              ),
            ),
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
              child: Column(
                children: [
                  SidebarItem(
                    icon: FontAwesomeIcons.gear,
                    label: AppStrings.get(lang, 'sidebar_settings'),
                    isActive: selectedIndex == 3,
                    onTap: () => onItemTap(3),
                    isDark: isDark,
                    showBadge:
                        !ollamaConnected, // Stealth Mode: Show red dot if disconnected
                  ),
                  SidebarItem(
                    icon: FontAwesomeIcons.bug,
                    label: 'Dev Logs',
                    isActive: selectedIndex == 4,
                    onTap: () => onItemTap(4),
                    isDark: isDark,
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }
}
</file>

<file path="lib/ui/theme/config_provider.dart">
import 'package:flutter/material.dart';
import 'package:http/http.dart' as http;
import 'package:shared_preferences/shared_preferences.dart';
import 'package:path/path.dart' as path;

enum AIProvider { ollama, lmStudio }

class ConfigProvider extends ChangeNotifier {
  static const String _projectPathKey = 'project_path';
  static const String _selectedModelKey = 'selected_model';
  static const String _ollamaUrlKey = 'ollama_url';
  static const String _lmStudioUrlKey = 'lm_studio_url';
  static const String _aiProviderKey = 'ai_provider';
  static const String _appLanguageKey = 'app_language';
  static const String _defaultOllamaUrl = 'http://localhost:11434';
  static const String _defaultLmStudioUrl = 'http://localhost:1234';

  String _projectPath = '';
  String _selectedModel = 'qwen2.5:7b'; // Default model
  String _ollamaUrl = _defaultOllamaUrl;
  String _lmStudioUrl = _defaultLmStudioUrl;
  AIProvider _aiProvider = AIProvider.ollama;
  String _appLanguage = 'vi'; // Default language
  bool _isLoading = true;
  bool _ollamaConnected = true; // Stealth Mode: AI provider connection status

  String get projectPath => _projectPath;
  String get selectedModel => _selectedModel;
  String get ollamaUrl => _ollamaUrl;
  String get lmStudioUrl => _lmStudioUrl;
  AIProvider get aiProvider => _aiProvider;
  String get appLanguage => _appLanguage;
  bool get isLoading => _isLoading;
  bool get ollamaConnected => _ollamaConnected;

  /// Get the current AI URL based on selected provider
  String get currentAiUrl =>
      _aiProvider == AIProvider.ollama ? _ollamaUrl : _lmStudioUrl;

  bool get isConfigured => _projectPath.isNotEmpty;

  String get dictionaryDir =>
      _projectPath.isEmpty ? '' : path.join(_projectPath, 'dictionary');

  ConfigProvider() {
    loadConfig();
  }

  Future<void> loadConfig() async {
    _isLoading = true;
    notifyListeners();

    final prefs = await SharedPreferences.getInstance();
    _projectPath = prefs.getString(_projectPathKey) ?? '';
    _selectedModel = prefs.getString(_selectedModelKey) ?? 'qwen2.5:7b';
    _ollamaUrl = prefs.getString(_ollamaUrlKey) ?? _defaultOllamaUrl;
    _lmStudioUrl = prefs.getString(_lmStudioUrlKey) ?? _defaultLmStudioUrl;
    _appLanguage = prefs.getString(_appLanguageKey) ?? 'vi';

    // Load AI provider
    final providerStr = prefs.getString(_aiProviderKey) ?? 'ollama';
    _aiProvider =
        providerStr == 'lmStudio' ? AIProvider.lmStudio : AIProvider.ollama;

    _isLoading = false;
    notifyListeners();
  }

  Future<void> setProjectPath(String projectPath) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_projectPathKey, projectPath);

    _projectPath = projectPath;
    notifyListeners();
  }

  Future<void> setSelectedModel(String model) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_selectedModelKey, model);

    _selectedModel = model;
    notifyListeners();
  }

  Future<void> setOllamaUrl(String url) async {
    final prefs = await SharedPreferences.getInstance();
    // Normalize URL: remove trailing slash if present
    String normalizedUrl = url.trim();
    if (normalizedUrl.endsWith('/')) {
      normalizedUrl = normalizedUrl.substring(0, normalizedUrl.length - 1);
    }
    await prefs.setString(_ollamaUrlKey, normalizedUrl);

    _ollamaUrl = normalizedUrl;
    notifyListeners();
  }

  Future<void> setLmStudioUrl(String url) async {
    final prefs = await SharedPreferences.getInstance();
    // Normalize URL: remove trailing slash if present
    String normalizedUrl = url.trim();
    if (normalizedUrl.endsWith('/')) {
      normalizedUrl = normalizedUrl.substring(0, normalizedUrl.length - 1);
    }
    await prefs.setString(_lmStudioUrlKey, normalizedUrl);

    _lmStudioUrl = normalizedUrl;
    notifyListeners();
  }

  Future<void> setAIProvider(AIProvider provider) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_aiProviderKey,
        provider == AIProvider.lmStudio ? 'lmStudio' : 'ollama');

    _aiProvider = provider;
    notifyListeners();
  }

  Future<void> setAppLanguage(String lang) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_appLanguageKey, lang);

    _appLanguage = lang;
    notifyListeners();
  }

  /// Stealth Mode: Check AI provider connection status silently
  /// Updates ollamaConnected state without showing any dialogs
  Future<void> checkOllamaHealth() async {
    try {
      final response = await http
          .get(Uri.parse('$currentAiUrl/'))
          .timeout(const Duration(seconds: 3));
      _ollamaConnected = (response.statusCode == 200);
    } catch (e) {
      _ollamaConnected = false;
    }
    notifyListeners();
  }
}
</file>

<file path="pubspec.lock">
# Generated by pub
# See https://dart.dev/tools/pub/glossary#lockfile
packages:
  archive:
    dependency: transitive
    description:
      name: archive
      sha256: cb6a278ef2dbb298455e1a713bda08524a175630ec643a242c399c932a0a1f7d
      url: "https://pub.dev"
    source: hosted
    version: "3.6.1"
  args:
    dependency: transitive
    description:
      name: args
      sha256: d0481093c50b1da8910eb0bb301626d4d8eb7284aa739614d2b394ee09e3ea04
      url: "https://pub.dev"
    source: hosted
    version: "2.7.0"
  async:
    dependency: transitive
    description:
      name: async
      sha256: "758e6d74e971c3e5aceb4110bfd6698efc7f501675bcfe0c775459a8140750eb"
      url: "https://pub.dev"
    source: hosted
    version: "2.13.0"
  boolean_selector:
    dependency: transitive
    description:
      name: boolean_selector
      sha256: "8aab1771e1243a5063b8b0ff68042d67334e3feab9e95b9490f9a6ebf73b42ea"
      url: "https://pub.dev"
    source: hosted
    version: "2.1.2"
  characters:
    dependency: transitive
    description:
      name: characters
      sha256: f71061c654a3380576a52b451dd5532377954cf9dbd272a78fc8479606670803
      url: "https://pub.dev"
    source: hosted
    version: "1.4.0"
  cli_util:
    dependency: transitive
    description:
      name: cli_util
      sha256: ff6785f7e9e3c38ac98b2fb035701789de90154024a75b6cb926445e83197d1c
      url: "https://pub.dev"
    source: hosted
    version: "0.4.2"
  clock:
    dependency: transitive
    description:
      name: clock
      sha256: fddb70d9b5277016c77a80201021d40a2247104d9f4aa7bab7157b7e3f05b84b
      url: "https://pub.dev"
    source: hosted
    version: "1.1.2"
  collection:
    dependency: transitive
    description:
      name: collection
      sha256: "2f5709ae4d3d59dd8f7cd309b4e023046b57d8a6c82130785d2b0e5868084e76"
      url: "https://pub.dev"
    source: hosted
    version: "1.19.1"
  console:
    dependency: transitive
    description:
      name: console
      sha256: e04e7824384c5b39389acdd6dc7d33f3efe6b232f6f16d7626f194f6a01ad69a
      url: "https://pub.dev"
    source: hosted
    version: "4.1.0"
  cross_file:
    dependency: transitive
    description:
      name: cross_file
      sha256: "701dcfc06da0882883a2657c445103380e53e647060ad8d9dfb710c100996608"
      url: "https://pub.dev"
    source: hosted
    version: "0.3.5+1"
  crypto:
    dependency: transitive
    description:
      name: crypto
      sha256: c8ea0233063ba03258fbcf2ca4d6dadfefe14f02fab57702265467a19f27fadf
      url: "https://pub.dev"
    source: hosted
    version: "3.0.7"
  csslib:
    dependency: transitive
    description:
      name: csslib
      sha256: "09bad715f418841f976c77db72d5398dc1253c21fb9c0c7f0b0b985860b2d58e"
      url: "https://pub.dev"
    source: hosted
    version: "1.0.2"
  csv:
    dependency: "direct main"
    description:
      name: csv
      sha256: c6aa2679b2a18cb57652920f674488d89712efaf4d3fdf2e537215b35fc19d6c
      url: "https://pub.dev"
    source: hosted
    version: "6.0.0"
  dbus:
    dependency: transitive
    description:
      name: dbus
      sha256: "79e0c23480ff85dc68de79e2cd6334add97e48f7f4865d17686dd6ea81a47e8c"
      url: "https://pub.dev"
    source: hosted
    version: "0.7.11"
  desktop_drop:
    dependency: "direct main"
    description:
      name: desktop_drop
      sha256: d55a010fe46c8e8fcff4ea4b451a9ff84a162217bdb3b2a0aa1479776205e15d
      url: "https://pub.dev"
    source: hosted
    version: "0.4.4"
  epubx:
    dependency: "direct main"
    description:
      name: epubx
      sha256: "0ab9354efa177c4be52c46f857bc15bf83f83a92667fb673465c8f89fca26db3"
      url: "https://pub.dev"
    source: hosted
    version: "4.0.0"
  fake_async:
    dependency: transitive
    description:
      name: fake_async
      sha256: "5368f224a74523e8d2e7399ea1638b37aecfca824a3cc4dfdf77bf1fa905ac44"
      url: "https://pub.dev"
    source: hosted
    version: "1.3.3"
  ffi:
    dependency: transitive
    description:
      name: ffi
      sha256: "289279317b4b16eb2bb7e271abccd4bf84ec9bdcbe999e278a94b804f5630418"
      url: "https://pub.dev"
    source: hosted
    version: "2.1.4"
  file:
    dependency: transitive
    description:
      name: file
      sha256: a3b4f84adafef897088c160faf7dfffb7696046cb13ae90b508c2cbc95d3b8d4
      url: "https://pub.dev"
    source: hosted
    version: "7.0.1"
  file_picker:
    dependency: "direct main"
    description:
      name: file_picker
      sha256: "7872545770c277236fd32b022767576c562ba28366204ff1a5628853cf8f2200"
      url: "https://pub.dev"
    source: hosted
    version: "10.3.7"
  flutter:
    dependency: "direct main"
    description: flutter
    source: sdk
    version: "0.0.0"
  flutter_animate:
    dependency: "direct main"
    description:
      name: flutter_animate
      sha256: "7befe2d3252728afb77aecaaea1dec88a89d35b9b1d2eea6d04479e8af9117b5"
      url: "https://pub.dev"
    source: hosted
    version: "4.5.2"
  flutter_lints:
    dependency: "direct dev"
    description:
      name: flutter_lints
      sha256: "9e8c3858111da373efc5aa341de011d9bd23e2c5c5e0c62bccf32438e192d7b1"
      url: "https://pub.dev"
    source: hosted
    version: "3.0.2"
  flutter_plugin_android_lifecycle:
    dependency: transitive
    description:
      name: flutter_plugin_android_lifecycle
      sha256: ee8068e0e1cd16c4a82714119918efdeed33b3ba7772c54b5d094ab53f9b7fd1
      url: "https://pub.dev"
    source: hosted
    version: "2.0.33"
  flutter_shaders:
    dependency: transitive
    description:
      name: flutter_shaders
      sha256: "34794acadd8275d971e02df03afee3dee0f98dbfb8c4837082ad0034f612a3e2"
      url: "https://pub.dev"
    source: hosted
    version: "0.1.3"
  flutter_test:
    dependency: "direct dev"
    description: flutter
    source: sdk
    version: "0.0.0"
  flutter_web_plugins:
    dependency: transitive
    description: flutter
    source: sdk
    version: "0.0.0"
  font_awesome_flutter:
    dependency: "direct main"
    description:
      name: font_awesome_flutter
      sha256: b9011df3a1fa02993630b8fb83526368cf2206a711259830325bab2f1d2a4eb0
      url: "https://pub.dev"
    source: hosted
    version: "10.12.0"
  get_it:
    dependency: transitive
    description:
      name: get_it
      sha256: ae78de7c3f2304b8d81f2bb6e320833e5e81de942188542328f074978cc0efa9
      url: "https://pub.dev"
    source: hosted
    version: "8.3.0"
  google_fonts:
    dependency: "direct main"
    description:
      name: google_fonts
      sha256: "517b20870220c48752eafa0ba1a797a092fb22df0d89535fd9991e86ee2cdd9c"
      url: "https://pub.dev"
    source: hosted
    version: "6.3.2"
  html:
    dependency: "direct main"
    description:
      name: html
      sha256: "6d1264f2dffa1b1101c25a91dff0dc2daee4c18e87cd8538729773c073dbf602"
      url: "https://pub.dev"
    source: hosted
    version: "0.15.6"
  http:
    dependency: "direct main"
    description:
      name: http
      sha256: "87721a4a50b19c7f1d49001e51409bddc46303966ce89a65af4f4e6004896412"
      url: "https://pub.dev"
    source: hosted
    version: "1.6.0"
  http_parser:
    dependency: transitive
    description:
      name: http_parser
      sha256: "178d74305e7866013777bab2c3d8726205dc5a4dd935297175b19a23a2e66571"
      url: "https://pub.dev"
    source: hosted
    version: "4.1.2"
  image:
    dependency: "direct overridden"
    description:
      name: image
      sha256: "8e9d133755c3e84c73288363e6343157c383a0c6c56fc51afcc5d4d7180306d6"
      url: "https://pub.dev"
    source: hosted
    version: "3.3.0"
  leak_tracker:
    dependency: transitive
    description:
      name: leak_tracker
      sha256: "33e2e26bdd85a0112ec15400c8cbffea70d0f9c3407491f672a2fad47915e2de"
      url: "https://pub.dev"
    source: hosted
    version: "11.0.2"
  leak_tracker_flutter_testing:
    dependency: transitive
    description:
      name: leak_tracker_flutter_testing
      sha256: "1dbc140bb5a23c75ea9c4811222756104fbcd1a27173f0c34ca01e16bea473c1"
      url: "https://pub.dev"
    source: hosted
    version: "3.0.10"
  leak_tracker_testing:
    dependency: transitive
    description:
      name: leak_tracker_testing
      sha256: "8d5a2d49f4a66b49744b23b018848400d23e54caf9463f4eb20df3eb8acb2eb1"
      url: "https://pub.dev"
    source: hosted
    version: "3.0.2"
  lints:
    dependency: transitive
    description:
      name: lints
      sha256: cbf8d4b858bb0134ef3ef87841abdf8d63bfc255c266b7bf6b39daa1085c4290
      url: "https://pub.dev"
    source: hosted
    version: "3.0.0"
  matcher:
    dependency: transitive
    description:
      name: matcher
      sha256: dc58c723c3c24bf8d3e2d3ad3f2f9d7bd9cf43ec6feaa64181775e60190153f2
      url: "https://pub.dev"
    source: hosted
    version: "0.12.17"
  material_color_utilities:
    dependency: transitive
    description:
      name: material_color_utilities
      sha256: f7142bb1154231d7ea5f96bc7bde4bda2a0945d2806bb11670e30b850d56bdec
      url: "https://pub.dev"
    source: hosted
    version: "0.11.1"
  meta:
    dependency: transitive
    description:
      name: meta
      sha256: "23f08335362185a5ea2ad3a4e597f1375e78bce8a040df5c600c8d3552ef2394"
      url: "https://pub.dev"
    source: hosted
    version: "1.17.0"
  msix:
    dependency: "direct dev"
    description:
      name: msix
      sha256: f88033fcb9e0dd8de5b18897cbebbd28ea30596810f4a7c86b12b0c03ace87e5
      url: "https://pub.dev"
    source: hosted
    version: "3.16.12"
  nested:
    dependency: transitive
    description:
      name: nested
      sha256: "03bac4c528c64c95c722ec99280375a6f2fc708eec17c7b3f07253b626cd2a20"
      url: "https://pub.dev"
    source: hosted
    version: "1.0.0"
  package_config:
    dependency: transitive
    description:
      name: package_config
      sha256: f096c55ebb7deb7e384101542bfba8c52696c1b56fca2eb62827989ef2353bbc
      url: "https://pub.dev"
    source: hosted
    version: "2.2.0"
  path:
    dependency: "direct main"
    description:
      name: path
      sha256: "75cca69d1490965be98c73ceaea117e8a04dd21217b37b292c9ddbec0d955bc5"
      url: "https://pub.dev"
    source: hosted
    version: "1.9.1"
  path_provider:
    dependency: transitive
    description:
      name: path_provider
      sha256: "50c5dd5b6e1aaf6fb3a78b33f6aa3afca52bf903a8a5298f53101fdaee55bbcd"
      url: "https://pub.dev"
    source: hosted
    version: "2.1.5"
  path_provider_android:
    dependency: transitive
    description:
      name: path_provider_android
      sha256: f2c65e21139ce2c3dad46922be8272bb5963516045659e71bb16e151c93b580e
      url: "https://pub.dev"
    source: hosted
    version: "2.2.22"
  path_provider_foundation:
    dependency: transitive
    description:
      name: path_provider_foundation
      sha256: "6d13aece7b3f5c5a9731eaf553ff9dcbc2eff41087fd2df587fd0fed9a3eb0c4"
      url: "https://pub.dev"
    source: hosted
    version: "2.5.1"
  path_provider_linux:
    dependency: transitive
    description:
      name: path_provider_linux
      sha256: f7a1fe3a634fe7734c8d3f2766ad746ae2a2884abe22e241a8b301bf5cac3279
      url: "https://pub.dev"
    source: hosted
    version: "2.2.1"
  path_provider_platform_interface:
    dependency: transitive
    description:
      name: path_provider_platform_interface
      sha256: "88f5779f72ba699763fa3a3b06aa4bf6de76c8e5de842cf6f29e2e06476c2334"
      url: "https://pub.dev"
    source: hosted
    version: "2.1.2"
  path_provider_windows:
    dependency: transitive
    description:
      name: path_provider_windows
      sha256: bd6f00dbd873bfb70d0761682da2b3a2c2fccc2b9e84c495821639601d81afe7
      url: "https://pub.dev"
    source: hosted
    version: "2.3.0"
  petitparser:
    dependency: transitive
    description:
      name: petitparser
      sha256: "1a97266a94f7350d30ae522c0af07890c70b8e62c71e8e3920d1db4d23c057d1"
      url: "https://pub.dev"
    source: hosted
    version: "7.0.1"
  platform:
    dependency: transitive
    description:
      name: platform
      sha256: "5d6b1b0036a5f331ebc77c850ebc8506cbc1e9416c27e59b439f917a902a4984"
      url: "https://pub.dev"
    source: hosted
    version: "3.1.6"
  plugin_platform_interface:
    dependency: transitive
    description:
      name: plugin_platform_interface
      sha256: "4820fbfdb9478b1ebae27888254d445073732dae3d6ea81f0b7e06d5dedc3f02"
      url: "https://pub.dev"
    source: hosted
    version: "2.1.8"
  provider:
    dependency: "direct main"
    description:
      name: provider
      sha256: "4e82183fa20e5ca25703ead7e05de9e4cceed1fbd1eadc1ac3cb6f565a09f272"
      url: "https://pub.dev"
    source: hosted
    version: "6.1.5+1"
  pub_semver:
    dependency: transitive
    description:
      name: pub_semver
      sha256: "5bfcf68ca79ef689f8990d1160781b4bad40a3bd5e5218ad4076ddb7f4081585"
      url: "https://pub.dev"
    source: hosted
    version: "2.2.0"
  quiver:
    dependency: transitive
    description:
      name: quiver
      sha256: ea0b925899e64ecdfbf9c7becb60d5b50e706ade44a85b2363be2a22d88117d2
      url: "https://pub.dev"
    source: hosted
    version: "3.2.2"
  screen_retriever:
    dependency: transitive
    description:
      name: screen_retriever
      sha256: "6ee02c8a1158e6dae7ca430da79436e3b1c9563c8cf02f524af997c201ac2b90"
      url: "https://pub.dev"
    source: hosted
    version: "0.1.9"
  shared_preferences:
    dependency: "direct main"
    description:
      name: shared_preferences
      sha256: "6e8bf70b7fef813df4e9a36f658ac46d107db4b4cfe1048b477d4e453a8159f5"
      url: "https://pub.dev"
    source: hosted
    version: "2.5.3"
  shared_preferences_android:
    dependency: transitive
    description:
      name: shared_preferences_android
      sha256: "46a46fd64659eff15f4638bbe19de43f9483f0e0bf024a9fb6b3582064bacc7b"
      url: "https://pub.dev"
    source: hosted
    version: "2.4.17"
  shared_preferences_foundation:
    dependency: transitive
    description:
      name: shared_preferences_foundation
      sha256: "4e7eaffc2b17ba398759f1151415869a34771ba11ebbccd1b0145472a619a64f"
      url: "https://pub.dev"
    source: hosted
    version: "2.5.6"
  shared_preferences_linux:
    dependency: transitive
    description:
      name: shared_preferences_linux
      sha256: "580abfd40f415611503cae30adf626e6656dfb2f0cee8f465ece7b6defb40f2f"
      url: "https://pub.dev"
    source: hosted
    version: "2.4.1"
  shared_preferences_platform_interface:
    dependency: transitive
    description:
      name: shared_preferences_platform_interface
      sha256: "57cbf196c486bc2cf1f02b85784932c6094376284b3ad5779d1b1c6c6a816b80"
      url: "https://pub.dev"
    source: hosted
    version: "2.4.1"
  shared_preferences_web:
    dependency: transitive
    description:
      name: shared_preferences_web
      sha256: c49bd060261c9a3f0ff445892695d6212ff603ef3115edbb448509d407600019
      url: "https://pub.dev"
    source: hosted
    version: "2.4.3"
  shared_preferences_windows:
    dependency: transitive
    description:
      name: shared_preferences_windows
      sha256: "94ef0f72b2d71bc3e700e025db3710911bd51a71cefb65cc609dd0d9a982e3c1"
      url: "https://pub.dev"
    source: hosted
    version: "2.4.1"
  sky_engine:
    dependency: transitive
    description: flutter
    source: sdk
    version: "0.0.0"
  source_span:
    dependency: transitive
    description:
      name: source_span
      sha256: "254ee5351d6cb365c859e20ee823c3bb479bf4a293c22d17a9f1bf144ce86f7c"
      url: "https://pub.dev"
    source: hosted
    version: "1.10.1"
  stack_trace:
    dependency: transitive
    description:
      name: stack_trace
      sha256: "8b27215b45d22309b5cddda1aa2b19bdfec9df0e765f2de506401c071d38d1b1"
      url: "https://pub.dev"
    source: hosted
    version: "1.12.1"
  stream_channel:
    dependency: transitive
    description:
      name: stream_channel
      sha256: "969e04c80b8bcdf826f8f16579c7b14d780458bd97f56d107d3950fdbeef059d"
      url: "https://pub.dev"
    source: hosted
    version: "2.1.4"
  string_scanner:
    dependency: transitive
    description:
      name: string_scanner
      sha256: "921cd31725b72fe181906c6a94d987c78e3b98c2e205b397ea399d4054872b43"
      url: "https://pub.dev"
    source: hosted
    version: "1.4.1"
  term_glyph:
    dependency: transitive
    description:
      name: term_glyph
      sha256: "7f554798625ea768a7518313e58f83891c7f5024f88e46e7182a4558850a4b8e"
      url: "https://pub.dev"
    source: hosted
    version: "1.2.2"
  test_api:
    dependency: transitive
    description:
      name: test_api
      sha256: ab2726c1a94d3176a45960b6234466ec367179b87dd74f1611adb1f3b5fb9d55
      url: "https://pub.dev"
    source: hosted
    version: "0.7.7"
  typed_data:
    dependency: transitive
    description:
      name: typed_data
      sha256: f9049c039ebfeb4cf7a7104a675823cd72dba8297f264b6637062516699fa006
      url: "https://pub.dev"
    source: hosted
    version: "1.4.0"
  url_launcher:
    dependency: "direct main"
    description:
      name: url_launcher
      sha256: f6a7e5c4835bb4e3026a04793a4199ca2d14c739ec378fdfe23fc8075d0439f8
      url: "https://pub.dev"
    source: hosted
    version: "6.3.2"
  url_launcher_android:
    dependency: transitive
    description:
      name: url_launcher_android
      sha256: "767344bf3063897b5cf0db830e94f904528e6dd50a6dfaf839f0abf509009611"
      url: "https://pub.dev"
    source: hosted
    version: "6.3.28"
  url_launcher_ios:
    dependency: transitive
    description:
      name: url_launcher_ios
      sha256: cfde38aa257dae62ffe79c87fab20165dfdf6988c1d31b58ebf59b9106062aad
      url: "https://pub.dev"
    source: hosted
    version: "6.3.6"
  url_launcher_linux:
    dependency: transitive
    description:
      name: url_launcher_linux
      sha256: d5e14138b3bc193a0f63c10a53c94b91d399df0512b1f29b94a043db7482384a
      url: "https://pub.dev"
    source: hosted
    version: "3.2.2"
  url_launcher_macos:
    dependency: transitive
    description:
      name: url_launcher_macos
      sha256: "368adf46f71ad3c21b8f06614adb38346f193f3a59ba8fe9a2fd74133070ba18"
      url: "https://pub.dev"
    source: hosted
    version: "3.2.5"
  url_launcher_platform_interface:
    dependency: transitive
    description:
      name: url_launcher_platform_interface
      sha256: "552f8a1e663569be95a8190206a38187b531910283c3e982193e4f2733f01029"
      url: "https://pub.dev"
    source: hosted
    version: "2.3.2"
  url_launcher_web:
    dependency: transitive
    description:
      name: url_launcher_web
      sha256: "4bd2b7b4dc4d4d0b94e5babfffbca8eac1a126c7f3d6ecbc1a11013faa3abba2"
      url: "https://pub.dev"
    source: hosted
    version: "2.4.1"
  url_launcher_windows:
    dependency: transitive
    description:
      name: url_launcher_windows
      sha256: "712c70ab1b99744ff066053cbe3e80c73332b38d46e5e945c98689b2e66fc15f"
      url: "https://pub.dev"
    source: hosted
    version: "3.1.5"
  vector_math:
    dependency: transitive
    description:
      name: vector_math
      sha256: d530bd74fea330e6e364cda7a85019c434070188383e1cd8d9777ee586914c5b
      url: "https://pub.dev"
    source: hosted
    version: "2.2.0"
  vm_service:
    dependency: transitive
    description:
      name: vm_service
      sha256: "45caa6c5917fa127b5dbcfbd1fa60b14e583afdc08bfc96dda38886ca252eb60"
      url: "https://pub.dev"
    source: hosted
    version: "15.0.2"
  web:
    dependency: transitive
    description:
      name: web
      sha256: "868d88a33d8a87b18ffc05f9f030ba328ffefba92d6c127917a2ba740f9cfe4a"
      url: "https://pub.dev"
    source: hosted
    version: "1.1.1"
  win32:
    dependency: transitive
    description:
      name: win32
      sha256: d7cb55e04cd34096cd3a79b3330245f54cb96a370a1c27adb3c84b917de8b08e
      url: "https://pub.dev"
    source: hosted
    version: "5.15.0"
  window_manager:
    dependency: "direct main"
    description:
      name: window_manager
      sha256: "8699323b30da4cdbe2aa2e7c9de567a6abd8a97d9a5c850a3c86dcd0b34bbfbf"
      url: "https://pub.dev"
    source: hosted
    version: "0.3.9"
  xdg_directories:
    dependency: transitive
    description:
      name: xdg_directories
      sha256: "7a3f37b05d989967cdddcbb571f1ea834867ae2faa29725fd085180e0883aa15"
      url: "https://pub.dev"
    source: hosted
    version: "1.1.0"
  xml:
    dependency: transitive
    description:
      name: xml
      sha256: "971043b3a0d3da28727e40ed3e0b5d18b742fa5a68665cca88e74b7876d5e025"
      url: "https://pub.dev"
    source: hosted
    version: "6.6.1"
  yaml:
    dependency: transitive
    description:
      name: yaml
      sha256: b9da305ac7c39faa3f030eccd175340f968459dae4af175130b3fc47e40d76ce
      url: "https://pub.dev"
    source: hosted
    version: "3.1.3"
sdks:
  dart: ">=3.9.0 <4.0.0"
  flutter: ">=3.35.0"
</file>

<file path="pubspec.yaml">
name: flux_origin
description: A translation desktop application for Windows
publish_to: 'none'
version: 2.0.2+1

environment:
  sdk: '>=3.0.0 <4.0.0'

dependencies:
  flutter:
    sdk: flutter
  
  # Window management
  window_manager: ^0.3.0
  
  # UI dependencies
  google_fonts: ^6.1.0
  font_awesome_flutter: ^10.6.0
  flutter_animate: ^4.3.0
  
  # State management
  provider: ^6.1.0
  file_picker: ^10.3.7
  shared_preferences: ^2.5.3
  http: ^1.1.0
  url_launcher: ^6.3.2
  csv: ^6.0.0
  html: ^0.15.4
  desktop_drop: ^0.4.4
  
  # File parsing
  epubx: ^4.0.0
  path: ^1.9.0

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^3.0.0
  msix: ^3.16.0

dependency_overrides:
  image: ^3.3.0

flutter:
  uses-material-design: true

# ... (gi·ªØ nguy√™n ph·∫ßn tr√™n c·ªßa file pubspec.yaml)

msix_config:
  display_name: FluxOrigin
  publisher_display_name: d-init-d
  identity_name: d-init-d.FluxOrigin  # QUAN TR·ªåNG: N·∫øu ƒëƒÉng Store, ph·∫£i l·∫•y t√™n Identity t·ª´ Partner Center
  publisher: CN=94D446F9-8A96-471F-9749-DFF18CBA6CD8     # QUAN TR·ªåNG: N·∫øu ƒëƒÉng Store, ph·∫£i l·∫•y chu·ªói Publisher ID (v√≠ d·ª•: CN=92837...) t·ª´ Partner Center
  msix_version: 2.0.2.0
  logo_path: D:\FluxOrigin\assets\fluxorigin logo.png
  store: true
  capabilities: "internetClient, internetClientServer"
  # C√°c quy·ªÅn truy c·∫≠p file n·∫øu app c·∫ßn (v√¨ MSIX ch·∫°y trong sandbox)
  # un-comment n·∫øu app c·∫ßn ƒë·ªçc/ghi file t·ª± do ngo√†i th∆∞ m·ª•c app
  # execution_alias: fluxorigin
</file>

<file path="lib/services/ai_service.dart">
import 'dart:convert';
import 'package:csv/csv.dart';
import 'package:http/http.dart' as http;
import 'dev_logger.dart';

enum AIProviderType { ollama, lmStudio }

class AIService {
  static const String _defaultBaseUrl = 'http://localhost:11434';
  String _baseUrl = _defaultBaseUrl;
  AIProviderType _providerType = AIProviderType.ollama;
  final DevLogger _logger = DevLogger();

  /// Set the base URL for AI API
  void setBaseUrl(String url) {
    // Normalize URL: remove trailing slash if present
    String normalizedUrl = url.trim();
    if (normalizedUrl.endsWith('/')) {
      normalizedUrl = normalizedUrl.substring(0, normalizedUrl.length - 1);
    }
    _baseUrl = normalizedUrl;
    _logger.info('AIService', 'Base URL set to: $normalizedUrl');
  }

  /// Set the AI provider type
  void setProviderType(AIProviderType type) {
    _providerType = type;
    _logger.info('AIService',
        'Provider type set to: ${type == AIProviderType.ollama ? 'Ollama' : 'LM Studio'}');
  }

  /// Get the chat API endpoint based on provider
  String get _chatUrl {
    if (_providerType == AIProviderType.lmStudio) {
      return '$_baseUrl/v1/chat/completions';
    }
    return '$_baseUrl/api/chat';
  }

  /// Get the tags/models API endpoint based on provider
  String get _tagsUrl {
    if (_providerType == AIProviderType.lmStudio) {
      return '$_baseUrl/v1/models';
    }
    return '$_baseUrl/api/tags';
  }

  /// Get the pull API endpoint (Ollama only)
  String get _pullUrl => '$_baseUrl/api/pull';

  /// Get the delete API endpoint (Ollama only)
  String get _deleteUrl => '$_baseUrl/api/delete';

  /// Check connection to AI server
  /// Returns a tuple of (success, errorCode, modelCount)
  /// errorCode is null on success, or one of: 'error_status', 'error_connect', 'error_timeout', 'error_generic'
  Future<(bool, String?, int)> checkConnection(
      {String? url, AIProviderType? providerType}) async {
    final testUrl = url ?? _baseUrl;
    final provider = providerType ?? _providerType;
    String normalizedUrl = testUrl.trim();
    if (normalizedUrl.endsWith('/')) {
      normalizedUrl = normalizedUrl.substring(0, normalizedUrl.length - 1);
    }

    final modelsEndpoint = provider == AIProviderType.lmStudio
        ? '$normalizedUrl/v1/models'
        : '$normalizedUrl/api/tags';

    try {
      final response = await http
          .get(Uri.parse(modelsEndpoint))
          .timeout(const Duration(seconds: 5));

      if (response.statusCode == 200) {
        final Map<String, dynamic> data = jsonDecode(response.body);

        if (provider == AIProviderType.lmStudio) {
          // LM Studio returns { data: [...] }
          final List<dynamic> models = data['data'] ?? [];
          return (true, null, models.length);
        } else {
          // Ollama returns { models: [...] }
          final List<dynamic> models = data['models'] ?? [];
          return (true, null, models.length);
        }
      } else {
        return (false, 'error_status:${response.statusCode}', 0);
      }
    } on http.ClientException {
      return (false, 'error_connect', 0);
    } catch (e) {
      if (e.toString().contains('TimeoutException')) {
        return (false, 'error_timeout', 0);
      }
      return (false, 'error_generic', 0);
    }
  }

  static const Map<String, String> _prompts = {
    "KIEMHIEP":
        "B·∫°n l√† d·ªãch gi·∫£ ki·∫øm hi·ªáp l√£o luy·ªán. D√πng t·ª´ H√°n Vi·ªát (huynh, ƒë·ªá, t·∫°i h·∫°...), vƒÉn phong h√†o h√πng, c·ªï trang. Chi√™u th·ª©c gi·ªØ nguy√™n √¢m H√°n Vi·ªát.",
    "NGONTINH":
        "B·∫°n l√† d·ªãch gi·∫£ ng√¥n t√¨nh. VƒÉn phong l√£ng m·∫°n, nh·∫π nh√†ng, ∆∞·ªõt √°t. X∆∞ng h√¥ Anh - Em ho·∫∑c Ch√†ng - N√†ng t√πy ng·ªØ c·∫£nh.",
    "KINHDOANH":
        "B·∫°n l√† chuy√™n gia kinh t·∫ø. D·ªãch vƒÉn phong trang tr·ªçng, chuy√™n nghi·ªáp, d√πng thu·∫≠t ng·ªØ ch√≠nh x√°c.",
    "KHAC":
        "B·∫°n l√† m·ªôt d·ªãch gi·∫£ chuy√™n nghi·ªáp. H√£y d·ªãch tr√¥i ch·∫£y, t·ª± nhi√™n, s√°t nghƒ©a g·ªëc."
  };

  Future<String> detectGenre(String sample, String modelName) async {
    final response = await chatCompletion(
      modelName: modelName,
      messages: [
        {
          "role": "user",
          "content":
              "B·∫°n l√† m·ªôt tr·ª£ l√Ω ph√¢n lo·∫°i vƒÉn h·ªçc.\nH√£y ƒë·ªçc ƒëo·∫°n vƒÉn b·∫£n m·∫´u d∆∞·ªõi ƒë√¢y v√† x√°c ƒë·ªãnh th·ªÉ lo·∫°i ch√≠nh c·ªßa n√≥.\nCh·ªâ tr·∫£ v·ªÅ DUY NH·∫§T m·ªôt t·ª´ kh√≥a trong danh s√°ch sau: [KIEMHIEP, NGONTINH, KINHDOANH, KHOAHOC, KHAC].\nTuy·ªát ƒë·ªëi kh√¥ng gi·∫£i th√≠ch g√¨ th√™m.\n\nVƒÉn b·∫£n m·∫´u:\n$sample"
        }
      ],
    );

    final genre = response.trim().toUpperCase();
    if (_prompts.containsKey(genre)) {
      return genre;
    }
    for (final key in _prompts.keys) {
      if (genre.contains(key)) {
        return key;
      }
    }
    return "KHAC";
  }

  String getSystemPrompt(String genre, String sourceLang, String targetLang) {
    // Tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát: Ti·∫øng Trung -> Ti·∫øng Vi·ªát (Ki·∫øm Hi·ªáp/Ng√¥n T√¨nh)
    if (sourceLang == 'Ti·∫øng Trung' && targetLang == 'Ti·∫øng Vi·ªát') {
      return _prompts[genre] ?? _prompts['KHAC']!;
    }

    // C√°c tr∆∞·ªùng h·ª£p kh√°c: Prompt chung
    return "You are a professional translator translating from $sourceLang to $targetLang. Translate the text naturally and fluently while preserving the original meaning and tone.";
  }

  Future<String> generateGlossary(String sample, String modelName,
      String sourceLanguage, String genre) async {
    // Prompt kh√°c nhau t√πy theo ng√¥n ng·ªØ ngu·ªìn v√† th·ªÉ lo·∫°i
    // Prompt kh√°c nhau t√πy theo ng√¥n ng·ªØ ngu·ªìn v√† th·ªÉ lo·∫°i
    String promptContent;
    bool isWuxia = genre == 'KIEMHIEP' || genre == 'NGONTINH';

    if (sourceLanguage == 'Ti·∫øng Trung' && isWuxia) {
      // === PROMPT CHO KI·∫æM HI·ªÜP / NG√îN T√åNH (GI·ªÆ NGUY√äN C≈®) ===
      promptContent =
          """NHI·ªÜM V·ª§: Ph√¢n t√≠ch vƒÉn b·∫£n Ti·∫øng Trung v√† tr√≠ch xu·∫•t c√°c T√™n Ri√™ng (Nh√¢n v·∫≠t, ƒê·ªãa danh, M√¥n ph√°i, Chi√™u th·ª©c) ƒë·ªÉ t·∫°o t·ª´ ƒëi·ªÉn H√°n Vi·ªát.

QUY T·∫ÆC B·∫ÆT BU·ªòC (TU√ÇN TH·ª¶ TUY·ªÜT ƒê·ªêI):
1. ƒê·ªäNH D·∫†NG OUTPUT: Ch·ªâ tr·∫£ v·ªÅ CSV 2 c·ªôt: `T·ª´ g·ªëc Trung,H√°n Vi·ªát`. Kh√¥ng th√™m STT, kh√¥ng th√™m gi·∫£i th√≠ch.
2. D·ªäCH H√ÅN VI·ªÜT CHU·∫®N:
   - "ÈïøËÄÅ" (Elder) PH·∫¢I d·ªãch l√† "Tr∆∞·ªüng l√£o". (C·∫•m d·ªãch l√† L√£o ƒê·∫ø, Gi·∫£ Li).
   - "ÂÆó" (Sect) PH·∫¢I d·ªãch l√† "T√¥ng".
   - "Â∏àÂÖÑ/Â∏àÂºü" PH·∫¢I d·ªãch l√† "S∆∞ huynh/S∆∞ ƒë·ªá".
   - T√™n ng∆∞·ªùi: D·ªãch nguy√™n theo √¢m H√°n Vi·ªát (V√≠ d·ª•: Âè∂Â∞ò -> Di·ªáp Tr·∫ßn).
3. KH√îNG ƒê∆Ø·ª¢C B·ªäA ƒê·∫∂T: N·∫øu kh√¥ng ch·∫Øc ch·∫Øn v·ªÅ √¢m H√°n Vi·ªát, h√£y b·ªè qua t·ª´ ƒë√≥.
4. KH√îNG d·ªãch sang ti·∫øng Anh.

VƒÉn b·∫£n:
$sample""";
    } else {
      // === PROMPT M·ªöI CHO: TI·∫æNG ANH, KHOA H·ªåC, K·ª∏ THU·∫¨T, ƒê·ªúI S·ªêNG, TI·∫æNG TRUNG (CHUY√äN NG√ÄNH) ===
      promptContent = """
NHI·ªÜM V·ª§: Tr√≠ch xu·∫•t thu·∫≠t ng·ªØ chuy√™n ng√†nh v√† T√™n ri√™ng ƒë·ªÉ t·∫°o t·ª´ ƒëi·ªÉn.

Y√äU C·∫¶U ƒê·∫¶U RA NGHI√äM NG·∫∂T:
1. CH·ªà TR·∫¢ V·ªÄ CSV 2 C·ªòT: `T·ª´ g·ªëc,Nghƒ©a Ti·∫øng Vi·ªát`.
2. TUY·ªÜT ƒê·ªêI KH√îNG c√≥ c·ªôt th·ª© 3 (Kh√¥ng gi·∫£i th√≠ch, kh√¥ng ƒë·ªãnh nghƒ©a).
3. KH√îNG c√≥ d√≤ng ti√™u ƒë·ªÅ (Header).
4. KH√îNG c√≥ d·∫•u ch·∫•m c√¢u th·ª´a ·ªü cu·ªëi d√≤ng.
5. QUY T·∫ÆC D·ªäCH (C·ªôt 2):
   - Thu·∫≠t ng·ªØ qu·ªëc t·∫ø (AI, CEO, MRI, LoRA...): GI·ªÆ NGUY√äN ti·∫øng Anh.
   - Thu·∫≠t ng·ªØ th∆∞·ªùng: D·ªãch sang ti·∫øng Vi·ªát hi·ªán ƒë·∫°i.
   - KH√îNG d√πng t·ª´ H√°n Vi·ªát c·ªï cho vƒÉn b·∫£n khoa h·ªçc.

VƒÉn b·∫£n:
$sample
""";
    }

    final response = await chatCompletion(modelName: modelName, messages: [
      {"role": "user", "content": promptContent}
    ], options: {
      "num_predict": 3000
    });

    final List<String> lines = response.split('\n');
    final StringBuffer cleanBuffer = StringBuffer();

    for (final line in lines) {
      // 1. X√≥a c√°c d√≤ng Header n·∫øu AI l·ª° sinh ra
      lines.removeWhere((line) {
        final lower = line.toLowerCase().trim();
        return lower.startsWith('original') ||
            lower.startsWith('term') ||
            lower.startsWith('t·ª´ g·ªëc') ||
            lower.startsWith('----');
      });

      for (var i = 0; i < lines.length; i++) {
        String line = lines[i].trim();
        if (line.isEmpty) continue;

        // 2. X·ª≠ l√Ω d·∫•u ph·∫©y cu·ªëi d√≤ng n·∫øu c√≥ (v√≠ d·ª•: "Term,Viet,")
        if (line.endsWith(',')) {
          line = line.substring(0, line.length - 1).trim();
        }

        String? original;
        String? vietnamese;

        // 3. ∆Øu ti√™n d√πng th∆∞ vi·ªán CSV ƒë·ªÉ parse cho chu·∫©n
        try {
          List<List<dynamic>> rows = const CsvToListConverter()
              .convert(line, shouldParseNumbers: false);
          if (rows.isNotEmpty && rows[0].isNotEmpty) {
            final row = rows[0];
            if (row.length >= 2) {
              original = row[0].toString().trim();
              vietnamese = row[1].toString().trim();
            } else if (row.length == 1 && line.contains(',')) {
              // Fallback: CSV parser c√≥ th·ªÉ fail n·∫øu quote kh√¥ng ƒë√≥ng, th·ª≠ split th·ªß c√¥ng
              final parts = line.split(',');
              if (parts.length >= 2) {
                original = parts[0].trim();
                vietnamese = parts.sublist(1).join(',').trim();
              }
            }
          }
        } catch (e) {
          // Fallback n·∫øu CSV parser l·ªói
        }

        // 4. N·∫øu CSV parser kh√¥ng ra, th·ª≠ split th·ªß c√¥ng th√¥ng minh
        if (original == null || vietnamese == null) {
          if (line.contains(':')) {
            final parts = line.split(':');
            if (parts.length >= 2) {
              original = parts[0].trim();
              vietnamese = parts.sublist(1).join(':').trim();
            }
          } else if (line.contains('-')) {
            // Ch·ªâ split b·∫±ng '-' n·∫øu kh√¥ng ph·∫£i l√† t·ª´ gh√©p (v√≠ d·ª•: "Sino-Vietnamese")
            // Logic ƒë∆°n gi·∫£n: split ·ªü d·∫•u g·∫°ch ngang ƒë·∫ßu ti√™n c√≥ kho·∫£ng tr·∫Øng bao quanh ho·∫∑c l√† d·∫•u g·∫°ch ngang duy nh·∫•t
            if (line.contains(' - ')) {
              final parts = line.split(' - ');
              if (parts.length >= 2) {
                original = parts[0].trim();
                vietnamese = parts.sublist(1).join(' - ').trim();
              }
            } else {
              final parts = line.split('-');
              if (parts.length >= 2) {
                original = parts[0].trim();
                vietnamese = parts.sublist(1).join('-').trim();
              }
            }
          }
        }

        if (original != null &&
            vietnamese != null &&
            original.isNotEmpty &&
            vietnamese.isNotEmpty) {
          if (vietnamese.length > 100) continue;
          cleanBuffer.writeln('"$original","$vietnamese"');
        }
      }
    }

    return cleanBuffer.toString().trim();
  }

  Future<String> translateChunk(
    String chunk,
    String systemPrompt,
    String glossaryCsv,
    String modelName,
    String sourceLanguage,
    String targetLanguage, {
    String? previousContext,
    String? genre,
  }) async {
    final isSmallModel = modelName.toLowerCase().contains("0.5b") ||
        modelName.toLowerCase().contains("1.5b");

    // LAYER 3: Strict Constraints to prevent garbage output
    String constraints = "";
    if (targetLanguage == 'Ti·∫øng Vi·ªát') {
      // Ki·ªÉm tra th·ªÉ lo·∫°i ƒë·ªÉ √°p d·ª•ng quy t·∫Øc ph√π h·ª£p
      bool isWuxia = genre == 'KIEMHIEP' || genre == 'NGONTINH';

      if (isWuxia) {
        // === CONSTRAINTS CHO KI·∫æM HI·ªÜP / NG√îN T√åNH ===
        constraints = """
CRITICAL OUTPUT RULES:
1. Translate to natural Vietnamese (Ti·∫øng Vi·ªát).
2. **ABSOLUTELY FORBIDDEN:** Do not output ANY English words (e.g., 'cold', 'surrounding', 'kill', 'said'). Translate them ALL to Vietnamese context.
3. **PUNCTUATION:** Convert Chinese punctuation („Äå...„Äç, Ôºå, „ÄÇ) to standard Vietnamese punctuation ("...", ,, .).
4. **TERMINOLOGY:** Use Sino-Vietnamese (H√°n-Vi·ªát) for all Proper Nouns, Cultivation Ranks, and Sect Names based on the Glossary.
5. Never output the Chinese text again. Only the Vietnamese translation.
6. **NO TRANSLATOR NOTES:** Do not add footnotes or explanations.
""";
      } else {
        // === CONSTRAINTS CHO KHOA H·ªåC / K·ª∏ THU·∫¨T / HI·ªÜN ƒê·∫†I ===
        constraints = """
CRITICAL OUTPUT RULES:
1. **FULL SENTENCE TRANSLATION:** You MUST translate the complete sentence structure, verbs, prepositions, and connecting words into Vietnamese. DO NOT just list the technical terms.
   - Wrong: "Blockchain (Blockchain) (Decentralization)."
   - Right: "C·ªët l√µi c·ªßa Blockchain (Blockchain) n·∫±m ·ªü s·ª± phi t·∫≠p trung (Decentralization)."
2. **TECHNICAL TERMS:** Keep English acronyms (Blockchain, AI, Node, CPU...) but translate the context around them naturally.
3. **NO CHINESE CHARACTERS:** Do not output Chinese text.
4. **PUNCTUATION:** Convert Chinese punctuation („Äå...„Äç, Ôºå, „ÄÇ) to standard Vietnamese punctuation ("...", ,, .).
5. **MODERN STYLE:** Use modern Vietnamese vocabulary, NOT archaic Sino-Vietnamese (H√°n-Vi·ªát c·ªï).
6. Never output the source text again. Only the Vietnamese translation.
7. **NO TRANSLATOR NOTES:** Do not add footnotes or explanations.
""";
      }
    }

    String contextInstruction = "";
    if (previousContext != null && previousContext.isNotEmpty) {
      contextInstruction = """
### CONTEXT FROM PREVIOUS SECTION:
The following is the ending of the previous translated section for continuity reference:
"$previousContext"

Use this context to maintain narrative flow, consistent pronouns, and proper subject references. Do NOT re-translate the context - only translate the new text below.

""";
    }

    String finalSystemPrompt;
    if (isSmallModel) {
      finalSystemPrompt =
          "You are a professional translator. Translate the following text into $targetLanguage. Output ONLY the translation. Do not repeat the input.\n$constraints";
      if (contextInstruction.isNotEmpty) {
        finalSystemPrompt += "\n$contextInstruction";
      }
    } else {
      if (targetLanguage == 'Ti·∫øng Vi·ªát') {
        finalSystemPrompt =
            "$systemPrompt\n\n$constraints\n\n$contextInstruction### Y√äU C·∫¶U D·ªäCH THU·∫¨T N√ÇNG CAO:\n1. D·ªãch CHI TI·∫æT t·ª´ng c√¢u, tuy·ªát ƒë·ªëi KH√îNG ƒë∆∞·ª£c t√≥m t·∫Øt hay b·ªè s√≥t √Ω.\n2. Gi·ªØ nguy√™n s·∫Øc th√°i bi·ªÉu c·∫£m, c√°c th√°n t·ª´, m√¥ t·∫£ n·ªôi t√¢m c·ªßa nh√¢n v·∫≠t.\n3. N·∫øu g·∫∑p th∆° ca ho·∫∑c c√¢u ƒë·ªëi, h√£y d·ªãch sao cho v·∫ßn ƒëi·ªáu ho·∫∑c gi·ªØ nguy√™n H√°n Vi·ªát n·∫øu c·∫ßn.\n4. VƒÉn phong ph·∫£i tr√¥i ch·∫£y, t·ª± nhi√™n nh∆∞ ng∆∞·ªùi b·∫£n x·ª© vi·∫øt.\n\nOUTPUT ONLY THE VIETNAMESE TRANSLATION. NO PREAMBLE.";
      } else {
        finalSystemPrompt =
            "$systemPrompt\n\n$contextInstruction\nOUTPUT ONLY THE TRANSLATION. NO PREAMBLE.";
      }
    }

    String formattedGlossary = "";
    try {
      final List<List<dynamic>> rows = const CsvToListConverter().convert(
        glossaryCsv,
        eol: '\n',
        shouldParseNumbers: false,
      );

      final StringBuffer buffer = StringBuffer();
      for (final row in rows) {
        if (row.length >= 2) {
          final original = row[0].toString().trim();
          final vietnamese = row[1].toString().trim();
          final definition = row.length > 2 ? row[2].toString().trim() : "";

          if (original.isNotEmpty && vietnamese.isNotEmpty) {
            if (isSmallModel) {
              buffer.write("$original: $vietnamese\n");
            } else {
              buffer.write("- Term: $original\n");
              buffer.write("  Vietnamese: $vietnamese\n");
              if (definition.isNotEmpty) {
                buffer.write("  Context/Definition: $definition\n");
              }
            }
          }
        }
      }
      formattedGlossary = buffer.toString().trim();
    } catch (e) {
      formattedGlossary = glossaryCsv;
    }

    if (formattedGlossary.isNotEmpty) {
      finalSystemPrompt += "\n\n### GLOSSARY:\n$formattedGlossary";
    }

    final rawResponse = await chatCompletion(modelName: modelName, messages: [
      {"role": "system", "content": finalSystemPrompt},
      {
        "role": "user",
        "content":
            "Translate the following text from $sourceLanguage into $targetLanguage:\n\n$chunk"
      }
    ], options: {
      "timeout": 28800000
    });

    final cleaned = _cleanResponse(rawResponse, sourceLanguage, targetLanguage);

    if (_isGarbageOutput(cleaned)) {
      return "";
    }

    return cleaned;
  }

  /// Checks if output is garbage (only punctuation, symbols, or very short)
  bool _isGarbageOutput(String text) {
    if (text.isEmpty) return true;

    final contentOnly =
        text.replaceAll(RegExp(r'[\s\p{P}\p{S}]+', unicode: true), '');

    if (contentOnly.isEmpty) return true;
    if (contentOnly.length < 3 && text.length > 10) return true;

    return false;
  }

  /// LAYER 2: Aggressive String Sanitization
  String _cleanResponse(String raw, String sourceLang, String targetLang) {
    if (targetLang == 'Ti·∫øng Trung') {
      return raw.trim();
    }

    String clean = raw.trim();

    // Normalize Chinese quotes to standard quotes (√°p d·ª•ng cho m·ªçi ng√¥n ng·ªØ ngu·ªìn)
    clean = clean.replaceAll('"', '"');
    clean = clean.replaceAll('"', '"');
    clean = clean.replaceAll('„Äå', '"');
    clean = clean.replaceAll('„Äç', '"');
    clean = clean.replaceAll('„Äé', '"');
    clean = clean.replaceAll('„Äè', '"');

    // Ch·ªâ normalize d·∫•u c√¢u Trung Qu·ªëc n·∫øu ngu·ªìn l√† Ti·∫øng Trung
    if (sourceLang == 'Ti·∫øng Trung') {
      clean = clean.replaceAll('„ÄÇ', '. ');
      clean = clean.replaceAll('Ôºå', ', ');
      clean = clean.replaceAll('„ÄÅ', ', ');
      clean = clean.replaceAll('Ôºö', ': ');
      clean = clean.replaceAll('Ôºü', '? ');
      clean = clean.replaceAll('ÔºÅ', '! ');
      clean = clean.replaceAll(''', "'");
      clean = clean.replaceAll(''', "'");
      clean = clean.replaceAll('Ôºà', '(');
      clean = clean.replaceAll('Ôºâ', ')');
      clean = clean.replaceAll('„Ää', '"');
      clean = clean.replaceAll('„Äã', '"');
      clean = clean.replaceAll('‚Ä¶', '...');
      clean = clean.replaceAll('ÔΩû', '~');
      clean = clean.replaceAll('¬∑', ' ');
      clean = clean.replaceAll('‚Äî', '-');
      clean = clean.replaceAll('‚Äì', '-');
    }

    // Remove Hallucinated Symbol Sequences - filter out lines that are ONLY punctuation
    final lines = clean.split('\n');
    final cleanedLines = <String>[];
    final punctOnlyPattern = RegExp(r'^[\s.,;:!?\-"' "'" r'()\[\]{}]+' r'$');
    for (final line in lines) {
      final trimmedLine = line.trim();
      if (trimmedLine.isEmpty) continue;
      if (punctOnlyPattern.hasMatch(trimmedLine)) {
        continue;
      }
      cleanedLines.add(line);
    }
    clean = cleanedLines.join('\n');

    // Standard cleaning (quotes)
    if (clean.startsWith('"') && clean.endsWith('"')) {
      clean = clean.substring(1, clean.length - 1);
    } else if (clean.startsWith("'") && clean.endsWith("'")) {
      clean = clean.substring(1, clean.length - 1);
    }

    // Strip prompt repetition
    final processedLines = clean.split('\n');
    if (processedLines.isNotEmpty) {
      final firstLine = processedLines.first.toLowerCase();
      if (firstLine.contains("d·ªãch ƒëo·∫°n vƒÉn b·∫£n") ||
          firstLine.contains("translate the following")) {
        clean = processedLines.sublist(1).join('\n').trim();
      }
    }

    // X√≥a k√Ω t·ª± Trung Qu·ªëc n·∫øu ƒë√≠ch l√† Ti·∫øng Vi·ªát (b·∫•t k·ªÉ ng√¥n ng·ªØ ngu·ªìn)
    // L√Ω do: Model Qwen ƒë√¥i khi b·ªã ·∫£o gi√°c ch√®n ti·∫øng Trung v√†o b·∫£n d·ªãch Anh-Vi·ªát
    if (targetLang == 'Ti·∫øng Vi·ªát') {
      // Remove parenthesized Chinese: (ÈªëÈìÅÂâë) or [ÈªëÈìÅÂâë] or ÔºàÈªëÈìÅÂâëÔºâ
      clean = clean.replaceAll(RegExp(r'\([^)]*[\u4e00-\u9fa5]+[^)]*\)'), '');
      clean = clean.replaceAll(RegExp(r'\[[^\]]*[\u4e00-\u9fa5]+[^\]]*\]'), '');
      clean = clean.replaceAll(RegExp(r'Ôºà[^Ôºâ]*[\u4e00-\u9fa5]+[^Ôºâ]*Ôºâ'), '');

      // Remove loose Chinese characters
      clean = clean.replaceAll(RegExp(r'[\u4e00-\u9fa5]+'), '');

      // Clean up hanging punctuation left after Chinese removal
      clean = clean.replaceAll(RegExp(r'(\s*[,.:;]\s*){2,}'), ' ');

      // Remove leading punctuation on lines
      clean = clean.replaceAll(RegExp(r'^\s*[,.:;]+\s*', multiLine: true), '');

      // Remove trailing orphan punctuation
      clean =
          clean.replaceAll(RegExp(r'\s+[,.:;]+\s*' r'$', multiLine: true), '');
    }

    // Final cleanup: Fix double/multiple spaces
    clean = clean.replaceAll(RegExp(r' {2,}'), ' ');

    return clean.trim();
  }

  /// LAYER 1: Strict Model Parameters in chatCompletion
  Future<String> chatCompletion(
      {required String modelName,
      required List<Map<String, String>> messages,
      Map<String, dynamic>? options}) async {
    final stopwatch = Stopwatch()..start();

    try {
      // Model name is now directly from provider, no conversion needed
      final String finalModel = modelName.trim();

      if (finalModel.isEmpty) {
        _logger.error(
            'AIService', 'chatCompletion failed: Model name is required');
        throw Exception("Model name is required");
      }

      Map<String, dynamic> body;

      if (_providerType == AIProviderType.lmStudio) {
        // LM Studio uses OpenAI API format
        body = {
          "model": finalModel,
          "messages": messages,
          "stream": false,
          "temperature": options?['temperature'] ?? 0.2,
          "max_tokens": options?['num_predict'] ?? 2048,
        };
      } else {
        // Ollama API format
        // LAYER 1: Strict Model Parameters to prevent hallucinations
        final Map<String, dynamic> defaultOptions = {
          "temperature":
              0.2, // Low creativity, high accuracy - kills hallucinations
          "num_predict": 2048, // Prevents cut-off sentences
          "repeat_penalty":
              1.2, // Prevents loops like "r·ª´ngispereming" or ",,,"
        };

        // Merge caller options with defaults (caller options take precedence)
        final Map<String, dynamic> mergedOptions = {
          ...defaultOptions,
          if (options != null) ...options,
        };

        body = {
          "model": finalModel,
          "messages": messages,
          "stream": false,
          "options": mergedOptions,
        };
      }

      // Log request
      final lastMessage =
          messages.isNotEmpty ? messages.last['content'] ?? '' : '';
      final truncatedContent = lastMessage.length > 200
          ? '${lastMessage.substring(0, 200)}...'
          : lastMessage;
      _logger.request(
        'AIService',
        'POST $_chatUrl | Model: $finalModel | Messages: ${messages.length}',
        details:
            'Last message (truncated): $truncatedContent\n\nBody: ${jsonEncode(body)}',
      );

      // Get timeout from options, default to 5 minutes (300000ms)
      final int timeoutMs = options?['timeout'] ?? 300000;
      final response = await http
          .post(
        Uri.parse(_chatUrl),
        headers: {"Content-Type": "application/json"},
        body: jsonEncode(body),
      )
          .timeout(
        Duration(milliseconds: timeoutMs),
        onTimeout: () {
          throw Exception(
              'AI request timed out after ${timeoutMs ~/ 1000} seconds. The model may still be loading. Please try again.');
        },
      );

      stopwatch.stop();

      if (response.statusCode == 200) {
        final json = jsonDecode(utf8.decode(response.bodyBytes));

        // Parse response based on provider
        String content;
        if (_providerType == AIProviderType.lmStudio) {
          // OpenAI format: { choices: [{ message: { content: "..." } }] }
          final choices = json['choices'] as List?;
          if (choices != null && choices.isNotEmpty) {
            content = choices[0]['message']['content'] ?? "";
          } else {
            content = "";
          }
        } else {
          // Ollama format: { message: { content: "..." } }
          content = json['message']['content'] ?? "";
        }

        final truncatedResponse =
            content.length > 300 ? '${content.substring(0, 300)}...' : content;

        _logger.response(
          'AIService',
          'OK 200 | ${stopwatch.elapsedMilliseconds}ms | ${content.length} chars',
          details: 'Response (truncated): $truncatedResponse',
        );

        return content;
      } else {
        _logger.error(
          'AIService',
          'API Error ${response.statusCode} | ${stopwatch.elapsedMilliseconds}ms',
          details: response.body,
        );
        final providerName =
            _providerType == AIProviderType.lmStudio ? 'LM Studio' : 'Ollama';
        throw Exception(
            "$providerName API Error: ${response.statusCode} - ${response.body}");
      }
    } catch (e) {
      stopwatch.stop();
      _logger.error(
        'AIService',
        'chatCompletion failed | ${stopwatch.elapsedMilliseconds}ms',
        details: e.toString(),
      );
      final providerName =
          _providerType == AIProviderType.lmStudio ? 'LM Studio' : 'Ollama';
      throw Exception("Failed to connect to $providerName: $e");
    }
  }

  Future<List<String>> getInstalledModels() async {
    try {
      final response = await http.get(Uri.parse(_tagsUrl));

      if (response.statusCode == 200) {
        final Map<String, dynamic> data = jsonDecode(response.body);

        if (_providerType == AIProviderType.lmStudio) {
          // LM Studio returns { data: [{ id: "model-name", ... }] }
          final List<dynamic> models = data['data'] ?? [];
          return models.map<String>((m) => m['id'] as String).toList();
        } else {
          // Ollama returns { models: [{ name: "model-name", ... }] }
          final List<dynamic> models = data['models'] ?? [];
          return models.map<String>((m) => m['name'] as String).toList();
        }
      } else {
        return [];
      }
    } catch (e) {
      return [];
    }
  }

  /// Check if current provider supports model management (pull/delete)
  bool get supportsModelManagement => _providerType == AIProviderType.ollama;

  Future<bool> pullModel(
      String modelName, Function(double progress) onProgress) async {
    if (!supportsModelManagement) {
      _logger.warning('AIService',
          'Model management not supported for LM Studio. Please load models in LM Studio app.');
      return false;
    }

    try {
      final request = http.Request('POST', Uri.parse(_pullUrl));
      request.body = jsonEncode({"name": modelName, "stream": true});
      request.headers.addAll({"Content-Type": "application/json"});

      final response = await request.send();

      if (response.statusCode == 200) {
        await response.stream.transform(utf8.decoder).listen((chunk) {
          final lines =
              chunk.split('\n').where((line) => line.trim().isNotEmpty);
          for (final line in lines) {
            try {
              final data = jsonDecode(line);
              if (data.containsKey('completed') && data.containsKey('total')) {
                final completed = data['completed'];
                final total = data['total'];
                if (total > 0) {
                  onProgress(completed / total);
                }
              } else if (data['status'] == 'success') {
                onProgress(1.0);
              }
            } catch (e) {
              // Ignore parse errors for partial chunks
            }
          }
        }).asFuture();
        return true;
      } else {
        return false;
      }
    } catch (e) {
      return false;
    }
  }

  /// Preload a model into memory silently (fire-and-forget)
  Future<void> preloadModel(String modelName) async {
    try {
      // Model name is now directly from provider, no conversion needed
      final String finalModel = modelName.trim();
      if (finalModel.isEmpty) return;

      final body = {
        "model": finalModel,
        "messages": [],
      };

      await http.post(
        Uri.parse(_chatUrl),
        headers: {"Content-Type": "application/json"},
        body: jsonEncode(body),
      );
    } catch (e) {
      // Silent failure
    }
  }

  /// Delete a model from Ollama (not supported for LM Studio)
  Future<bool> deleteModel(String modelName) async {
    if (!supportsModelManagement) {
      _logger.warning('AIService',
          'Model management not supported for LM Studio. Please manage models in LM Studio app.');
      return false;
    }

    try {
      final response = await http.delete(
        Uri.parse(_deleteUrl),
        headers: {"Content-Type": "application/json"},
        body: jsonEncode({"name": modelName}),
      );
      return response.statusCode == 200;
    } catch (e) {
      return false;
    }
  }
}
</file>

<file path="lib/ui/screens/settings_screen.dart">
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:font_awesome_flutter/font_awesome_flutter.dart';
import 'package:flutter_animate/flutter_animate.dart';
import 'package:provider/provider.dart';
import '../theme/app_theme.dart';
import '../theme/config_provider.dart';
import '../widgets/path_setup_modal.dart';
import '../../services/ai_service.dart';
import '../../utils/app_strings.dart';

class SettingsScreen extends StatefulWidget {
  final bool isDark;

  const SettingsScreen({super.key, required this.isDark});

  @override
  State<SettingsScreen> createState() => _SettingsScreenState();
}

class _SettingsScreenState extends State<SettingsScreen>
    with WidgetsBindingObserver {
  // String _selectedModel = 'Qwen2.5-7B'; // Removed local state
  bool _isModelDropdownOpen = false;
  bool _isLanguageDropdownOpen = false;

  final List<String> _models = [
    'Qwen2.5-0.5B',
    'Qwen2.5-1B',
    'Qwen2.5-3B',
    'Qwen2.5-7B',
    'Qwen3-8B',
    'Qwen3-14B',
    'Qwen3-30B-A3B',
  ];

  final AIService _aiService = AIService();
  final TextEditingController _ollamaUrlController = TextEditingController();
  final TextEditingController _lmStudioUrlController = TextEditingController();
  bool _isCheckingConnection = false;
  String? _connectionStatus;
  bool? _isConnectionSuccess;
  List<String> _installedModels = [];
  final Map<String, double?> _downloadProgress = {};
  bool _isLoadingModels = false;

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addObserver(this);
    // Load URLs from config after widget is built
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _initAIConfig();
    });
  }

  void _initAIConfig() {
    final config = context.read<ConfigProvider>();
    _ollamaUrlController.text = config.ollamaUrl;
    _lmStudioUrlController.text = config.lmStudioUrl;

    // Set AIService based on current provider
    _updateAIServiceConfig(config);
    _checkInstalledModels();
  }

  void _updateAIServiceConfig(ConfigProvider config) {
    if (config.aiProvider == AIProvider.lmStudio) {
      _aiService.setBaseUrl(config.lmStudioUrl);
      _aiService.setProviderType(AIProviderType.lmStudio);
    } else {
      _aiService.setBaseUrl(config.ollamaUrl);
      _aiService.setProviderType(AIProviderType.ollama);
    }
  }

  @override
  void dispose() {
    WidgetsBinding.instance.removeObserver(this);
    _ollamaUrlController.dispose();
    _lmStudioUrlController.dispose();
    super.dispose();
  }

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state == AppLifecycleState.resumed) {
      _checkInstalledModels();
    }
  }

  Future<void> _checkAIConnection(AIProvider provider) async {
    if (!mounted) return;

    setState(() {
      _isCheckingConnection = true;
      _connectionStatus = null;
      _isConnectionSuccess = null;
    });

    final url = provider == AIProvider.lmStudio
        ? _lmStudioUrlController.text.trim()
        : _ollamaUrlController.text.trim();

    final providerType = provider == AIProvider.lmStudio
        ? AIProviderType.lmStudio
        : AIProviderType.ollama;

    final (success, errorCode, modelCount) =
        await _aiService.checkConnection(url: url, providerType: providerType);

    if (mounted) {
      final lang = context.read<ConfigProvider>().appLanguage;
      String message;

      if (success) {
        // Build localized success message
        final key = provider == AIProvider.lmStudio
            ? 'lmstudio_connection_success'
            : 'ollama_connection_success';
        message = AppStrings.get(lang, key)
            .replaceAll('@count', modelCount.toString());
      } else {
        // Build localized error message
        if (errorCode != null && errorCode.startsWith('error_status:')) {
          final statusCode = errorCode.split(':')[1];
          message = AppStrings.get(lang, 'connection_error_status')
              .replaceAll('@code', statusCode);
        } else if (errorCode == 'error_timeout') {
          message = AppStrings.get(lang, 'connection_error_timeout');
        } else if (errorCode == 'error_connect') {
          message = AppStrings.get(lang, 'connection_error_connect');
        } else {
          message = AppStrings.get(lang, 'connection_error_generic');
        }
      }

      setState(() {
        _isCheckingConnection = false;
        _connectionStatus = message;
        _isConnectionSuccess = success;
      });

      if (success) {
        final config = context.read<ConfigProvider>();
        // Save URL to config
        if (provider == AIProvider.lmStudio) {
          await config.setLmStudioUrl(url);
        } else {
          await config.setOllamaUrl(url);
        }

        // If this is the active provider, update AIService and refresh models
        if (config.aiProvider == provider) {
          _updateAIServiceConfig(config);
          _checkInstalledModels();
        }
      }
    }
  }

  Future<void> _switchAIProvider(AIProvider provider) async {
    final config = context.read<ConfigProvider>();
    await config.setAIProvider(provider);

    // Reset connection status when switching
    setState(() {
      _connectionStatus = null;
      _isConnectionSuccess = null;
      _installedModels = [];
    });

    // Update AIService config
    _updateAIServiceConfig(config);

    // Check models for the new provider
    _checkInstalledModels();
  }

  Future<void> _checkInstalledModels() async {
    if (!mounted) return;

    setState(() {
      _isLoadingModels = true;
    });

    try {
      final models = await _aiService.getInstalledModels();
      if (mounted) {
        setState(() {
          _installedModels = models;
        });

        // Auto-select first model if current selection is invalid
        final config = context.read<ConfigProvider>();
        if (models.isNotEmpty && !models.contains(config.selectedModel)) {
          config.setSelectedModel(models.first);
        }
      }
    } catch (e) {
      debugPrint('Error checking installed models: $e');
      // Optionally show a snackbar or just fail silently
    } finally {
      if (mounted) {
        setState(() {
          _isLoadingModels = false;
        });
      }
    }
  }

  Widget _buildProviderButton({
    required String label,
    required IconData icon,
    required bool isSelected,
    required VoidCallback onTap,
  }) {
    return Expanded(
      child: GestureDetector(
        onTap: onTap,
        child: MouseRegion(
          cursor: SystemMouseCursors.click,
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
            decoration: BoxDecoration(
              color: isSelected
                  ? (widget.isDark
                      ? AppColors.lightPrimary.withValues(alpha: 0.2)
                      : AppColors.lightPrimary.withValues(alpha: 0.1))
                  : (widget.isDark
                      ? Colors.black.withValues(alpha: 0.2)
                      : Colors.grey[100]),
              borderRadius: BorderRadius.circular(8),
              border: Border.all(
                color: isSelected
                    ? (widget.isDark
                        ? AppColors.lightPrimary
                        : AppColors.lightPrimary)
                    : (widget.isDark
                        ? const Color(0xFF444444)
                        : Colors.grey[300]!),
                width: isSelected ? 2 : 1,
              ),
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                FaIcon(
                  icon,
                  size: 16,
                  color: isSelected
                      ? (widget.isDark ? Colors.white : AppColors.lightPrimary)
                      : (widget.isDark ? Colors.grey[400] : Colors.grey[600]),
                ),
                const SizedBox(width: 8),
                Text(
                  label,
                  style: TextStyle(
                    fontSize: 14,
                    fontWeight:
                        isSelected ? FontWeight.w600 : FontWeight.normal,
                    color: isSelected
                        ? (widget.isDark
                            ? Colors.white
                            : AppColors.lightPrimary)
                        : (widget.isDark ? Colors.grey[400] : Colors.grey[600]),
                  ),
                ),
                if (isSelected) ...[
                  const SizedBox(width: 8),
                  FaIcon(
                    FontAwesomeIcons.circleCheck,
                    size: 14,
                    color: widget.isDark ? Colors.green[400] : Colors.green,
                  ),
                ],
              ],
            ),
          ),
        ),
      ),
    );
  }

  String _getOllamaModelName(String uiName) {
    return uiName.toLowerCase().replaceFirst('-', ':');
  }

  Future<void> _downloadModel(String uiName) async {
    setState(() {
      _downloadProgress[uiName] = 0.0;
    });

    final ollamaName = _getOllamaModelName(uiName);
    final success = await _aiService.pullModel(ollamaName, (progress) {
      if (mounted) {
        setState(() {
          _downloadProgress[uiName] = progress;
        });
      }
    });

    if (mounted) {
      setState(() {
        _downloadProgress[uiName] = null;
      });

      if (success) {
        await _checkInstalledModels();
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(content: Text('T·∫£i model $uiName th√†nh c√¥ng!')),
          );
        }
      } else {
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(content: Text('T·∫£i model $uiName th·∫•t b·∫°i.')),
          );
        }
      }
    }
  }

  void _showManageModelsDialog(BuildContext context) {
    final lang = context.read<ConfigProvider>().appLanguage;
    showDialog(
      context: context,
      builder: (context) => _ManageModelsDialog(
        isDark: widget.isDark,
        installedModels: _installedModels,
        aiService: _aiService,
        onModelsChanged: _checkInstalledModels,
        lang: lang,
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final lang = context.watch<ConfigProvider>().appLanguage;
    return Container(
      padding: const EdgeInsets.all(32),
      child: Center(
        child: Container(
          constraints: const BoxConstraints(maxWidth: 768),
          child: ListView(
            children: [
              Text(
                AppStrings.get(lang, 'settings_title'),
                style: GoogleFonts.merriweather(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: widget.isDark ? Colors.white : AppColors.lightPrimary,
                ),
              ),

              const SizedBox(height: 32),

              // Appearance Section
              _SectionHeader(
                icon: FontAwesomeIcons.palette,
                title: AppStrings.get(lang, 'appearance_section'),
                isDark: widget.isDark,
              ),
              const SizedBox(height: 16),
              Container(
                decoration: BoxDecoration(
                  color: widget.isDark ? AppColors.darkSurface : Colors.white,
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(
                    color: widget.isDark
                        ? AppColors.darkBorder
                        : AppColors.lightBorder,
                  ),
                ),
                child: Column(
                  children: [
                    _SettingRow(
                      title: AppStrings.get(lang, 'dark_mode'),
                      subtitle: AppStrings.get(lang, 'dark_mode_subtitle'),
                      isDark: widget.isDark,
                      trailing: Consumer<ThemeNotifier>(
                        builder: (context, themeNotifier, _) => Switch(
                          value: widget.isDark,
                          onChanged: (_) => themeNotifier.toggleTheme(),
                          activeThumbColor: widget.isDark
                              ? Colors.white.withValues(alpha: 0.9)
                              : const Color(0xFF3E4C59),
                        ),
                      ),
                      showBorder: true,
                    ),
                    _SettingRow(
                      title: AppStrings.get(lang, 'display_font'),
                      subtitle: AppStrings.get(lang, 'display_font_subtitle'),
                      isDark: widget.isDark,
                      trailing: Container(
                        padding: const EdgeInsets.symmetric(
                            horizontal: 16, vertical: 8),
                        decoration: BoxDecoration(
                          color: widget.isDark
                              ? Colors.black.withValues(alpha: 0.2)
                              : AppColors.lightPaper,
                          border: Border.all(
                            color: widget.isDark
                                ? const Color(0xFF444444)
                                : AppColors.lightBorder,
                          ),
                          borderRadius: BorderRadius.circular(6),
                        ),
                        child: Text(
                          'Merriweather (${AppStrings.get(lang, 'default_label')})',
                          style: TextStyle(
                            fontSize: 14,
                            color: widget.isDark
                                ? Colors.grey[300]
                                : AppColors.lightPrimary,
                          ),
                        ),
                      ),
                      showBorder: true,
                    ),
                    _SettingRow(
                      title: AppStrings.get(lang, 'language'),
                      subtitle: AppStrings.get(lang, 'language_subtitle'),
                      isDark: widget.isDark,
                      trailing: MouseRegion(
                        cursor: SystemMouseCursors.click,
                        child: GestureDetector(
                          onTap: () => setState(() => _isLanguageDropdownOpen =
                              !_isLanguageDropdownOpen),
                          child: Container(
                            padding: const EdgeInsets.symmetric(
                                horizontal: 16, vertical: 8),
                            constraints: const BoxConstraints(minWidth: 120),
                            decoration: BoxDecoration(
                              color: widget.isDark
                                  ? Colors.black.withValues(alpha: 0.2)
                                  : AppColors.lightPaper,
                              border: Border.all(
                                color: widget.isDark
                                    ? const Color(0xFF444444)
                                    : AppColors.lightBorder,
                              ),
                              borderRadius: BorderRadius.circular(6),
                            ),
                            child: Row(
                              mainAxisSize: MainAxisSize.min,
                              mainAxisAlignment: MainAxisAlignment.spaceBetween,
                              children: [
                                Text(
                                  lang == 'vi' ? 'Ti·∫øng Vi·ªát' : 'English',
                                  style: TextStyle(
                                    fontSize: 14,
                                    color: widget.isDark
                                        ? Colors.grey[300]
                                        : AppColors.lightPrimary,
                                  ),
                                ),
                                const SizedBox(width: 8),
                                FaIcon(
                                  _isLanguageDropdownOpen
                                      ? FontAwesomeIcons.chevronUp
                                      : FontAwesomeIcons.chevronDown,
                                  size: 12,
                                  color: widget.isDark
                                      ? Colors.grey
                                      : Colors.grey[600],
                                ),
                              ],
                            ),
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
              if (_isLanguageDropdownOpen)
                Container(
                  margin: const EdgeInsets.only(top: 8),
                  decoration: BoxDecoration(
                    color: widget.isDark ? AppColors.darkSurface : Colors.white,
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(
                      color: widget.isDark
                          ? AppColors.darkBorder
                          : AppColors.lightBorder,
                    ),
                  ),
                  child: Column(
                    children: ['vi', 'en'].map((l) {
                      final isSelected = lang == l;
                      return InkWell(
                        onTap: () {
                          context.read<ConfigProvider>().setAppLanguage(l);
                          setState(() {
                            _isLanguageDropdownOpen = false;
                          });
                        },
                        child: Container(
                          padding: const EdgeInsets.symmetric(
                              horizontal: 16, vertical: 12),
                          decoration: BoxDecoration(
                            color: isSelected
                                ? (widget.isDark
                                    ? Colors.white.withValues(alpha: 0.1)
                                    : AppColors.lightPrimary
                                        .withValues(alpha: 0.05))
                                : Colors.transparent,
                          ),
                          child: Row(
                            children: [
                              Expanded(
                                child: Text(
                                  l == 'vi' ? 'Ti·∫øng Vi·ªát' : 'English',
                                  style: TextStyle(
                                    fontSize: 14,
                                    fontWeight: isSelected
                                        ? FontWeight.bold
                                        : FontWeight.normal,
                                    color: isSelected
                                        ? (widget.isDark
                                            ? Colors.white
                                            : AppColors.lightPrimary)
                                        : (widget.isDark
                                            ? Colors.grey[300]
                                            : Colors.grey[600]),
                                  ),
                                ),
                              ),
                              if (isSelected)
                                FaIcon(
                                  FontAwesomeIcons.check,
                                  size: 12,
                                  color: widget.isDark
                                      ? Colors.white
                                      : AppColors.lightPrimary,
                                ),
                            ],
                          ),
                        ),
                      );
                    }).toList(),
                  ),
                ).animate().fadeIn(),

              const SizedBox(height: 32),

              // AI Section
              _SectionHeader(
                icon: FontAwesomeIcons.brain,
                title: AppStrings.get(lang, 'ai_config_section'),
                isDark: widget.isDark,
                onRefresh: _checkInstalledModels,
                isLoading: _isLoadingModels,
              ),
              const SizedBox(height: 16),

              // AI Provider Selection
              Container(
                decoration: BoxDecoration(
                  color: widget.isDark ? AppColors.darkSurface : Colors.white,
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(
                    color: widget.isDark
                        ? AppColors.darkBorder
                        : AppColors.lightBorder,
                  ),
                ),
                child: Padding(
                  padding: const EdgeInsets.all(20),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'AI Provider',
                        style: TextStyle(
                          fontSize: 14,
                          fontWeight: FontWeight.w500,
                          color: widget.isDark
                              ? Colors.grey[200]
                              : AppColors.lightPrimary,
                        ),
                      ),
                      const SizedBox(height: 4),
                      Text(
                        AppStrings.get(lang, 'ai_provider_subtitle'),
                        style: TextStyle(
                          fontSize: 12,
                          color: widget.isDark
                              ? Colors.grey[500]
                              : AppColors.lightPrimary.withValues(alpha: 0.6),
                        ),
                      ),
                      const SizedBox(height: 12),
                      Consumer<ConfigProvider>(
                        builder: (context, config, _) => Row(
                          children: [
                            _buildProviderButton(
                              label: 'Ollama',
                              icon: FontAwesomeIcons.server,
                              isSelected:
                                  config.aiProvider == AIProvider.ollama,
                              onTap: () => _switchAIProvider(AIProvider.ollama),
                            ),
                            const SizedBox(width: 12),
                            _buildProviderButton(
                              label: 'LM Studio',
                              icon: FontAwesomeIcons.desktop,
                              isSelected:
                                  config.aiProvider == AIProvider.lmStudio,
                              onTap: () =>
                                  _switchAIProvider(AIProvider.lmStudio),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
              ),

              const SizedBox(height: 16),

              // AI URL Configuration - Shows based on selected provider
              Consumer<ConfigProvider>(
                builder: (context, config, _) => Container(
                  decoration: BoxDecoration(
                    color: widget.isDark ? AppColors.darkSurface : Colors.white,
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(
                      color: widget.isDark
                          ? AppColors.darkBorder
                          : AppColors.lightBorder,
                    ),
                  ),
                  child: Padding(
                    padding: const EdgeInsets.all(20),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          config.aiProvider == AIProvider.lmStudio
                              ? 'URL LM Studio Server'
                              : 'URL Ollama Server',
                          style: TextStyle(
                            fontSize: 14,
                            fontWeight: FontWeight.w500,
                            color: widget.isDark
                                ? Colors.grey[200]
                                : AppColors.lightPrimary,
                          ),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          config.aiProvider == AIProvider.lmStudio
                              ? AppStrings.get(lang, 'lmstudio_url_subtitle')
                              : AppStrings.get(lang, 'ollama_url_subtitle'),
                          style: TextStyle(
                            fontSize: 12,
                            color: widget.isDark
                                ? Colors.grey[500]
                                : AppColors.lightPrimary.withValues(alpha: 0.6),
                          ),
                        ),
                        const SizedBox(height: 12),
                        Row(
                          children: [
                            Expanded(
                              child: TextField(
                                controller:
                                    config.aiProvider == AIProvider.lmStudio
                                        ? _lmStudioUrlController
                                        : _ollamaUrlController,
                                style: TextStyle(
                                  fontSize: 14,
                                  color: widget.isDark
                                      ? Colors.grey[200]
                                      : AppColors.lightPrimary,
                                ),
                                decoration: InputDecoration(
                                  hintText:
                                      config.aiProvider == AIProvider.lmStudio
                                          ? 'http://localhost:1234'
                                          : 'http://localhost:11434',
                                  hintStyle: TextStyle(
                                    color: widget.isDark
                                        ? Colors.grey[600]
                                        : Colors.grey[400],
                                  ),
                                  contentPadding: const EdgeInsets.symmetric(
                                      horizontal: 12, vertical: 10),
                                  filled: true,
                                  fillColor: widget.isDark
                                      ? Colors.black.withValues(alpha: 0.2)
                                      : AppColors.lightPaper,
                                  border: OutlineInputBorder(
                                    borderRadius: BorderRadius.circular(6),
                                    borderSide: BorderSide(
                                      color: widget.isDark
                                          ? const Color(0xFF444444)
                                          : AppColors.lightBorder,
                                    ),
                                  ),
                                  enabledBorder: OutlineInputBorder(
                                    borderRadius: BorderRadius.circular(6),
                                    borderSide: BorderSide(
                                      color: widget.isDark
                                          ? const Color(0xFF444444)
                                          : AppColors.lightBorder,
                                    ),
                                  ),
                                  focusedBorder: OutlineInputBorder(
                                    borderRadius: BorderRadius.circular(6),
                                    borderSide: BorderSide(
                                      color: widget.isDark
                                          ? Colors.white.withValues(alpha: 0.3)
                                          : AppColors.lightPrimary,
                                    ),
                                  ),
                                ),
                              ),
                            ),
                            const SizedBox(width: 12),
                            ElevatedButton.icon(
                              onPressed: _isCheckingConnection
                                  ? null
                                  : () => _checkAIConnection(config.aiProvider),
                              icon: _isCheckingConnection
                                  ? SizedBox(
                                      width: 16,
                                      height: 16,
                                      child: CircularProgressIndicator(
                                        strokeWidth: 2,
                                        color: widget.isDark
                                            ? Colors.white
                                            : AppColors.lightPrimary,
                                      ),
                                    )
                                  : FaIcon(
                                      FontAwesomeIcons.plug,
                                      size: 14,
                                      color: widget.isDark
                                          ? Colors.white
                                          : Colors.white,
                                    ),
                              label: Text(
                                _isCheckingConnection
                                    ? AppStrings.get(
                                        lang, 'checking_connection')
                                    : AppStrings.get(lang, 'check_connection'),
                                style: const TextStyle(fontSize: 13),
                              ),
                              style: ElevatedButton.styleFrom(
                                backgroundColor: widget.isDark
                                    ? const Color(0xFF4CAF50)
                                    : AppColors.lightPrimary,
                                foregroundColor: Colors.white,
                                padding: const EdgeInsets.symmetric(
                                    horizontal: 16, vertical: 12),
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(6),
                                ),
                              ),
                            ),
                          ],
                        ),
                        if (_connectionStatus != null) ...[
                          const SizedBox(height: 12),
                          Container(
                            padding: const EdgeInsets.symmetric(
                                horizontal: 12, vertical: 8),
                            decoration: BoxDecoration(
                              color: _isConnectionSuccess == true
                                  ? Colors.green.withValues(alpha: 0.1)
                                  : Colors.red.withValues(alpha: 0.1),
                              borderRadius: BorderRadius.circular(6),
                              border: Border.all(
                                color: _isConnectionSuccess == true
                                    ? Colors.green.withValues(alpha: 0.3)
                                    : Colors.red.withValues(alpha: 0.3),
                              ),
                            ),
                            child: Row(
                              children: [
                                FaIcon(
                                  _isConnectionSuccess == true
                                      ? FontAwesomeIcons.circleCheck
                                      : FontAwesomeIcons.circleXmark,
                                  size: 14,
                                  color: _isConnectionSuccess == true
                                      ? Colors.green
                                      : Colors.red,
                                ),
                                const SizedBox(width: 8),
                                Expanded(
                                  child: Text(
                                    _connectionStatus!,
                                    style: TextStyle(
                                      fontSize: 13,
                                      color: _isConnectionSuccess == true
                                          ? Colors.green
                                          : Colors.red,
                                    ),
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                        // Note for LM Studio users
                        if (config.aiProvider == AIProvider.lmStudio) ...[
                          const SizedBox(height: 12),
                          Container(
                            padding: const EdgeInsets.all(12),
                            decoration: BoxDecoration(
                              color: Colors.blue.withValues(alpha: 0.1),
                              borderRadius: BorderRadius.circular(6),
                              border: Border.all(
                                color: Colors.blue.withValues(alpha: 0.3),
                              ),
                            ),
                            child: Row(
                              children: [
                                FaIcon(
                                  FontAwesomeIcons.circleInfo,
                                  size: 14,
                                  color: Colors.blue,
                                ),
                                const SizedBox(width: 8),
                                Expanded(
                                  child: Text(
                                    AppStrings.get(lang, 'lmstudio_note'),
                                    style: TextStyle(
                                      fontSize: 12,
                                      color: Colors.blue[700],
                                    ),
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ],
                    ),
                  ),
                ),
              ),

              const SizedBox(height: 16),

              // Model Selection - Show installed models
              Container(
                decoration: BoxDecoration(
                  color: widget.isDark ? AppColors.darkSurface : Colors.white,
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(
                    color: widget.isDark
                        ? AppColors.darkBorder
                        : AppColors.lightBorder,
                  ),
                ),
                child: _SettingRow(
                  title: AppStrings.get(lang, 'translation_model'),
                  subtitle: _installedModels.isEmpty
                      ? AppStrings.get(lang, 'no_models_check_connection')
                      : AppStrings.get(lang, 'select_from_models').replaceAll(
                          '{count}', _installedModels.length.toString()),
                  isDark: widget.isDark,
                  trailing: MouseRegion(
                    cursor: SystemMouseCursors.click,
                    child: GestureDetector(
                      onTap: _installedModels.isEmpty
                          ? null
                          : () => setState(() =>
                              _isModelDropdownOpen = !_isModelDropdownOpen),
                      child: Container(
                        padding: const EdgeInsets.symmetric(
                            horizontal: 16, vertical: 8),
                        constraints:
                            const BoxConstraints(minWidth: 140, maxWidth: 250),
                        decoration: BoxDecoration(
                          color: widget.isDark
                              ? Colors.black.withValues(alpha: 0.2)
                              : AppColors.lightPaper,
                          border: Border.all(
                            color: widget.isDark
                                ? const Color(0xFF444444)
                                : AppColors.lightBorder,
                          ),
                          borderRadius: BorderRadius.circular(6),
                        ),
                        child: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Flexible(
                              child: Text(
                                _installedModels.isEmpty
                                    ? AppStrings.get(lang, 'no_model_available')
                                    : context
                                        .watch<ConfigProvider>()
                                        .selectedModel,
                                style: TextStyle(
                                  fontSize: 14,
                                  color: _installedModels.isEmpty
                                      ? Colors.grey
                                      : (widget.isDark
                                          ? Colors.grey[300]
                                          : AppColors.lightPrimary),
                                ),
                                overflow: TextOverflow.ellipsis,
                              ),
                            ),
                            const SizedBox(width: 8),
                            FaIcon(
                              _isModelDropdownOpen
                                  ? FontAwesomeIcons.chevronUp
                                  : FontAwesomeIcons.chevronDown,
                              size: 12,
                              color: widget.isDark
                                  ? Colors.grey
                                  : Colors.grey[600],
                            ),
                          ],
                        ),
                      ),
                    ),
                  ),
                ),
              ),

              if (_isModelDropdownOpen && _installedModels.isNotEmpty)
                Container(
                  margin: const EdgeInsets.only(top: 8),
                  constraints: const BoxConstraints(maxHeight: 300),
                  decoration: BoxDecoration(
                    color: widget.isDark ? AppColors.darkSurface : Colors.white,
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(
                      color: widget.isDark
                          ? AppColors.darkBorder
                          : AppColors.lightBorder,
                    ),
                  ),
                  child: SingleChildScrollView(
                    child: Column(
                      children: _installedModels.map((model) {
                        final configProvider = context.read<ConfigProvider>();
                        final isSelected =
                            model == configProvider.selectedModel;

                        return InkWell(
                          onTap: () {
                            setState(() {
                              context
                                  .read<ConfigProvider>()
                                  .setSelectedModel(model);
                              _isModelDropdownOpen = false;
                            });

                            // Silent preload: trigger model loading in background
                            _aiService.preloadModel(model);
                          },
                          child: Container(
                            padding: const EdgeInsets.symmetric(
                                horizontal: 16, vertical: 12),
                            decoration: BoxDecoration(
                              color: isSelected
                                  ? (widget.isDark
                                      ? Colors.white.withValues(alpha: 0.1)
                                      : AppColors.lightPrimary
                                          .withValues(alpha: 0.05))
                                  : Colors.transparent,
                            ),
                            child: Row(
                              children: [
                                Expanded(
                                  child: Text(
                                    model,
                                    style: TextStyle(
                                      fontSize: 14,
                                      fontWeight: isSelected
                                          ? FontWeight.bold
                                          : FontWeight.normal,
                                      color: isSelected
                                          ? (widget.isDark
                                              ? Colors.white
                                              : AppColors.lightPrimary)
                                          : (widget.isDark
                                              ? Colors.grey[300]
                                              : Colors.grey[600]),
                                    ),
                                  ),
                                ),
                                if (isSelected)
                                  FaIcon(
                                    FontAwesomeIcons.check,
                                    size: 12,
                                    color: widget.isDark
                                        ? Colors.white
                                        : AppColors.lightPrimary,
                                  ),
                              ],
                            ),
                          ),
                        );
                      }).toList(),
                    ),
                  ),
                ).animate().fadeIn(),

              const SizedBox(height: 16),

              // Manage Downloaded Models
              Container(
                decoration: BoxDecoration(
                  color: widget.isDark ? AppColors.darkSurface : Colors.white,
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(
                    color: widget.isDark
                        ? AppColors.darkBorder
                        : AppColors.lightBorder,
                  ),
                ),
                child: InkWell(
                  onTap: () => _showManageModelsDialog(context),
                  borderRadius: BorderRadius.circular(12),
                  child: _SettingRow(
                    title: AppStrings.get(lang, 'manage_models'),
                    subtitle: AppStrings.get(lang, 'models_installed_count')
                        .replaceAll(
                            '{count}', _installedModels.length.toString()),
                    isDark: widget.isDark,
                    trailing: FaIcon(
                      FontAwesomeIcons.hardDrive,
                      size: 16,
                      color: widget.isDark
                          ? Colors.grey[400]
                          : AppColors.lightPrimary.withValues(alpha: 0.5),
                    ),
                  ),
                ),
              ),

              const SizedBox(height: 32),

              // Translation Configuration Section
              _SectionHeader(
                icon: FontAwesomeIcons.gears,
                title: AppStrings.get(lang, 'translation_config_section'),
                isDark: widget.isDark,
              ),
              const SizedBox(height: 16),
              Container(
                decoration: BoxDecoration(
                  color: widget.isDark ? AppColors.darkSurface : Colors.white,
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(
                    color: widget.isDark
                        ? AppColors.darkBorder
                        : AppColors.lightBorder,
                  ),
                ),
                child: Consumer<ConfigProvider>(
                  builder: (context, config, _) => InkWell(
                    onTap: () {
                      showDialog(
                        context: context,
                        builder: (context) => PathSetupModal(
                          isDark: widget.isDark,
                          onClose: () => Navigator.pop(context),
                        ),
                      );
                    },
                    borderRadius: BorderRadius.circular(12),
                    child: Padding(
                      padding: const EdgeInsets.all(20),
                      child: Row(
                        children: [
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  AppStrings.get(lang, 'project_folder'),
                                  style: TextStyle(
                                    fontSize: 14,
                                    fontWeight: FontWeight.w500,
                                    color: widget.isDark
                                        ? Colors.grey[200]
                                        : AppColors.lightPrimary,
                                  ),
                                ),
                                const SizedBox(height: 4),
                                Text(
                                  config.isConfigured
                                      ? config.projectPath
                                      : AppStrings.get(lang, 'not_configured'),
                                  style: TextStyle(
                                    fontSize: 12,
                                    color: widget.isDark
                                        ? Colors.grey[500]
                                        : AppColors.lightPrimary
                                            .withValues(alpha: 0.6),
                                  ),
                                ),
                              ],
                            ),
                          ),
                          FaIcon(
                            FontAwesomeIcons.penToSquare,
                            size: 16,
                            color: widget.isDark
                                ? Colors.grey[400]
                                : AppColors.lightPrimary.withValues(alpha: 0.5),
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
              ),

              // Footer Credit
              const SizedBox(height: 48),
              Align(
                alignment: Alignment.bottomRight,
                child: Text(
                  'FluxOrigin v1.0.0 - Made with ‚òï by d-init-d',
                  style: TextStyle(
                    fontSize: 11,
                    fontFamily: 'Consolas',
                    color: widget.isDark
                        ? Colors.grey.withValues(alpha: 0.6)
                        : const Color(0xFF888888),
                  ),
                ),
              ),
              const SizedBox(height: 16),
            ],
          ),
        ),
      ),
    ).animate().fadeIn();
  }
}

class _SectionHeader extends StatelessWidget {
  final IconData icon;
  final String title;
  final bool isDark;
  final VoidCallback? onRefresh;
  final bool isLoading;

  const _SectionHeader({
    required this.icon,
    required this.title,
    required this.isDark,
    this.onRefresh,
    this.isLoading = false,
  });

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        FaIcon(
          icon,
          size: 12,
          color: isDark
              ? Colors.white.withValues(alpha: 0.7)
              : AppColors.lightPrimary,
        ),
        const SizedBox(width: 8),
        Text(
          title,
          style: TextStyle(
            fontSize: 12,
            fontWeight: FontWeight.bold,
            letterSpacing: 1.5,
            color:
                isDark ? Colors.white.withOpacity(0.7) : AppColors.lightPrimary,
          ),
        ),
        if (onRefresh != null) ...[
          const SizedBox(width: 8),
          if (isLoading)
            SizedBox(
              width: 12,
              height: 12,
              child: CircularProgressIndicator(
                strokeWidth: 2,
                color: isDark ? Colors.white : AppColors.lightPrimary,
              ),
            )
          else
            InkWell(
              onTap: onRefresh,
              borderRadius: BorderRadius.circular(12),
              child: Padding(
                padding: const EdgeInsets.all(4.0),
                child: FaIcon(
                  FontAwesomeIcons.rotateRight,
                  size: 12,
                  color: isDark
                      ? Colors.white.withValues(alpha: 0.7)
                      : AppColors.lightPrimary,
                ),
              ),
            ),
        ],
      ],
    );
  }
}

class _SettingRow extends StatelessWidget {
  final String title;
  final String subtitle;
  final bool isDark;
  final Widget trailing;
  final bool showBorder;

  const _SettingRow({
    required this.title,
    required this.subtitle,
    required this.isDark,
    required this.trailing,
    this.showBorder = false,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        border: showBorder
            ? Border(
                bottom: BorderSide(
                  color: isDark ? AppColors.darkBorder : AppColors.lightBorder,
                ),
              )
            : null,
      ),
      child: Row(
        children: [
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: TextStyle(
                    fontSize: 14,
                    fontWeight: FontWeight.w500,
                    color: isDark ? Colors.grey[200] : AppColors.lightPrimary,
                  ),
                ),
                const SizedBox(height: 4),
                Text(
                  subtitle,
                  style: TextStyle(
                    fontSize: 14,
                    color: isDark
                        ? Colors.grey[500]
                        : AppColors.lightPrimary.withValues(alpha: 0.6),
                  ),
                ),
              ],
            ),
          ),
          trailing,
        ],
      ),
    );
  }
}

class _ManageModelsDialog extends StatefulWidget {
  final bool isDark;
  final List<String> installedModels;
  final AIService aiService;
  final VoidCallback onModelsChanged;
  final String lang;

  const _ManageModelsDialog({
    required this.isDark,
    required this.installedModels,
    required this.aiService,
    required this.onModelsChanged,
    required this.lang,
  });

  @override
  State<_ManageModelsDialog> createState() => _ManageModelsDialogState();
}

class _ManageModelsDialogState extends State<_ManageModelsDialog> {
  late List<String> _models;
  final Set<String> _deletingModels = {};

  @override
  void initState() {
    super.initState();
    _models = List.from(widget.installedModels);
  }

  Future<void> _deleteModel(String modelName) async {
    setState(() {
      _deletingModels.add(modelName);
    });

    final success = await widget.aiService.deleteModel(modelName);

    if (mounted) {
      setState(() {
        _deletingModels.remove(modelName);
        if (success) {
          _models.remove(modelName);
        }
      });

      if (success) {
        widget.onModelsChanged();
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
                content: Text(
                    '${AppStrings.get(widget.lang, 'deleted_model')} $modelName')),
          );
        }
      } else {
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
                content: Text(
                    '${AppStrings.get(widget.lang, 'delete_fail')} $modelName')),
          );
        }
      }
    }
  }

  void _confirmDelete(String modelName) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: widget.isDark ? AppColors.darkSurface : Colors.white,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        title: Text(
          AppStrings.get(widget.lang, 'delete_model_confirm'),
          style: TextStyle(
            color: widget.isDark ? Colors.white : AppColors.lightPrimary,
          ),
        ),
        content: Text(
          '${AppStrings.get(widget.lang, 'delete_model_question')} "$modelName"?',
          style: TextStyle(
            color: widget.isDark ? Colors.grey[300] : Colors.grey[700],
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text(
              AppStrings.get(widget.lang, 'cancel'),
              style: TextStyle(
                color: widget.isDark ? Colors.grey[400] : Colors.grey[600],
              ),
            ),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(context);
              _deleteModel(modelName);
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.red[600],
              foregroundColor: Colors.white,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(8),
              ),
            ),
            child: Text(AppStrings.get(widget.lang, 'delete')),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      child: Container(
        width: 500,
        constraints: const BoxConstraints(maxHeight: 500),
        decoration: BoxDecoration(
          color: widget.isDark ? AppColors.darkSurface : Colors.white,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: widget.isDark ? const Color(0xFF444444) : Colors.grey[200]!,
          ),
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Header
            Container(
              padding: const EdgeInsets.all(24),
              decoration: BoxDecoration(
                border: Border(
                  bottom: BorderSide(
                    color: widget.isDark
                        ? const Color(0xFF444444)
                        : Colors.grey[200]!,
                  ),
                ),
              ),
              child: Row(
                children: [
                  FaIcon(
                    FontAwesomeIcons.hardDrive,
                    size: 18,
                    color:
                        widget.isDark ? Colors.white : AppColors.lightPrimary,
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Text(
                      AppStrings.get(widget.lang, 'manage_models_title'),
                      style: TextStyle(
                        fontSize: 20,
                        fontWeight: FontWeight.bold,
                        fontFamily: 'Merriweather',
                        color: widget.isDark
                            ? Colors.white
                            : AppColors.lightPrimary,
                      ),
                    ),
                  ),
                  IconButton(
                    onPressed: () => Navigator.pop(context),
                    icon: FaIcon(
                      FontAwesomeIcons.xmark,
                      size: 20,
                      color:
                          widget.isDark ? Colors.grey[400] : Colors.grey[500],
                    ),
                    style: IconButton.styleFrom(
                      backgroundColor: widget.isDark
                          ? Colors.white.withValues(alpha: 0.1)
                          : Colors.grey[100],
                      shape: const CircleBorder(),
                    ),
                  ),
                ],
              ),
            ),

            // Body
            Flexible(
              child: _models.isEmpty
                  ? Padding(
                      padding: const EdgeInsets.all(32),
                      child: Column(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          FaIcon(
                            FontAwesomeIcons.boxOpen,
                            size: 48,
                            color: widget.isDark
                                ? Colors.grey[600]
                                : Colors.grey[400],
                          ),
                          const SizedBox(height: 16),
                          Text(
                            AppStrings.get(widget.lang, 'no_models_installed'),
                            style: TextStyle(
                              fontSize: 14,
                              color: widget.isDark
                                  ? Colors.grey[500]
                                  : Colors.grey[600],
                            ),
                          ),
                        ],
                      ),
                    )
                  : ListView.builder(
                      shrinkWrap: true,
                      padding: const EdgeInsets.symmetric(vertical: 8),
                      itemCount: _models.length,
                      itemBuilder: (context, index) {
                        final model = _models[index];
                        final isDeleting = _deletingModels.contains(model);

                        return Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 24,
                            vertical: 12,
                          ),
                          decoration: BoxDecoration(
                            border: index < _models.length - 1
                                ? Border(
                                    bottom: BorderSide(
                                      color: widget.isDark
                                          ? AppColors.darkBorder
                                          : AppColors.lightBorder,
                                    ),
                                  )
                                : null,
                          ),
                          child: Row(
                            children: [
                              FaIcon(
                                FontAwesomeIcons.cube,
                                size: 14,
                                color: widget.isDark
                                    ? Colors.grey[400]
                                    : Colors.grey[600],
                              ),
                              const SizedBox(width: 12),
                              Expanded(
                                child: Text(
                                  model,
                                  style: TextStyle(
                                    fontSize: 14,
                                    color: widget.isDark
                                        ? Colors.grey[200]
                                        : AppColors.lightPrimary,
                                  ),
                                ),
                              ),
                              if (isDeleting)
                                SizedBox(
                                  width: 20,
                                  height: 20,
                                  child: CircularProgressIndicator(
                                    strokeWidth: 2,
                                    color: widget.isDark
                                        ? Colors.white
                                        : AppColors.lightPrimary,
                                  ),
                                )
                              else
                                IconButton(
                                  onPressed: () => _confirmDelete(model),
                                  icon: FaIcon(
                                    FontAwesomeIcons.trash,
                                    size: 14,
                                    color: Colors.red[400],
                                  ),
                                  padding: EdgeInsets.zero,
                                  constraints: const BoxConstraints(),
                                  tooltip: AppStrings.get(
                                      widget.lang, 'delete_model_tooltip'),
                                ),
                            ],
                          ),
                        );
                      },
                    ),
            ),

            // Footer
            Container(
              padding: const EdgeInsets.all(24),
              decoration: BoxDecoration(
                border: Border(
                  top: BorderSide(
                    color: widget.isDark
                        ? const Color(0xFF444444)
                        : Colors.grey[200]!,
                  ),
                ),
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  ElevatedButton(
                    onPressed: () => Navigator.pop(context),
                    style: ElevatedButton.styleFrom(
                      backgroundColor:
                          widget.isDark ? Colors.white : AppColors.lightPrimary,
                      foregroundColor:
                          widget.isDark ? Colors.black : Colors.white,
                      padding: const EdgeInsets.symmetric(
                        horizontal: 16,
                        vertical: 12,
                      ),
                      elevation: 0,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(8),
                      ),
                    ),
                    child: Text(
                      AppStrings.get(widget.lang, 'close'),
                      style: const TextStyle(
                        fontSize: 14,
                        fontWeight: FontWeight.w500,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    ).animate().scale(
          begin: const Offset(0.95, 0.95),
          end: const Offset(1, 1),
          duration: const Duration(milliseconds: 200),
        );
  }
}
</file>

<file path="lib/controllers/translation_controller.dart">
import 'dart:convert';
import 'dart:io';
import 'package:csv/csv.dart';
import 'package:flutter/foundation.dart';
import 'package:path/path.dart' as path;
import '../models/translation_progress.dart';
import '../services/ai_service.dart';
import '../services/web_search_service.dart';
import '../services/dev_logger.dart';
import '../utils/text_processor.dart';
import '../utils/file_parser.dart';
import '../utils/app_strings.dart';

class TranslationController {
  final AIService _aiService = AIService();
  final WebSearchService _webSearchService = WebSearchService();
  final DevLogger _logger = DevLogger();

  /// Set the base URL for AI API
  void setAIUrl(String url) {
    _aiService.setBaseUrl(url);
  }

  /// Set the AI provider type
  void setAIProviderType(AIProviderType type) {
    _aiService.setProviderType(type);
  }

  // Pause control
  bool _isPaused = false;

  /// Request to pause the translation after the current chunk
  void requestPause() {
    _isPaused = true;
  }

  /// Reset pause state (call before starting/resuming)
  void resetPause() {
    _isPaused = false;
  }

  /// Check if a progress file exists for the given document
  /// Returns progress percentage (0.0 to 1.0) if exists, null otherwise
  Future<double?> getProgressPercentage(
      String filePath, String dictionaryDir) async {
    final String fileName = path.basenameWithoutExtension(filePath);
    final String progressPath =
        path.join(dictionaryDir, "$fileName.flux_progress.json");
    final progress = await TranslationProgress.loadFromFile(progressPath);
    if (progress == null) return null;
    if (progress.rawChunks.isEmpty) return null;
    return progress.currentIndex / progress.rawChunks.length;
  }

  /// Check if a progress file exists for the given document
  Future<bool> hasProgress(String filePath, String dictionaryDir) async {
    final String fileName = path.basenameWithoutExtension(filePath);
    final String progressPath =
        path.join(dictionaryDir, "$fileName.flux_progress.json");
    final File progressFile = File(progressPath);
    return await progressFile.exists();
  }

  /// Delete progress file for the given document
  Future<void> deleteProgress(String filePath, String dictionaryDir) async {
    final String fileName = path.basenameWithoutExtension(filePath);
    final String progressPath =
        path.join(dictionaryDir, "$fileName.flux_progress.json");
    final File progressFile = File(progressPath);
    if (await progressFile.exists()) {
      await progressFile.delete();
    }
  }

  /// Processes the file with resume capability.
  /// [onUpdate] callback returns status message and progress (0.0 to 1.0).
  /// [onChunkUpdate] callback returns current chunk index, total chunks, source chunk, and translated chunk.
  /// [allowInternet] controls whether web search (RAG) is used for glossary enrichment.
  /// [resume] if true and progress exists, resume from saved state; if false, start fresh.
  /// Returns the translated content as a String, or null if paused.
  Future<String?> processFile({
    required String filePath,
    required String dictionaryDir,
    required String modelName,
    required String sourceLanguage,
    required String targetLanguage,
    required Function(String status, double progress) onUpdate,
    Function(int currentIndex, int total, String sourceChunk,
            String translatedChunk)?
        onChunkUpdate,
    required bool allowInternet,
    bool resume = false,
    String appLanguage = 'vi',
  }) async {
    // Reset pause state at start
    _isPaused = false;

    _logger.info('Translation', 'Starting translation process', details: '''
File: $filePath
Model: $modelName
Source: $sourceLanguage -> Target: $targetLanguage
Allow Internet: $allowInternet
Resume: $resume
''');

    final String fileName = path.basenameWithoutExtension(filePath);
    final String progressPath =
        path.join(dictionaryDir, "$fileName.flux_progress.json");
    TranslationProgress? progress =
        await TranslationProgress.loadFromFile(progressPath);

    // --- 1. INITIALIZATION OR RESUME ---
    if (progress != null && resume) {
      _logger.info('Translation',
          'Resuming from saved progress: ${progress.currentIndex}/${progress.rawChunks.length} chunks');
      onUpdate(AppStrings.get(appLanguage, 'status_restoring_progress'),
          progress.currentIndex / progress.rawChunks.length);
      await Future.delayed(const Duration(seconds: 1)); // UX delay
    } else {
      // If not resuming or no progress, delete old progress and start fresh
      if (progress != null && !resume) {
        final File progressFile = File(progressPath);
        if (await progressFile.exists()) {
          // Retry loop to handle Windows file lock (OS Error 32)
          bool deleted = false;
          for (int attempt = 1; attempt <= 3; attempt++) {
            try {
              await progressFile.delete();
              deleted = true;
              break;
            } on PathAccessException catch (e) {
              _logger.warning('Translation',
                  'File delete attempt $attempt/3 failed (OS Error 32): $e');
              if (attempt < 3) {
                await Future.delayed(const Duration(milliseconds: 500));
              }
            }
          }
          if (!deleted) {
            _logger.warning('Translation',
                'Could not delete progress file after 3 attempts. Proceeding anyway (writeAsString may overwrite).');
          }
        }
        progress = null;
      }

      // INITIALIZATION SECTION - Wrapped in try-catch to handle AI service failures
      try {
        onUpdate(AppStrings.get(appLanguage, 'status_reading_file'), 0.0);
        _logger.debug('Translation', 'Reading source file...');

        // Extract text content based on file type (TXT or EPUB)
        // Use compute() for heavy EPUB parsing to avoid blocking UI
        final String content = await compute(_extractTextInIsolate, filePath);
        final String fileName = path.basenameWithoutExtension(filePath);
        _logger.info('Translation', 'File loaded: ${content.length} characters');

        onUpdate(AppStrings.get(appLanguage, 'status_analyzing'), 0.1);
        // Use compute() for heavy text splitting to avoid blocking UI
        final List<String> chunks = await compute(_smartSplitInIsolate, content);
        final String sample = TextProcessor.createSample(content);
        _logger.info('Translation', 'Text split into ${chunks.length} chunks');

        onUpdate(AppStrings.get(appLanguage, 'status_detecting_genre'), 0.2);
        // Ch·ªâ detect genre n·∫øu ngu·ªìn l√† Ti·∫øng Trung, c√°c tr∆∞·ªùng h·ª£p kh√°c d√πng "KHAC"
        final String genreKey = sourceLanguage == 'Ti·∫øng Trung'
            ? await _aiService.detectGenre(sample, modelName)
            : "KHAC";
        _logger.info('Translation', 'Detected genre: $genreKey');

        final String systemPrompt =
            _aiService.getSystemPrompt(genreKey, sourceLanguage, targetLanguage);
        _logger.debug('Translation', 'System prompt set', details: systemPrompt);

        onUpdate(AppStrings.get(appLanguage, 'status_creating_glossary'), 0.3);
        final String glossaryCsv = await _aiService.generateGlossary(
            sample, modelName, sourceLanguage, genreKey);
        _logger.info('Translation',
            'Glossary generated: ${glossaryCsv.split('\n').length} terms');

        // Smart Merge: Merge AI glossary with existing user CSV
        final glossaryFile =
            File(path.join(dictionaryDir, "${fileName}_glossary.csv"));

        try {
          final String mergedCsv = await _smartMergeGlossary(
            aiGeneratedCsv: glossaryCsv,
            existingFile: glossaryFile,
          );

          // Save merged glossary as CSV
          await glossaryFile.writeAsString(mergedCsv);
          _logger.debug('Translation', 'Glossary saved to: ${glossaryFile.path}');
        } catch (e) {
          _logger.warning('Translation', 'Error saving glossary: $e');
          // Non-critical error, continue
        }

        // Enrich Glossary: Lookup definitions (only if Internet is allowed)
        String glossary;
        if (allowInternet) {
          onUpdate("ƒêang tra c·ª©u thu·∫≠t ng·ªØ (RAG)...", 0.35);
          glossary = await _enrichGlossary(
            glossaryFile: glossaryFile,
            targetLanguage: targetLanguage,
            onUpdate: onUpdate,
          );
        } else {
          onUpdate("Ch·∫ø ƒë·ªô c·ª•c b·ªô - b·ªè qua tra c·ª©u Internet...", 0.35);
          glossary = await glossaryFile.readAsString();
        }

        // Create output path in outputDir
        // Note: In new flow, we don't save automatically, but we keep this field
        // in TranslationProgress for compatibility or future use.
        const String outputPath = "";

        progress = TranslationProgress(
          sourcePath: filePath,
          outputPath: outputPath,
          glossary: glossary,
          systemPrompt: systemPrompt,
          genre: genreKey,
          rawChunks: chunks,
          translatedChunks: List<String?>.filled(chunks.length, null),
          currentIndex: 0,
          lastUpdated: DateTime.now(),
        );

        await progress.saveToFile(progressPath);
      } catch (e) {
        // Log the initialization error
        _logger.error('Translation', 'Initialization failed during glossary generation', details: e.toString());
        
        // CRITICAL: Update UI with error status so it doesn't stay stuck at "Creating glossary"
        onUpdate(AppStrings.get(appLanguage, 'status_error') + ': $e', 0.3);
        
        // Rethrow to stop execution and let caller handle the error
        rethrow;
      }
    }

    // --- 2. TRANSLATION LOOP WITH CONTEXT AWARENESS ---
    final int total = progress.rawChunks.length;
    String? previousContext;

    // If resuming, extract context from the last translated chunk
    if (progress.currentIndex > 0) {
      final lastTranslated =
          progress.translatedChunks[progress.currentIndex - 1];
      if (lastTranslated != null && lastTranslated.isNotEmpty) {
        previousContext =
            TextProcessor.extractLastSentences(lastTranslated, maxLength: 200);
      }
    }

    _logger.info('Translation',
        'Starting translation loop: ${progress.currentIndex}/$total chunks');

    for (int i = progress.currentIndex; i < total; i++) {
      // Check for pause request BEFORE processing next chunk
      if (_isPaused) {
        _logger.info(
            'Translation', 'Translation paused at chunk ${i + 1}/$total');
        onUpdate(AppStrings.get(appLanguage, 'status_paused'), i / total);
        await progress.saveToFile(progressPath);
        return null; // Return null to indicate paused state
      }

      final double percent = (i / total);
      onUpdate("${AppStrings.get(appLanguage, 'status_translating')} ${i + 1}/$total...", percent);

      try {
        final String chunk = progress.rawChunks[i];
        _logger.debug('Translation',
            'Translating chunk ${i + 1}/$total (${chunk.length} chars)');

        // Notify UI about current chunk being processed
        onChunkUpdate?.call(i + 1, total, chunk, AppStrings.get(appLanguage, 'processing'));

        final String translated = await _aiService.translateChunk(
          chunk,
          progress.systemPrompt,
          progress.glossary,
          modelName,
          sourceLanguage,
          targetLanguage,
          previousContext: previousContext,
          genre: progress.genre,
        );

        progress.translatedChunks[i] = translated;
        progress.currentIndex = i + 1;

        _logger.debug('Translation',
            'Chunk ${i + 1} translated (${translated.length} chars)');

        // Notify UI about translated result
        onChunkUpdate?.call(i + 1, total, chunk, translated);

        // Update context for next iteration
        if (translated.isNotEmpty) {
          previousContext =
              TextProcessor.extractLastSentences(translated, maxLength: 200);
        }

        // CRITICAL: Save after every chunk
        await progress.saveToFile(progressPath);
      } catch (e) {
        _logger.error('Translation', 'Error translating chunk ${i + 1}: $e');
        onUpdate("${AppStrings.get(appLanguage, 'status_error')} ${i + 1}: $e", percent);
        // Simple retry logic: decrement i to retry this chunk next loop
        // Or just throw to stop and let user resume later.
        // For now, let's throw so the loop stops and user can resume.
        throw Exception("${AppStrings.get(appLanguage, 'status_error')} ${i + 1}: $e");
      }
    }

    // --- 3. FINALIZE ---
    _logger.info('Translation', 'Translation complete! Finalizing...');
    onUpdate(AppStrings.get(appLanguage, 'status_merging'), 1.0);
    final StringBuffer finalContent = StringBuffer();
    for (final chunk in progress.translatedChunks) {
      if (chunk != null) {
        finalContent.write(chunk);
        finalContent.write("\n\n");
      }
    }

    // Cleanup progress file
    final File progressFile = File(progressPath);
    if (await progressFile.exists()) {
      await progressFile.delete();
    }

    // Add to history log
    await _addToHistory(
      dictionaryDir: dictionaryDir,
      fileName: fileName,
      status: 'completed',
    );

    _logger.info('Translation',
        'Translation saved! Final length: ${finalContent.length} chars');
    onUpdate(AppStrings.get(appLanguage, 'status_completed'), 1.0);
    return finalContent.toString();
  }

  /// Adds a translation entry to the history log
  Future<void> _addToHistory({
    required String dictionaryDir,
    required String fileName,
    required String status,
  }) async {
    final historyPath = path.join(dictionaryDir, 'history_log.json');
    final historyFile = File(historyPath);

    List<Map<String, dynamic>> history = [];

    // Load existing history
    if (await historyFile.exists()) {
      try {
        final content = await historyFile.readAsString();
        final decoded = jsonDecode(content);
        if (decoded is List) {
          history = decoded.cast<Map<String, dynamic>>();
        }
      } catch (e) {
        // If file is corrupted, start fresh
        debugPrint('Error reading history: $e');
      }
    }

    // Add new entry
    history.add({
      'fileName': fileName,
      'date': DateTime.now().toIso8601String(),
      'status': status,
    });

    // Save history
    try {
      await historyFile.writeAsString(jsonEncode(history));
    } catch (e) {
      debugPrint('Error saving history: $e');
    }
  }

  /// Smart Merge: Merges AI-generated CSV with existing user CSV
  /// Keeps user edits, adds new AI entries
  /// Smart Merge: Merges AI-generated CSV with existing user CSV
  /// Keeps user edits, adds new AI entries
  /// Preserves 3 columns: Original, Vietnamese, Definition
  Future<String> _smartMergeGlossary({
    required String aiGeneratedCsv,
    required File existingFile,
  }) async {
    // Parse AI-generated CSV
    List<List<dynamic>> aiRows = [];
    try {
      aiRows = const CsvToListConverter().convert(
        aiGeneratedCsv,
        eol: '\n',
        shouldParseNumbers: false,
      );
    } catch (e) {
      print("Error parsing AI glossary CSV: $e");
    }

    // Create a map from AI data: Original Name -> [Vietnamese Name, Definition]
    final Map<String, List<String>> aiMap = {};
    for (final row in aiRows) {
      if (row.length >= 2) {
        final original = row[0].toString().trim();
        final vietnamese = row[1].toString().trim();
        final definition = row.length > 2 ? row[2].toString().trim() : "";
        if (original.isNotEmpty) {
          aiMap[original] = [vietnamese, definition];
        }
      }
    }

    // If existing file exists, load and preserve user edits
    if (await existingFile.exists()) {
      List<List<dynamic>> existingRows = [];
      try {
        final String existingContent = await existingFile.readAsString();
        existingRows = const CsvToListConverter().convert(
          existingContent,
          eol: '\n',
          shouldParseNumbers: false,
        );
      } catch (e) {
        print("Error parsing existing glossary CSV: $e");
      }

      // User edits take priority
      final Map<String, List<String>> userMap = {};
      for (final row in existingRows) {
        if (row.length >= 2) {
          final original = row[0].toString().trim();
          final vietnamese = row[1].toString().trim();
          final definition = row.length > 2 ? row[2].toString().trim() : "";
          if (original.isNotEmpty) {
            userMap[original] = [vietnamese, definition];
          }
        }
      }

      // Merge: User edits + New AI entries
      // Start with AI map, then overwrite with User map
      final Map<String, List<String>> mergedMap = {...aiMap};
      mergedMap.addAll(userMap);

      // Convert back to CSV
      final List<List<String>> csvData = mergedMap.entries.map((e) {
        return [e.key, e.value[0], e.value[1]];
      }).toList();

      return const ListToCsvConverter().convert(csvData, eol: '\n');
    } else {
      // No existing file, use AI-generated CSV but ensure 3 columns structure
      final List<List<String>> csvData = aiMap.entries.map((e) {
        return [e.key, e.value[0], e.value[1]];
      }).toList();

      return const ListToCsvConverter().convert(csvData, eol: '\n');
    }
  }

  /// Enriches the glossary by looking up definitions for terms
  Future<String> _enrichGlossary({
    required File glossaryFile,
    required String targetLanguage,
    required Function(String, double) onUpdate,
  }) async {
    if (!await glossaryFile.exists()) return "";

    try {
      final String content = await glossaryFile.readAsString();
      List<List<dynamic>> rows = const CsvToListConverter().convert(
        content,
        eol: '\n',
        shouldParseNumbers: false,
      );

      bool isModified = false;
      final int totalRows = rows.length;

      for (int i = 0; i < totalRows; i++) {
        final row = rows[i];
        if (row.isEmpty) continue;

        // Ensure row has at least 3 columns
        while (row.length < 3) {
          row.add(""); // Add empty definition
          isModified = true;
        }

        final String original = row[0].toString().trim();
        // final String vietnamese = row[1].toString().trim();
        String definition = row[2].toString().trim();

        // If definition is empty, lookup
        if (definition.isEmpty && original.isNotEmpty) {
          onUpdate(
              "ƒêang tra c·ª©u: $original...", 0.35 + (0.05 * (i / totalRows)));

          final langCode = _getLangCode(targetLanguage);
          final String? result =
              await _webSearchService.lookupTerm(original, langCode);
          if (result != null) {
            row[2] =
                result; // ListToCsvConverter will handle escaping quotes/commas
            isModified = true;
          }

          // Delay to avoid rate limiting
          await Future.delayed(const Duration(milliseconds: 500));
        }
      }

      // Always convert back to ensure consistent 3-column format and proper escaping
      final String newCsv = const ListToCsvConverter().convert(rows, eol: '\n');

      if (isModified) {
        await glossaryFile.writeAsString(newCsv);
      }

      return newCsv;
    } catch (e) {
      print("Error enriching glossary: $e");
      // Return original content if enrichment fails to avoid data loss
      return await glossaryFile.readAsString();
    }
  }

  String _getLangCode(String languageName) {
    switch (languageName) {
      case 'Ti·∫øng Vi·ªát':
        return 'vi';
      case 'Ti·∫øng Anh':
        return 'en';
      case 'Ti·∫øng Trung':
        return 'zh';
      default:
        return 'en'; // M·∫∑c ƒë·ªãnh l√† Anh
    }
  }
}

// Top-level functions for compute() isolate execution
// These must be top-level or static to work with compute()

/// Extracts text from file in isolate (supports TXT and EPUB)
Future<String> _extractTextInIsolate(String filePath) async {
  return FileParser.extractText(filePath);
}

/// Splits text into chunks in isolate
List<String> _smartSplitInIsolate(String content) {
  return TextProcessor.smartSplit(content);
}
</file>

<file path="lib/ui/screens/translate_screen.dart">
import 'dart:io';
import 'package:flutter/material.dart';
import 'package:font_awesome_flutter/font_awesome_flutter.dart';
import 'package:file_picker/file_picker.dart';
import 'package:flutter_animate/flutter_animate.dart';
import 'package:provider/provider.dart';
import 'package:path/path.dart' as path;
import 'package:url_launcher/url_launcher.dart';
import '../theme/app_theme.dart';
import '../widgets/language_selector.dart';
import '../widgets/file_upload_zone.dart';
import '../../controllers/translation_controller.dart';
import '../../services/ai_service.dart';
import '../theme/config_provider.dart';
import '../../utils/app_strings.dart';
import '../widgets/ollama_connection_dialog.dart';

enum TranslationState { idle, fileSelected, processing, finished }

class TranslateScreen extends StatefulWidget {
  final bool isDark;
  final bool isActive;

  const TranslateScreen({
    super.key,
    required this.isDark,
    this.isActive = true,
  });

  @override
  State<TranslateScreen> createState() => _TranslateScreenState();
}

class _TranslateScreenState extends State<TranslateScreen> {
  String _sourceLang = 'Ti·∫øng Anh';
  String _targetLang = 'Ti·∫øng Vi·ªát';
  bool _useCustomDict = true;

  // State Machine
  TranslationState _currentState = TranslationState.idle;
  String? _selectedFilePath;
  String? _selectedDictionaryPath;
  String? _translatedContent;

  // Processing State
  final TranslationController _controller = TranslationController();
  double _progress = 0.0;
  String _statusMessage = "";

  // Live translation preview
  String _currentSourceChunk = "";
  String _currentTranslatedChunk = "";
  int _currentChunkIndex = 0;
  int _totalChunks = 0;

  // Resume state
  bool _hasExistingProgress = false;
  double _existingProgressPercent = 0.0;

  final List<String> _allLanguages = ['Ti·∫øng Anh', 'Ti·∫øng Trung', 'Ti·∫øng Vi·ªát'];

  void _swapLanguages() {
    setState(() {
      final temp = _sourceLang;
      _sourceLang = _targetLang;
      _targetLang = temp;
    });
  }

  void _reset() {
    setState(() {
      _currentState = TranslationState.idle;
      _selectedFilePath = null;
      _translatedContent = null;
      _progress = 0.0;
      _statusMessage = "";
      _hasExistingProgress = false;
      _existingProgressPercent = 0.0;
    });
  }

  void _onFileSelected(String filePath) async {
    setState(() {
      _selectedFilePath = filePath;
      _currentState = TranslationState.fileSelected;
    });
    // Check for existing progress
    await _checkExistingProgress();
  }

  Future<void> _checkExistingProgress() async {
    final configProvider = context.read<ConfigProvider>();
    if (!configProvider.isConfigured || _selectedFilePath == null) {
      setState(() {
        _hasExistingProgress = false;
        _existingProgressPercent = 0.0;
      });
      return;
    }

    final progress = await _controller.getProgressPercentage(
      _selectedFilePath!,
      configProvider.dictionaryDir,
    );

    if (mounted) {
      setState(() {
        _hasExistingProgress = progress != null;
        _existingProgressPercent = progress ?? 0.0;
      });
    }
  }

  Future<void> _deleteProgress() async {
    final configProvider = context.read<ConfigProvider>();
    if (!configProvider.isConfigured || _selectedFilePath == null) return;

    await _controller.deleteProgress(
      _selectedFilePath!,
      configProvider.dictionaryDir,
    );

    if (mounted) {
      setState(() {
        _hasExistingProgress = false;
        _existingProgressPercent = 0.0;
      });
    }
  }

  Future<void> _startTranslation({bool resume = false}) async {
    final configProvider = context.read<ConfigProvider>();
    final lang = configProvider.appLanguage;

    if (!configProvider.isConfigured) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(
            AppStrings.get(lang, 'please_configure_project'),
            style: const TextStyle(color: AppColors.lightPrimary),
          ),
          behavior: SnackBarBehavior.floating,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(10),
            side: BorderSide(color: Colors.red.withValues(alpha: 0.5)),
          ),
          backgroundColor: widget.isDark ? AppColors.darkSurface : Colors.white,
          margin: const EdgeInsets.all(16),
          elevation: 6,
        ),
      );
      return;
    }

    if (_selectedFilePath == null) return;

    // Pre-flight connection check
    final aiService = AIService();
    aiService.setBaseUrl(configProvider.currentAiUrl);
    aiService.setProviderType(
      configProvider.aiProvider == AIProvider.lmStudio
          ? AIProviderType.lmStudio
          : AIProviderType.ollama,
    );

    final (connected, _, __) = await aiService.checkConnection();
    if (!connected) {
      if (mounted) {
        showDialog(
          context: context,
          builder: (ctx) => OllamaConnectionDialog(
            isDark: widget.isDark,
            lang: lang,
          ),
        );
      }
      return;
    }

    setState(() {
      _currentState = TranslationState.processing;
      _progress = resume ? _existingProgressPercent : 0.0;
      _statusMessage = resume
          ? AppStrings.get(lang, 'resuming')
          : AppStrings.get(lang, 'initializing');
      // Reset live translation preview
      _currentSourceChunk = "";
      _currentTranslatedChunk = "";
      _currentChunkIndex = 0;
      _totalChunks = 0;
    });

    // Set AI config from provider
    _controller.setAIUrl(configProvider.currentAiUrl);
    _controller.setAIProviderType(
      configProvider.aiProvider == AIProvider.lmStudio
          ? AIProviderType.lmStudio
          : AIProviderType.ollama,
    );

    // Switch ON = Local Mode (Offline) -> allowInternet: false
    // Switch OFF = Internet Mode (Online) -> allowInternet: true
    final bool allowInternet = !_useCustomDict;

    try {
      final result = await _controller.processFile(
        filePath: _selectedFilePath!,
        dictionaryDir: configProvider.dictionaryDir,
        modelName: configProvider.selectedModel,
        sourceLanguage: _sourceLang,
        targetLanguage: _targetLang,
        allowInternet: allowInternet,
        resume: resume,
        appLanguage: lang,
        onUpdate: (status, progress) {
          if (mounted) {
            setState(() {
              _statusMessage = status;
              _progress = progress;
            });
          }
        },
        onChunkUpdate: (currentIndex, total, sourceChunk, translatedChunk) {
          if (mounted) {
            setState(() {
              _currentChunkIndex = currentIndex;
              _totalChunks = total;
              _currentSourceChunk = sourceChunk;
              _currentTranslatedChunk = translatedChunk;
            });
          }
        },
      );

      if (mounted) {
        // result is null if paused
        if (result == null) {
          // Paused - go back to file selected state
          await _checkExistingProgress();
          setState(() {
            _currentState = TranslationState.fileSelected;
          });
        } else {
          // Completed
          setState(() {
            _translatedContent = result;
            _currentState = TranslationState.finished;
            _progress = 1.0;
            _hasExistingProgress = false;
            _existingProgressPercent = 0.0;
          });
        }
      }
    } catch (e) {
      if (mounted) {
        await _checkExistingProgress();
        if (!mounted) return;

        final lang = context.read<ConfigProvider>().appLanguage;
        setState(() {
          _currentState = TranslationState.fileSelected; // Go back to selected
          _statusMessage = "${AppStrings.get(lang, 'error_prefix')}$e";
        });

        // Check if it's a connection error and show custom dialog
        final errorStr = e.toString().toLowerCase();
        if (errorStr.contains('failed to connect') ||
            errorStr.contains('connection') ||
            errorStr.contains('socket')) {
          showDialog(
            context: context,
            builder: (ctx) => OllamaConnectionDialog(
              isDark: widget.isDark,
              lang: lang,
            ),
          );
        } else {
          // Show SnackBar for other errors (non-connection related)
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(
                '${AppStrings.get(lang, 'error_prefix')}$e',
                style: const TextStyle(color: AppColors.lightPrimary),
              ),
              behavior: SnackBarBehavior.floating,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(10),
                side: BorderSide(color: Colors.red.withValues(alpha: 0.5)),
              ),
              backgroundColor:
                  widget.isDark ? AppColors.darkSurface : Colors.white,
              margin: const EdgeInsets.all(16),
              elevation: 6,
            ),
          );
        }
      }
    }
  }

  void _requestPause() {
    _controller.requestPause();
    final lang = context.read<ConfigProvider>().appLanguage;
    setState(() {
      _statusMessage = AppStrings.get(lang, 'pausing');
    });
  }

  Future<void> _saveResult() async {
    if (_translatedContent == null || _selectedFilePath == null) return;

    final lang = context.read<ConfigProvider>().appLanguage;
    final String fileName = path.basenameWithoutExtension(_selectedFilePath!);
    // Output is ALWAYS .txt regardless of input format
    final String defaultName = "${fileName}_translated.txt";

    String? outputFile = await FilePicker.platform.saveFile(
      dialogTitle: AppStrings.get(lang, 'save_result_dialog_title'),
      fileName: defaultName,
      type: FileType.custom,
      allowedExtensions: ['txt'], // Output is always TXT
    );

    if (outputFile != null) {
      try {
        final File file = File(outputFile);
        await file.writeAsString(_translatedContent!);

        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(
                '${AppStrings.get(lang, 'file_saved_at')}$outputFile',
                style: const TextStyle(color: AppColors.lightPrimary),
              ),
              behavior: SnackBarBehavior.floating,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(10),
                side: BorderSide(color: Colors.green.withValues(alpha: 0.5)),
              ),
              backgroundColor:
                  widget.isDark ? AppColors.darkSurface : Colors.white,
              margin: const EdgeInsets.all(16),
              elevation: 6,
            ),
          );
        }
      } catch (e) {
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(
                '${AppStrings.get(lang, 'error_saving_file')}$e',
                style: const TextStyle(color: AppColors.lightPrimary),
              ),
              behavior: SnackBarBehavior.floating,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(10),
                side: BorderSide(color: Colors.red.withValues(alpha: 0.5)),
              ),
              backgroundColor:
                  widget.isDark ? AppColors.darkSurface : Colors.white,
              margin: const EdgeInsets.all(16),
              elevation: 6,
            ),
          );
        }
      }
    }
  }

  Future<void> _reportContent() async {
    final Uri emailUri = Uri(
      scheme: 'mailto',
      path: 'd.init.d.contact@gmail.com',
      query: Uri.encodeFull(
        'subject=Report Inappropriate Content - FluxOrigin&body=I found inappropriate content generated by the AI in file...\n\nPlease describe the issue below:\n',
      ),
    );

    if (await canLaunchUrl(emailUri)) {
      await launchUrl(emailUri);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(24),
      child: Column(
        children: [
          // Language Control
          Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              SizedBox(
                width: 192,
                child: LanguageSelector(
                  value: _sourceLang,
                  isDark: widget.isDark,
                  onChange: (lang) {
                    setState(() {
                      if (lang == _targetLang) {
                        _targetLang = _sourceLang;
                      }
                      _sourceLang = lang;
                    });
                  },
                  availableLanguages: _allLanguages,
                ),
              ),
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 16),
                child: IconButton(
                  onPressed: _swapLanguages,
                  icon: FaIcon(
                    FontAwesomeIcons.rightLeft,
                    size: 16,
                    color:
                        widget.isDark ? Colors.white : AppColors.lightPrimary,
                  ),
                  style: IconButton.styleFrom(
                    backgroundColor: widget.isDark
                        ? Colors.white.withValues(alpha: 0.1)
                        : AppColors.lightPrimary.withValues(alpha: 0.1),
                    shape: const CircleBorder(),
                  ),
                ),
              ),
              SizedBox(
                width: 192,
                child: LanguageSelector(
                  value: _targetLang,
                  isDark: widget.isDark,
                  onChange: (lang) => setState(() => _targetLang = lang),
                  availableLanguages: _allLanguages,
                  disabledLanguage: _sourceLang,
                ),
              ),
            ],
          ),

          const SizedBox(height: 24),

          // Specialized Mode Content (Dictionary + File Upload)
          Expanded(
            child: _buildSpecializedMode(),
          ),
        ],
      ),
    );
  }

  Widget _buildStateContent() {
    switch (_currentState) {
      case TranslationState.idle:
        return FileUploadZone(
          isDark: widget.isDark,
          onFileSelected: _onFileSelected,
          enabled: widget.isActive,
        ).animate().fadeIn();

      case TranslationState.fileSelected:
        return _buildFileSelectedView();

      case TranslationState.processing:
        return _buildProcessingView();

      case TranslationState.finished:
        return _buildFinishedView();
    }
  }

  Widget _buildFileSelectedView() {
    final String fileName = _selectedFilePath != null
        ? path.basename(_selectedFilePath!)
        : "Unknown File";

    final lang = context.watch<ConfigProvider>().appLanguage;
    final int progressPercent = (_existingProgressPercent * 100).toInt();

    return Center(
      child: Container(
        constraints: const BoxConstraints(maxWidth: 400),
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: widget.isDark ? AppColors.darkSurface : Colors.white,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: widget.isDark ? const Color(0xFF444444) : Colors.grey[300]!,
          ),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.1),
              blurRadius: 10,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // File Card
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: widget.isDark
                    ? Colors.white.withValues(alpha: 0.05)
                    : Colors.grey[100],
                borderRadius: BorderRadius.circular(12),
                border: Border.all(
                  color: widget.isDark
                      ? const Color(0xFF555555)
                      : Colors.grey[300]!,
                ),
              ),
              child: Row(
                children: [
                  Container(
                    width: 48,
                    height: 48,
                    decoration: BoxDecoration(
                      color: widget.isDark
                          ? Colors.white.withValues(alpha: 0.1)
                          : Colors.white,
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Center(
                      child: FaIcon(
                        FontAwesomeIcons.fileLines,
                        size: 24,
                        color: widget.isDark
                            ? Colors.white
                            : AppColors.lightPrimary,
                      ),
                    ),
                  ),
                  const SizedBox(width: 16),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          fileName,
                          style: TextStyle(
                            fontFamily: 'Merriweather',
                            fontWeight: FontWeight.bold,
                            fontSize: 16,
                            color: widget.isDark
                                ? Colors.white
                                : AppColors.lightPrimary,
                          ),
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                        ),
                        if (_hasExistingProgress)
                          Text(
                            '${AppStrings.get(lang, 'progress')}$progressPercent%',
                            style: TextStyle(
                              fontSize: 12,
                              color: widget.isDark
                                  ? Colors.green[300]
                                  : Colors.green[700],
                            ),
                          ),
                      ],
                    ),
                  ),
                  // Delete progress button (only show if progress exists)
                  if (_hasExistingProgress)
                    IconButton(
                      onPressed: _deleteProgress,
                      icon: FaIcon(
                        FontAwesomeIcons.trash,
                        size: 14,
                        color: Colors.red[400],
                      ),
                      tooltip: AppStrings.get(lang, 'delete_progress_tooltip'),
                      style: IconButton.styleFrom(
                        backgroundColor: widget.isDark
                            ? Colors.red.withValues(alpha: 0.1)
                            : Colors.red.withValues(alpha: 0.1),
                        shape: const CircleBorder(),
                      ),
                    ),
                  IconButton(
                    onPressed: _reset,
                    icon: FaIcon(
                      FontAwesomeIcons.xmark,
                      size: 16,
                      color:
                          widget.isDark ? Colors.grey[400] : Colors.grey[500],
                    ),
                    style: IconButton.styleFrom(
                      backgroundColor: widget.isDark
                          ? Colors.white.withValues(alpha: 0.1)
                          : Colors.grey[200],
                      shape: const CircleBorder(),
                    ),
                  ),
                ],
              ),
            ),
            const SizedBox(height: 16),

            // Start/Resume Button
            SizedBox(
              width: double.infinity,
              child: ElevatedButton.icon(
                onPressed: () =>
                    _startTranslation(resume: _hasExistingProgress),
                icon: _hasExistingProgress
                    ? const FaIcon(FontAwesomeIcons.play, size: 14)
                    : const SizedBox.shrink(),
                label: Text(
                  _hasExistingProgress
                      ? '${AppStrings.get(lang, 'continue_translation')} - $progressPercent%'
                      : AppStrings.get(lang, 'start_translation'),
                  style: const TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                    letterSpacing: 1,
                  ),
                ),
                style: ElevatedButton.styleFrom(
                  backgroundColor:
                      widget.isDark ? Colors.white : AppColors.lightPrimary,
                  foregroundColor: widget.isDark ? Colors.black : Colors.white,
                  elevation: 0,
                  padding: const EdgeInsets.symmetric(vertical: 12),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
              ),
            ),

            // Start Fresh button (only show if progress exists)
            if (_hasExistingProgress) ...[
              const SizedBox(height: 8),
              TextButton(
                onPressed: () async {
                  await _deleteProgress();
                  _startTranslation(resume: false);
                },
                child: Text(
                  AppStrings.get(lang, 'restart_from_beginning'),
                  style: TextStyle(
                    fontSize: 12,
                    color: widget.isDark ? Colors.grey[400] : Colors.grey[600],
                  ),
                ),
              ),
            ],
          ],
        ),
      ).animate().scale(duration: 200.ms, curve: Curves.easeOut),
    );
  }

  Widget _buildProcessingView() {
    final lang = context.watch<ConfigProvider>().appLanguage;
    return Center(
      child: Container(
        width: 900,
        height: 600,
        padding: const EdgeInsets.all(24),
        decoration: BoxDecoration(
          color: widget.isDark ? AppColors.darkSurface : Colors.white,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: widget.isDark ? const Color(0xFF444444) : Colors.grey[300]!,
          ),
        ),
        child: Column(
          children: [
            // Header with progress
            Row(
              children: [
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        AppStrings.get(lang, 'processing'),
                        style: TextStyle(
                          fontFamily: 'Merriweather',
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                          color: widget.isDark
                              ? Colors.white
                              : AppColors.lightPrimary,
                        ),
                      ),
                      const SizedBox(height: 4),
                      Text(
                        _statusMessage,
                        style: TextStyle(
                          fontSize: 13,
                          color: widget.isDark
                              ? Colors.grey[400]
                              : Colors.grey[600],
                        ),
                      ),
                    ],
                  ),
                ),
                Container(
                  padding:
                      const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                  decoration: BoxDecoration(
                    color: widget.isDark
                        ? Colors.white.withValues(alpha: 0.1)
                        : AppColors.lightPrimary.withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: Text(
                    "${(_progress * 100).toStringAsFixed(0)}%",
                    style: TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                      color:
                          widget.isDark ? Colors.white : AppColors.lightPrimary,
                    ),
                  ),
                ),
              ],
            ),
            const SizedBox(height: 12),
            // Progress bar
            LinearProgressIndicator(
              value: _progress > 0 ? _progress : null,
              minHeight: 6,
              borderRadius: BorderRadius.circular(3),
              backgroundColor: widget.isDark
                  ? Colors.white.withValues(alpha: 0.1)
                  : Colors.grey[200],
              color: widget.isDark ? Colors.white : AppColors.lightPrimary,
            ),
            const SizedBox(height: 16),
            // Chunk info
            if (_totalChunks > 0)
              Container(
                padding:
                    const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                decoration: BoxDecoration(
                  color: widget.isDark
                      ? Colors.blue.withValues(alpha: 0.2)
                      : Colors.blue.withValues(alpha: 0.1),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Text(
                  "${AppStrings.get(lang, 'chunk_progress')} $_currentChunkIndex / $_totalChunks",
                  style: TextStyle(
                    fontSize: 13,
                    fontWeight: FontWeight.w600,
                    color: widget.isDark ? Colors.blue[200] : Colors.blue[700],
                  ),
                ),
              ),
            const SizedBox(height: 16),
            // Translation preview panels
            Expanded(
              child: Row(
                children: [
                  // Source text panel
                  Expanded(
                    child: _buildTextPanel(
                      title: AppStrings.get(lang, 'source_text_panel'),
                      content: _currentSourceChunk,
                      icon: FontAwesomeIcons.fileLines,
                      iconColor: Colors.orange,
                    ),
                  ),
                  const SizedBox(width: 16),
                  // Translated text panel
                  Expanded(
                    child: _buildTextPanel(
                      title: AppStrings.get(lang, 'translated_text_panel'),
                      content: _currentTranslatedChunk,
                      icon: FontAwesomeIcons.language,
                      iconColor: Colors.green,
                      isTranslating: _currentTranslatedChunk ==
                          AppStrings.get(lang, 'processing'),
                    ),
                  ),
                ],
              ),
            ),
            const SizedBox(height: 16),
            // Action buttons
            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                // Pause Button
                ElevatedButton.icon(
                  onPressed: _requestPause,
                  icon: const FaIcon(FontAwesomeIcons.pause, size: 14),
                  label: Text(AppStrings.get(lang, 'pause')),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: widget.isDark
                        ? Colors.orange.withValues(alpha: 0.2)
                        : Colors.orange.withValues(alpha: 0.1),
                    foregroundColor: Colors.orange,
                    elevation: 0,
                    padding: const EdgeInsets.symmetric(
                        horizontal: 24, vertical: 12),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(8),
                      side: BorderSide(
                        color: Colors.orange.withValues(alpha: 0.5),
                      ),
                    ),
                  ),
                ),
                const SizedBox(width: 16),
                // Cancel Button
                TextButton(
                  onPressed: () {
                    _controller.requestPause();
                    _reset();
                  },
                  style: TextButton.styleFrom(
                    foregroundColor: Colors.red,
                    padding: const EdgeInsets.symmetric(
                        horizontal: 24, vertical: 12),
                  ),
                  child: Text(AppStrings.get(lang, 'cancel_action')),
                ),
              ],
            ),
          ],
        ),
      ).animate().fadeIn(),
    );
  }

  Widget _buildTextPanel({
    required String title,
    required String content,
    required IconData icon,
    required Color iconColor,
    bool isTranslating = false,
  }) {
    return Container(
      decoration: BoxDecoration(
        color: widget.isDark
            ? Colors.black.withValues(alpha: 0.3)
            : Colors.grey[50],
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: widget.isDark ? const Color(0xFF333333) : Colors.grey[300]!,
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Panel header
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
            decoration: BoxDecoration(
              color: widget.isDark
                  ? Colors.white.withValues(alpha: 0.05)
                  : Colors.grey[100],
              borderRadius: const BorderRadius.only(
                topLeft: Radius.circular(11),
                topRight: Radius.circular(11),
              ),
            ),
            child: Row(
              children: [
                FaIcon(icon, size: 14, color: iconColor),
                const SizedBox(width: 8),
                Text(
                  title,
                  style: TextStyle(
                    fontSize: 13,
                    fontWeight: FontWeight.w600,
                    color: widget.isDark ? Colors.white70 : Colors.grey[700],
                  ),
                ),
                if (isTranslating) ...[
                  const Spacer(),
                  SizedBox(
                    width: 14,
                    height: 14,
                    child: CircularProgressIndicator(
                      strokeWidth: 2,
                      color: iconColor,
                    ),
                  ),
                ],
              ],
            ),
          ),
          // Panel content
          Expanded(
            child: content.isEmpty
                ? Center(
                    child: Text(
                      AppStrings.get(context.read<ConfigProvider>().appLanguage,
                          'waiting_data'),
                      style: TextStyle(
                        fontSize: 13,
                        fontStyle: FontStyle.italic,
                        color:
                            widget.isDark ? Colors.grey[600] : Colors.grey[400],
                      ),
                    ),
                  )
                : SingleChildScrollView(
                    padding: const EdgeInsets.all(12),
                    child: SelectableText(
                      content,
                      style: TextStyle(
                        fontSize: 13,
                        height: 1.6,
                        color:
                            widget.isDark ? Colors.grey[300] : Colors.grey[800],
                      ),
                    ),
                  ),
          ),
        ],
      ),
    );
  }

  Widget _buildFinishedView() {
    final lang = context.watch<ConfigProvider>().appLanguage;
    return Center(
      child: Container(
        width: 500,
        padding: const EdgeInsets.all(32),
        decoration: BoxDecoration(
          color: widget.isDark ? AppColors.darkSurface : Colors.white,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: widget.isDark ? const Color(0xFF444444) : Colors.grey[300]!,
          ),
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(
              width: 80,
              height: 80,
              decoration: BoxDecoration(
                color: Colors.green.withValues(alpha: 0.1),
                shape: BoxShape.circle,
              ),
              child: const Center(
                child: FaIcon(
                  FontAwesomeIcons.check,
                  size: 40,
                  color: Colors.green,
                ),
              ),
            ),
            const SizedBox(height: 24),
            Text(
              AppStrings.get(lang, 'translation_success'),
              style: TextStyle(
                fontFamily: 'Merriweather',
                fontSize: 20,
                fontWeight: FontWeight.bold,
                color: widget.isDark ? Colors.white : AppColors.lightPrimary,
              ),
            ),
            const SizedBox(height: 32),
            SizedBox(
              width: double.infinity,
              height: 56,
              child: ElevatedButton.icon(
                onPressed: _saveResult,
                icon: const FaIcon(FontAwesomeIcons.floppyDisk, size: 18),
                label: Text(
                  AppStrings.get(lang, 'save_result'),
                  style: const TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                    letterSpacing: 1,
                  ),
                ),
                style: ElevatedButton.styleFrom(
                  backgroundColor:
                      widget.isDark ? Colors.white : AppColors.lightPrimary,
                  foregroundColor: widget.isDark ? Colors.black : Colors.white,
                  elevation: 0,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
              ),
            ),
            const SizedBox(height: 8),
            TextButton.icon(
              onPressed: _reportContent,
              icon: Icon(
                Icons.flag_outlined,
                size: 16,
                color: widget.isDark ? Colors.grey[500] : Colors.grey[500],
              ),
              label: Text(
                AppStrings.get(lang, 'report_inappropriate_content'),
                style: TextStyle(
                  fontSize: 12,
                  color: widget.isDark ? Colors.grey[500] : Colors.grey[500],
                ),
              ),
            ),
            const SizedBox(height: 4),
            TextButton(
              onPressed: _reset,
              style: TextButton.styleFrom(
                padding:
                    const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
              ),
              child: Text(
                AppStrings.get(lang, 'translate_another'),
                style: TextStyle(
                  color: widget.isDark ? Colors.grey[400] : Colors.grey[600],
                ),
              ),
            ),
          ],
        ),
      ).animate().scale(duration: 200.ms, curve: Curves.easeOut),
    );
  }

  Widget _buildSpecializedMode() {
    final lang = context.watch<ConfigProvider>().appLanguage;
    return Column(
      children: [
        // Dictionary header with toggle
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Row(
              children: [
                FaIcon(
                  FontAwesomeIcons.bookBookmark,
                  size: 16,
                  color: widget.isDark ? Colors.white : AppColors.lightPrimary,
                ),
                const SizedBox(width: 8),
                Text(
                  AppStrings.get(lang, 'local_dictionary'),
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                    color:
                        widget.isDark ? Colors.white : AppColors.lightPrimary,
                  ),
                ),
              ],
            ),
            Switch(
              value: _useCustomDict,
              onChanged: (value) => setState(() => _useCustomDict = value),
              activeTrackColor: const Color(0xFF043222),
              activeThumbColor: Colors.white,
            ),
          ],
        ),

        const SizedBox(height: 16),

        // Conditional: Upload (Local/Offline) or AI Auto (Online) box
        Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: _useCustomDict
                ? (widget.isDark
                    ? Colors.white.withValues(alpha: 0.05)
                    : Colors.grey[50])
                : (widget.isDark
                    ? Colors.white.withValues(alpha: 0.05)
                    : const Color(0xFFE8E6DF)),
            borderRadius: BorderRadius.circular(12),
            border: Border.all(
              color: _useCustomDict
                  ? (widget.isDark
                      ? const Color(0xFF444444)
                      : Colors.grey[300]!)
                  : (widget.isDark
                      ? const Color(0xFF444444)
                      : AppColors.lightBorder),
              style: _useCustomDict ? BorderStyle.solid : BorderStyle.solid,
            ),
          ),
          child: _useCustomDict
              // Switch ON: Local Mode (Offline) - Show File Picker
              ? Column(
                  mainAxisSize: MainAxisSize.min,
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        FaIcon(
                          FontAwesomeIcons.upload,
                          size: 18,
                          color: widget.isDark
                              ? Colors.white
                              : AppColors.lightPrimary,
                        ),
                        const SizedBox(width: 16),
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Text(
                                _selectedDictionaryPath != null
                                    ? path.basename(_selectedDictionaryPath!)
                                    : AppStrings.get(
                                        lang, 'upload_dictionary_placeholder'),
                                style: TextStyle(
                                  fontSize: 14,
                                  fontWeight: FontWeight.w500,
                                  color: widget.isDark
                                      ? Colors.grey[200]
                                      : Colors.grey[800],
                                ),
                                maxLines: 1,
                                overflow: TextOverflow.ellipsis,
                              ),
                              Text(
                                _selectedDictionaryPath != null
                                    ? AppStrings.get(lang, 'selected')
                                    : '.CSV',
                                style: TextStyle(
                                  fontSize: 12,
                                  color: widget.isDark
                                      ? Colors.grey[400]
                                      : Colors.grey[500],
                                ),
                              ),
                            ],
                          ),
                        ),
                        OutlinedButton(
                          onPressed: () async {
                            try {
                              final result =
                                  await FilePicker.platform.pickFiles(
                                type: FileType.custom,
                                allowedExtensions: ['csv'],
                              );

                              if (result != null &&
                                  result.files.single.path != null) {
                                setState(() {
                                  _selectedDictionaryPath =
                                      result.files.single.path;
                                });
                              }
                            } catch (e) {
                              debugPrint("Error picking dictionary: $e");
                              if (mounted) {
                                ScaffoldMessenger.of(context).showSnackBar(
                                  SnackBar(
                                    content: Text(
                                        '${AppStrings.get(lang, 'error_picking_file')}$e'),
                                    backgroundColor: Colors.red,
                                  ),
                                );
                              }
                            }
                          },
                          style: OutlinedButton.styleFrom(
                            side: BorderSide(
                              color: widget.isDark
                                  ? Colors.grey[500]!
                                  : Colors.grey[300]!,
                            ),
                            backgroundColor: widget.isDark
                                ? Colors.transparent
                                : Colors.white,
                          ),
                          child: Text(
                            _selectedDictionaryPath != null
                                ? AppStrings.get(lang, 'change_file')
                                : AppStrings.get(lang, 'choose_file'),
                            style: TextStyle(
                              fontSize: 12,
                              color: widget.isDark
                                  ? Colors.grey[300]
                                  : Colors.grey[600],
                            ),
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 8),
                    // Hint text for Local Mode
                    Text(
                      AppStrings.get(lang, 'local_mode_hint'),
                      style: TextStyle(
                        fontSize: 11,
                        fontStyle: FontStyle.italic,
                        color:
                            widget.isDark ? Colors.grey[500] : Colors.grey[600],
                      ),
                    ),
                  ],
                )
              // Switch OFF: Internet Mode (Online) - Show AI Auto status
              : Row(
                  children: [
                    Container(
                      width: 40,
                      height: 40,
                      decoration: BoxDecoration(
                        color: widget.isDark
                            ? Colors.white.withValues(alpha: 0.1)
                            : const Color(0xFFD1FAE5),
                        borderRadius: BorderRadius.circular(20),
                      ),
                      child: Center(
                        child: FaIcon(
                          FontAwesomeIcons.wandMagicSparkles,
                          size: 18,
                          color: widget.isDark
                              ? Colors.white
                              : AppColors.lightAccent,
                        ),
                      ),
                    ),
                    const SizedBox(width: 16),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Text(
                            AppStrings.get(lang, 'ai_auto_mode'),
                            style: TextStyle(
                              fontSize: 14,
                              fontWeight: FontWeight.bold,
                              color: widget.isDark
                                  ? Colors.white
                                  : AppColors.lightPrimary,
                            ),
                          ),
                          Text(
                            AppStrings.get(lang, 'ai_auto_hint'),
                            style: TextStyle(
                              fontSize: 12,
                              color: widget.isDark
                                  ? Colors.grey[400]
                                  : AppColors.lightPrimary
                                      .withValues(alpha: 0.6),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
        ).animate().fadeIn(),

        const SizedBox(height: 16),

        // Main upload zone
        Expanded(
          child: AnimatedSwitcher(
            duration: const Duration(milliseconds: 300),
            child: _buildStateContent(),
          ),
        ),
      ],
    ).animate().fadeIn();
  }
}
</file>

</files>
